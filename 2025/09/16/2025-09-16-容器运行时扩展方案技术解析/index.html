<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>å®¹å™¨è¿è¡Œæ—¶æ‰©å±•æ–¹æ¡ˆæŠ€æœ¯è§£æ | Roger-Lv's space</title><meta name="author" content="Roger-Lv"><meta name="copyright" content="Roger-Lv"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="å®¹å™¨è¿è¡Œæ—¶æ‰©å±•æ–¹æ¡ˆæŠ€æœ¯è§£æ åŸºäºå¯¹æŸå®¹å™¨è¿è¡Œæ—¶æ‰©å±•é¡¹ç›®çš„ä»£ç åˆ†æï¼Œç°ä»æ¶æ„å±‚é¢æç‚¼å…¶æ ¸å¿ƒæŠ€æœ¯å®ç°ï¼Œèšç„¦ä¸‰å¤§æ ¸å¿ƒèƒ½åŠ›ï¼šè¿è¡Œæ—¶æ¥å…¥æœºåˆ¶ã€å®¹å™¨æ ¹æ–‡ä»¶ç³»ç»Ÿäº‘ç«¯æŒä¹…åŒ–ã€Docker-in-Docker å®‰å…¨å®ç°æ–¹æ¡ˆã€‚  1. å¦‚ä½•æ¥å…¥ Containerd è¿è¡Œæ—¶ç”Ÿæ€ é¡¹ç›®é€šè¿‡ Containerd Proxy Plugin æœºåˆ¶ å®ç°ä¸å®¹å™¨è¿è¡Œæ—¶çš„æ— ç¼é›†æˆï¼Œæ¶æ„æ¸…æ™°ã€æ‰©å±•æ€§å¼ºã€‚ â–¶ é…ç½®å±‚æ¥å…¥  åœ¨ co">
<meta property="og:type" content="article">
<meta property="og:title" content="å®¹å™¨è¿è¡Œæ—¶æ‰©å±•æ–¹æ¡ˆæŠ€æœ¯è§£æ">
<meta property="og:url" content="http://example.com/2025/09/16/2025-09-16-%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E6%89%A9%E5%B1%95%E6%96%B9%E6%A1%88%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90/index.html">
<meta property="og:site_name" content="Roger-Lv&#39;s space">
<meta property="og:description" content="å®¹å™¨è¿è¡Œæ—¶æ‰©å±•æ–¹æ¡ˆæŠ€æœ¯è§£æ åŸºäºå¯¹æŸå®¹å™¨è¿è¡Œæ—¶æ‰©å±•é¡¹ç›®çš„ä»£ç åˆ†æï¼Œç°ä»æ¶æ„å±‚é¢æç‚¼å…¶æ ¸å¿ƒæŠ€æœ¯å®ç°ï¼Œèšç„¦ä¸‰å¤§æ ¸å¿ƒèƒ½åŠ›ï¼šè¿è¡Œæ—¶æ¥å…¥æœºåˆ¶ã€å®¹å™¨æ ¹æ–‡ä»¶ç³»ç»Ÿäº‘ç«¯æŒä¹…åŒ–ã€Docker-in-Docker å®‰å…¨å®ç°æ–¹æ¡ˆã€‚  1. å¦‚ä½•æ¥å…¥ Containerd è¿è¡Œæ—¶ç”Ÿæ€ é¡¹ç›®é€šè¿‡ Containerd Proxy Plugin æœºåˆ¶ å®ç°ä¸å®¹å™¨è¿è¡Œæ—¶çš„æ— ç¼é›†æˆï¼Œæ¶æ„æ¸…æ™°ã€æ‰©å±•æ€§å¼ºã€‚ â–¶ é…ç½®å±‚æ¥å…¥  åœ¨ co">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/cover/k8s.png">
<meta property="article:published_time" content="2025-09-15T16:00:00.000Z">
<meta property="article:modified_time" content="2025-09-19T02:11:22.026Z">
<meta property="article:author" content="Roger-Lv">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="K8S">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/cover/k8s.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "å®¹å™¨è¿è¡Œæ—¶æ‰©å±•æ–¹æ¡ˆæŠ€æœ¯è§£æ",
  "url": "http://example.com/2025/09/16/2025-09-16-%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E6%89%A9%E5%B1%95%E6%96%B9%E6%A1%88%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90/",
  "image": "http://example.com/img/cover/k8s.png",
  "datePublished": "2025-09-15T16:00:00.000Z",
  "dateModified": "2025-09-19T02:11:22.026Z",
  "author": [
    {
      "@type": "Person",
      "name": "Roger-Lv",
      "url": "http://example.com"
    }
  ]
}</script><link rel="shortcut icon" href="/img/avatar.jpg"><link rel="canonical" href="http://example.com/2025/09/16/2025-09-16-%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E6%89%A9%E5%B1%95%E6%96%B9%E6%A1%88%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.4.2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":-1,"unescape":true,"languages":{"hits_empty":"æœªæ‰¾åˆ°ç¬¦åˆæ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}","hits_stats":"å…±æ‰¾åˆ° ${hits} ç¯‡æ–‡ç« "}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶å¤±è´¥',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: 'åŠ è½½æ›´å¤š'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'å®¹å™¨è¿è¡Œæ—¶æ‰©å±•æ–¹æ¡ˆæŠ€æœ¯è§£æ',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/font.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">150</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">129</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">42</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äºç¬”è€…</span></a></div><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> ä¸»é¡µ</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-graduation-cap"></i><span> åšæ–‡</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> åˆ†ç±»</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> æ ‡ç­¾</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> å½’æ¡£</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> ç•™è¨€æ¿</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/default_top_img.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Roger-Lv's space</span></a><a class="nav-page-title" href="/"><span class="site-name">å®¹å™¨è¿è¡Œæ—¶æ‰©å±•æ–¹æ¡ˆæŠ€æœ¯è§£æ</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  è¿”å›é¦–é¡µ</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äºç¬”è€…</span></a></div><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> ä¸»é¡µ</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-graduation-cap"></i><span> åšæ–‡</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> åˆ†ç±»</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> æ ‡ç­¾</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> å½’æ¡£</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> ç•™è¨€æ¿</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div><!-- æ·»åŠ æœç´¢æŒ‰é’® â†“--><span class="search-button"><i class="fas fa-search" aria-hidden="true"></i></span></div></nav><div id="post-info"><h1 class="post-title">å®¹å™¨è¿è¡Œæ—¶æ‰©å±•æ–¹æ¡ˆæŠ€æœ¯è§£æ</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2025-09-15T16:00:00.000Z" title="å‘è¡¨äº 2025-09-16 00:00:00">2025-09-16</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2025-09-19T02:11:22.026Z" title="æ›´æ–°äº 2025-09-19 10:11:22">2025-09-19</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Linux/">Linux</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="leancloud_visitors" id="/2025/09/16/2025-09-16-%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E6%89%A9%E5%B1%95%E6%96%B9%E6%A1%88%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90/" data-flag-title="å®¹å™¨è¿è¡Œæ—¶æ‰©å±•æ–¹æ¡ˆæŠ€æœ¯è§£æ"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">æµè§ˆé‡:</span><span class="leancloud-visitors-count"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1>å®¹å™¨è¿è¡Œæ—¶æ‰©å±•æ–¹æ¡ˆæŠ€æœ¯è§£æ</h1>
<p>åŸºäºå¯¹æŸå®¹å™¨è¿è¡Œæ—¶æ‰©å±•é¡¹ç›®çš„ä»£ç åˆ†æï¼Œç°ä»æ¶æ„å±‚é¢æç‚¼å…¶æ ¸å¿ƒæŠ€æœ¯å®ç°ï¼Œèšç„¦ä¸‰å¤§æ ¸å¿ƒèƒ½åŠ›ï¼š<strong>è¿è¡Œæ—¶æ¥å…¥æœºåˆ¶ã€å®¹å™¨æ ¹æ–‡ä»¶ç³»ç»Ÿäº‘ç«¯æŒä¹…åŒ–ã€Docker-in-Docker å®‰å…¨å®ç°æ–¹æ¡ˆ</strong>ã€‚</p>
<hr>
<h2 id="1-å¦‚ä½•æ¥å…¥-Containerd-è¿è¡Œæ—¶ç”Ÿæ€">1. å¦‚ä½•æ¥å…¥ Containerd è¿è¡Œæ—¶ç”Ÿæ€</h2>
<p>é¡¹ç›®é€šè¿‡ <strong>Containerd Proxy Plugin æœºåˆ¶</strong> å®ç°ä¸å®¹å™¨è¿è¡Œæ—¶çš„æ— ç¼é›†æˆï¼Œæ¶æ„æ¸…æ™°ã€æ‰©å±•æ€§å¼ºã€‚</p>
<h3 id="â–¶-é…ç½®å±‚æ¥å…¥">â–¶ é…ç½®å±‚æ¥å…¥</h3>
<ul>
<li>åœ¨ <code>containerd</code> é…ç½®ä¸­æ³¨å†Œåä¸º <code>custom-snapshotter</code> çš„ä»£ç†æ’ä»¶ï¼Œé€šè¿‡ Unix Domain Socket ä¸æœ¬åœ° Agent é€šä¿¡ï¼›</li>
<li>åŒæ—¶æ³¨å†Œè‡ªå®šä¹‰ Runtimeï¼ŒæŒ‡å‘ç‰¹å®šäºŒè¿›åˆ¶æ‰§è¡Œç¨‹åºï¼Œå®ç°å®¹å™¨ç”Ÿå‘½å‘¨æœŸçš„å®šåˆ¶åŒ–æ§åˆ¶ã€‚</li>
</ul>
<h3 id="â–¶-è¿è¡Œæ—¶å±‚å®ç°">â–¶ è¿è¡Œæ—¶å±‚å®ç°</h3>
<ul>
<li><strong>Agent ä¾§</strong>ï¼šå®ç°æ ‡å‡† gRPC æœåŠ¡ï¼Œå“åº”æ¥è‡ª Containerd çš„ Snapshotter æ¥å£è°ƒç”¨ï¼ˆå¦‚ Prepareã€Mountã€Removeï¼‰ï¼›</li>
<li><strong>å­˜å‚¨å±‚å°è£…</strong>ï¼šé‡‡ç”¨ Wrapper æ¨¡å¼å°è£…åŸç”Ÿ OverlayFS Snapshotterï¼Œåœ¨ä¸ç ´ååŸæœ‰é€»è¾‘çš„å‰æä¸‹æ³¨å…¥è‡ªå®šä¹‰è¡Œä¸ºï¼ˆå¦‚é•œåƒé¢„å¤„ç†ã€å…ƒæ•°æ®è®°å½•ç­‰ï¼‰ï¼›</li>
<li><strong>é€šä¿¡æœºåˆ¶</strong>ï¼šé€šè¿‡æœ¬åœ° Unix Socket å®ç°ä½å»¶è¿Ÿã€é«˜å®‰å…¨æ€§çš„è¿›ç¨‹é—´é€šä¿¡ã€‚</li>
</ul>
<blockquote>
<p>âœ… ä»·å€¼ï¼šæ— éœ€ä¿®æ”¹ Containerd æ ¸å¿ƒä»£ç ï¼Œå³å¯å®ç°è¿è¡Œæ—¶è¡Œä¸ºæ‰©å±•ï¼Œç¬¦åˆäº‘åŸç”Ÿæ’ä»¶åŒ–è®¾è®¡å“²å­¦ã€‚</p>
</blockquote>
<hr>
<h2 id="2-å®¹å™¨-RootFS-äº‘ç«¯æŒä¹…åŒ–æ–¹æ¡ˆ">2. å®¹å™¨ RootFS äº‘ç«¯æŒä¹…åŒ–æ–¹æ¡ˆ</h2>
<p>é¡¹ç›®æ”¯æŒåœ¨å®¹å™¨ç»ˆæ­¢æ—¶ï¼Œè‡ªåŠ¨å°†æ ¹æ–‡ä»¶ç³»ç»Ÿæ‰“åŒ…å¹¶ä¸Šä¼ è‡³äº‘ç«¯å­˜å‚¨ï¼Œå®ç°çŠ¶æ€æŒä¹…åŒ–ä¸è·¨èŠ‚ç‚¹æ¢å¤ã€‚</p>
<h3 id="â–¶-è§¦å‘æœºåˆ¶">â–¶ è§¦å‘æœºåˆ¶</h3>
<ul>
<li>é€šè¿‡ Kubernetes Pod æ ‡ç­¾ï¼ˆå¦‚ <code>backup.container.io/enabled=true</code>ï¼‰å£°æ˜å¼è§¦å‘å¤‡ä»½è¡Œä¸ºï¼›</li>
<li>ç”±æ§åˆ¶å™¨ç›‘å¬ Pod ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œåœ¨å®¹å™¨ç»ˆæ­¢å‰è‡ªåŠ¨å‘èµ·å¤‡ä»½æµç¨‹ã€‚</li>
</ul>
<h3 id="â–¶-å­˜å‚¨æ¶æ„">â–¶ å­˜å‚¨æ¶æ„</h3>
<ul>
<li>æ”¯æŒ<strong>æœ¬åœ°æš‚å­˜ + äº‘ç«¯è¿ç§»</strong>åŒé˜¶æ®µæ¨¡å¼ï¼Œé€‚é…ä¸åŒå­˜å‚¨åç«¯ï¼ˆå¦‚ POSIX å…¼å®¹æ–‡ä»¶ç³»ç»Ÿã€åˆ†å¸ƒå¼å­˜å‚¨ç­‰ï¼‰ï¼›</li>
<li>ä½¿ç”¨æ ‡å‡† <code>tar</code> æ ¼å¼å½’æ¡£å®¹å™¨æ ¹ç›®å½•ï¼Œå…¼å®¹æ€§å¼ºï¼Œæ”¯æŒå¤šç‰ˆæœ¬æ ¼å¼æ¼”è¿›ï¼›</li>
<li>é€šè¿‡è‡ªå®šä¹‰ CRDï¼ˆCustom Resource Definitionï¼‰ç»Ÿä¸€ç®¡ç†å¤‡ä»½ä»»åŠ¡çŠ¶æ€ã€å…ƒæ•°æ®åŠç”Ÿå‘½å‘¨æœŸã€‚</li>
</ul>
<h3 id="â–¶-ä¸Šä¼ æµç¨‹">â–¶ ä¸Šä¼ æµç¨‹</h3>
<ol>
<li>æ§åˆ¶å™¨æ•è·å®¹å™¨ç»ˆæ­¢äº‹ä»¶ï¼ŒåŒ¹é…å¤‡ä»½ç­–ç•¥ï¼›</li>
<li>è°ƒç”¨ Backup Manager æ‰§è¡Œæœ¬åœ°æ‰“åŒ…ï¼›</li>
<li>å°†å½’æ¡£æ–‡ä»¶å¼‚æ­¥ä¸Šä¼ è‡³äº‘ç«¯å­˜å‚¨ç³»ç»Ÿï¼›</li>
<li>æ›´æ–° CRD çŠ¶æ€ï¼Œè®°å½•å­˜å‚¨è·¯å¾„ã€æ ¡éªŒå’Œã€æ—¶é—´æˆ³ç­‰å…³é”®å…ƒæ•°æ®ã€‚</li>
</ol>
<blockquote>
<p>âœ… ä»·å€¼ï¼šå®ç°â€œæœ‰çŠ¶æ€å®¹å™¨â€çš„äº‘åŸç”Ÿå­˜å‚¨è¿ç§»ï¼Œä¸ºæ•…éšœæ¢å¤ã€ç¯å¢ƒå¤ç°ã€å®¡è®¡è¿½æº¯æä¾›åŸºç¡€èƒ½åŠ›ã€‚</p>
</blockquote>
<hr>
<h2 id="3-Docker-in-Dockerï¼ˆDinDï¼‰å®‰å…¨å®ç°æ–¹æ¡ˆ">3. Docker-in-Dockerï¼ˆDinDï¼‰å®‰å…¨å®ç°æ–¹æ¡ˆ</h2>
<p>é¡¹ç›®é€šè¿‡è½»é‡åŒ–ã€å‘½åç©ºé—´éš”ç¦»çš„ DinD æ¶æ„ï¼Œä¸ºå®¹å™¨å†…æä¾›å®Œæ•´ä¸”å®‰å…¨çš„ Docker æœåŠ¡ï¼Œé¿å…ä¼ ç»Ÿ DinD çš„æƒé™ä¸èµ„æºå†²çªé—®é¢˜ã€‚</p>
<h3 id="â–¶-æ¶æ„è®¾è®¡">â–¶ æ¶æ„è®¾è®¡</h3>
<ul>
<li>ä¸ºæ¯ä¸ªéœ€ Docker èƒ½åŠ›çš„ä¸šåŠ¡å®¹å™¨ï¼ŒåŠ¨æ€åˆ›å»ºä¸“å±çš„ DinDå®¹å™¨ï¼›</li>
<li>DinD å®¹å™¨ä¸ä¸»å®¹å™¨å…±äº« cgroup ä¸ç½‘ç»œå‘½åç©ºé—´ï¼Œç¡®ä¿èµ„æºéš”ç¦»çš„åŒæ—¶ä¿æŒç½‘ç»œäº’é€šã€‚</li>
</ul>
<h3 id="â–¶-æ ¸å¿ƒå®ç°">â–¶ æ ¸å¿ƒå®ç°</h3>
<ul>
<li><strong>å®¹å™¨åˆ›å»º</strong>ï¼šä½¿ç”¨è½»é‡çº§å®¹å™¨å·¥å…·ï¼ˆå¦‚ <code>nerdctl</code>ï¼‰å¯åŠ¨ DinD å®¹å™¨ï¼ŒæŒ‚è½½ä¸»å®¹å™¨ rootfs è‡³æŒ‡å®šè·¯å¾„ï¼Œå®ç°ä¸Šä¸‹æ–‡å…±äº«ï¼›</li>
<li><strong>ç½‘ç»œé…ç½®</strong>ï¼šé€šè¿‡åˆå§‹åŒ–è„šæœ¬é…ç½®å…±äº«ç½‘ç»œæ ˆï¼Œç¡®ä¿ DinD å†…éƒ¨æ„å»ºçš„å®¹å™¨å¯è¢«ä¸»å®¹å™¨è®¿é—®ï¼›</li>
<li><strong>æœåŠ¡æš´éœ²</strong>ï¼šé€šè¿‡ gRPC æ¥å£å°è£… Docker APIï¼Œä¸»å®¹å™¨å¯é€šè¿‡å®¢æˆ·ç«¯å·¥å…·è°ƒç”¨æ„å»ºã€è¿è¡Œã€é•œåƒç®¡ç†ç­‰æ“ä½œï¼›</li>
<li><strong>å‘½ä»¤è¡Œå·¥å…·</strong>ï¼šæä¾› CLI å·¥å…·ï¼Œæ”¯æŒä¸ DinD æœåŠ¡äº¤äº’ï¼Œç®€åŒ–è°ƒè¯•ä¸é›†æˆã€‚</li>
</ul>
<h3 id="â–¶-å…³é”®ç‰¹æ€§">â–¶ å…³é”®ç‰¹æ€§</h3>
<ul>
<li>æ”¯æŒ GPU è®¾å¤‡é€ä¼ ä¸èµ„æºé…é¢ç®¡ç†ï¼›</li>
<li>å®Œæ•´å…¼å®¹ Docker APIï¼Œä¸šåŠ¡æ— æ„ŸçŸ¥è¿ç§»ï¼›</li>
<li>åŸºäº Kubernetes ServiceAccount Token å®ç°è°ƒç”¨é‰´æƒï¼›</li>
<li>å†…ç½®å¥åº·æ£€æŸ¥ä¸é…ç½®çƒ­æ›´æ–°æœºåˆ¶ï¼Œä¿éšœæœåŠ¡ç¨³å®šæ€§ã€‚</li>
</ul>
<blockquote>
<p>âœ… ä»·å€¼ï¼šåœ¨å®‰å…¨éš”ç¦»çš„å‰æä¸‹ï¼Œèµ‹äºˆå®¹å™¨å†…æ„å»ºä¸è¿è¡Œ Docker çš„èƒ½åŠ›ï¼Œé€‚ç”¨äº CI/CDã€å¼€å‘ç¯å¢ƒã€æ¨¡å‹è®­ç»ƒç­‰åœºæ™¯ã€‚</p>
</blockquote>
<hr>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>æœ¬æ–¹æ¡ˆé€šè¿‡æ·±åº¦é›†æˆ Containerd ä¸ Kubernetesï¼Œå®ç°äº†ä¸‰å¤§æ ¸å¿ƒèƒ½åŠ›ï¼š</p>
<ol>
<li><strong>æ ‡å‡†åŒ–è¿è¡Œæ—¶æ‰©å±•</strong> â€”â€” åŸºäº Proxy Plugin æœºåˆ¶ï¼Œéä¾µå…¥å¼å¢å¼ºå®¹å™¨è¡Œä¸ºï¼›</li>
<li><strong>äº‘åŸç”Ÿå­˜å‚¨è¿ç§»</strong> â€”â€” å£°æ˜å¼è§¦å‘ + CRD ç®¡ç†ï¼Œå®ç°å®¹å™¨çŠ¶æ€æŒä¹…åŒ–ï¼›</li>
<li><strong>å®‰å…¨ DinD æ¶æ„</strong> â€”â€”  å‘½åç©ºé—´å…±äº«ï¼Œå…¼é¡¾åŠŸèƒ½å®Œæ•´ä¸èµ„æºéš”ç¦»ã€‚</li>
</ol>
<p>è¯¥æ¶æ„å…·å¤‡è‰¯å¥½çš„å¯ç§»æ¤æ€§ä¸æ‰©å±•æ€§ï¼Œå¯ä½œä¸ºä¼ä¸šçº§å®¹å™¨å¹³å°å¢å¼ºè¿è¡Œæ—¶èƒ½åŠ›çš„å‚è€ƒå®ç°ã€‚</p>
<h1>åŸºäº Containerd Snapshotter æ¥å£çš„å®¹å™¨é•œåƒæ“ä½œå¢å¼ºæœºåˆ¶</h1>
<p>åœ¨å®¹å™¨è¿è¡Œæ—¶æ‰©å±•åœºæ™¯ä¸­ï¼Œé€šè¿‡ <strong>Wrapper æ¨¡å¼å°è£…åŸç”Ÿ Snapshotter</strong>ï¼Œå¯å®ç°å¯¹å®¹å™¨é•œåƒç”Ÿå‘½å‘¨æœŸæ“ä½œçš„é€æ˜æ‹¦æˆªä¸å¢å¼ºå¤„ç†ã€‚ä»¥ä¸‹ä»æ¶æ„è®¾è®¡ã€æ“ä½œæµç¨‹ã€å…³é”®å®ç°ä¸é›†æˆæ–¹å¼å››ä¸ªç»´åº¦ï¼Œè¯¦ç»†è§£æè¯¥æŠ€æœ¯æ–¹æ¡ˆã€‚</p>
<hr>
<h2 id="ä¸€ã€Wrapper-æ¨¡å¼æ¶æ„ï¼šéä¾µå…¥å¼æ‰©å±•">ä¸€ã€Wrapper æ¨¡å¼æ¶æ„ï¼šéä¾µå…¥å¼æ‰©å±•</h2>
<p>é¡¹ç›®é‡‡ç”¨æ ‡å‡†çš„ <strong>Wrapper è®¾è®¡æ¨¡å¼</strong>ï¼Œå¯¹ Containerd åŸç”Ÿçš„ OverlayFS Snapshotter è¿›è¡Œå°è£…ï¼Œé€šè¿‡ <code>pre</code> / <code>post</code> é’©å­å‡½æ•°å®ç°æ“ä½œæ‹¦æˆªï¼Œæ— éœ€ä¿®æ”¹åº•å±‚å®ç°ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¤ºä¾‹ï¼šå°è£… Prepare æ¥å£ï¼Œæ”¯æŒè‡ªå®šä¹‰é‡å†™é€»è¾‘</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *WrappedSnapshotter)</span></span> Prepare(ctx context.Context, req *api.PrepareSnapshotRequest) (*api.PrepareSnapshotResponse, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> s.prepareRewriteFn != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> s.prepareRewriteFn(ctx, s.parent, req)  <span class="comment">// è‡ªå®šä¹‰é¢„å¤„ç†</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s.parent.Prepare(ctx, req)  <span class="comment">// é»˜è®¤è°ƒç”¨åŸç”Ÿé€»è¾‘</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>âœ… <strong>ä¼˜åŠ¿</strong>ï¼š</p>
<ul>
<li>ä¿æŒä¸åŸç”Ÿ Snapshotter çš„å®Œå…¨å…¼å®¹ï¼›</li>
<li>æ”¯æŒçµæ´»æ³¨å…¥è‡ªå®šä¹‰è¡Œä¸ºï¼ˆå¦‚æ—¥å¿—ã€ç¼“å­˜ã€å¤‡ä»½ã€æ¢å¤ç­‰ï¼‰ï¼›</li>
<li>æ˜“äºç»´æŠ¤ä¸å‡çº§ï¼Œä¸ç»‘å®šç‰¹å®šåº•å±‚å®ç°ã€‚</li>
</ul>
<hr>
<h2 id="äºŒã€æ ‡å‡†åŒ–æ“ä½œæ‹¦æˆªæµç¨‹">äºŒã€æ ‡å‡†åŒ–æ“ä½œæ‹¦æˆªæµç¨‹</h2>
<p>æ‰€æœ‰ Snapshotter æ“ä½œå‡éµå¾ªç»Ÿä¸€çš„ <strong>ä¸‰é˜¶æ®µå¤„ç†æµç¨‹</strong>ï¼š<strong>Pre â†’ Execute â†’ Post</strong>ï¼Œç¡®ä¿æ‰©å±•é€»è¾‘å¯é¢„æµ‹ã€å¯æ’æ‹”ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *OperationRewriter)</span></span> do(ctx context.Context, s api.SnapshotsServer, req Request) (Response, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> err := r.pre(ctx, req); err != <span class="literal">nil</span> &#123;      <span class="comment">// é¢„å¤„ç†ï¼ˆå¦‚æƒé™æ ¡éªŒã€æ—¥å¿—è®°å½•ï¼‰</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    resp, execErr := s.Execute(ctx, req)         <span class="comment">// æ‰§è¡ŒåŸç”Ÿæ“ä½œ</span></span><br><span class="line">    <span class="keyword">if</span> execErr != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> resp, execErr</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err := r.post(ctx, req, resp, execErr); err != <span class="literal">nil</span> &#123;  <span class="comment">// åå¤„ç†ï¼ˆå¦‚çŠ¶æ€æ›´æ–°ã€è§¦å‘å¤‡ä»½ï¼‰</span></span><br><span class="line">        <span class="keyword">return</span> resp, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> resp, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>âœ… <strong>ä»·å€¼</strong>ï¼š</p>
<ul>
<li>å®ç°æ“ä½œå‰åçŠ¶æ€æ„ŸçŸ¥ï¼›</li>
<li>æ”¯æŒå¼‚æ­¥ã€éé˜»å¡æ‰©å±•é€»è¾‘ï¼›</li>
<li>ä¾¿äºç»Ÿä¸€é”™è¯¯å¤„ç†ä¸å®¡è®¡è¿½è¸ªã€‚</li>
</ul>
<hr>
<h2 id="ä¸‰ã€å…³é”®æ“ä½œçš„å…·ä½“å¢å¼ºå®ç°">ä¸‰ã€å…³é”®æ“ä½œçš„å…·ä½“å¢å¼ºå®ç°</h2>
<h3 id="1-Prepareï¼ˆå®¹å™¨å‡†å¤‡é˜¶æ®µï¼‰">1. Prepareï¼ˆå®¹å™¨å‡†å¤‡é˜¶æ®µï¼‰</h3>
<ul>
<li><strong>PrePrepare</strong>ï¼šåˆå§‹åŒ–ä¸Šä¸‹æ–‡ã€è®°å½•æ“ä½œæ—¥å¿—ï¼›</li>
<li><strong>PostPrepare</strong>ï¼š
<ul>
<li>è§£ææŒ‚è½½å‚æ•°ä¸­çš„ <code>upperdir</code> è·¯å¾„ï¼Œå®šä½å®¹å™¨å¯å†™å±‚ï¼›</li>
<li>åˆ›å»ºå®¹å™¨å…ƒæ•°æ®ç¼“å­˜ï¼Œè®°å½•å®¹å™¨ ID ä¸å­˜å‚¨è·¯å¾„æ˜ å°„ï¼›</li>
<li>è‹¥æ£€æµ‹åˆ°éœ€æ¢å¤çŠ¶æ€ï¼ˆå¦‚ä»äº‘ç«¯æ‹‰å–ï¼‰ï¼Œè§¦å‘å¼‚æ­¥æ¢å¤æµç¨‹ã€‚</li>
</ul>
</li>
</ul>
<h3 id="2-Mountsï¼ˆæŒ‚è½½è®¿é—®é˜¶æ®µï¼‰">2. Mountsï¼ˆæŒ‚è½½è®¿é—®é˜¶æ®µï¼‰</h3>
<ul>
<li><strong>PostMounts</strong>ï¼š
<ul>
<li>åˆå§‹åŒ–å®¹å™¨è¿è¡Œæ—¶ä¸Šä¸‹æ–‡ï¼›</li>
<li>æ ¹æ®ç­–ç•¥åˆ¤æ–­æ˜¯å¦éœ€ä»è¿œç¨‹å­˜å‚¨æ¢å¤ RootFSï¼ˆå¦‚å†·å¯åŠ¨åœºæ™¯ï¼‰ï¼›</li>
<li>æŒ‚è½½å®Œæˆåæ›´æ–°å®¹å™¨çŠ¶æ€ä¸ºâ€œå·²å°±ç»ªâ€ã€‚</li>
</ul>
</li>
</ul>
<h3 id="3-Removeï¼ˆå¿«ç…§åˆ é™¤é˜¶æ®µï¼‰">3. Removeï¼ˆå¿«ç…§åˆ é™¤é˜¶æ®µï¼‰</h3>
<ul>
<li><strong>PreRemove</strong>ï¼š
<ul>
<li>è§¦å‘å®¹å™¨çŠ¶æ€æŒä¹…åŒ–ï¼šè°ƒç”¨ Backup Manager å°† RootFS æ‰“åŒ…ä¸Šä¼ è‡³äº‘ç«¯å­˜å‚¨ï¼›</li>
<li>æ”¯æŒå¤±è´¥é‡è¯•ä¸çŠ¶æ€æ ‡è®°ï¼ˆå¦‚â€œå¤‡ä»½ä¸­â€ã€â€œå¤‡ä»½å¤±è´¥â€ï¼‰ï¼›</li>
</ul>
</li>
<li><strong>PostRemove</strong>ï¼š
<ul>
<li>æ¸…ç†æœ¬åœ°ç¼“å­˜å…ƒæ•°æ®ï¼›</li>
<li>é‡Šæ”¾å…³è”èµ„æºï¼ˆå¦‚ç½‘ç»œã€è®¾å¤‡å¥æŸ„ç­‰ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<blockquote>
<p>ğŸ“Œ ç¤ºä¾‹ï¼šåœ¨ Remove å‰è‡ªåŠ¨è§¦å‘å¤‡ä»½</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *SnapshotHandler)</span></span> OnRemove(ctx context.Context, key <span class="type">string</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> shouldBackup(key) &#123;</span><br><span class="line">        <span class="keyword">if</span> err := backupManager.TriggerBackup(ctx, containerID); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            log.WithError(err).Error(<span class="string">&quot;Backup failed before snapshot removal&quot;</span>)</span><br><span class="line">            <span class="comment">// å¯é€‰ï¼šé˜»å¡åˆ é™¤ or æ ‡è®°çŠ¶æ€ä¾›åç»­è¡¥å¿</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="å››ã€å®¹å™¨ç”Ÿå‘½å‘¨æœŸå…ƒæ•°æ®ç®¡ç†">å››ã€å®¹å™¨ç”Ÿå‘½å‘¨æœŸå…ƒæ•°æ®ç®¡ç†</h2>
<p>é€šè¿‡è½»é‡çº§ç¼“å­˜å±‚ç®¡ç†å®¹å™¨è¿è¡Œæ—¶çŠ¶æ€ï¼Œå…³é”®å‡½æ•°åŒ…æ‹¬ï¼š</p>
<h3 id="â–¶-InitSnapshotMounts">â–¶ InitSnapshotMounts</h3>
<ul>
<li>ä» <code>mount.Options</code> ä¸­æå– <code>upperdir</code> è·¯å¾„ï¼›</li>
<li>å»ºç«‹å®¹å™¨ ID â†’ å­˜å‚¨è·¯å¾„ â†’ çŠ¶æ€ çš„æ˜ å°„å…³ç³»ï¼›</li>
<li>æ”¯æŒå¤šå®¹å™¨å¹¶å‘åˆå§‹åŒ–ï¼Œçº¿ç¨‹å®‰å…¨ã€‚</li>
</ul>
<h3 id="â–¶-OnMounts">â–¶ OnMounts</h3>
<ul>
<li>æ£€æŸ¥å®¹å™¨æ˜¯å¦éœ€ä»äº‘ç«¯æ¢å¤ RootFSï¼›</li>
<li>å¦‚éœ€æ¢å¤ï¼Œå¼‚æ­¥æ‹‰å–å¹¶è§£å‹è‡³æŒ‡å®šè·¯å¾„ï¼›</li>
<li>æ›´æ–°å®¹å™¨çŠ¶æ€ä¸ºâ€œæ¢å¤å®Œæˆâ€ï¼Œå…è®¸åç»­å¯åŠ¨ã€‚</li>
</ul>
<h3 id="â–¶-OnRemove-Clear">â–¶ OnRemove + Clear</h3>
<ul>
<li>åˆ é™¤å‰è§¦å‘å¤‡ä»½ï¼ˆå¯é…ç½®ç­–ç•¥ï¼‰ï¼›</li>
<li>åˆ é™¤åæ¸…ç†ç¼“å­˜ï¼Œé¿å…å†…å­˜æ³„æ¼ï¼›</li>
<li>æ”¯æŒäº‹ä»¶é€šçŸ¥ï¼ˆå¦‚ Prometheus æŒ‡æ ‡æ›´æ–°ã€å®¡è®¡æ—¥å¿—ï¼‰ã€‚</li>
</ul>
<hr>
<h2 id="äº”ã€ä¸-Containerd-çš„é›†æˆæ–¹å¼">äº”ã€ä¸ Containerd çš„é›†æˆæ–¹å¼</h2>
<ol>
<li>
<p><strong>Proxy Plugin æœºåˆ¶</strong><br>
é€šè¿‡ Unix Domain Socket æš´éœ² Snapshotter gRPC æœåŠ¡ï¼ŒContainerd é€šè¿‡æ’ä»¶é…ç½®åŠ¨æ€åŠ è½½ã€‚</p>
</li>
<li>
<p><strong>å®Œæ•´æ¥å£å®ç°</strong><br>
å®ç° <code>api.SnapshotsServer</code> æ‰€æœ‰æ–¹æ³•ï¼Œç¡®ä¿åè®®å…¼å®¹æ€§ã€‚</p>
</li>
<li>
<p><strong>æ“ä½œé€ä¼  + å¢å¼º</strong><br>
é»˜è®¤è°ƒç”¨åŸç”Ÿ OverlayFS Snapshotterï¼Œä»…åœ¨ç‰¹å®š Hook æ³¨å…¥è‡ªå®šä¹‰é€»è¾‘ã€‚</p>
</li>
<li>
<p><strong>å¼‚æ­¥éé˜»å¡è®¾è®¡</strong><br>
è€—æ—¶æ“ä½œï¼ˆå¦‚å¤‡ä»½ã€æ¢å¤ï¼‰é€šè¿‡ Goroutine å¼‚æ­¥æ‰§è¡Œï¼Œé¿å…é˜»å¡å®¹å™¨å¯åŠ¨æµç¨‹ã€‚</p>
</li>
</ol>
<hr>
<h2 id="âœ…-æ–¹æ¡ˆä»·å€¼æ€»ç»“">âœ… æ–¹æ¡ˆä»·å€¼æ€»ç»“</h2>
<table>
<thead>
<tr>
<th>èƒ½åŠ›ç»´åº¦</th>
<th>å®ç°æ•ˆæœ</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>æ— ç¼é›†æˆ</strong></td>
<td>æ— éœ€ä¿®æ”¹ Containerd æ ¸å¿ƒï¼Œé€šè¿‡æ ‡å‡†æ’ä»¶æœºåˆ¶æ¥å…¥</td>
</tr>
<tr>
<td><strong>é€æ˜å¢å¼º</strong></td>
<td>å¯¹ä¸Šå±‚ï¼ˆå¦‚ Kubernetesã€CRIï¼‰å®Œå…¨é€æ˜ï¼Œæ— æ„ŸçŸ¥ä½¿ç”¨å¢å¼ºåŠŸèƒ½</td>
</tr>
<tr>
<td><strong>çŠ¶æ€æŒä¹…åŒ–</strong></td>
<td>å®¹å™¨åˆ é™¤å‰è‡ªåŠ¨å¤‡ä»½ RootFS è‡³äº‘ç«¯ï¼Œæ”¯æŒè·¨èŠ‚ç‚¹æ¢å¤</td>
</tr>
<tr>
<td><strong>ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥</strong></td>
<td>é€šè¿‡ Hook æœºåˆ¶ç²¾ç¡®æ•è· Prepare/Mount/Remove äº‹ä»¶ï¼Œå®ç°ç²¾ç»†åŒ–æ§åˆ¶</td>
</tr>
<tr>
<td><strong>å¯æ‰©å±•æ€§</strong></td>
<td>æ‰€æœ‰æ“ä½œæ”¯æŒæ’ä»¶åŒ– Hookï¼Œä¾¿äºåç»­æ‰©å±•å®¡è®¡ã€åŠ å¯†ã€å‹ç¼©ã€ç­–ç•¥è·¯ç”±ç­‰åŠŸèƒ½</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="ğŸ§©-é€‚ç”¨åœºæ™¯">ğŸ§© é€‚ç”¨åœºæ™¯</h2>
<ul>
<li>æœ‰çŠ¶æ€å®¹å™¨çš„äº‘åŸç”Ÿå­˜å‚¨è¿ç§»ï¼›</li>
<li>å®¹å™¨ç¯å¢ƒå¿«é€Ÿå¤ç°ä¸è°ƒè¯•ï¼ˆå¦‚ CI/CDã€è®­ç»ƒä»»åŠ¡ï¼‰ï¼›</li>
<li>å®‰å…¨åˆè§„åœºæ™¯ä¸‹çš„æ“ä½œå®¡è®¡ä¸æ•°æ®ç•™å­˜ï¼›</li>
<li>è¾¹ç¼˜è®¡ç®—ä¸­å®¹å™¨çŠ¶æ€çš„äº‘ç«¯åŒæ­¥ä¸æ¢å¤ã€‚</li>
</ul>
<h1>dindè¿™éƒ¨åˆ†</h1>
<p>dindå®¹å™¨ä¸­æœ‰dockerå®ˆæŠ¤è¿›ç¨‹</p>
<p>æ„å»ºåŸºç¡€Dindé•œåƒæ—¶ï¼Œä¸‹è½½ç‰¹å®šç‰ˆæœ¬çš„DockeräºŒè¿›åˆ¶æ–‡ä»¶</p>
<p>dindå®¹å™¨çš„ç½‘ç»œå‘½åç©ºé—´æ˜¯è·Ÿmainå®¹å™¨ä¸€æ ·çš„</p>
<p>dindå®¹å™¨ä¸­æ‰§è¡Œdockerå‘½ä»¤çš„æŠ€æœ¯åŸç†å’Œé€»è¾‘é“¾è·¯ï¼š</p>
<h2 id="æ ¸å¿ƒæŠ€æœ¯">æ ¸å¿ƒæŠ€æœ¯</h2>
<ol>
<li><strong>Docker-in-Docker (DinD) æŠ€æœ¯</strong>: ä½¿ç”¨ç‰¹æƒå®¹å™¨è¿è¡ŒDockerå®ˆæŠ¤è¿›ç¨‹</li>
<li><strong>Containerdç®¡ç†</strong>: é€šè¿‡containerd APIåˆ›å»ºå’Œç®¡ç†å®¹å™¨</li>
<li><strong>ç½‘ç»œå…±äº«</strong>: ä½¿ç”¨<code>container:&lt;main_container_id&gt;</code>ç½‘ç»œæ¨¡å¼å…±äº«ç½‘ç»œå‘½åç©ºé—´</li>
<li><strong>æ–‡ä»¶ç³»ç»Ÿæ˜ å°„</strong>: é€šè¿‡bind mountå°†ä¸»å®¹å™¨çš„rootfsæ˜ å°„åˆ°dindå®¹å™¨ä¸­</li>
<li><strong>è¯·æ±‚åŠ«æŒ(Hijack)</strong>: æ‹¦æˆªå’Œä¿®æ”¹Docker APIè¯·æ±‚</li>
</ol>
<h2 id="é€»è¾‘é“¾è·¯">é€»è¾‘é“¾è·¯</h2>
<h3 id="1-dindå®¹å™¨åˆ›å»ºæµç¨‹">1. dindå®¹å™¨åˆ›å»ºæµç¨‹</h3>
<ul>
<li><strong>æƒé™éªŒè¯</strong>: æ£€æŸ¥Podæ³¨è§£ <a target="_blank" rel="noopener" href="http://k8s.io/dind=%22enabled%22">k8s.io/dind=â€œenabledâ€</a></li>
<li><strong>å®¹å™¨åˆ›å»º</strong>: ä½¿ç”¨nerdctlåˆ›å»ºç‰¹æƒdindå®¹å™¨</li>
<li><strong>ç½‘ç»œé…ç½®</strong>: ä½¿ç”¨<code>container:&lt;main_id&gt;</code>å…±äº«ç½‘ç»œå‘½åç©ºé—´</li>
<li><strong>æ–‡ä»¶ç³»ç»Ÿæ˜ å°„</strong>: å°†ä¸»å®¹å™¨rootfsæŒ‚è½½åˆ°dindå®¹å™¨çš„<code>/mainroot</code>ç›®å½•</li>
<li><strong>å®‰å…¨é…ç½®</strong>: è®¾ç½®seccomp=unconfined, apparmor=unconfinedç­‰å®‰å…¨é€‰é¡¹</li>
</ul>
<h3 id="2-Dockerå‘½ä»¤æ‰§è¡Œæµç¨‹">2. Dockerå‘½ä»¤æ‰§è¡Œæµç¨‹</h3>
<ul>
<li><strong>APIä»£ç†</strong>: Ginæ¡†æ¶æ¥æ”¶Docker APIè¯·æ±‚</li>
<li><strong>è¯·æ±‚åŠ«æŒ</strong>: æ‹¦æˆªcreate/update/execè¯·æ±‚å¹¶ä¿®æ”¹é…ç½®</li>
<li><strong>è·¯å¾„é‡å†™</strong>: å°†ä¸»æœºè·¯å¾„é‡å†™ä¸ºå®¹å™¨å†…è·¯å¾„ (å¦‚ <code>/host/path</code> â†’ <code>/mainroot/host/path</code>)</li>
<li><strong>åå‘ä»£ç†</strong>: å°†ä¿®æ”¹åçš„è¯·æ±‚è½¬å‘åˆ°çœŸæ­£çš„Dockerå®ˆæŠ¤è¿›ç¨‹socket</li>
</ul>
<h3 id="3-å…³é”®æŠ€æœ¯ç‚¹">3. å…³é”®æŠ€æœ¯ç‚¹</h3>
<p><strong>ç½‘ç»œéš”ç¦»çªç ´</strong>:</p>
<ul>
<li>dindå®¹å™¨ä½¿ç”¨<code>--network=container:&lt;main_id&gt;</code>å¯åŠ¨ï¼Œå…±äº«ä¸»å®¹å™¨çš„ç½‘ç»œå‘½åç©ºé—´</li>
<li>è¿™ä½¿å¾—dindå®¹å™¨ä¸­çš„Dockerå®ˆæŠ¤è¿›ç¨‹èƒ½å¤Ÿè®¿é—®ä¸»å®¹å™¨çš„ç½‘ç»œç¯å¢ƒ</li>
</ul>
<p><strong>æ–‡ä»¶ç³»ç»Ÿè®¿é—®</strong>:</p>
<ul>
<li>ä¸»å®¹å™¨çš„rootfsé€šè¿‡bind mountæŒ‚è½½åˆ°dindå®¹å™¨çš„<code>/mainroot</code>ç›®å½•</li>
<li>Docker volumeå’Œbind mountçš„æºè·¯å¾„ä¼šè¢«é‡å†™ä¸ºå®¹å™¨å†…è·¯å¾„</li>
</ul>
<p><strong>å®‰å…¨é™åˆ¶</strong>:</p>
<ul>
<li>ç¦æ­¢privilegedæ¨¡å¼ã€capabilitiesä¿®æ”¹ç­‰å±é™©æ“ä½œ</li>
<li>éªŒè¯æŒ‚è½½ç›®æ ‡è·¯å¾„çš„åˆæ³•æ€§ï¼Œé˜²æ­¢è·¯å¾„éå†æ”»å‡»</li>
</ul>
<p><strong>å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†</strong>:</p>
<ul>
<li>é€šè¿‡containerdäº‹ä»¶ç›‘å¬è‡ªåŠ¨ç®¡ç†dindå®¹å™¨çš„åˆ›å»ºå’Œæ¸…ç†</li>
<li>ä¸»å®¹å™¨åˆ é™¤æ—¶è‡ªåŠ¨æ¸…ç†å¯¹åº”çš„dindå®¹å™¨</li>
</ul>
<h2 id="æ‰§è¡Œæµç¨‹ç¤ºä¾‹">æ‰§è¡Œæµç¨‹ç¤ºä¾‹</h2>
<ol>
<li>ç”¨æˆ·åœ¨Podä¸­æ‰§è¡Œ<code>docker run</code>å‘½ä»¤</li>
<li>Docker clientè¿æ¥åˆ°<code>/mainroot/run/docker.sock</code> (è¢«dind serveråŠ«æŒ)</li>
<li>dind serverä¿®æ”¹è¯·æ±‚é…ç½®ï¼ˆè·¯å¾„é‡å†™ã€å®‰å…¨éªŒè¯ï¼‰</li>
<li>è¯·æ±‚è¢«è½¬å‘åˆ°çœŸæ­£çš„Dockerå®ˆæŠ¤è¿›ç¨‹(/run/docker.sock)</li>
<li>Dockerå®ˆæŠ¤è¿›ç¨‹åœ¨dindå®¹å™¨ä¸­åˆ›å»ºç›®æ ‡å®¹å™¨</li>
<li>dindå®¹å™¨ä¸ä¸»å®¹å™¨å…±äº«ç½‘ç»œå‘½åç©ºé—´</li>
</ol>
<p>è¿™ç§è®¾è®¡ä½¿å¾—åœ¨Kubernetes Podä¸­å®‰å…¨åœ°è¿è¡ŒDockerå‘½ä»¤æˆä¸ºå¯èƒ½ï¼ŒåŒæ—¶ä¿æŒäº†è‰¯å¥½çš„éš”ç¦»æ€§å’Œå®‰å…¨æ€§ã€‚</p>
<h2 id="dindå®¹å™¨ç½‘ç»œé…ç½®çš„å…·ä½“å®ç°">dindå®¹å™¨ç½‘ç»œé…ç½®çš„å…·ä½“å®ç°</h2>
<p>åœ¨ <a href="pkg/dind/controller/create_helpers.go:198-203"><code>pkg/dind/controller/create_helpers.go</code></a> ä¸­ï¼Œç½‘ç»œé…ç½®çš„å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DindContainerNetworkOptions</span><span class="params">(mainID apis.ContainerID, hostname <span class="type">string</span>)</span></span> types.NetworkOptions &#123;</span><br><span class="line">    <span class="keyword">return</span> types.NetworkOptions&#123;</span><br><span class="line">        NetworkSlice: []<span class="type">string</span>&#123;<span class="string">&quot;container:&quot;</span> + mainID.String()&#125;,</span><br><span class="line">        Hostname:     hostname,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç½‘ç»œé…ç½®æµç¨‹">ç½‘ç»œé…ç½®æµç¨‹</h3>
<ol>
<li>
<p><strong>ç½‘ç»œé€‰é¡¹åˆ›å»º</strong> (<a href="pkg/dind/controller/dind_manager.go:186"><code>pkg/dind/controller/dind_manager.go</code></a>)</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">networkOptions := DindContainerNetworkOptions(apis.ContainerID(mainContainer.ID()), mainSpec.Hostname)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>ç½‘ç»œç®¡ç†å™¨åˆ›å»º</strong> (<a href="pkg/dind/controller/dind_manager.go:187"><code>pkg/dind/controller/dind_manager.go</code></a>)</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netManager, err := containerutil.NewNetworkingOptionsManager(createOptions.GOptions, networkOptions, client)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>å®¹å™¨åˆ›å»º</strong> (<a href="pkg/dind/controller/dind_manager.go:197"><code>pkg/dind/controller/dind_manager.go</code></a>)</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c, gc, err := container.Create(ctx, client, args, netManager, createOptions)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="æŠ€æœ¯ç»†èŠ‚">æŠ€æœ¯ç»†èŠ‚</h3>
<p><strong><code>container:&lt;main_id&gt;</code> ç½‘ç»œæ¨¡å¼</strong>:</p>
<ul>
<li>è¿™æ˜¯Dockerçš„å®¹å™¨ç½‘ç»œæ¨¡å¼ï¼Œå…è®¸ä¸€ä¸ªå®¹å™¨å…±äº«å¦ä¸€ä¸ªå®¹å™¨çš„ç½‘ç»œå‘½åç©ºé—´</li>
<li>åœ¨nerdctl/containerdä¸­ï¼Œè¿™é€šè¿‡è®¾ç½® <code>NetworkSlice: []string&#123;&quot;container:&quot; + mainID.String()&#125;</code> å®ç°</li>
</ul>
<p><strong>ç½‘ç»œå‘½åç©ºé—´å…±äº«</strong>:</p>
<ul>
<li>dindå®¹å™¨å¯åŠ¨æ—¶ä¼šä½¿ç”¨ä¸»å®¹å™¨çš„ç½‘ç»œå‘½åç©ºé—´</li>
<li>è¿™ä½¿å¾—dindå®¹å™¨ä¸­çš„Dockerå®ˆæŠ¤è¿›ç¨‹èƒ½å¤Ÿçœ‹åˆ°å’Œè®¿é—®ä¸»å®¹å™¨çš„ç½‘ç»œç¯å¢ƒ</li>
<li>æ‰€æœ‰ç½‘ç»œæ¥å£ã€è·¯ç”±ã€iptablesè§„åˆ™ç­‰éƒ½ä¼šè¢«å…±äº«</li>
</ul>
<p><strong>å®é™…æ‰§è¡Œæ•ˆæœ</strong>:<br>
ç›¸å½“äºæ‰§è¡Œäº†ç±»ä¼¼è¿™æ ·çš„dockerå‘½ä»¤ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --network=container:&lt;main_container_id&gt; --name dind-&lt;main_id_prefix&gt; ...</span><br></pre></td></tr></table></figure>
<h3 id="éªŒè¯é€»è¾‘">éªŒè¯é€»è¾‘</h3>
<p>è¿˜æœ‰ç½‘ç»œæ¨¡å¼çš„éªŒè¯é€»è¾‘ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> config.HostConfig.NetworkMode.IsBridge() &#123;</span><br><span class="line">    <span class="keyword">return</span> ErrBridgeNetworkNotSupported</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ç¡®ä¿äº†åœ¨dindç¯å¢ƒä¸­åªèƒ½ä½¿ç”¨å®¹å™¨ç½‘ç»œæ¨¡å¼ï¼Œä¸èƒ½ä½¿ç”¨bridgeç­‰å…¶ä»–ç½‘ç»œæ¨¡å¼ã€‚</p>
<p>è¿™ç§ç½‘ç»œé…ç½®ä½¿å¾—dindå®¹å™¨èƒ½å¤Ÿå®Œå…¨å…±äº«ä¸»å®¹å™¨çš„ç½‘ç»œç¯å¢ƒï¼Œä¸ºåœ¨å®¹å™¨å†…è¿è¡ŒDockerå‘½ä»¤æä¾›äº†å¿…è¦çš„ç½‘ç»œéš”ç¦»çªç ´ã€‚</p>
<h2 id="Dockerå‘½ä»¤åŠ«æŒçš„é€»è¾‘">Dockerå‘½ä»¤åŠ«æŒçš„é€»è¾‘</h2>
<p>Dockerå‘½ä»¤èƒ½å¤Ÿè¢«åŠ«æŒçš„æ ¸å¿ƒé€»è¾‘åœ¨äº<strong>socketé‡å®šå‘å’ŒAPIè¯·æ±‚æ‹¦æˆª</strong>ï¼Œå…·ä½“å®ç°å¦‚ä¸‹ï¼š</p>
<h3 id="1-Socketé‡å®šå‘æœºåˆ¶">1. Socketé‡å®šå‘æœºåˆ¶</h3>
<p>åœ¨dindå®¹å™¨ä¸­ï¼ŒDockerå®ˆæŠ¤è¿›ç¨‹ç›‘å¬çš„æ˜¯çœŸæ­£çš„ <code>/run/docker.sock</code>ï¼Œä½†æ˜¯ï¼š</p>
<p><strong>å®¢æˆ·ç«¯è¿æ¥è·¯å¾„</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">address := <span class="string">&quot;/mainroot/run/docker.sock&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong>æœåŠ¡ç«¯ä»£ç†è·¯å¾„</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dockerSocket := <span class="string">&quot;/run/docker.sock&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="2-åå‘ä»£ç†åŠ«æŒï¼š">2. åå‘ä»£ç†åŠ«æŒï¼š</h3>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">r.Any(<span class="string">&quot;*path&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 1. æ‰¾åˆ°çœŸæ­£çš„docker socket</span></span><br><span class="line">    _ = s.findDockerSocket()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. è¯·æ±‚åŠ«æŒ - å…³é”®æ­¥éª¤ï¼</span></span><br><span class="line">    <span class="keyword">if</span> err := HijackRequest(c.Request); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        c.String(http.StatusBadRequest, <span class="string">&quot;%v&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. åˆ›å»ºåå‘ä»£ç†åˆ°çœŸæ­£çš„dockerå®ˆæŠ¤è¿›ç¨‹</span></span><br><span class="line">    proxy := &amp;httputil.ReverseProxy&#123;</span><br><span class="line">        Transport: &amp;http.Transport&#123;</span><br><span class="line">            DialContext: <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, network, addr <span class="type">string</span>)</span></span> (net.Conn, <span class="type">error</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> net.Dial(<span class="string">&quot;unix&quot;</span>, s.dockerSocket) <span class="comment">// è¿æ¥åˆ°çœŸæ­£çš„docker socket</span></span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        Director: <span class="function"><span class="keyword">func</span><span class="params">(req *http.Request)</span></span> &#123;</span><br><span class="line">            req.URL = u <span class="comment">// ä¿æŒåŸå§‹URLè·¯å¾„</span></span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    proxy.ServeHTTP(c.Writer, c.Request)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="3-è¯·æ±‚åŠ«æŒé€»è¾‘">3. è¯·æ±‚åŠ«æŒé€»è¾‘</h3>
<p><strong>åŠ«æŒç±»å‹è¯†åˆ«</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetHijackType</span><span class="params">(method <span class="type">string</span>, path <span class="type">string</span>)</span></span> HijackType &#123;</span><br><span class="line">    <span class="keyword">if</span> method == http.MethodPost &#123;</span><br><span class="line">        path = filepath.Clean(path)</span><br><span class="line">        path = strings.TrimPrefix(path, <span class="string">&quot;/&quot;</span>)</span><br><span class="line">        fields := strings.Split(path, <span class="string">&quot;/&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(fields) &lt; <span class="number">3</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> HijackNone</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> fields[<span class="number">1</span>] == <span class="string">&quot;containers&quot;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> fields[<span class="number">2</span>] == <span class="string">&quot;create&quot;</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> HijackCreate</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(fields) == <span class="number">4</span> &amp;&amp; fields[<span class="number">3</span>] == <span class="string">&quot;update&quot;</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> HijackUpdate</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(fields) == <span class="number">4</span> &amp;&amp; fields[<span class="number">3</span>] == <span class="string">&quot;exec&quot;</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> HijackExec</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> HijackNone</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-å…·ä½“åŠ«æŒæ“ä½œ">4. å…·ä½“åŠ«æŒæ“ä½œ</h3>
<p><strong>åˆ›å»ºè¯·æ±‚åŠ«æŒ</strong></p>
<ul>
<li>è·¯å¾„é‡å†™ï¼šå°†ä¸»æœºè·¯å¾„é‡å†™ä¸ºå®¹å™¨å†…è·¯å¾„ (<code>/host/path</code> â†’ <code>/mainroot/host/path</code>)</li>
<li>å®‰å…¨éªŒè¯ï¼šç¦æ­¢privilegedæ¨¡å¼ã€capabilitiesä¿®æ”¹ç­‰å±é™©æ“ä½œ</li>
<li>æŒ‚è½½ç‚¹éªŒè¯ï¼šç¡®ä¿æŒ‚è½½ç›®æ ‡è·¯å¾„çš„åˆæ³•æ€§</li>
</ul>
<p><strong>æ‰§è¡Œè¯·æ±‚åŠ«æŒ</strong> :</p>
<ul>
<li>éªŒè¯æ‰§è¡Œæƒé™å’Œå®‰å…¨è®¾ç½®</li>
</ul>
<h3 id="5-å®Œæ•´çš„åŠ«æŒæµç¨‹">5. å®Œæ•´çš„åŠ«æŒæµç¨‹</h3>
<ol>
<li><strong>å®¢æˆ·ç«¯è¿æ¥</strong>: Docker clientè¿æ¥åˆ° <code>/mainroot/run/docker.sock</code></li>
<li><strong>è¯·æ±‚æ‹¦æˆª</strong>: dind server (Ginæ¡†æ¶) æ¥æ”¶æ‰€æœ‰APIè¯·æ±‚</li>
<li><strong>è¯·æ±‚åˆ†æ</strong>: è¯†åˆ«éœ€è¦åŠ«æŒçš„è¯·æ±‚ç±»å‹ (create/update/exec)</li>
<li><strong>é…ç½®ä¿®æ”¹</strong>: é‡å†™è·¯å¾„ã€éªŒè¯å®‰å…¨è®¾ç½®ã€ä¿®æ”¹å®¹å™¨é…ç½®</li>
<li><strong>ä»£ç†è½¬å‘</strong>: å°†ä¿®æ”¹åçš„è¯·æ±‚è½¬å‘åˆ°çœŸæ­£çš„Dockerå®ˆæŠ¤è¿›ç¨‹</li>
<li><strong>å“åº”è¿”å›</strong>: å°†Dockerå®ˆæŠ¤è¿›ç¨‹çš„å“åº”è¿”å›ç»™å®¢æˆ·ç«¯</li>
</ol>
<h3 id="æŠ€æœ¯ä¼˜åŠ¿">æŠ€æœ¯ä¼˜åŠ¿</h3>
<p>è¿™ç§è®¾è®¡å®ç°äº†ï¼š</p>
<ul>
<li><strong>é€æ˜åŠ«æŒ</strong>: å®¢æˆ·ç«¯æ— æ„ŸçŸ¥ï¼Œä»ç„¶ä½¿ç”¨æ ‡å‡†Docker API</li>
<li><strong>å®‰å…¨æ§åˆ¶</strong>: åœ¨è½¬å‘å‰è¿›è¡Œå®‰å…¨éªŒè¯å’Œé…ç½®ä¿®æ”¹</li>
<li><strong>çµæ´»æ€§</strong>: å¯ä»¥æ ¹æ®éœ€è¦åŠ«æŒç‰¹å®šçš„APIç«¯ç‚¹</li>
<li><strong>æ€§èƒ½</strong>: åå‘ä»£ç†æ¨¡å¼å¼€é”€æå°</li>
</ul>
<p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆDockerå‘½ä»¤èƒ½å¤Ÿè¢«åŠ«æŒçš„æ ¸å¿ƒé€»è¾‘ - é€šè¿‡socketé‡å®šå‘å’ŒHTTP APIæ‹¦æˆªæ¥å®ç°é€æ˜çš„è¯·æ±‚ä¿®æ”¹å’Œè½¬å‘ã€‚</p>
<h2 id="é—®é¢˜1-çœŸæ­£çš„dockerd-socketä½ç½®">é—®é¢˜1: çœŸæ­£çš„dockerd socketä½ç½®</h2>
<p><strong>çœŸæ­£çš„Dockerå®ˆæŠ¤è¿›ç¨‹socketåœ¨dindå®¹å™¨ä¸­çš„ <code>/run/docker.sock</code>ã€‚</strong></p>
<p>çœŸæ­£çš„docker socketè·¯å¾„ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dockerSocket := <span class="string">&quot;/run/docker.sock&quot;</span></span><br></pre></td></tr></table></figure>
<p>åå‘ä»£ç†ç›´æ¥è¿æ¥åˆ°è¿™ä¸ªsocketï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> net.Dial(<span class="string">&quot;unix&quot;</span>, s.dockerSocket) <span class="comment">// è¿æ¥åˆ°çœŸæ­£çš„docker socket</span></span><br></pre></td></tr></table></figure>
<h2 id="é—®é¢˜2-ä¸ºä»€ä¹ˆèƒ½è®¿é—®-â€œ-mainroot-run-docker-sockâ€">é—®é¢˜2: ä¸ºä»€ä¹ˆèƒ½è®¿é—® â€œ/mainroot/run/docker.sockâ€</h2>
<p>è¿™æ˜¯å› ä¸º<strong>æ–‡ä»¶ç³»ç»Ÿæ˜ å°„å’Œsocketä»£ç†æœºåˆ¶</strong>ï¼š</p>
<h3 id="1-æ–‡ä»¶ç³»ç»Ÿæ˜ å°„">1. æ–‡ä»¶ç³»ç»Ÿæ˜ å°„</h3>
<p>åœ¨dindå®¹å™¨åˆ›å»ºæ—¶</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">createOptions.Volume = <span class="built_in">append</span>(createOptions.Volume,</span><br><span class="line">    fmt.Sprintf(<span class="string">&quot;%v:%v&quot;</span>, rootfsMount.Mountpoint, MAINROOT),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œ <code>MAINROOT = &quot;/mainroot&quot;</code>ï¼Œæ‰€ä»¥ä¸»å®¹å™¨çš„rootfsè¢«æŒ‚è½½åˆ°dindå®¹å™¨çš„ <code>/mainroot</code> ç›®å½•ã€‚</p>
<h3 id="2-Socketåˆ›å»ºæœºåˆ¶">2. Socketåˆ›å»ºæœºåˆ¶</h3>
<p>dind serverä¼šåœ¨ <code>/mainroot/run/docker.sock</code> åˆ›å»ºä¸€ä¸ªä»£ç†socketï¼š</p>
<p>åœ¨ <a href="pkg/dind/server/server.go:94-101"><code>pkg/dind/server/server.go</code></a>)ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">_ = os.RemoveAll(s.serveSocket)  <span class="comment">// æ¸…ç†æ—§çš„socket</span></span><br><span class="line"></span><br><span class="line">l, err := net.Listen(<span class="string">&quot;unix&quot;</span>, s.serveSocket)  <span class="comment">// åˆ›å»ºæ–°çš„socketç›‘å¬</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> os.Remove(s.serveSocket)</span><br><span class="line">_ = os.Chmod(s.serveSocket, <span class="number">0777</span>)  <span class="comment">// è®¾ç½®æƒé™</span></span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„ <code>s.serveSocket</code> å°±æ˜¯ <code>/mainroot/run/docker.sock</code></p>
<h3 id="3-å®Œæ•´çš„è®¿é—®è·¯å¾„">3. å®Œæ•´çš„è®¿é—®è·¯å¾„</h3>
<ol>
<li><strong>ä¸»å®¹å™¨ä¸­</strong>: ç”¨æˆ·æ‰§è¡Œ <code>docker -H unix:///run/docker.sock ...</code></li>
<li><strong>è·¯å¾„æ˜ å°„</strong>: <code>/run/docker.sock</code> (ä¸»å®¹å™¨) â†’ <code>/mainroot/run/docker.sock</code> (dindå®¹å™¨)</li>
<li><strong>socketä»£ç†</strong>: dind serverç›‘å¬åœ¨ <code>/mainroot/run/docker.sock</code></li>
<li><strong>è¯·æ±‚è½¬å‘</strong>: dind serverå°†è¯·æ±‚è½¬å‘åˆ°çœŸæ­£çš„ <code>/run/docker.sock</code> (dindå®¹å™¨å†…çš„çœŸå®docker socket)</li>
</ol>
<h3 id="æŠ€æœ¯å®ç°">æŠ€æœ¯å®ç°</h3>
<p>è¿™å®é™…ä¸Šæ˜¯ä¸€ä¸ª <strong>Unix socketä»£ç†</strong>ï¼š</p>
<ul>
<li>åœ¨ <code>/mainroot/run/docker.sock</code> åˆ›å»ºä¸€ä¸ªä»£ç†socket</li>
<li>æ‰€æœ‰è¿æ¥åˆ°è¿™ä¸ªsocketçš„è¯·æ±‚éƒ½è¢«dind serverå¤„ç†</li>
<li>dind serverè¿›è¡Œå®‰å…¨éªŒè¯å’Œè¯·æ±‚ä¿®æ”¹åï¼Œè½¬å‘åˆ°çœŸæ­£çš„docker socket</li>
<li>å“åº”å†é€šè¿‡ä»£ç†socketè¿”å›ç»™å®¢æˆ·ç«¯</li>
</ul>
<p>è¿™æ ·è®¾è®¡çš„å¥½å¤„æ˜¯ï¼š</p>
<ul>
<li><strong>å¯¹å®¢æˆ·ç«¯é€æ˜</strong>: ç”¨æˆ·ä»ç„¶ä½¿ç”¨æ ‡å‡†Dockerå‘½ä»¤è¡Œ</li>
<li><strong>å®‰å…¨æ§åˆ¶</strong>: å¯ä»¥åœ¨è½¬å‘å‰è¿›è¡Œå®‰å…¨éªŒè¯</li>
<li><strong>çµæ´»æ€§</strong>: å¯ä»¥åŠ«æŒå’Œä¿®æ”¹ç‰¹å®šçš„APIè¯·æ±‚</li>
</ul>
<p>æ‰€ä»¥æœ¬è´¨ä¸Šï¼Œ<code>/mainroot/run/docker.sock</code> æ˜¯ä¸€ä¸ªä»£ç†socketï¼Œè€Œ <code>/run/docker.sock</code> æ˜¯çœŸæ­£çš„Dockerå®ˆæŠ¤è¿›ç¨‹socketã€‚</p>
<p>dockerctlå‘½ä»¤èƒ½å¤Ÿè¢«dind managerè¯†åˆ«æ˜¯é€šè¿‡ä»¥ä¸‹æœºåˆ¶å®ç°çš„ï¼š</p>
<h2 id="1-gRPCé€šä¿¡æœºåˆ¶">1. gRPCé€šä¿¡æœºåˆ¶</h2>
<p>dockerctlå‘½ä»¤é€šè¿‡gRPCä¸dind managerè¿›è¡Œé€šä¿¡ï¼š</p>
<ul>
<li><strong>å®¢æˆ·ç«¯è¿æ¥</strong>: dockerctlé€šè¿‡ <a href="cmd/dind/dockerctl/commands/root.go:22"><code>getClient()</code></a> è¿æ¥åˆ°Unix socket <code>/run/aeon/container/container-service.sock</code></li>
<li><strong>è®¤è¯æœºåˆ¶</strong>: ä½¿ç”¨Podçš„service account tokenè¿›è¡Œè®¤è¯ <a href="cmd/dind/dockerctl/commands/root.go:31"><code>getTokenContent()</code></a></li>
</ul>
<h2 id="2-ServiceCallå¤„ç†æµç¨‹">2. ServiceCallå¤„ç†æµç¨‹</h2>
<h3 id="2-1-å‘½ä»¤æ‰§è¡Œæµç¨‹">2.1 å‘½ä»¤æ‰§è¡Œæµç¨‹</h3>
<ol>
<li><strong>ç”¨æˆ·æ‰§è¡Œå‘½ä»¤</strong>: å¦‚ <code>dockerctl start</code></li>
<li><strong>gRPCè°ƒç”¨</strong>: è°ƒç”¨ <a href="cmd/dind/dockerctl/commands/actions.go:22"><code>ServiceCall</code></a> æ–¹æ³•</li>
<li><strong>æœåŠ¡è¯†åˆ«</strong>: æŒ‡å®š <code>Service: &quot;docker&quot;</code> å’Œç›¸åº”çš„ <code>Action</code> (start/stop/restart/status/show-config)</li>
</ol>
<h3 id="2-2-æœåŠ¡ç«¯å¤„ç†">2.2 æœåŠ¡ç«¯å¤„ç†</h3>
<p>åœ¨agentçš„runtime serviceä¸­ï¼Œ<a href="pkg/agent/service_runtime.go:109"><code>ServiceCall</code></a> æ–¹æ³•å¤„ç†è¯·æ±‚ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&quot;docker&quot;</span>:</span><br><span class="line">    message, err := s.dc.DindCall(ctx, token, req.Action, req.Args)</span><br></pre></td></tr></table></figure>
<h3 id="2-3-dind-managerè¯†åˆ«">2.3 dind managerè¯†åˆ«</h3>
<p>dind controllerçš„ <a href="pkg/dind/controller/controller.go:114"><code>DindCall</code></a> æ–¹æ³•æ ¹æ®actionå‚æ•°è¿›è¡Œè¯†åˆ«ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> action &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;start&quot;</span>:</span><br><span class="line">    _, err := dc.dcm.CreateDindContainer(ctx, mainID)</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;stop&quot;</span>:</span><br><span class="line">    err := dc.dcm.ClearDindContainer(ctx, mainID)</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;restart&quot;</span>:</span><br><span class="line">    <span class="comment">// å…ˆstopå†start</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;status&quot;</span>:</span><br><span class="line">    tasks, mem, cpu, err := dc.dcm.GetDindStatus(ctx, mainID)</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;show-config&quot;</span>:</span><br><span class="line">    config, err := dc.dcm.GetDindConfig(ctx, mainID)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-æƒé™éªŒè¯æœºåˆ¶">3. æƒé™éªŒè¯æœºåˆ¶</h2>
<p>dind manageré€šè¿‡ä»¥ä¸‹æ–¹å¼éªŒè¯æƒé™ï¼š</p>
<ol>
<li><strong>TokenéªŒè¯</strong>: ä½¿ç”¨Kubernetes TokenReview APIéªŒè¯tokenæœ‰æ•ˆæ€§ <a href="pkg/dind/controller/controller.go:215"><code>getPodByToken()</code></a></li>
<li><strong>Podæ³¨è§£æ£€æŸ¥</strong>: æ£€æŸ¥Podæ˜¯å¦æœ‰ <code>mizar.k8s.io/dind: &quot;enabled&quot;</code> æ³¨è§£ <a href="pkg/dind/controller/utils.go:16"><code>judgeDindEnabled()</code></a></li>
<li><strong>å®¹å™¨IDæå–</strong>: ä»PodçŠ¶æ€ä¸­æå–ä¸»å®¹å™¨çš„container ID <a href="pkg/dind/controller/utils.go:23"><code>getMainIDFromPod()</code></a></li>
</ol>
<h2 id="4-å‘½ä»¤ä¸actionæ˜ å°„">4. å‘½ä»¤ä¸actionæ˜ å°„</h2>
<p>dockerctlå‘½ä»¤ä¸dind manager actionçš„æ˜ å°„å…³ç³»ï¼š</p>
<table>
<thead>
<tr>
<th>dockerctlå‘½ä»¤</th>
<th>dind manager action</th>
<th>åŠŸèƒ½æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>dockerctl start</code></td>
<td><code>&quot;start&quot;</code></td>
<td>åˆ›å»ºdindå®¹å™¨</td>
</tr>
<tr>
<td><code>dockerctl stop</code></td>
<td><code>&quot;stop&quot;</code></td>
<td>åœæ­¢å¹¶æ¸…ç†dindå®¹å™¨</td>
</tr>
<tr>
<td><code>dockerctl restart</code></td>
<td><code>&quot;restart&quot;</code></td>
<td>é‡å¯dindå®¹å™¨</td>
</tr>
<tr>
<td><code>dockerctl status</code></td>
<td><code>&quot;status&quot;</code></td>
<td>è·å–dindå®¹å™¨çŠ¶æ€</td>
</tr>
<tr>
<td><code>dockerctl show-config</code></td>
<td><code>&quot;show-config&quot;</code></td>
<td>æ˜¾ç¤ºdindé…ç½®</td>
</tr>
</tbody>
</table>
<h2 id="5-å®Œæ•´çš„è¯†åˆ«æµç¨‹">5. å®Œæ•´çš„è¯†åˆ«æµç¨‹</h2>
<ol>
<li><strong>å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚</strong>: dockerctlé€šè¿‡gRPCå‘é€ServiceRequest</li>
<li><strong>æœåŠ¡ç«¯æ¥æ”¶</strong>: runtime serviceçš„ServiceCallæ–¹æ³•æ¥æ”¶è¯·æ±‚</li>
<li><strong>æœåŠ¡ç±»å‹åˆ¤æ–­</strong>: æ£€æŸ¥ <code>req.Service == &quot;docker&quot;</code></li>
<li><strong>æƒé™éªŒè¯</strong>: éªŒè¯tokenå’ŒPodæ³¨è§£</li>
<li><strong>actionåˆ†å‘</strong>: æ ¹æ®actionå‚æ•°è°ƒç”¨ç›¸åº”çš„dind manageræ–¹æ³•</li>
<li><strong>ç»“æœè¿”å›</strong>: å°†æ‰§è¡Œç»“æœå°è£…æˆanypb.Anyè¿”å›ç»™å®¢æˆ·ç«¯</li>
</ol>
<p>è¿™ç§è®¾è®¡ä½¿å¾—dockerctlå‘½ä»¤èƒ½å¤Ÿè¢«dind managerå‡†ç¡®è¯†åˆ«å’Œå¤„ç†ï¼ŒåŒæ—¶ä¿è¯äº†å®‰å…¨æ€§å’Œæƒé™æ§åˆ¶ã€‚</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="http://example.com">Roger-Lv</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="http://example.com/2025/09/16/2025-09-16-%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E6%89%A9%E5%B1%95%E6%96%B9%E6%A1%88%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90/">http://example.com/2025/09/16/2025-09-16-%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E6%89%A9%E5%B1%95%E6%96%B9%E6%A1%88%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥æº <a href="http://example.com" target="_blank">Roger-Lv's space</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/K8S/">K8S</a></div><div class="post-share"><div class="social-share" data-image="/img/cover/k8s.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/09/17/2025-09-17-Volcano%E8%B0%83%E5%BA%A6%E5%99%A8/" title="Volcanoè°ƒåº¦å™¨"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/k8s.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">ä¸Šä¸€ç¯‡</div><div class="info-item-2">Volcanoè°ƒåº¦å™¨</div></div><div class="info-2"><div class="info-item-1">å‚è€ƒï¼šhttps://zhuanlan.zhihu.com/p/700565336 åœ¨ Volcano ç³»ç»Ÿä¸­ï¼Œâ€œJobâ€ å’Œ â€œTaskâ€ è¿™ä¸¤ä¸ªè¯åœ¨ è°ƒåº¦å™¨ï¼ˆSchedulerï¼‰å†…éƒ¨ å’Œ ç”¨æˆ·/æ§åˆ¶å™¨ï¼ˆControllerï¼‰å±‚é¢ ä»£è¡¨çš„æ˜¯å®Œå…¨ä¸åŒçš„ä¸œè¥¿ã€‚ https://volcano.sh/zh/docs/ ä¸°å¯Œçš„è°ƒåº¦ç­–ç•¥  Gang Schedulingï¼šç¡®ä¿ä½œä¸šçš„æ‰€æœ‰ä»»åŠ¡åŒæ—¶å¯åŠ¨ï¼Œé€‚ç”¨äºåˆ†å¸ƒå¼è®­ç»ƒã€å¤§æ•°æ®ç­‰åœºæ™¯ Binpack Schedulingï¼šé€šè¿‡ä»»åŠ¡ç´§å‡‘åˆ†é…ä¼˜åŒ–èµ„æºåˆ©ç”¨ç‡ Heterogeneous device schedulingï¼šé«˜æ•ˆå…±äº«GPUå¼‚æ„èµ„æºï¼Œæ”¯æŒCUDAå’ŒMIGä¸¤ç§æ¨¡å¼çš„GPUè°ƒåº¦ï¼Œæ”¯æŒNPUè°ƒåº¦ Proportion/Capacity Schedulingï¼šåŸºäºé˜Ÿåˆ—é…é¢è¿›è¡Œèµ„æºçš„å…±äº«/æŠ¢å /å›æ”¶ NodeGroup Schedulingï¼šæ”¯æŒèŠ‚ç‚¹åˆ†ç»„äº²å’Œæ€§è°ƒåº¦ï¼Œå®ç°é˜Ÿåˆ—ä¸èŠ‚ç‚¹ç»„çš„ç»‘å®šå…³ç³» DRF Schedulingï¼šæ”¯æŒå¤šç»´åº¦èµ„æºçš„å…¬å¹³è°ƒåº¦ SLA Schedulingï¼šåŸºäºæœåŠ¡è´¨é‡çš„è°ƒåº¦ä¿éšœ Task-topology Schedulin...</div></div></div></a><a class="pagination-related" href="/2025/09/16/2025-09-16-sandbox%E5%92%8Ccontainer%E5%AF%B9%E6%AF%94/" title="sandboxå’Œcontainerå¯¹æ¯”"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/k8s.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">ä¸‹ä¸€ç¯‡</div><div class="info-item-2">sandboxå’Œcontainerå¯¹æ¯”</div></div><div class="info-2"><div class="info-item-1">sandboxå’Œcontainerå¯¹æ¯” Sandbox å’Œ Container çš„åŒºåˆ« åŸºæœ¬æ¦‚å¿µ Sandboxï¼ˆæ²™ç®±ï¼‰  å®šä¹‰ï¼šä¸€ç§éš”ç¦»ç¯å¢ƒï¼Œç”¨äºå®‰å…¨åœ°è¿è¡Œç¨‹åºï¼Œé™åˆ¶å…¶å¯¹ç³»ç»Ÿèµ„æºçš„è®¿é—® ç›®çš„ï¼šæä¾›å®‰å…¨éš”ç¦»ï¼Œé˜²æ­¢æ¶æ„ä»£ç å½±å“ä¸»æœºç³»ç»Ÿ èŒƒå›´ï¼šé€šå¸¸é’ˆå¯¹å•ä¸ªåº”ç”¨ç¨‹åºæˆ–è¿›ç¨‹  Containerï¼ˆå®¹å™¨ï¼‰  å®šä¹‰ï¼šä¸€ç§è½»é‡çº§è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œå°†åº”ç”¨ç¨‹åºåŠå…¶ä¾èµ–æ‰“åŒ…åœ¨ä¸€èµ· ç›®çš„ï¼šæä¾›ä¸€è‡´çš„è¿è¡Œç¯å¢ƒï¼Œç¡®ä¿åº”ç”¨åœ¨ä¸åŒç¯å¢ƒä¸­è¡Œä¸ºä¸€è‡´ èŒƒå›´ï¼šåŒ…å«å®Œæ•´çš„åº”ç”¨ç¨‹åºè¿è¡Œæ—¶ç¯å¢ƒ  ä¸»è¦åŒºåˆ«å¯¹æ¯”    ç‰¹æ€§ Sandbox Container     ä¸»è¦ç›®æ ‡ å®‰å…¨éš”ç¦» ç¯å¢ƒä¸€è‡´æ€§   éš”ç¦»çº§åˆ« é«˜ï¼ˆå®‰å…¨ä¼˜å…ˆï¼‰ ä¸­ç­‰ï¼ˆèµ„æºéš”ç¦»ï¼‰   èµ„æºå¼€é”€ æä½ ä½åˆ°ä¸­ç­‰   å¯åŠ¨é€Ÿåº¦ æå¿« å¿«   åŒ…å«å†…å®¹ å•ä¸ªåº”ç”¨/è¿›ç¨‹ å®Œæ•´è¿è¡Œæ—¶ç¯å¢ƒ    æŠ€æœ¯å®ç°å·®å¼‚ Sandbox å®ç°æ–¹å¼ 1234567// æµè§ˆå™¨æ²™ç®±ç¤ºä¾‹ï¼ˆæ¦‚å¿µæ€§ï¼‰// è¿è¡Œåœ¨å—é™ç¯å¢ƒä¸­const sandboxedCode = `  // æ— æ³•è®¿é—®DOMã€ç½‘ç»œã€æ–‡ä»¶ç³»ç»Ÿ  // åªèƒ½æ‰§è¡Œå®‰å…¨çš„JavaScriptä»£ç   return 42;`; å…¸å‹æŠ€æœ¯ï¼š  æµ...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/09/15/2025-09-15-%E5%A6%82%E4%BD%95%E9%80%9A%E8%BF%87Pod%E8%BF%9B%E5%85%A5%E5%88%B0%E5%AE%BF%E4%B8%BB%E6%9C%BA%EF%BC%9F/" title="å¦‚ä½•é€šè¿‡Podè¿›å…¥åˆ°å®¿ä¸»æœº?"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/k8s.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-15</div><div class="info-item-2">å¦‚ä½•é€šè¿‡Podè¿›å…¥åˆ°å®¿ä¸»æœº?</div></div><div class="info-2"><div class="info-item-1">å¦‚ä½•é€šè¿‡Podè¿›å…¥åˆ°å®¿ä¸»æœº? nsenter -a -t 1 bash å‘½ä»¤çš„ä½œç”¨æ˜¯è®©ä½ åœ¨ä¸€ä¸ªæ–°çš„ shell ä¼šè¯ä¸­ï¼Œè¿›å…¥ PID ä¸º 1 çš„è¿›ç¨‹æ‰€åœ¨çš„å…¨éƒ¨å‘½åç©ºé—´ï¼ˆNamespaceï¼‰ã€‚ é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¯ä»¥ä»podä¸­è¿›å…¥åˆ°å®¿ä¸»æœºï¼ˆå…¨éƒ¨çš„namespaceéƒ½è·Ÿå®¿ä¸»æœºä¸€æ ·ï¼‰ breakdown å¦‚ä¸‹ï¼š  nsenter: è¿™æ˜¯ä¸€ä¸ª Linux å‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºå°†å½“å‰è¿›ç¨‹â€œè¿›å…¥â€åˆ°æŒ‡å®šè¿›ç¨‹çš„ä¸€ä¸ªæˆ–å¤šä¸ªå‘½åç©ºé—´ä¸­ã€‚ -t 1: è¿™ä¸ªé€‰é¡¹æŒ‡å®šäº†ç›®æ ‡è¿›ç¨‹çš„ PID (Process ID)ã€‚åœ¨è¿™é‡Œï¼Œ1 æ˜¯ Linux ç³»ç»Ÿä¸­ç¬¬ä¸€ä¸ªå¯åŠ¨çš„è¿›ç¨‹ï¼ˆé€šå¸¸æ˜¯ init æˆ– systemdï¼‰çš„ PIDã€‚æ‰€æœ‰å…¶ä»–è¿›ç¨‹éƒ½æ˜¯ç”±å®ƒæˆ–å®ƒçš„å­è¿›ç¨‹æ´¾ç”Ÿå‡ºæ¥çš„ã€‚ -a: è¿™ä¸ªé€‰é¡¹æ˜¯ â€œall namespacesâ€ çš„ç¼©å†™ã€‚å®ƒå‘Šè¯‰ nsenter å°†å½“å‰è¿›ç¨‹åŠ å…¥åˆ°ç›®æ ‡è¿›ç¨‹ï¼ˆPID 1ï¼‰æ‰€å±äºçš„æ‰€æœ‰ç±»å‹çš„å‘½åç©ºé—´ä¸­ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š  Mount (mnt) UTS (ä¸»æœºåå’ŒåŸŸå) IPC (è¿›ç¨‹é—´é€šä¿¡) Network PID (è¿›ç¨‹ ID) User ID Cgroup   bash: è¿™æ˜¯è¦åœ¨æ–°åŠ å…¥çš„å‘½åç©ºé—´ç¯...</div></div></div></a><a class="pagination-related" href="/2025/09/15/2025-09-15-k8s-informer%E9%80%9A%E4%BF%97%E6%98%93%E6%87%82%E8%AF%A6%E8%A7%A3/" title="k8s informeré€šä¿—æ˜“æ‡‚è¯¦è§£"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/k8s.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-15</div><div class="info-item-2">k8s informeré€šä¿—æ˜“æ‡‚è¯¦è§£</div></div><div class="info-2"><div class="info-item-1">Kubernetes Informer æœºåˆ¶è¯¦è§£ æ ¸å¿ƒæ¦‚å¿µ Informer æ˜¯ Kubernetes ä¸­ç”¨äºç›‘å¬å’Œç¼“å­˜èµ„æºå¯¹è±¡çš„æ ¸å¿ƒæœºåˆ¶ï¼Œå®ƒé€šè¿‡ ListAndWatch æœºåˆ¶å®ç°é«˜æ•ˆçš„èµ„æºç›‘æ§ã€‚ æ ¸å¿ƒç»„ä»¶åŠä½œç”¨ 1. Reflectorï¼ˆåå°„å™¨ï¼‰  ä½œç”¨ï¼šè´Ÿè´£ä» Kubernetes API Server è·å–èµ„æºå¯¹è±¡ åŠŸèƒ½ï¼š  Listï¼šè·å–èµ„æºçš„å…¨é‡æ•°æ® Watchï¼šç›‘å¬èµ„æºçš„å¢é‡å˜åŒ– å°†æ•°æ®æ”¾å…¥ Delta FIFO é˜Ÿåˆ—    2. Delta FIFO Queueï¼ˆå¢é‡é˜Ÿåˆ—ï¼‰  ä½œç”¨ï¼šå­˜å‚¨èµ„æºå¯¹è±¡çš„å˜åŒ–ï¼ˆå¢åˆ æ”¹ï¼‰ ç‰¹ç‚¹ï¼š  ä¿æŒæ“ä½œé¡ºåº å­˜å‚¨å¯¹è±¡çš„å¢é‡å˜åŒ–ï¼ˆDeltaï¼‰ çº¿ç¨‹å®‰å…¨    3. Informerï¼ˆé€šçŸ¥å™¨ï¼‰  ä½œç”¨ï¼šä» Delta FIFO é˜Ÿåˆ—ä¸­å–å‡ºå¯¹è±¡å¹¶å¤„ç† åŠŸèƒ½ï¼š  è°ƒç”¨ Indexer æ›´æ–°æœ¬åœ°ç¼“å­˜ è§¦å‘æ³¨å†Œçš„äº‹ä»¶å¤„ç†å™¨    4. Indexerï¼ˆç´¢å¼•å™¨ï¼‰  ä½œç”¨ï¼šæœ¬åœ°ç¼“å­˜ï¼Œæä¾›å¿«é€ŸæŸ¥è¯¢ åŠŸèƒ½ï¼š  å­˜å‚¨èµ„æºå¯¹è±¡çš„æœ¬åœ°å‰¯æœ¬ æä¾›åŸºäºç´¢å¼•çš„å¿«é€ŸæŸ¥æ‰¾ çº¿ç¨‹å®‰å…¨çš„è¯»å†™æ“ä½œ    5. Resource Event Handlersï¼ˆèµ„æºäº‹ä»¶å¤„ç†å™¨ï¼‰  ...</div></div></div></a><a class="pagination-related" href="/2025/09/16/2025-09-16-sandbox%E5%92%8Ccontainer%E5%AF%B9%E6%AF%94/" title="sandboxå’Œcontainerå¯¹æ¯”"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/k8s.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-16</div><div class="info-item-2">sandboxå’Œcontainerå¯¹æ¯”</div></div><div class="info-2"><div class="info-item-1">sandboxå’Œcontainerå¯¹æ¯” Sandbox å’Œ Container çš„åŒºåˆ« åŸºæœ¬æ¦‚å¿µ Sandboxï¼ˆæ²™ç®±ï¼‰  å®šä¹‰ï¼šä¸€ç§éš”ç¦»ç¯å¢ƒï¼Œç”¨äºå®‰å…¨åœ°è¿è¡Œç¨‹åºï¼Œé™åˆ¶å…¶å¯¹ç³»ç»Ÿèµ„æºçš„è®¿é—® ç›®çš„ï¼šæä¾›å®‰å…¨éš”ç¦»ï¼Œé˜²æ­¢æ¶æ„ä»£ç å½±å“ä¸»æœºç³»ç»Ÿ èŒƒå›´ï¼šé€šå¸¸é’ˆå¯¹å•ä¸ªåº”ç”¨ç¨‹åºæˆ–è¿›ç¨‹  Containerï¼ˆå®¹å™¨ï¼‰  å®šä¹‰ï¼šä¸€ç§è½»é‡çº§è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œå°†åº”ç”¨ç¨‹åºåŠå…¶ä¾èµ–æ‰“åŒ…åœ¨ä¸€èµ· ç›®çš„ï¼šæä¾›ä¸€è‡´çš„è¿è¡Œç¯å¢ƒï¼Œç¡®ä¿åº”ç”¨åœ¨ä¸åŒç¯å¢ƒä¸­è¡Œä¸ºä¸€è‡´ èŒƒå›´ï¼šåŒ…å«å®Œæ•´çš„åº”ç”¨ç¨‹åºè¿è¡Œæ—¶ç¯å¢ƒ  ä¸»è¦åŒºåˆ«å¯¹æ¯”    ç‰¹æ€§ Sandbox Container     ä¸»è¦ç›®æ ‡ å®‰å…¨éš”ç¦» ç¯å¢ƒä¸€è‡´æ€§   éš”ç¦»çº§åˆ« é«˜ï¼ˆå®‰å…¨ä¼˜å…ˆï¼‰ ä¸­ç­‰ï¼ˆèµ„æºéš”ç¦»ï¼‰   èµ„æºå¼€é”€ æä½ ä½åˆ°ä¸­ç­‰   å¯åŠ¨é€Ÿåº¦ æå¿« å¿«   åŒ…å«å†…å®¹ å•ä¸ªåº”ç”¨/è¿›ç¨‹ å®Œæ•´è¿è¡Œæ—¶ç¯å¢ƒ    æŠ€æœ¯å®ç°å·®å¼‚ Sandbox å®ç°æ–¹å¼ 1234567// æµè§ˆå™¨æ²™ç®±ç¤ºä¾‹ï¼ˆæ¦‚å¿µæ€§ï¼‰// è¿è¡Œåœ¨å—é™ç¯å¢ƒä¸­const sandboxedCode = `  // æ— æ³•è®¿é—®DOMã€ç½‘ç»œã€æ–‡ä»¶ç³»ç»Ÿ  // åªèƒ½æ‰§è¡Œå®‰å…¨çš„JavaScriptä»£ç   return 42;`; å…¸å‹æŠ€æœ¯ï¼š  æµ...</div></div></div></a><a class="pagination-related" href="/2025/09/17/2025-09-17-k8s-%E6%8E%A2%E9%92%88/" title="k8s æ¢é’ˆ"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/k8s.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-17</div><div class="info-item-2">k8s æ¢é’ˆ</div></div><div class="info-2"><div class="info-item-1">k8s æ¢é’ˆ ä¸‰ç±»æ¢é’ˆçš„ä½œç”¨åŸŸ 1. å­˜æ´»æ¢é’ˆï¼ˆLiveness Probeï¼‰  ä½œç”¨ï¼šåˆ¤æ–­Podæ˜¯å¦å­˜æ´» å½±å“ï¼šå¤±è´¥æ—¶é‡å¯Pod èŒƒå›´ï¼šä»…å½±å“Podç”Ÿå‘½å‘¨æœŸ  2. å°±ç»ªæ¢é’ˆï¼ˆReadiness Probeï¼‰  ä½œç”¨ï¼šåˆ¤æ–­Podæ˜¯å¦å‡†å¤‡å¥½æ¥æ”¶æµé‡ å½±å“ï¼šæ§åˆ¶Podæ˜¯å¦åŠ å…¥Serviceçš„Endpoint èŒƒå›´ï¼šå½±å“Serviceæµé‡åˆ†å‘  3. å¯åŠ¨æ¢é’ˆï¼ˆStartup Probeï¼‰  ä½œç”¨ï¼šåˆ¤æ–­åº”ç”¨æ˜¯å¦å¯åŠ¨å®Œæˆ å½±å“ï¼šåœ¨å¯åŠ¨æœŸé—´ç¦ç”¨å…¶ä»–æ¢é’ˆ èŒƒå›´ï¼šä»…å½±å“Podå¯åŠ¨è¿‡ç¨‹  ä¸Serviceçš„å…³ç³»è¯¦è§£ å°±ç»ªæ¢é’ˆä¸Serviceçš„å…³è” 12345678910apiVersion: v1kind: Servicemetadata:  name: my-servicespec:  selector:    app: my-app  # é€‰æ‹©æ ‡ç­¾åŒ¹é…çš„Pod  ports:  - port: 80    targetPort: 8080 123456789101112131415apiVersion: v1kind: Podmetadata:  labels:    app: my-ap...</div></div></div></a><a class="pagination-related" href="/2024/07/19/2024-07-19-Linux%E7%B3%BB%E7%BB%9F%E4%B8%AD%E5%8D%B8%E8%BD%BDanaconda/" title="Linuxç³»ç»Ÿä¸­å¸è½½anaconda"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/Linux.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-19</div><div class="info-item-2">Linuxç³»ç»Ÿä¸­å¸è½½anaconda</div></div><div class="info-2"><div class="info-item-1">Linuxç³»ç»Ÿä¸­å¸è½½anaconda è¦åœ¨Linuxç³»ç»Ÿä¸­å¸è½½Anacondaï¼Œä½ éœ€è¦æ‰§è¡Œä¸€ç³»åˆ—çš„å‘½ä»¤ã€‚è¿™é‡Œæ˜¯ä¸€ä¸ªé€šç”¨çš„æ­¥éª¤æŒ‡å—ï¼š   æ‰¾åˆ°Anacondaå®‰è£…è„šæœ¬ï¼š åœ¨å®‰è£…Anacondaæ—¶ï¼Œå®ƒä¼šåœ¨ä½ çš„ä¸»ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªåä¸ºanaconda3çš„æ–‡ä»¶å¤¹ï¼ˆé»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœä½ åœ¨å®‰è£…æ—¶é€‰æ‹©äº†ä¸åŒçš„åç§°æˆ–ä½ç½®ï¼Œè¯·ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„è·¯å¾„ï¼‰ã€‚   è¿è¡ŒAnacondaå¸è½½ç¨‹åºï¼š Anacondaæä¾›äº†ä¸€ä¸ªå¸è½½ç¨‹åºanaconda-cleanï¼Œå¯ä»¥å¸®åŠ©ä½ åˆ é™¤Anacondaçš„é…ç½®æ–‡ä»¶ã€‚åœ¨ç»ˆç«¯ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š 12conda install anaconda-cleananaconda-clean --yes è¿™ä¸ªå‘½ä»¤å°†åˆ é™¤Anacondaçš„é…ç½®æ–‡ä»¶ï¼Œå¹¶ä¸”å¯ä»¥é€‰æ‹©åˆ›å»ºä¸€ä¸ªå¤‡ä»½ã€‚ä½¿ç”¨â€“yesé€‰é¡¹å¯ä»¥é¿å…åœ¨åˆ é™¤æ¯ä¸ªé¡¹ç›®æ—¶éƒ½è¦æ±‚ç¡®è®¤ã€‚   åˆ é™¤Anacondaå®‰è£…ç›®å½•ï¼š æ¥ä¸‹æ¥ï¼Œä½ éœ€è¦æ‰‹åŠ¨åˆ é™¤Anacondaçš„å®‰è£…ç›®å½•ã€‚å¦‚æœä½ çš„å®‰è£…ç›®å½•æ˜¯é»˜è®¤çš„~/anaconda3ï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š 1rm -rf ~/anaconda3 å¦‚æœä½ çš„å®‰è£…ç›®å½•ä¸æ˜¯é»˜è®¤çš„ï¼Œè¯·ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„è·¯å¾„ã€‚   ç¼–è¾‘.bashrcæˆ–å…¶ä»–...</div></div></div></a><a class="pagination-related" href="/2025/09/01/2025-09-01-Linux-%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%A0%B9%E5%88%86%E5%8C%BA%E6%89%A9%E5%AE%B9%E6%B5%81%E7%A8%8B(ext4-%E7%A4%BA%E4%BE%8B)/" title="Linux äº‘æœåŠ¡å™¨æ ¹åˆ†åŒºæ‰©å®¹æµç¨‹(ext4 ç¤ºä¾‹)"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/df.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-01</div><div class="info-item-2">Linux äº‘æœåŠ¡å™¨æ ¹åˆ†åŒºæ‰©å®¹æµç¨‹(ext4 ç¤ºä¾‹)</div></div><div class="info-2"><div class="info-item-1">Linux äº‘æœåŠ¡å™¨æ ¹åˆ†åŒºæ‰©å®¹æµç¨‹ï¼ˆext4 ç¤ºä¾‹ï¼‰ 1. äº‘å‚å•†æ§åˆ¶å°æ‰©å®¹ç£ç›˜  ç™»å½•äº‘æœåŠ¡å•†ï¼ˆAWSã€é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ç­‰ï¼‰ æ‰¾åˆ°å¯¹åº”å®ä¾‹çš„ ç³»ç»Ÿç›˜ / æ•°æ®ç›˜ ä¿®æ”¹ç£ç›˜å¤§å°ï¼Œä¾‹å¦‚ä» 40G â†’ 80G è¿™ä¸€æ­¥å®Œæˆåï¼Œè™šæ‹Ÿç£ç›˜ /dev/vda å°±ä¼šå˜å¤§ï¼Œä½†åˆ†åŒºå’Œæ–‡ä»¶ç³»ç»Ÿä¸ä¼šè‡ªåŠ¨å˜å¤§   2. ç¡®è®¤ç£ç›˜å’Œåˆ†åŒºæƒ…å†µ 12lsblkdf -h  lsblk ä¼šæ˜¾ç¤ºç£ç›˜å’Œåˆ†åŒºå¤§å° df -h ä¼šæ˜¾ç¤ºæ–‡ä»¶ç³»ç»ŸæŒ‚è½½çš„ç©ºé—´å¤§å°  ä¾‹å­ï¼š 12vda    80Gâ””â”€vda1 40G   / ğŸ‘‰ è¯´æ˜ç£ç›˜æ˜¯ 80Gï¼Œä½†åˆ†åŒºè¿˜åªæœ‰ 40G  3. å®‰è£…æ‰©å®¹å·¥å…· ï¼ˆUbuntu/Debianï¼‰ 12sudo apt updatesudo apt install -y cloud-guest-utils ï¼ˆCentOS/RHELï¼‰ 1sudo yum install -y cloud-utils-growpart  4. æ‰©å±•åˆ†åŒº 1sudo growpart /dev/vda 1  /dev/vda â†’ ç£ç›˜å 1 â†’ åˆ†åŒºå·ï¼ˆå³ /dev/vda1ï¼‰  æ‰§è¡Œåå†çœ‹ï¼š 1lsblk åº”è¯¥å˜æˆï¼š ...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Roger-Lv</div><div class="author-info-description">Send a flare and light the way.</div><div class="site-data"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">150</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">129</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">42</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Roger-Lv"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/Roger-Lv" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:1150568956@qq.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://www.linkedin.com/in/zhongrenjie-lv-5588a928a/" target="_blank" title="LinkedIn"><i class="iconfont icon-linkedin-fill"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content">Welcome!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">å®¹å™¨è¿è¡Œæ—¶æ‰©å±•æ–¹æ¡ˆæŠ€æœ¯è§£æ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%A6%82%E4%BD%95%E6%8E%A5%E5%85%A5-Containerd-%E8%BF%90%E8%A1%8C%E6%97%B6%E7%94%9F%E6%80%81"><span class="toc-number">1.1.</span> <span class="toc-text">1. å¦‚ä½•æ¥å…¥ Containerd è¿è¡Œæ—¶ç”Ÿæ€</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%96%B6-%E9%85%8D%E7%BD%AE%E5%B1%82%E6%8E%A5%E5%85%A5"><span class="toc-number">1.1.1.</span> <span class="toc-text">â–¶ é…ç½®å±‚æ¥å…¥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%96%B6-%E8%BF%90%E8%A1%8C%E6%97%B6%E5%B1%82%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.1.2.</span> <span class="toc-text">â–¶ è¿è¡Œæ—¶å±‚å®ç°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%AE%B9%E5%99%A8-RootFS-%E4%BA%91%E7%AB%AF%E6%8C%81%E4%B9%85%E5%8C%96%E6%96%B9%E6%A1%88"><span class="toc-number">1.2.</span> <span class="toc-text">2. å®¹å™¨ RootFS äº‘ç«¯æŒä¹…åŒ–æ–¹æ¡ˆ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%96%B6-%E8%A7%A6%E5%8F%91%E6%9C%BA%E5%88%B6"><span class="toc-number">1.2.1.</span> <span class="toc-text">â–¶ è§¦å‘æœºåˆ¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%96%B6-%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84"><span class="toc-number">1.2.2.</span> <span class="toc-text">â–¶ å­˜å‚¨æ¶æ„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%96%B6-%E4%B8%8A%E4%BC%A0%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.3.</span> <span class="toc-text">â–¶ ä¸Šä¼ æµç¨‹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Docker-in-Docker%EF%BC%88DinD%EF%BC%89%E5%AE%89%E5%85%A8%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88"><span class="toc-number">1.3.</span> <span class="toc-text">3. Docker-in-Dockerï¼ˆDinDï¼‰å®‰å…¨å®ç°æ–¹æ¡ˆ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%96%B6-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.3.1.</span> <span class="toc-text">â–¶ æ¶æ„è®¾è®¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%96%B6-%E6%A0%B8%E5%BF%83%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.3.2.</span> <span class="toc-text">â–¶ æ ¸å¿ƒå®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%96%B6-%E5%85%B3%E9%94%AE%E7%89%B9%E6%80%A7"><span class="toc-number">1.3.3.</span> <span class="toc-text">â–¶ å…³é”®ç‰¹æ€§</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.4.</span> <span class="toc-text">æ€»ç»“</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">åŸºäº Containerd Snapshotter æ¥å£çš„å®¹å™¨é•œåƒæ“ä½œå¢å¼ºæœºåˆ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81Wrapper-%E6%A8%A1%E5%BC%8F%E6%9E%B6%E6%9E%84%EF%BC%9A%E9%9D%9E%E4%BE%B5%E5%85%A5%E5%BC%8F%E6%89%A9%E5%B1%95"><span class="toc-number">2.1.</span> <span class="toc-text">ä¸€ã€Wrapper æ¨¡å¼æ¶æ„ï¼šéä¾µå…¥å¼æ‰©å±•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%A0%87%E5%87%86%E5%8C%96%E6%93%8D%E4%BD%9C%E6%8B%A6%E6%88%AA%E6%B5%81%E7%A8%8B"><span class="toc-number">2.2.</span> <span class="toc-text">äºŒã€æ ‡å‡†åŒ–æ“ä½œæ‹¦æˆªæµç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%85%B3%E9%94%AE%E6%93%8D%E4%BD%9C%E7%9A%84%E5%85%B7%E4%BD%93%E5%A2%9E%E5%BC%BA%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.3.</span> <span class="toc-text">ä¸‰ã€å…³é”®æ“ä½œçš„å…·ä½“å¢å¼ºå®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Prepare%EF%BC%88%E5%AE%B9%E5%99%A8%E5%87%86%E5%A4%87%E9%98%B6%E6%AE%B5%EF%BC%89"><span class="toc-number">2.3.1.</span> <span class="toc-text">1. Prepareï¼ˆå®¹å™¨å‡†å¤‡é˜¶æ®µï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Mounts%EF%BC%88%E6%8C%82%E8%BD%BD%E8%AE%BF%E9%97%AE%E9%98%B6%E6%AE%B5%EF%BC%89"><span class="toc-number">2.3.2.</span> <span class="toc-text">2. Mountsï¼ˆæŒ‚è½½è®¿é—®é˜¶æ®µï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Remove%EF%BC%88%E5%BF%AB%E7%85%A7%E5%88%A0%E9%99%A4%E9%98%B6%E6%AE%B5%EF%BC%89"><span class="toc-number">2.3.3.</span> <span class="toc-text">3. Removeï¼ˆå¿«ç…§åˆ é™¤é˜¶æ®µï¼‰</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%AE%B9%E5%99%A8%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%85%83%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86"><span class="toc-number">2.4.</span> <span class="toc-text">å››ã€å®¹å™¨ç”Ÿå‘½å‘¨æœŸå…ƒæ•°æ®ç®¡ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%96%B6-InitSnapshotMounts"><span class="toc-number">2.4.1.</span> <span class="toc-text">â–¶ InitSnapshotMounts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%96%B6-OnMounts"><span class="toc-number">2.4.2.</span> <span class="toc-text">â–¶ OnMounts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%96%B6-OnRemove-Clear"><span class="toc-number">2.4.3.</span> <span class="toc-text">â–¶ OnRemove + Clear</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E4%B8%8E-Containerd-%E7%9A%84%E9%9B%86%E6%88%90%E6%96%B9%E5%BC%8F"><span class="toc-number">2.5.</span> <span class="toc-text">äº”ã€ä¸ Containerd çš„é›†æˆæ–¹å¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%9C%85-%E6%96%B9%E6%A1%88%E4%BB%B7%E5%80%BC%E6%80%BB%E7%BB%93"><span class="toc-number">2.6.</span> <span class="toc-text">âœ… æ–¹æ¡ˆä»·å€¼æ€»ç»“</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%A7%A9-%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">2.7.</span> <span class="toc-text">ğŸ§© é€‚ç”¨åœºæ™¯</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">dindè¿™éƒ¨åˆ†</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF"><span class="toc-number">3.1.</span> <span class="toc-text">æ ¸å¿ƒæŠ€æœ¯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%BB%E8%BE%91%E9%93%BE%E8%B7%AF"><span class="toc-number">3.2.</span> <span class="toc-text">é€»è¾‘é“¾è·¯</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-dind%E5%AE%B9%E5%99%A8%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B"><span class="toc-number">3.2.1.</span> <span class="toc-text">1. dindå®¹å™¨åˆ›å»ºæµç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Docker%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">3.2.2.</span> <span class="toc-text">2. Dockerå‘½ä»¤æ‰§è¡Œæµç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%85%B3%E9%94%AE%E6%8A%80%E6%9C%AF%E7%82%B9"><span class="toc-number">3.2.3.</span> <span class="toc-text">3. å…³é”®æŠ€æœ¯ç‚¹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.3.</span> <span class="toc-text">æ‰§è¡Œæµç¨‹ç¤ºä¾‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dind%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE%E7%9A%84%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.4.</span> <span class="toc-text">dindå®¹å™¨ç½‘ç»œé…ç½®çš„å…·ä½“å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE%E6%B5%81%E7%A8%8B"><span class="toc-number">3.4.1.</span> <span class="toc-text">ç½‘ç»œé…ç½®æµç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E7%BB%86%E8%8A%82"><span class="toc-number">3.4.2.</span> <span class="toc-text">æŠ€æœ¯ç»†èŠ‚</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E9%80%BB%E8%BE%91"><span class="toc-number">3.4.3.</span> <span class="toc-text">éªŒè¯é€»è¾‘</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Docker%E5%91%BD%E4%BB%A4%E5%8A%AB%E6%8C%81%E7%9A%84%E9%80%BB%E8%BE%91"><span class="toc-number">3.5.</span> <span class="toc-text">Dockerå‘½ä»¤åŠ«æŒçš„é€»è¾‘</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Socket%E9%87%8D%E5%AE%9A%E5%90%91%E6%9C%BA%E5%88%B6"><span class="toc-number">3.5.1.</span> <span class="toc-text">1. Socketé‡å®šå‘æœºåˆ¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E5%8A%AB%E6%8C%81%EF%BC%9A"><span class="toc-number">3.5.2.</span> <span class="toc-text">2. åå‘ä»£ç†åŠ«æŒï¼š</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E8%AF%B7%E6%B1%82%E5%8A%AB%E6%8C%81%E9%80%BB%E8%BE%91"><span class="toc-number">3.5.3.</span> <span class="toc-text">3. è¯·æ±‚åŠ«æŒé€»è¾‘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%85%B7%E4%BD%93%E5%8A%AB%E6%8C%81%E6%93%8D%E4%BD%9C"><span class="toc-number">3.5.4.</span> <span class="toc-text">4. å…·ä½“åŠ«æŒæ“ä½œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%AE%8C%E6%95%B4%E7%9A%84%E5%8A%AB%E6%8C%81%E6%B5%81%E7%A8%8B"><span class="toc-number">3.5.5.</span> <span class="toc-text">5. å®Œæ•´çš„åŠ«æŒæµç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E4%BC%98%E5%8A%BF"><span class="toc-number">3.5.6.</span> <span class="toc-text">æŠ€æœ¯ä¼˜åŠ¿</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%981-%E7%9C%9F%E6%AD%A3%E7%9A%84dockerd-socket%E4%BD%8D%E7%BD%AE"><span class="toc-number">3.6.</span> <span class="toc-text">é—®é¢˜1: çœŸæ­£çš„dockerd socketä½ç½®</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%982-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%83%BD%E8%AE%BF%E9%97%AE-%E2%80%9C-mainroot-run-docker-sock%E2%80%9D"><span class="toc-number">3.7.</span> <span class="toc-text">é—®é¢˜2: ä¸ºä»€ä¹ˆèƒ½è®¿é—® â€œ&#x2F;mainroot&#x2F;run&#x2F;docker.sockâ€</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%98%A0%E5%B0%84"><span class="toc-number">3.7.1.</span> <span class="toc-text">1. æ–‡ä»¶ç³»ç»Ÿæ˜ å°„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Socket%E5%88%9B%E5%BB%BA%E6%9C%BA%E5%88%B6"><span class="toc-number">3.7.2.</span> <span class="toc-text">2. Socketåˆ›å»ºæœºåˆ¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%AE%8C%E6%95%B4%E7%9A%84%E8%AE%BF%E9%97%AE%E8%B7%AF%E5%BE%84"><span class="toc-number">3.7.3.</span> <span class="toc-text">3. å®Œæ•´çš„è®¿é—®è·¯å¾„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.7.4.</span> <span class="toc-text">æŠ€æœ¯å®ç°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-gRPC%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6"><span class="toc-number">3.8.</span> <span class="toc-text">1. gRPCé€šä¿¡æœºåˆ¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-ServiceCall%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="toc-number">3.9.</span> <span class="toc-text">2. ServiceCallå¤„ç†æµç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">3.9.1.</span> <span class="toc-text">2.1 å‘½ä»¤æ‰§è¡Œæµç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%A4%84%E7%90%86"><span class="toc-number">3.9.2.</span> <span class="toc-text">2.2 æœåŠ¡ç«¯å¤„ç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-dind-manager%E8%AF%86%E5%88%AB"><span class="toc-number">3.9.3.</span> <span class="toc-text">2.3 dind managerè¯†åˆ«</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%9D%83%E9%99%90%E9%AA%8C%E8%AF%81%E6%9C%BA%E5%88%B6"><span class="toc-number">3.10.</span> <span class="toc-text">3. æƒé™éªŒè¯æœºåˆ¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%91%BD%E4%BB%A4%E4%B8%8Eaction%E6%98%A0%E5%B0%84"><span class="toc-number">3.11.</span> <span class="toc-text">4. å‘½ä»¤ä¸actionæ˜ å°„</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%AE%8C%E6%95%B4%E7%9A%84%E8%AF%86%E5%88%AB%E6%B5%81%E7%A8%8B"><span class="toc-number">3.12.</span> <span class="toc-text">5. å®Œæ•´çš„è¯†åˆ«æµç¨‹</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/11/03/2025-11-03-langfuse%E4%BA%A4%E4%BA%92data%E5%92%8Ctask%E4%BA%A4%E4%BA%92%E5%8E%9F%E7%90%86/" title="langfuseäº¤äº’dataå’Œtaskäº¤äº’åŸç†"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/langfuse.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="langfuseäº¤äº’dataå’Œtaskäº¤äº’åŸç†"/></a><div class="content"><a class="title" href="/2025/11/03/2025-11-03-langfuse%E4%BA%A4%E4%BA%92data%E5%92%8Ctask%E4%BA%A4%E4%BA%92%E5%8E%9F%E7%90%86/" title="langfuseäº¤äº’dataå’Œtaskäº¤äº’åŸç†">langfuseäº¤äº’dataå’Œtaskäº¤äº’åŸç†</a><time datetime="2025-11-02T16:00:00.000Z" title="å‘è¡¨äº 2025-11-03 00:00:00">2025-11-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/10/12/2025-10-12-Rust-just%E5%AE%89%E8%A3%85/" title="Rust-justå®‰è£…"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/rust.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Rust-justå®‰è£…"/></a><div class="content"><a class="title" href="/2025/10/12/2025-10-12-Rust-just%E5%AE%89%E8%A3%85/" title="Rust-justå®‰è£…">Rust-justå®‰è£…</a><time datetime="2025-10-11T16:00:00.000Z" title="å‘è¡¨äº 2025-10-12 00:00:00">2025-10-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/30/2025-09-30-Langfuse-%E5%92%8C-ClickHouse-%E7%BB%93%E5%90%88%E4%BD%BF%E7%94%A8/" title="Langfuse å’Œ ClickHouse ç»“åˆä½¿ç”¨"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/tencent.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Langfuse å’Œ ClickHouse ç»“åˆä½¿ç”¨"/></a><div class="content"><a class="title" href="/2025/09/30/2025-09-30-Langfuse-%E5%92%8C-ClickHouse-%E7%BB%93%E5%90%88%E4%BD%BF%E7%94%A8/" title="Langfuse å’Œ ClickHouse ç»“åˆä½¿ç”¨">Langfuse å’Œ ClickHouse ç»“åˆä½¿ç”¨</a><time datetime="2025-09-29T16:00:00.000Z" title="å‘è¡¨äº 2025-09-30 00:00:00">2025-09-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/24/2025-09-24-Intern-%E5%BF%AB%E9%80%9F-Landing+%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" title="Intern å¿«é€Ÿ Landing+ç¯å¢ƒæ­å»º"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/tencent.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Intern å¿«é€Ÿ Landing+ç¯å¢ƒæ­å»º"/></a><div class="content"><a class="title" href="/2025/09/24/2025-09-24-Intern-%E5%BF%AB%E9%80%9F-Landing+%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" title="Intern å¿«é€Ÿ Landing+ç¯å¢ƒæ­å»º">Intern å¿«é€Ÿ Landing+ç¯å¢ƒæ­å»º</a><time datetime="2025-09-23T16:00:00.000Z" title="å‘è¡¨äº 2025-09-24 00:00:00">2025-09-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/20/2025-09-14-Autogen%E5%A4%9A%E6%99%BA%E8%83%BD%E4%BD%93%E4%BA%A4%E6%8E%A5/" title="Autogenå¤šæ™ºèƒ½ä½“äº¤æ¥"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/agent.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Autogenå¤šæ™ºèƒ½ä½“äº¤æ¥"/></a><div class="content"><a class="title" href="/2025/09/20/2025-09-14-Autogen%E5%A4%9A%E6%99%BA%E8%83%BD%E4%BD%93%E4%BA%A4%E6%8E%A5/" title="Autogenå¤šæ™ºèƒ½ä½“äº¤æ¥">Autogenå¤šæ™ºèƒ½ä½“äº¤æ¥</a><time datetime="2025-09-19T16:00:00.000Z" title="å‘è¡¨äº 2025-09-20 00:00:00">2025-09-20</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;2024 - 2025 By Roger-Lv</span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æ—¥é—´å’Œå¤œé—´æ¨¡å¼åˆ‡æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="å‰å¾€è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.4.2"></script><script src="/js/main.js?v=5.4.2"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@19.1.3/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@11.8.0/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const initValine = (el, path) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyValine = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    const valineConfig = {
      el: '#vcomment',
      appId: 'smA3tZdRGodG2VgnMubBQjLm-gzGzoHsz',
      appKey: 'biCDxj0lSBtZTMie2kNIKErd',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      visitor: true,
      ...option,
      path: isShuoshuo ? path : (option && option.path) || window.location.pathname
    }

    new Valine(valineConfig)
  }

  const loadValine = async (el, path) => {
    if (typeof Valine === 'function') {
      initValine(el, path)
    } else {
      await btf.getScript('https://cdn.jsdelivr.net/npm/valine@1.5.3/dist/Valine.min.js')
      initValine(el, path)
    }
  }

  if (isShuoshuo) {
    'Valine' === 'Valine'
      ? window.shuoshuoComment = { loadComment: loadValine }
      : window.loadOtherComment = loadValine
    return
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script></div><div class="aplayer no-destroy" data-id="8674547170" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="true" data-lrcType="-1"> </div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/dist/fireworks.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=5.4.2"></script></div></div></body></html>