<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>后端微服务-programmer-club项目的设计与实现 | Roger-Lv's space</title><meta name="author" content="Roger-Lv"><meta name="copyright" content="Roger-Lv"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="程序员社区项目 开发模式前后端分离，后端负责所有的设计、接口的定义，后端先行，前端协同，通过接口文档，采用apifox的文档进行对接。 敏捷开发，版本上线迭代，需求分析-&gt;功能设计-&gt;详细设计-&gt;编码实现。 开发工具后端：IDEA 前端：VSCode 项目管理：giteazycode 包依赖管理：Maven3.6.0 数据库：Mysql5.7 数据库连接池和监控库：Druid 框">
<meta property="og:type" content="article">
<meta property="og:title" content="后端微服务-programmer-club项目的设计与实现">
<meta property="og:url" content="http://example.com/2024/07/10/2024-07-10-%E7%A8%8B%E5%BA%8F%E5%91%98%E7%A4%BE%E5%8C%BA%E9%A1%B9%E7%9B%AE%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/index.html">
<meta property="og:site_name" content="Roger-Lv&#39;s space">
<meta property="og:description" content="程序员社区项目 开发模式前后端分离，后端负责所有的设计、接口的定义，后端先行，前端协同，通过接口文档，采用apifox的文档进行对接。 敏捷开发，版本上线迭代，需求分析-&gt;功能设计-&gt;详细设计-&gt;编码实现。 开发工具后端：IDEA 前端：VSCode 项目管理：giteazycode 包依赖管理：Maven3.6.0 数据库：Mysql5.7 数据库连接池和监控库：Druid 框">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/cover/java.gif">
<meta property="article:published_time" content="2024-07-09T16:00:00.000Z">
<meta property="article:modified_time" content="2025-07-27T03:05:27.913Z">
<meta property="article:author" content="Roger-Lv">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="后端">
<meta property="article:tag" content="微服务">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/cover/java.gif"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "后端微服务-programmer-club项目的设计与实现",
  "url": "http://example.com/2024/07/10/2024-07-10-%E7%A8%8B%E5%BA%8F%E5%91%98%E7%A4%BE%E5%8C%BA%E9%A1%B9%E7%9B%AE%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/",
  "image": "http://example.com/img/cover/java.gif",
  "datePublished": "2024-07-09T16:00:00.000Z",
  "dateModified": "2025-07-27T03:05:27.913Z",
  "author": [
    {
      "@type": "Person",
      "name": "Roger-Lv",
      "url": "http://example.com"
    }
  ]
}</script><link rel="shortcut icon" href="/img/avatar.jpg"><link rel="canonical" href="http://example.com/2024/07/10/2024-07-10-%E7%A8%8B%E5%BA%8F%E5%91%98%E7%A4%BE%E5%8C%BA%E9%A1%B9%E7%9B%AE%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.4.2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '后端微服务-programmer-club项目的设计与实现',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/font.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">85</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">108</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">25</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/default_top_img.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Roger-Lv's space</span></a><a class="nav-page-title" href="/"><span class="site-name">后端微服务-programmer-club项目的设计与实现</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">后端微服务-programmer-club项目的设计与实现</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-07-09T16:00:00.000Z" title="发表于 2024-07-10 00:00:00">2024-07-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-07-27T03:05:27.913Z" title="更新于 2025-07-27 11:05:27">2025-07-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="leancloud_visitors" id="/2024/07/10/2024-07-10-%E7%A8%8B%E5%BA%8F%E5%91%98%E7%A4%BE%E5%8C%BA%E9%A1%B9%E7%9B%AE%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/" data-flag-title="后端微服务-programmer-club项目的设计与实现"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span class="leancloud-visitors-count"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="程序员社区项目"><a href="#程序员社区项目" class="headerlink" title="程序员社区项目"></a>程序员社区项目</h1><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/10/zbYgoZyvmxdwP3n.png" alt="image-20240710162449654.png"></p>
<h2 id="开发模式"><a href="#开发模式" class="headerlink" title="开发模式"></a>开发模式</h2><p>前后端分离，后端负责所有的设计、接口的定义，后端先行，前端协同，通过接口文档，采用apifox的文档进行对接。</p>
<p>敏捷开发，版本上线迭代，需求分析-&gt;功能设计-&gt;详细设计-&gt;编码实现。</p>
<h2 id="开发工具"><a href="#开发工具" class="headerlink" title="开发工具"></a>开发工具</h2><p>后端：IDEA</p>
<p>前端：VSCode</p>
<p>项目管理：giteazycode</p>
<p>包依赖管理：Maven3.6.0</p>
<p>数据库：Mysql5.7</p>
<p>数据库连接池和监控库：Druid</p>
<p>框架：Springboot 2.4.2</p>
<p>数据库图形化：Navicat</p>
<p>接口管理工具：APIPost7</p>
<p>Redis桌面工具：RedisDesktop</p>
<p>表建模：PDManager</p>
<p>原型设计：axure8</p>
<p>原型组件库: antdesign</p>
<p>代码生成器：easycode（idea的plugin市场）</p>
<p>一些插件：mybatis（类-&gt;dao-&gt;数据库），easycode（由数据库表生成相应代码）, preconditions（参数校验）</p>
<p>node.js</p>
<h2 id="架构设计"><a href="#架构设计" class="headerlink" title="架构设计"></a>架构设计</h2><h3 id="传统项目"><a href="#传统项目" class="headerlink" title="传统项目"></a>传统项目</h3><p>[SpringMVC框架（详解）-CSDN博客](<a target="_blank" rel="noopener" href="https://blog.csdn.net/H20031011/article/details/131511482?ops_request_misc=%7B%22request_id%22:%22172145077916800222810035%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=172145077916800222810035&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-2-131511482-null-null.142%5Ev100%5Epc_search_result_base8&utm_term=spring">https://blog.csdn.net/H20031011/article/details/131511482?ops_request_misc=%7B%22request%5Fid%22%3A%22172145077916800222810035%22%2C%22scm%22%3A%2220140713.130102334..%22%7D&amp;request_id=172145077916800222810035&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-2-131511482-null-null.142^v100^pc_search_result_base8&amp;utm_term=spring</a> mvc架构&amp;spm&#x3D;1018.2226.3001.4187)</p>
<p>一般的mvc：model，view，controller</p>
<p>SpringMVC：controller(view+controller)，service（业务逻辑），dao（数据库）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/10/IkmcCyEaiVK8jvT.png" alt="image-20240710175347652.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/20/4xSwLQAW6PBKqYI.png" alt="image-20240720125604514.png"></p>
<h3 id="现有的架构"><a href="#现有的架构" class="headerlink" title="现有的架构"></a>现有的架构</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_49619863/article/details/127836283?ops_request_misc=%7B%22request_id%22:%22172060612716800222827668%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=172060612716800222827668&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-127836283-null-null.142%5Ev100%5Epc_search_result_base8&utm_term=ddd%E6%9E%B6%E6%9E%84&spm=1018.2226.3001.4187">DDD架构-CSDN博客</a></p>
<p>[浅谈架构设计：MVC架构与DDD架构【开发实践】_ddd架构和mvc架构区别-CSDN博客](<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_40656637/article/details/137344153?ops_request_misc=%7B%22request_id%22:%22172145093416800184184571%22,%22scm%22:%2220140713.130102334.pc_all.%22%7D&request_id=172145093416800184184571&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-1-137344153-null-null.142%5Ev100%5Epc_search_result_base8&utm_term=spring">https://blog.csdn.net/qq_40656637/article/details/137344153?ops_request_misc=%7B%22request%5Fid%22%3A%22172145093416800184184571%22%2C%22scm%22%3A%2220140713.130102334.pc%5Fall.%22%7D&amp;request_id=172145093416800184184571&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-1-137344153-null-null.142^v100^pc_search_result_base8&amp;utm_term=spring</a> mvc架构和ddd架构&amp;spm&#x3D;1018.2226.3001.4187)</p>
<p>ddd 架构</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/10/6L8j9VMkRHxWOga.png" alt="cbc3530efc1e41d6b6a94455d804d3d3[1].png"></p>
<ul>
<li><p>用户接口层（User Interface ）：负责向用户显示信息和解释用户指令（是DDD架构中的表现层）（表现层是视图层的超集，概念有所区别，知道最上层就是表现层即可）</p>
</li>
<li><p>应用层（Application）：很“薄”的一层，理论上不应该有业务规则或逻辑，主要面向用例和流程相关的操作。在应用层协调多个服务和领域对象完成服务的组合和编排，协作完成业务操作。此外，应用层也是微服务之间交互的通道，它可以调用其它微服务的应用服务，完成微服务之间服务的组合和编排</p>
</li>
<li><p>领域层（Domain）：是实现企业核心业务逻辑，通过各种校验手段保证业务的正确性。领域层主要体现领域模型的业务能力，它用来表达业务概念、业务状态和业务规则。领域层包含聚合根、实体、值对象、领域服务等领域模型中的领域对象</p>
</li>
<li><p>基础层（Infrastructure）：贯穿所有层，为其它层提供通用的技术和基础服务，包括第三方工具、驱动、消息中间件、网关、文件、缓存以及数据库等</p>
</li>
<li><p>个人理解：将service层拆分为了应用层和领域层。其中应用层关注于用例和流程，不涉及业务规则或逻辑，通过组合和编排下层的领域层来完成业务操作。而领域层用于封装具体的业务规则或逻辑，拆分出来的领域层不再和具体流程关联，实现了高内聚和低耦合，还提高了领域层的可复用性。用户接口层和基础层则为原来的视图层和dao层的扩展，新增了部分职责功能。</p>
</li>
</ul>
<p>例子：</p>
<ol>
<li><strong>电子商务领域</strong>：<ul>
<li>实体：用户、产品、订单、支付记录。</li>
<li>聚合：购物车、订单详情。</li>
<li>领域服务：订单处理、库存管理、用户认证。</li>
</ul>
</li>
<li><strong>交通物流领域</strong>：<ul>
<li>实体：司机、车辆、货物、运输任务。</li>
<li>聚合：运输订单、车队管理。</li>
<li>领域服务：路径规划、货物追踪、调度优化。</li>
</ul>
</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/10/eTX5pdGHV3OrFIB.png" alt="image-20240710175452746.png"></p>
<ol>
<li><p><strong>API（对外接口层）</strong>：这一层负责定义对外提供的服务接口，通常用于与客户端或其他服务进行交互。</p>
</li>
<li><p><strong>Controller</strong>：在传统的MVC架构中，控制器用于处理用户的请求。在这里，它用于接收API层的请求，并将请求转换为应用层可以理解的格式。</p>
</li>
<li><p><strong>DTO（Data Transfer Object）</strong>：</p>
<p>代表数据传输对象的意思</p>
<p>是一种设计模式之间传输数据的软件应用系统，数据传输目标往往是数据访问对象从数据库中检索数据</p>
<p>数据传输对象与数据交互对象或数据访问对象之间的差异是一个以不具任何行为除了存储和检索的数据（访问和存取器）</p>
<p>简而言之，就是<strong>接口之间传递的数据封装</strong></p>
<p>表里面有十几个字段：id，name，gender（M&#x2F;F)，age……</p>
<p>页面需要展示三个字段：name，gender(男&#x2F;女)，age</p>
<p>DTO由此产生，一是能提高数据传输的速度(减少了传输字段)，二能隐藏后端表结构。</p>
</li>
<li><p><strong>BO（Business Object）</strong>：</p>
<p>代表业务对象的意思，Bo就是把业务逻辑封装为一个对象（注意是逻辑，业务逻辑），这个对象可以包括一个或多个其它的对象。通过调用Dao方法，结合Po或Vo进行业务操作。</p>
<p>形象描述为一个对象的形为和动作，当然也有涉及到基它对象的一些形为和动作。比如处理一个人的业务逻辑，该人会睡觉，吃饭，工作，上班等等行为，还有可能和别人发关系的行为，处理这样的业务逻辑时，我们就可以针对BO去处理。</p>
<p>再比如投保人是一个PO，被保险人是一个PO，险种信息也是一个PO等等，他们组合起来就是一张保单的BO。</p>
</li>
<li><p><strong>PO&#x2F;DO: Persistent Object &#x2F; Data Object，持久对象 &#x2F; 数据对象。</strong></p>
<p>它跟持久层（通常是关系型数据库）的数据结构形成一一对应的映射关系，如果持久层是关系型数据库，那么，数据表中的每个字段（或若干个）就对应PO的一个（或若干个）属性。</p>
</li>
<li><p><strong>VO: View Object, 视图模型，展示层对象</strong>:</p>
<p>对应页面显示（web页面&#x2F;移动端H5&#x2F;Native视图）的数据对象。</p>
</li>
<li><p><strong>Application层（应用层）</strong>：这一层包含应用服务，它们协调领域对象来完成业务逻辑。它还包含一些业务逻辑的转换逻辑，如DTO到BO的转换。</p>
</li>
<li><p><strong>Interceptor</strong>：拦截器，用于在请求处理过程中进行一些前置或后置处理，例如日志记录、权限验证等。</p>
</li>
<li><p><strong>Application-MQ（消费者）&#x2F; Application-Job</strong>：这指的是应用层中处理消息队列消息的组件，或者定时任务的处理。</p>
</li>
<li><p><strong>Domain层（领域层）</strong>：这是DDD中的核心层，包含业务逻辑和领域模型。领域层专注于业务规则和业务实体。</p>
</li>
<li><p><strong>Service</strong>：领域服务，执行领域逻辑但不自然属于任何实体或值对象的操作。</p>
</li>
<li><p><strong>Entity&#x2F;PO（Persistent Object）</strong>：持久化对象，通常与数据库存储相关，代表数据库中的记录。</p>
</li>
<li><p><strong>Mapper</strong>：数据访问对象，用于将领域对象映射到数据库表。</p>
</li>
<li><p><strong>Infra层（基础设施层）</strong>：提供技术实现，如数据库访问、消息传递、外部服务调用等。</p>
</li>
<li><p><strong>RPC</strong>：远程过程调用，用于服务之间的通信。</p>
</li>
<li><p><strong>MG（生产者）</strong>：指的是消息生成者，负责生成并发送消息到消息队列。</p>
</li>
<li><p><strong>Starter（启动层）</strong>：指的是服务启动时需要自动执行的代码或配置。</p>
</li>
<li><p><strong>Aggressive（聚合层）</strong>：聚合层，将多个领域对象聚合成一个更大的业务实体。</p>
</li>
<li><p><strong>Config</strong>：配置层，用于存储和访问配置信息。</p>
</li>
<li><p><strong>Dict（字典）</strong>：指的是数据字典，用于存储一些固定的数据或映射关系。</p>
</li>
<li><p><strong>Common（公共层）</strong>：包含整个应用中多个地方会用到的通用代码或工具。</p>
</li>
<li><p><strong>Enums</strong>：枚举，用于定义一组命名的常量。</p>
</li>
<li><p><strong>Utils</strong>：工具类，提供一些通用的辅助功能。</p>
</li>
</ol>
<p>req-&gt;dto-&gt;do-&gt;bo-&gt;entity-&gt;po</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/10/vcwy8WMZKz7pNSe.jpg" alt="UBWaSonlxTkZyGs[1].jpg"></p>
<h3 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/17/YwcR1HeWvrqD72s.png" alt="image-20240717163452115.png"></p>
<h4 id="后端项目目录（backend）"><a href="#后端项目目录（backend）" class="headerlink" title="后端项目目录（backend）"></a>后端项目目录（backend）</h4><ul>
<li><strong>asyncTool</strong>: 包含异步处理工具或库，用于处理异步任务。</li>
<li><strong>doc</strong>: 存放项目文档，如API文档、技术规范等。</li>
<li><strong>jc-club-auth</strong>: 认证服务，负责用户认证和授权。</li>
<li><strong>jc-club-circle</strong>: 可能与社区圈子或用户组相关功能。</li>
<li><strong>jc-club-common-starter</strong>: 通用启动器或工具类，提供项目通用功能。</li>
<li><strong>jc-club-gateway</strong>: 网关服务，负责请求路由、负载均衡等。</li>
<li><strong>jc-club-gen</strong>: 代码生成工具，可能用于快速生成项目代码。</li>
<li><strong>jc-club-interview</strong>: 面试相关功能，可能包含面试题库或模拟面试。</li>
<li><strong>jc-club-oss</strong>: 对象存储服务，用于管理文件存储。</li>
<li><strong>jc-club-practice</strong>: 实践项目或示例代码。</li>
<li><strong>jc-club-subject</strong>: 主题或课程相关功能，可能用于教育或培训。</li>
<li><strong>jc-club-wx</strong>: 微信相关功能，可能包含微信公众号接口或小程序支持。</li>
</ul>
<h2 id="技术选型"><a href="#技术选型" class="headerlink" title="技术选型"></a>技术选型</h2><p>[Spring和Spring Boot之间的区别（小结）_spring和springboot的区别-CSDN博客](<a target="_blank" rel="noopener" href="https://blog.csdn.net/mengxin_chen/article/details/116240326?ops_request_misc=%7B%22request_id%22:%22172145220016800227442776%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=172145220016800227442776&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-116240326-null-null.142%5Ev100%5Epc_search_result_base8&utm_term=spring%E5%92%8Cspring">https://blog.csdn.net/mengxin_chen/article/details/116240326?ops_request_misc=%7B%22request%5Fid%22%3A%22172145220016800227442776%22%2C%22scm%22%3A%2220140713.130102334..%22%7D&amp;request_id=172145220016800227442776&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-116240326-null-null.142^v100^pc_search_result_base8&amp;utm_term=spring和spring</a> boot区别&amp;spm&#x3D;1018.2226.3001.4187)</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/10/SRyfeJV49ksGvNl.png" alt="image-20240710163626898.png"></p>
<h2 id="服务器中间件"><a href="#服务器中间件" class="headerlink" title="服务器中间件"></a>服务器中间件</h2><p>服务器采用的京东云 centos</p>
<h3 id="Docker安装"><a href="#Docker安装" class="headerlink" title="Docker安装"></a>Docker安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">yum install docker-ce docker-ce-cli containerd.io -y </span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl enable docker</span><br><span class="line">docker version </span><br><span class="line">docker images</span><br></pre></td></tr></table></figure>

<h3 id="Docker安装mysql"><a href="#Docker安装mysql" class="headerlink" title="Docker安装mysql"></a>Docker安装mysql</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql:5.7 </span><br><span class="line">docker images </span><br><span class="line">mkdir -p /home/service/mysql/data </span><br><span class="line">mkdir -p /home/service/mysql/conf</span><br><span class="line">cd /home/service/mysql/conf</span><br><span class="line">touch my.cnf</span><br></pre></td></tr></table></figure>

<p>将以下内容粘入:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">user=mysql</span><br><span class="line">character-set-server=utf8</span><br><span class="line">default_authentication_plugin=mysql_native_password</span><br><span class="line">default-time_zone = &#x27;+8:00&#x27;</span><br><span class="line">[client]</span><br><span class="line">default-character-set=utf8</span><br><span class="line">[mysql]</span><br><span class="line">default-character-set=utf8</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 3306:3306 --name mysql -v /home/service/mysql/logs:/logs -v /home/service/mysql/data:/mysql_data -e MYSQL_ROOT_PASSWORD=Wing1Q2W#E -d mysql:5.7</span><br><span class="line">docker exec -it mysql bash </span><br><span class="line">mysql -uroot -p </span><br><span class="line"></span><br><span class="line">CREATE USER &#x27;admin&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;Wing1Q2W#E&#x27;;</span><br><span class="line">GRANT ALL ON *.* TO &#x27;admin&#x27;@&#x27;%&#x27;; </span><br><span class="line">flush privileges; </span><br></pre></td></tr></table></figure>

<p>docker ps 查看启动状态。</p>
<p>navicat直接连接即可，云服务器需要开启防火墙。</p>
<h3 id="Maven配置国内源"><a href="#Maven配置国内源" class="headerlink" title="Maven配置国内源"></a>Maven配置国内源</h3><p>maven一定要放到Jenkins的数据挂载目录内，这样容器才能读到。参考开发工具选型里面的maaven包。</p>
<p>在maven的conf的setting的mirrors里面进行配置，配置后，Jenkins下载包会非常的快。</p>
<mirror>
    <id>alimaven</id>
    <name>aliyun maven</name>
    <url>http://maven.aliyun.com/nexus/content/groups/public/</url>
    <mirrorOf>central</mirrorOf>
</mirror>

<h3 id="Docker安装Jenkins"><a href="#Docker安装Jenkins" class="headerlink" title="Docker安装Jenkins"></a>Docker安装Jenkins</h3><p>机器上要有 jdk，服务器可以执行如下命令安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y java-1.8.0-openjdk.x86_64</span><br></pre></td></tr></table></figure>

<p>jenkins开始</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker search jenkins</span><br><span class="line">docker pull jenkins/jenkins:2.414.2</span><br><span class="line">docker run -d -u root -p 8080:8080 -p 50000:50000 -v /var/jenkins_home:/var/jenkins_home -v /etc/localtime:/etc/localtime --name jenkins jenkins/jenkins:2.414.2</span><br><span class="line">docker start jenkins</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/10/M5EsQGFc1BZRXKO.png" alt="image-20240710183915242.png"></p>
<p>这样就是启动成功了。然后通过8080端口进行访问。访问的过程会很慢等待一下。服务器内存最好大点，内存小的容易启动不起来。</p>
<p>通过log来看一下密码:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs 67166b666c76</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/06/ikvAUXqgBdT3Yem.png" alt="image-20240710184049696.png"></p>
<p>访问之后，输入上面的密码。</p>
<p>点击继续后，选择 按照推荐安装插件。然后继续等待。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/10/c47Sz8MmHEie1q9.png" alt="image-20240710184132391.png"></p>
<p>界面如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/10/Xth1ImGUkQxvTeN.png" alt="image-20240710184237761.png"></p>
<p><strong>新建任务</strong></p>
<p>上面输入任务名称，下面选择构建自由风格</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/10/3I4O7YSW8Xm9Cag.png" alt="image-20240710184414482.png"></p>
<p>选择源码管理，配置maven，注意：maven一定要放到Jenkins的数据挂载目录内，这样容器才能读到。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/10/pXRAlrL3iSWkdMQ.png" alt="image-20240710184525082.png"></p>
<p><strong>配置ssh服务器</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/10/Af3ZOncUWhbgRmy.png" alt="image-20240710184610325.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/10/AdwqUtZPVxmolQb.png" alt="image-20240710184703520.png"></p>
<p>设置密码即可。</p>
<p><strong>配置ssh分发</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/10/9vxsIKnEQPHNF7k.png" alt="image-20240710184752937.png"></p>
<p><strong>配置shell脚本</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cp /var/jenkins_home/workspace/programmer-club-subject/programmer-club-subject/programmer-club-starter/target/programmer-club-starter.jar /var/jenkins_home/jar/</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">APP_NAME=programmer-club-starter.jar</span><br><span class="line">LOG_NAME=programmer-club-starter.log</span><br><span class="line"></span><br><span class="line">pid=`ps -ef | grep $APP_NAME | grep -v grep|awk &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line"></span><br><span class="line">function is_exist()&#123;</span><br><span class="line">pid=`ps -ef | grep $APP_NAME | grep -v grep|awk &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">if [ -z $&#123;pid&#125; ]; then</span><br><span class="line">String=&quot;notExist&quot;</span><br><span class="line">echo $String</span><br><span class="line">else</span><br><span class="line">String=&quot;exist&quot;</span><br><span class="line">echo $String</span><br><span class="line">fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">str=$(is_exist)</span><br><span class="line">if [ $&#123;str&#125; = &quot;exist&quot; ]; then</span><br><span class="line">echo &quot; 检测到已经启动的程序，pid 是 $&#123;pid&#125; &quot;</span><br><span class="line">kill -9 $pid</span><br><span class="line">else</span><br><span class="line">echo &quot; 程序没有启动了 &quot;</span><br><span class="line">echo &quot;$&#123;APP_NAME&#125; is not running&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">str=$(is_exist)</span><br><span class="line">if [ $&#123;str&#125; = &quot;exist&quot; ]; then</span><br><span class="line">echo &quot;$&#123;APP_NAME&#125; 已经启动了. pid=$&#123;pid&#125; .&quot;</span><br><span class="line">else</span><br><span class="line">source /etc/profile</span><br><span class="line">BUILD_ID=dontKillMe</span><br><span class="line">nohup java -Xms300m -Xmx300m -jar /var/jenkins_home/jar/$APP_NAME   &gt;$LOG_NAME 2&gt;&amp;1 &amp;</span><br><span class="line">echo &quot;程序已重新启动...&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<h3 id="yum安装JDK"><a href="#yum安装JDK" class="headerlink" title="yum安装JDK"></a>yum安装JDK</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y java-1.8.0-openjdk.x86_64</span><br></pre></td></tr></table></figure>

<h3 id="Docker安装minio，搭建自己的oss服务器"><a href="#Docker安装minio，搭建自己的oss服务器" class="headerlink" title="Docker安装minio，搭建自己的oss服务器"></a>Docker安装minio，搭建自己的oss服务器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker search minio</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/10/iAn9flaIqCROozt.png" alt="image-20240710185255132.png"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker pull minio/minio</span><br><span class="line"></span><br><span class="line">docker run -p 9000:9000 -p 9090:9090 \</span><br><span class="line"> --name minio \</span><br><span class="line"> -d --restart=always \</span><br><span class="line"> -e &quot;MINIO_ACCESS_KEY=minioadmin&quot; \</span><br><span class="line"> -e &quot;MINIO_SECRET_KEY=minioadmin&quot; \</span><br><span class="line"> -v /mydata/minio/data:/data \</span><br><span class="line"> minio/minio server \</span><br><span class="line"> /data --console-address &quot;:9090&quot; -address &quot;:9000&quot;</span><br></pre></td></tr></table></figure>

<p>启动后，访问机器ip+9090，进入minio的界面，输入用户名或密码后可以访问。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/10/g5FPeCrX4x1AbWd.png" alt="image-20240710185416658.png"></p>
<h4 id="Docker安装miniomc突破7天限制"><a href="#Docker安装miniomc突破7天限制" class="headerlink" title="Docker安装miniomc突破7天限制"></a>Docker安装miniomc突破7天限制</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">docker pull minio/mc</span><br><span class="line"></span><br><span class="line">docker run -it --entrypoint=/bin/sh minio/mc</span><br><span class="line"></span><br><span class="line">mc config host add &lt;ALIAS&gt; &lt;YOUR-S3-ENDPOINT&gt; &lt;YOUR-ACCESS-KEY&gt; &lt;YOUR-SECRET-KEY&gt; [--api API-SIGNATURE]</span><br><span class="line"></span><br><span class="line">mc config host add minio http://xxx.xx.xx.xxx:9000 GrVCPXySKgGoJiGgXmtv 0xlqSI9GXvnBOtp0GwUj5OshKNBk9JgwoexotbVV</span><br><span class="line"></span><br><span class="line">mc ls minio</span><br><span class="line"></span><br><span class="line">mc anonymous</span><br><span class="line"></span><br><span class="line">mc anonymous set download minio/jichi</span><br></pre></td></tr></table></figure>

<h3 id="Docker查看运行容器启动命令"><a href="#Docker查看运行容器启动命令" class="headerlink" title="Docker查看运行容器启动命令"></a>Docker查看运行容器启动命令</h3><p>安装一个小工具 get_command_4_run_container</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull cucker/get_command_4_run_container</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">以nacos为例子</span></span><br><span class="line">docker run --rm -v /var/run/docker.sock:/var/run/docker.sock cucker/get_command_4_run_container nacos</span><br></pre></td></tr></table></figure>

<p>看到如下的启动命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \ </span><br><span class="line">--name nacos \ </span><br><span class="line">--privileged \ </span><br><span class="line">--cgroupns host \ </span><br><span class="line">--env JVM_XMX=256m \ </span><br><span class="line">--env MODE=standalone \ </span><br><span class="line">--env JVM_XMS=256m \ </span><br><span class="line">-p 8848:8848/tcp \ </span><br><span class="line">-p 9848:9848/tcp \ </span><br><span class="line">--restart=always \ </span><br><span class="line">-w /home/nacos \ </span><br><span class="line">nacos/nacos-server</span><br></pre></td></tr></table></figure>

<h3 id="Docker安装nacos"><a href="#Docker安装nacos" class="headerlink" title="Docker安装nacos"></a>Docker安装nacos</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker search nacos</span><br><span class="line">docker pull nacos/nacos-server</span><br></pre></td></tr></table></figure>

<p>镜像拉完之后，启动脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  --name nacos \</span><br><span class="line">  --privileged  \</span><br><span class="line">  --cgroupns host \</span><br><span class="line">  --env JVM_XMX=256m \</span><br><span class="line"> --env MODE=standalone \</span><br><span class="line">  --env JVM_XMS=256m \</span><br><span class="line">  -p 8848:8848/tcp \</span><br><span class="line">  -p 9848:9848/tcp \</span><br><span class="line">  --restart=always \</span><br><span class="line">  -w /home/nacos \</span><br><span class="line">  nacos/nacos-server</span><br></pre></td></tr></table></figure>

<p>云服务器不要忘记打开防火墙端口。</p>
<p>访问 ip 地址+8848 &#x2F;nacos 即可进入控制台</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/17/omQFLlRk7htf5bB.png" alt="image-20240717151037534.png"></p>
<p>nacos 的文档：<a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/docs/what-is-nacos.html">https://nacos.io/zh-cn/docs/what-is-nacos.html</a></p>
<p>nacos 的架构原理：<a target="_blank" rel="noopener" href="https://developer.aliyun.com/ebook/36?spm=a2c6h.20345107.ebook-index.18.152c2984fsi5ST">https://developer.aliyun.com/ebook/36?spm=a2c6h.20345107.ebook-index.18.152c2984fsi5ST</a></p>
<h3 id="Docker安装Redis"><a href="#Docker安装Redis" class="headerlink" title="Docker安装Redis"></a>Docker安装Redis</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker search redis</span><br><span class="line">docker pull redis</span><br></pre></td></tr></table></figure>

<p>拉下镜像之后，点击下面地址选择自己需要的 redis 版本的配置文件</p>
<p><a target="_blank" rel="noopener" href="https://redis.io/docs/management/config/">https://redis.io/docs/management/config/</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/17/QifoExYAU6VzSnt.png" alt="image-20240717151249025.png"></p>
<p>提前在服务器建立 &#x2F;data&#x2F;redis 文件夹，touch 文件redis.conf，也可以上面的直接复制</p>
<p><code>redis.conf</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">protected-mode yes</span><br><span class="line">port 6379</span><br><span class="line">tcp-backlog 511</span><br><span class="line">timeout 0</span><br><span class="line">tcp-keepalive 300</span><br><span class="line">daemonize no</span><br><span class="line">pidfile /var/run/redis_6379.pid</span><br><span class="line">loglevel notice</span><br><span class="line">logfile &quot;&quot;</span><br><span class="line">databases 16</span><br><span class="line">always-show-logo no</span><br><span class="line">set-proc-title yes</span><br><span class="line">proc-title-template &quot;&#123;title&#125; &#123;listen-addr&#125; &#123;server-mode&#125;&quot;</span><br><span class="line">locale-collate &quot;&quot;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">启动命令</span><br><span class="line">docker run -p 6379:6379 --name redis -v /data/redis/redis.conf:/etc/redis/redis.conf  -v /data/redis/data:/data -d redis redis-server /etc/redis/redis.conf --appendonly yes</span><br></pre></td></tr></table></figure>

<p>-p 6379:6379:把容器内的6379端口映射到宿主机6379端口 </p>
<p>-v &#x2F;data&#x2F;redis&#x2F;redis.conf:&#x2F;etc&#x2F;redis&#x2F;redis.conf：把宿主机配置好的redis.conf放到容器内的这个位置中 </p>
<p>-v &#x2F;data&#x2F;redis&#x2F;data:&#x2F;data：把redis持久化的数据在宿主机内显示，做数据备份</p>
<p>redis-server &#x2F;etc&#x2F;redis&#x2F;redis.conf：这个是关键配置，让redis不是无配置启动，而是按照这个redis.conf的配置启动 </p>
<p>–appendonly yes：redis启动后数据持久化</p>
<p>工具：Redis Desktop Manager</p>
<p><strong>IDEA连接redis可以直接下载 plugin 的 redis 插件</strong></p>
<h3 id="Docker安装es"><a href="#Docker安装es" class="headerlink" title="Docker安装es"></a>Docker安装es</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line"></span><br><span class="line">docker search elasticsearch</span><br><span class="line"></span><br><span class="line">docker pull elasticsearch:7.3.1</span><br><span class="line"></span><br><span class="line">docker run -d --name elasticsearch -p 9200:9200 -p 9300:9300 -e &quot;discovery.type=single-node&quot;  -e ES_JAVA_OPTS=&quot;-Xms1024m -Xmx1024m&quot; 3d3aa92f641f</span><br></pre></td></tr></table></figure>

<p>启动成功之后，访问<a target="_blank" rel="noopener" href="http://xxx.xx.xx.xxx:9200/">http://xxx.xx.xx.xxx:9200/</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/17/g9zDn8wIMPYakiS.png" alt="image-20240717151757675.png"></p>
<p>看到这个就证明成功了！</p>
<p>插件：es-head</p>
<h3 id="docker安装xxl-job"><a href="#docker安装xxl-job" class="headerlink" title="docker安装xxl-job"></a>docker安装xxl-job</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">docker search xxl-job</span><br><span class="line">docker pull xuxueli/xxl-job-admin:2.4.0</span><br><span class="line"></span><br><span class="line">docker run  -d \</span><br><span class="line">        -p 8088:8088\</span><br><span class="line">        -v /tool/xxl-job/logs:/data/applogs \</span><br><span class="line">        -v /tool/xxl-job/application.properties:/xxl-job/xxl-job-admin/src/main/resources/application.properties \</span><br><span class="line">        -e PARAMS=&quot;--server.port=8088\</span><br><span class="line">        --spring.datasource.url=jdbc:mysql://xxx.xx.xx.xxx:3306/xxl_job?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai \</span><br><span class="line">        --spring.datasource.username=root \</span><br><span class="line">        --spring.datasource.password=Wing1Q2W#E&quot; \</span><br><span class="line">        --name xxl-job-admin  \</span><br><span class="line">xuxueli/xxl-job-admin:2.4.0</span><br></pre></td></tr></table></figure>

<h3 id="rocketmq安装"><a href="#rocketmq安装" class="headerlink" title="rocketmq安装"></a>rocketmq安装</h3><p>官网地址：<a target="_blank" rel="noopener" href="https://rocketmq.apache.org/">https://rocketmq.apache.org/</a></p>
<p>安装包上传到 linux 的&#x2F;soft 文件夹，没有此文件夹，先创建，不过在 es 的时候已经创建过了。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/17/eEKGOkDYhwJUHxT.png" alt="image-20240717152141331.png"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yum install unzip  可以解压zip包的依赖</span><br><span class="line">unzip rocketmq-all-4.8.0-bin-release.zip</span><br><span class="line">cd rocketmq-all-4.8.0-bin-release</span><br><span class="line">cd bin</span><br><span class="line">vim runserver.sh</span><br><span class="line">将其中的xmx，xms等进行修改256m，弄小一点，让服务器用</span><br><span class="line">vim runbroker.sh</span><br><span class="line">同理修改其中的xmx，xms等进行修改256m，弄小一点，让服务器用</span><br><span class="line">nohup sh mqnamesrv &amp;</span><br><span class="line">tail -f ~/logs/rocketmqlogs/namesrv.log</span><br></pre></td></tr></table></figure>

<p>启动broker</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export NAMESRV_ADDR=localhost:9876</span><br><span class="line">nohup sh mqbroker -n localhost:9876 &amp;</span><br><span class="line">tail -f ~/logs/rocketmqlogs/broker.log</span><br></pre></td></tr></table></figure>

<p>发送消息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sh tools.sh org.apache.rocketmq.example.quickstart.Producer</span><br><span class="line">sh tools.sh org.apache.rocketmq.example.quickstart.Consumer</span><br></pre></td></tr></table></figure>

<p>如果发送消息报错，建立文件夹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd ~/store</span><br><span class="line">mkdir commitlog </span><br><span class="line">cd commitlog</span><br><span class="line">mkdir consumequeue</span><br></pre></td></tr></table></figure>

<p>关闭</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sh bin/mqshutdown broker</span><br><span class="line">sh bin/mqshutdown namesrv</span><br></pre></td></tr></table></figure>

<p><strong>安装控制台</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/17/QmgKi1q86yeVaR3.png" alt="image-20240717152526211.png"></p>
<p>更改端口和配置文件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup java -Xms300m -Xmx300m -jar rocketmq-console.jar &gt; console.log &amp;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/17/QvTwp6AJcBnLKjV.png" alt="image-20240717152632964.png"></p>
<h2 id="第一部分"><a href="#第一部分" class="headerlink" title="第一部分"></a>第一部分</h2><h3 id="数据库表"><a href="#数据库表" class="headerlink" title="数据库表"></a>数据库表</h3><h4 id="数据库表建模JSON"><a href="#数据库表建模JSON" class="headerlink" title="数据库表建模JSON"></a>数据库表建模JSON</h4><p><strong>刷题模块</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/17/AE9ZyjdKSlap1tb.png" alt="image-20240717154028356.png"></p>
<p><strong>SQL</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `subject_radio`;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> `subject_radio`</span><br><span class="line">(</span><br><span class="line">    `id`             <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">    `subject_id`     <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;题目id&#x27;</span>,</span><br><span class="line">    `option_type`    tinyint(<span class="number">4</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;a,b,c,d&#x27;</span>,</span><br><span class="line">    `option_content` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;选项内容&#x27;</span>,</span><br><span class="line">    `is_correct`     tinyint(<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;是否正确&#x27;</span>,</span><br><span class="line">    `created_by`     <span class="type">varchar</span>(<span class="number">32</span>)  <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建人&#x27;</span>,</span><br><span class="line">    `created_time`   datetime     <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">    `update_by`      <span class="type">varchar</span>(<span class="number">32</span>)  <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改人&#x27;</span>,</span><br><span class="line">    `update_time`    datetime     <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">    `is_deleted`     <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;单选题信息表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `subject_multiple`;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> `subject_multiple`</span><br><span class="line">(</span><br><span class="line">    `id`             <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">    `subject_id`     <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;题目id&#x27;</span>,</span><br><span class="line">    `option_type`    <span class="type">bigint</span>(<span class="number">4</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;选项类型&#x27;</span>,</span><br><span class="line">    `option_content` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;选项内容&#x27;</span>,</span><br><span class="line">    `is_correct`     tinyint(<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;是否正确&#x27;</span>,</span><br><span class="line">    `created_by`     <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建人&#x27;</span>,</span><br><span class="line">    `created_time`   datetime    <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">    `update_by`      <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新人&#x27;</span>,</span><br><span class="line">    `update_time`    datetime    <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">    `is_deleted`     <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;多选题信息表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `subject_mapping`;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> `subject_mapping`</span><br><span class="line">(</span><br><span class="line">    `id`           <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">    `subject_id`   <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;题目id&#x27;</span>,</span><br><span class="line">    `category_id`  <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;分类id&#x27;</span>,</span><br><span class="line">    `label_id`     <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;标签id&#x27;</span>,</span><br><span class="line">    `created_by`   <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建人&#x27;</span>,</span><br><span class="line">    `created_time` datetime    <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">    `update_by`    <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改人&#x27;</span>,</span><br><span class="line">    `update_time`  datetime    <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">    `is_deleted`   <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">536</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;题目分类关系表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `subject_liked`;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> `subject_liked`</span><br><span class="line">(</span><br><span class="line">    `id`           <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">    `subject_id`   <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;题目id&#x27;</span>,</span><br><span class="line">    `like_user_id` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">COLLATE</span> utf8mb4_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;点赞人id&#x27;</span>,</span><br><span class="line">    `status`       <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;点赞状态 1点赞 0不点赞&#x27;</span>,</span><br><span class="line">    `created_by`   <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">CHARACTER SET</span> utf8  <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建人&#x27;</span>,</span><br><span class="line">    `created_time` datetime                        <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">    `update_by`    <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">CHARACTER SET</span> utf8  <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改人&#x27;</span>,</span><br><span class="line">    `update_time`  datetime                        <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">    `is_deleted`   <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (`id`),</span><br><span class="line">    <span class="keyword">UNIQUE</span> KEY `uniq_like` (`subject_id`,`like_user_id`) <span class="keyword">USING</span> BTREE COMMENT <span class="string">&#x27;点赞唯一索引&#x27;</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_bin COMMENT<span class="operator">=</span><span class="string">&#x27;题目点赞表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `subject_label`;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> `subject_label`</span><br><span class="line">(</span><br><span class="line">    `id`           <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">    `label_name`   <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;标签分类&#x27;</span>,</span><br><span class="line">    `sort_num`     <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;排序&#x27;</span>,</span><br><span class="line">    `category_id`  <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `created_by`   <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建人&#x27;</span>,</span><br><span class="line">    `created_time` datetime    <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">    `update_by`    <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新人&#x27;</span>,</span><br><span class="line">    `update_time`  datetime    <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">    `is_deleted`   <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">64</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;题目标签表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `subject_judge`;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> `subject_judge`</span><br><span class="line">(</span><br><span class="line">    `id`           <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">    `subject_id`   <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;题目id&#x27;</span>,</span><br><span class="line">    `is_correct`   tinyint(<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;是否正确&#x27;</span>,</span><br><span class="line">    `created_by`   <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建人&#x27;</span>,</span><br><span class="line">    `created_time` datetime    <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">    `update_by`    <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新人&#x27;</span>,</span><br><span class="line">    `update_time`  datetime    <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">    `is_deleted`   <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;判断题&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `subject_info`;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> `subject_info`</span><br><span class="line">(</span><br><span class="line">    `id`                <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">    `subject_name`      <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;题目名称&#x27;</span>,</span><br><span class="line">    `subject_difficult` tinyint(<span class="number">4</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;题目难度&#x27;</span>,</span><br><span class="line">    `settle_name`       <span class="type">varchar</span>(<span class="number">32</span>)  <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;出题人名&#x27;</span>,</span><br><span class="line">    `subject_type`      tinyint(<span class="number">4</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;题目类型 1单选 2多选 3判断 4简答&#x27;</span>,</span><br><span class="line">    `subject_score`     tinyint(<span class="number">4</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;题目分数&#x27;</span>,</span><br><span class="line">    `subject_parse`     <span class="type">varchar</span>(<span class="number">512</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;题目解析&#x27;</span>,</span><br><span class="line">    `created_by`        <span class="type">varchar</span>(<span class="number">32</span>)  <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建人&#x27;</span>,</span><br><span class="line">    `created_time`      datetime     <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">    `update_by`         <span class="type">varchar</span>(<span class="number">32</span>)  <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改人&#x27;</span>,</span><br><span class="line">    `update_time`       datetime     <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">    `is_deleted`        <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">327</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;题目信息表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `subject_category`;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> `subject_category`</span><br><span class="line">(</span><br><span class="line">    `id`            <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">    `category_name` <span class="type">varchar</span>(<span class="number">16</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;分类名称&#x27;</span>,</span><br><span class="line">    `category_type` tinyint(<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;分类类型&#x27;</span>,</span><br><span class="line">    `image_url`     <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;图标连接&#x27;</span>,</span><br><span class="line">    `parent_id`     <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;父级id&#x27;</span>,</span><br><span class="line">    `created_by`    <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建人&#x27;</span>,</span><br><span class="line">    `created_time`  datetime    <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">    `update_by`     <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新人&#x27;</span>,</span><br><span class="line">    `update_time`   datetime    <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">    `is_deleted`    tinyint(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;是否删除 0: 未删除 1: 已删除&#x27;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">12</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;题目分类&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `subject_brief`;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> `subject_brief`</span><br><span class="line">(</span><br><span class="line">    `id`             <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">    `subject_id`     <span class="type">int</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;题目id&#x27;</span>,</span><br><span class="line">    `subject_answer` text COMMENT <span class="string">&#x27;题目答案&#x27;</span>,</span><br><span class="line">    `created_by`     <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建人&#x27;</span>,</span><br><span class="line">    `created_time`   datetime    <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">    `update_by`      <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新人&#x27;</span>,</span><br><span class="line">    `update_time`    datetime    <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">    `is_deleted`     <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">280</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;简答题&#x27;</span>;</span><br></pre></td></tr></table></figure>



<h4 id="刷题模块数据模型"><a href="#刷题模块数据模型" class="headerlink" title="刷题模块数据模型"></a>刷题模块数据模型</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/17/V8iKD6RWFCJHUab.png" alt="image-20240717162213876.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/17/9I7ol1eVBZm3NvA.png" alt="image-20240717154416885.png"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/17/nbR4qgoGCBw93ik.png" alt="image-20240717154425945.png"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/17/iYCKuszXPJmLG5t.png" alt="image-20240717154441135.png"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/17/cuG26enxkZCDtps.png" alt="image-20240717162527674.png"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/17/KZSErI4H5tVxn2k.png" alt="image-20240717162448319.png"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/17/V2PGpheKlCJ1Dfw.png" alt="image-20240717154448206.png"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/17/b85pTjQCnKoW2VB.png" alt="image-20240717154500698.png"></p>
<p><strong>鉴权模块</strong></p>
<h3 id="1-刷题模块（微服务模块）"><a href="#1-刷题模块（微服务模块）" class="headerlink" title="1.刷题模块（微服务模块）"></a>1.刷题模块（微服务模块）</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/17/wl4dD9uVb1gnAtB.png" alt="image-20240717163944712.png"></p>
<p>starter类是用于放置整个项目的启动类的</p>
<h4 id="产品功能模块"><a href="#产品功能模块" class="headerlink" title="产品功能模块"></a>产品功能模块</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/10/weDZpG3xrbvXtnV.png" alt="image-20240710164145589.png"></p>
<h4 id="研发功能模块拆分"><a href="#研发功能模块拆分" class="headerlink" title="研发功能模块拆分"></a>研发功能模块拆分</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/10/xjnVqWl3YUD97AB.png" alt="image-20240710164949102.png"></p>
<h4 id="原型设计"><a href="#原型设计" class="headerlink" title="原型设计"></a>原型设计</h4><p>axrue+antdesign的组件库</p>
<h5 id="刷题首页"><a href="#刷题首页" class="headerlink" title="刷题首页"></a>刷题首页</h5><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/10/mLyW9JI56dVsefR.png" alt="image-20240710165032544.png"></p>
<h5 id="题目详情"><a href="#题目详情" class="headerlink" title="题目详情"></a>题目详情</h5><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/10/s5GYPwTHDFv6pe3.png" alt="image-20240710165319312.png"></p>
<h4 id="分类模块"><a href="#分类模块" class="headerlink" title="分类模块"></a>分类模块</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/10/OQNz3dAREaLeyTm.png" alt="image-20240710174638222.png"></p>
<p><strong>分类的概念是面试题的大类。其中我们有两种概念：</strong></p>
<ol>
<li><strong>一种是岗位分类，例如后端，前端，测试。</strong></li>
<li><strong>一种是岗位下细分的分类，比如后端下细分，框架，并发，集合等等。</strong></li>
</ol>
<h5 id="新增分类"><a href="#新增分类" class="headerlink" title="新增分类"></a>新增分类</h5><p>正常的业务逻辑，保证新增后，可以正常的插入数据库即可。</p>
<h5 id="修改分类"><a href="#修改分类" class="headerlink" title="修改分类"></a>修改分类</h5><p>crud</p>
<h5 id="删除分类"><a href="#删除分类" class="headerlink" title="删除分类"></a>删除分类</h5><p>crud</p>
<h5 id="首页的分类"><a href="#首页的分类" class="headerlink" title="首页的分类"></a>首页的分类</h5><p>可以扩展做成做成缓存，不易变的数据，直接从redis查缓存。</p>
<p>缓存预热这种，启动项目之后，扔进去。</p>
<p>目前做成串行化的，二期可以优化，由前端先查询岗位大类，然后再根据大类查询小类。</p>
<h4 id="标签详细设计"><a href="#标签详细设计" class="headerlink" title="标签详细设计"></a>标签详细设计</h4><p>标签的概念是分类下的细分。标签是通用性的，独立的个体，与分类不进行强耦合，和题目相关。标签和分类是公用的，多个分类可以对应同一个标签。</p>
<h5 id="新增标签"><a href="#新增标签" class="headerlink" title="新增标签"></a>新增标签</h5><p>crud 直接看代码</p>
<h5 id="修改标签"><a href="#修改标签" class="headerlink" title="修改标签"></a>修改标签</h5><p>crud</p>
<h5 id="删除标签"><a href="#删除标签" class="headerlink" title="删除标签"></a>删除标签</h5><p>crud</p>
<h5 id="标签查询"><a href="#标签查询" class="headerlink" title="标签查询"></a>标签查询</h5><p>根据分类去查询标签，要通过题目信息的关联表来进行查询。详细看代码</p>
<p>以上功能涉及到 subject_label 表</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/10/omhFSeL9tyZRjVJ.png" alt="7yCAHGEJegnk5NF[1].png"></p>
<h4 id="题目模块"><a href="#题目模块" class="headerlink" title="题目模块"></a>题目模块</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/10/MLmSYUluqyNp1sz.png" alt="image-20240710174839950.png"></p>
<p>题目分为单选，多选，判断，简单，四种数据类型，在设计数据的时候，拆分成了题目的主表和其他对应的表来做。</p>
<h5 id="新增题目"><a href="#新增题目" class="headerlink" title="新增题目"></a>新增题目</h5><p>注意：采取工厂+策略的模式去做扩展，现在有四种题型，未来无论加多少种，都可以不用动主流程。</p>
<p>后期会结合es 做题目的查重。为搜索做准备。</p>
<h5 id="修改题目"><a href="#修改题目" class="headerlink" title="修改题目"></a>修改题目</h5><p>crud</p>
<h5 id="删除题目"><a href="#删除题目" class="headerlink" title="删除题目"></a>删除题目</h5><p>要注意删除主表的同时，也把其他的细分的数据表进行同步的处理。</p>
<h5 id="题目列表"><a href="#题目列表" class="headerlink" title="题目列表"></a>题目列表</h5><p>难度不大，就是个简单的分页的查询，分类、标签，难度这些其实都是入参的场景。</p>
<p>查标签，难度啊，出题人啊，等等，这些就直接查，不做join。</p>
<h5 id="题目的详情"><a href="#题目的详情" class="headerlink" title="题目的详情"></a>题目的详情</h5><p>也做一下工厂+策略吧</p>
<p>此功能涉及如下数据表</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/10/x2aCvEXZFSIl6N7.png" alt="image-20240710171403151.png"></p>
<h4 id="刷题模块代码的实现（jc-club-subject）"><a href="#刷题模块代码的实现（jc-club-subject）" class="headerlink" title="刷题模块代码的实现（jc-club-subject）"></a>刷题模块代码的实现（jc-club-subject）</h4><h5 id="application层的SubjectController（应用层初探-SpringMVC集成）"><a href="#application层的SubjectController（应用层初探-SpringMVC集成）" class="headerlink" title="application层的SubjectController（应用层初探&amp;SpringMVC集成）"></a>application层的SubjectController（应用层初探&amp;SpringMVC集成）</h5><p>在<code>jc-club-subject</code>中的<code>jc-club-application-controller</code>中的<code>controller</code>模块下面建立<code>SubjectController.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jingdianjichi.subject.application.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 刷题controller</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/subject&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubjectController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/test&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">    	<span class="keyword">return</span> <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里给出的测试代码如上。</p>
<p>在<code>jc-club-subject</code>中的<code>jc-club-starter</code>包中有<code>SubjectApplication.java</code>作为启动类,并且需要修改<code>pom.xml</code>中的内容，让启动类能够访问到<code>jc-club-application-controller</code>中的代码内容。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">//jc-club-starter的pom.xml,在starter中关于启动的配置是写在resources中的application.yml文件中的，包裹数据库连接,redis等等</span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.jingdianjichi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jc-club-application-controller<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SubjectApplication.java 启动类</span></span><br><span class="line"><span class="keyword">package</span> com.jingdianjichi.subject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.annotation.MapperScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.EnableFeignClients;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 刷题微服务启动类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: ChickenWing</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2023/10/1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.jingdianjichi&quot;)</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.jingdianjichi.**.mapper&quot;)</span></span><br><span class="line"><span class="meta">@EnableFeignClients(basePackages = &quot;com.jingdianjichi&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubjectApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(SubjectApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>记得maven install</p>
<h5 id="mysql-druid-mybatis集成-infrastructure层"><a href="#mysql-druid-mybatis集成-infrastructure层" class="headerlink" title="mysql,druid,mybatis集成(infrastructure层)"></a>mysql,druid,mybatis集成(infrastructure层)</h5><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Bb15070047748/article/details/107188167/?ops_request_misc=&request_id=&biz_id=102&utm_term=&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-1-107188167.nonecase&spm=1018.2226.3001.4187#{}&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-1-107188167.nonecase">彻底搞懂MyBaits中#{}和${}的区别_mybatis #{}-CSDN博客</a></p>
<p>在<code>jc-club-subject</code>中的<code>jc-club-infra</code>包中</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">//pom.xml</span><br><span class="line"> <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- jdbcStarter --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- druid连接池 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- mysql --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- mybatisplus --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>做<strong>subject_category</strong>这个模块</p>
<p>用IDEA自带是数据库工具去连上MySQL</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/20/fDcwKd4ak8NtzXj.png" alt="image-20240720131302130.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/20/HANolc9JDCsXFhy.png" alt="image-20240720131412700.png"><br>联上数据库后，右键category表，然后Eazycode，选择目录，放在<code>jc-club-infra</code>包下的basic目录中，<code>template</code>选择<code>mapper.xml.vm, dao.java.vm, entity.java.vm, service.java.vm, serviceImpl.java.vm</code>(下面两张图是项目结束后完整的截图，这里就涉及到了mybatis)</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/20/sYgHreQo5bGAaxq.png" alt="image-20240720132232428.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/20/y4JMCVFKU3uv2lf.png" alt="image-20240720132254642.png"></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/quest101/article/details/105624322?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522172154711316800226546866%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=172154711316800226546866&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-1-105624322-null-null.142">https://blog.csdn.net/quest101/article/details/105624322?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522172154711316800226546866%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=172154711316800226546866&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-1-105624322-null-null.142</a></p>
<p>[mybatis-plus关于@Mapper、@Repository、@MapperScan、xml文件的相关问题_mybatisplus repository-CSDN博客](<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41428418/article/details/132575881?ops_request_misc=&request_id=&biz_id=102&utm_term=mapperscan">https://blog.csdn.net/qq_41428418/article/details/132575881?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=mapperscan</a> resulttype&#x3D;&amp;utm_medium&#x3D;distribute.pc_search_result.none-task-blog-2<del>all</del>sobaiduweb~default-1-132575881.142^v100^pc_search_result_base8&amp;spm&#x3D;1018.2226.3001.4187)</p>
<p>继续在<code>jc-club-starter</code>模块的<code>pom.xml</code>中引入当前的<code>jc-club-infra</code>模块</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">//jc-club-starter的pom.xml</span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.jingdianjichi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jc-club-application-controller<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.jingdianjichi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jc-club-infra<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>jc-club-subject</code>中的<code>jc-club-starter</code>中的<code>resources</code>中的<code>application.yml</code>中，定义了服务器和数据源的配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="string">port:3000</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/jc-club?serverTimezone=Asia/Shanghai&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=true</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">    <span class="attr">druid:</span></span><br><span class="line">      <span class="attr">initial-size:</span> <span class="number">20</span></span><br><span class="line">      <span class="attr">min-idle:</span> <span class="number">20</span></span><br><span class="line">      <span class="attr">max-active:</span> <span class="number">100</span></span><br><span class="line">      <span class="attr">max-wait:</span> <span class="number">60000</span></span><br><span class="line">      <span class="attr">stat-view-servlet:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">url-pattern:</span> <span class="string">/druid/*</span></span><br><span class="line">        <span class="attr">login-username:</span> <span class="string">admin</span></span><br><span class="line">        <span class="attr">login-password:</span> <span class="number">123456</span></span><br><span class="line">      <span class="attr">filter:</span></span><br><span class="line">        <span class="attr">stat:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">slow-sql-millis:</span> <span class="number">2000</span></span><br><span class="line">          <span class="attr">log-slow-sql:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">wall:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>server</code>: 定义了服务器的配置。</p>
<ul>
<li><code>port</code>: 指定了服务器运行的端口号，这里是 <code>3000</code>。</li>
</ul>
</li>
<li><p><code>spring</code>: 包含了Spring框架的配置。</p>
<ul>
<li><code>datasource</code>: 定义了数据源的配置，用于数据库连接。<ul>
<li><code>username</code>: 数据库的用户名，这里是 <code>root</code>。</li>
<li><code>password</code>: 数据库的密码，这里是 <code>123456</code>。</li>
<li><code>driver-class-name</code>: MySQL数据库驱动的类名。</li>
<li><code>url</code>: 数据库的连接URL，包括数据库地址、端口、数据库名以及一些连接参数。这里的URL表明连接到本地的MySQL服务器上的 <code>jc-club</code> 数据库，并且指定了时区、字符编码和SSL的使用。</li>
<li><code>type</code>: 指定了数据源的类型，这里使用的是阿里巴巴的Druid连接池。</li>
<li><code>druid</code>: Druid连接池的特定配置。<ul>
<li><code>initial-size</code>: 连接池的初始大小，这里是 <code>20</code>。</li>
<li><code>min-idle</code>: 连接池中最小的空闲连接数，这里是 <code>20</code>。</li>
<li><code>max-active</code>: 连接池中最大的活动连接数，这里是 <code>100</code>。</li>
<li><code>max-wait</code>: 连接池中获取连接的最大等待时间（毫秒），这里是 <code>60000</code> 毫秒（即60秒）。</li>
<li><code>stat-view-servlet</code>: 用于Druid的监控页面。<ul>
<li><code>enabled</code>: 是否启用监控页面，这里是 <code>true</code>。</li>
<li><code>url-pattern</code>: 监控页面的URL模式。</li>
<li><code>login-username</code>: 监控页面的登录用户名。</li>
<li><code>login-password</code>: 监控页面的登录密码。</li>
</ul>
</li>
<li><code>filter</code>: 定义了Druid的过滤器配置。<ul>
<li><code>stat</code>: 用于统计的过滤器。<ul>
<li><code>enabled</code>: 是否启用统计过滤器，这里是 <code>true</code>。</li>
<li><code>slow-sql-millis</code>: 执行时间超过多少毫秒的SQL被认为是慢查询，这里是 <code>2000</code> 毫秒。</li>
<li><code>log-slow-sql</code>: 是否记录慢查询的日志，这里是 <code>true</code>。</li>
</ul>
</li>
<li><code>wall</code>: 用于防火墙的过滤器，用于防止SQL注入。<ul>
<li><code>enabled</code>: 是否启用防火墙过滤器，这里是 <code>true</code>。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>在<code>jc-club-subject</code>中的<code>jc-club-application-controller</code>中的<code>pom.xml</code>中引入<code>jc-club-infra</code>模块</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jc-club-application<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.jingdianjichi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jc-club-application-controller<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.compilerVersion</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.compilerVersion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.jingdianjichi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jc-club-infra<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在<code>jc-club-subject</code>中的<code>jc-club-application-controller</code>中的<code>SubjectController.java</code>中新增一段对数据库的测试代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jingdianjichi.subject.application.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 刷题controller</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/subject&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubjectController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/test&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">SubjectCategory</span> <span class="variable">subjectCategory</span> <span class="operator">=</span> subjectCategoryService.queryById(<span class="number">1L</span>);</span><br><span class="line">        <span class="keyword">return</span> subjectCategory;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试成功</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/21/V6nFPGIOk5UmXSu.png" alt="image-20240721152600418.png"></p>
<h5 id="基于druid配置文件加密（infra中的工具类）"><a href="#基于druid配置文件加密（infra中的工具类）" class="headerlink" title="基于druid配置文件加密（infra中的工具类）"></a>基于druid配置文件加密（infra中的工具类）</h5><p>在<code>jc-club-subject</code>中的<code>jc-club-infra/basic</code>中新建一个<code>utils</code>包，建一个用于数据库加密的<code>DruidEncrypUtil.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jingdianjichi.subject.infra.basic.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.druid.filter.config.ConfigTools;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchProviderException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DruidEncryptUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String publicKey;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String privateKey;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String[] keyPair = ConfigTools.genKeyPair(<span class="number">512</span>);</span><br><span class="line">            privateKey = keyPair[<span class="number">0</span>]; <span class="comment">//私钥</span></span><br><span class="line">            System.out.println(<span class="string">&quot;privateKey:&quot;</span> + privateKey);</span><br><span class="line">            publicKey = keyPair[<span class="number">1</span>]; <span class="comment">//公钥</span></span><br><span class="line">            System.out.println(<span class="string">&quot;publicKey:&quot;</span> + publicKey);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchProviderException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//加密</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">encrypt</span><span class="params">(String plainText)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">encrypt</span> <span class="operator">=</span> ConfigTools.encrypt(privateKey, plainText);</span><br><span class="line">        System.out.println(<span class="string">&quot;encrypt:&quot;</span> + encrypt);</span><br><span class="line">        <span class="keyword">return</span> encrypt;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//解密</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">decrypt</span><span class="params">(String encryptText)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">decrypt</span> <span class="operator">=</span> ConfigTools.decrypt(publicKey, encryptText);</span><br><span class="line">        System.out.println(<span class="string">&quot;decrypt:&quot;</span> + decrypt);</span><br><span class="line">        <span class="keyword">return</span> decrypt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">encrypt</span> <span class="operator">=</span> encrypt(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;encrypt:&quot;</span> + encrypt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>生成的公私钥和加密的密码</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/20/trGKkfQ7o2C9MqU.png" alt="image-20240720154842241.png"></p>
<p>在<code>jc-club-subject</code>中的<code>jc-club-starter</code>中修改<code>application.yml</code>，在<code>password、config和publicKey</code>处进行修改:</p>
<ul>
<li><p><code>config</code>: 配置过滤器，这里启用了配置过滤器。</p>
</li>
<li><p><code>connectionProperties</code>: 连接属性，这里配置了解密配置，<code>config.decrypt=true</code> 表示开启解密功能，<code>config.decrypt.key=$&#123;publicKey&#125;</code> 表示使用配置的公钥属性进行解密。</p>
</li>
<li><p><code>publicKey</code>: 定义了一个公钥，用于与 <code>connectionProperties</code> 中的 <code>config.decrypt.key</code> 配合，进行数据库密码的解密。</p>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="string">port:3000</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">Me2Tw8jJlEU2C3ghYkBPPfauoyYKXOnb7iTsOHbISHU/mC1ol9OUvU3O9klxv1o5UEv49mErTSawnrw4zsG+5g==</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/jc-club?serverTimezone=Asia/Shanghai&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=true</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">    <span class="attr">druid:</span></span><br><span class="line">      <span class="attr">initial-size:</span> <span class="number">20</span></span><br><span class="line">      <span class="attr">min-idle:</span> <span class="number">20</span></span><br><span class="line">      <span class="attr">max-active:</span> <span class="number">100</span></span><br><span class="line">      <span class="attr">max-wait:</span> <span class="number">60000</span></span><br><span class="line">      <span class="attr">connectionProperties:</span> <span class="string">config.decrypt=true;config.decrypt.key=$&#123;publicKey&#125;;</span></span><br><span class="line">      <span class="attr">stat-view-servlet:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">url-pattern:</span> <span class="string">/druid/*</span></span><br><span class="line">        <span class="attr">login-username:</span> <span class="string">admin</span></span><br><span class="line">        <span class="attr">login-password:</span> <span class="number">123456</span></span><br><span class="line">      <span class="attr">filter:</span></span><br><span class="line">        <span class="attr">stat:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">slow-sql-millis:</span> <span class="number">2000</span></span><br><span class="line">          <span class="attr">log-slow-sql:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">wall:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">config:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span> </span><br><span class="line"><span class="attr">publicKey:</span> <span class="string">MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAIKZoTIyh/UEThK6nHOmxVlsSYM6o5qTle39c8NilMUjIln2P3bll86R0asiMLU2p2S81RRfARjIO1im8dNBvS8CAwEAAQ==</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>现在数据库可以通过加密后的密码连上了</p>
<h5 id="分层架构业务开发"><a href="#分层架构业务开发" class="headerlink" title="分层架构业务开发"></a>分层架构业务开发</h5><p>所有接口如图所示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/22/kZsLMm7DNdGpfSX.png" alt="image-20240722125513009.png"></p>
<h6 id="题目分类-SubjectCategoryController-java"><a href="#题目分类-SubjectCategoryController-java" class="headerlink" title="题目分类(SubjectCategoryController.java)"></a>题目分类(SubjectCategoryController.java)</h6><p>这部分内容中，<code>SujectCategoryController</code>作为对题目类型涉及到get、post增删改查的入口，其中包含都在<code>jc-club-application-controller</code>中的<code>SubjectCategoryServiceImpl</code>和<code>SubjectCategoryDomainServiceImpl</code>。该controller通过<code>jc-club-application-convert</code>组件中<code>SubjectCategoryDTOConverter</code>的将DTO-&gt;BO&#x2F;BO-&gt;DTO，再利用<code>SubjectCategoryDomainServiceImpl</code>组件的add方法，其中涉及到<code>jc-club-domain-convert</code>组件中的<code>SubjectCategoryConverter</code>将BO-&gt;Category，在通过<code>SubjectCategoryServiceImpl</code>调用<code>infra</code>层的<code>SubjectCategoryConverter</code>将Category类转化为DAO。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45067224/article/details/130882294?ops_request_misc=%7B%22request_id%22:%22172154968616800188590959%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=172154968616800188590959&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-130882294-null-null.142%5Ev100%5Epc_search_result_base8&utm_term=mapstruct.Mapper&spm=1018.2226.3001.4187">MapStruct转换器常见问题及其使用方式_@inheritinverseconfiguration-CSDN博客</a></p>
<p>这里的convert的实现是利用@Mapper注解到converter类的</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/hellozhxy/article/details/121403654?ops_request_misc=%7B%22request_id%22:%22172154968616800188590959%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=172154968616800188590959&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~baidu_landing_v2~default-4-121403654-null-null.142%5Ev100%5Epc_search_result_base8&utm_term=mapstruct.Mapper&spm=1018.2226.3001.4187">MapStruct使用详解-CSDN博客</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.mapstruct.Mapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SubjectCategoryDTOConverter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">SubjectCategoryDTOConverter</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> Mappers.getMapper(SubjectCategoryDTOConverter.class);</span><br><span class="line"></span><br><span class="line">    List&lt;SubjectCategoryDTO&gt; <span class="title function_">convertBoToCategoryDTOList</span><span class="params">(List&lt;SubjectCategoryBO&gt; subjectCategoryDTO)</span>;</span><br><span class="line"></span><br><span class="line">    SubjectCategoryBO <span class="title function_">convertDtoToCategoryBO</span><span class="params">(SubjectCategoryDTO subjectCategoryDTO)</span>;</span><br><span class="line"></span><br><span class="line">    SubjectCategoryDTO <span class="title function_">convertBoToCategoryDTO</span><span class="params">(SubjectCategoryBO subjectCategoryBO)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol>
<li><p>新增分类（<code>POST: /subject/category/add</code>）</p>
<p>请求<code>body</code>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;categoryName&quot;</span><span class="punctuation">:</span><span class="string">&quot;后端&quot;</span>，</span><br><span class="line">	<span class="attr">&quot;categoryType&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;parentId&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;imgUrl&quot;</span><span class="punctuation">:</span><span class="string">&quot;http://image/123&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>响应成功示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;code&quot;</span><span class="punctuation">:</span><span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;message&quot;</span><span class="punctuation">:</span><span class="string">&quot;新增成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;data&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;reqUuid&quot;</span><span class="punctuation">:</span><span class="string">&quot;123123123.123123.123123&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;success&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>新增<code>jc-club-common</code>包：</p>
<ol>
<li><p><code>Lombok</code>是一个Java库，它通过注解的方式提供了一系列可以简化Java代码的工具，比如自动生成getter、setter、toString等方法。</p>
</li>
<li><p><code>MapStruct</code>是一个代码生成器，用于将Java方法的输入参数映射到输出参数，通常用于DTO（数据传输对象）和Entity（实体）之间的映射。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Kevinnsm/article/details/114998540?ops_request_misc=%7B%22request_id%22:%22172146370216800184185770%22,%22scm%22:%2220140713.130102334.pc_all.%22%7D&request_id=172146370216800184185770&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-5-114998540-null-null.142%5Ev100%5Epc_search_result_base8&utm_term=%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E5%AF%B9%E8%B1%A1%E4%B8%8E%E5%AE%9E%E4%BD%93&spm=1018.2226.3001.4187">DTO数据传输对象详解_dto撖寡情-CSDN博客</a></p>
</li>
<li><p><code>mapstruct-processor</code>，是MapStruct的注解处理器部分，用于在编译时生成映射代码。</p>
</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//pom.xml 注意lombok放在mapstruct前面是为了能够正常的拿到数据。如果项目中使用了lombok，那么需要在编译器指定他们的执行顺序，因为mapstrut底层是靠set/get赋值的，所以需要lombok先编译。</span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.2.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.2.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>jc-club-infra</code>中的<code>entity</code>下的<code>SubjectCategory.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jingdianjichi.subject.infra.basic.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 题目分类(SubjectCategory)实体类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span> <span class="comment">//导入了Lombok库中的@Data注解。@Data是一个便利的注解，它为类自动生成getter和setter方法、equals()、hashCode()和toString()方法。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubjectCategory</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123; <span class="comment">//序列化</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分类名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String categoryName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分类类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer categoryType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 图标连接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String imageUrl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 父级id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long parentId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建人</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String createdBy;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date createdTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新人</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String updateBy;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 逻辑删除 0未删除 1已删除</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer isDeleted;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>jc-club-infra</code>中的<code>mapper</code>下的<code>SubjectCategoryDao.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jingdianjichi.subject.infra.basic.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.subject.infra.basic.entity.SubjectCategory;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 题目分类(SubjectCategory)表数据库访问层</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SubjectCategoryDao</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过ID查询单条数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 实例对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SubjectCategory <span class="title function_">queryById</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 统计总行数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subjectCategory 查询条件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 总行数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">long</span> <span class="title function_">count</span><span class="params">(SubjectCategory subjectCategory)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subjectCategory 实例对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 影响行数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">insert</span><span class="params">(SubjectCategory subjectCategory)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量新增数据（MyBatis原生foreach方法）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> entities List&lt;SubjectCategory&gt; 实例对象列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 影响行数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">insertBatch</span><span class="params">(<span class="meta">@Param(&quot;entities&quot;)</span> List&lt;SubjectCategory&gt; entities)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量新增或按主键更新数据（MyBatis原生foreach方法）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> entities List&lt;SubjectCategory&gt; 实例对象列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 影响行数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> org.springframework.jdbc.BadSqlGrammarException 入参是空List的时候会抛SQL语句错误的异常，请自行校验入参</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">insertOrUpdateBatch</span><span class="params">(<span class="meta">@Param(&quot;entities&quot;)</span> List&lt;SubjectCategory&gt; entities)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subjectCategory 实例对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 影响行数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">update</span><span class="params">(SubjectCategory subjectCategory)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过主键删除数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 影响行数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">deleteById</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;SubjectCategory&gt; <span class="title function_">queryCategory</span><span class="params">(SubjectCategory subjectCategory)</span>;</span><br><span class="line"></span><br><span class="line">    Integer <span class="title function_">querySubjectCount</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>jc-club-infra</code>中的<code>service</code>下的<code>SubjectCategoryServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jingdianjichi.subject.infra.basic.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.subject.infra.basic.entity.SubjectCategory;</span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.subject.infra.basic.mapper.SubjectCategoryDao;</span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.subject.infra.basic.service.SubjectCategoryService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 题目分类(SubjectCategory)表服务实现类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service(&quot;subjectCategoryService&quot;)</span> <span class="comment">//Spring注解，用于声明这个类是一个服务组件，并且可以通过subjectCategoryService这个名称获取到这个服务的实例。</span></span><br><span class="line"><span class="meta">@Slf4j</span> <span class="comment">//Lombok注解，自动为类生成一个日志对象(log)，使用SLF4J日志框架。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubjectCategoryServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">SubjectCategoryService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span> <span class="comment">//Spring注解，用于自动装配(注入)SubjectCategoryDao类型的bean到subjectCategoryDao字段。</span></span><br><span class="line">    <span class="keyword">private</span> SubjectCategoryDao subjectCategoryDao;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subjectCategory 实例对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 实例对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SubjectCategory <span class="title function_">insert</span><span class="params">(SubjectCategory subjectCategory)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(log.isInfoEnabled())&#123;</span><br><span class="line">            log.info(<span class="string">&quot;SubjectCategoryController.add.subjectCategory:&#123;&#125;&quot;</span></span><br><span class="line">                    , JSON.toJSONString(subjectCategory));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.subjectCategoryDao.insert(subjectCategory);</span><br><span class="line">        <span class="keyword">return</span> subjectCategory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SubjectCategory <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.subjectCategoryDao.queryById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subjectCategory 实例对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 实例对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">update</span><span class="params">(SubjectCategory subjectCategory)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.subjectCategoryDao.update(subjectCategory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过主键删除数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 是否成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">deleteById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.subjectCategoryDao.deleteById(id) &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;SubjectCategory&gt; <span class="title function_">queryCategory</span><span class="params">(SubjectCategory subjectCategory)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.subjectCategoryDao.queryCategory(subjectCategory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">querySubjectCount</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.subjectCategoryDao.querySubjectCount(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>jc-club-domain</code>中的<code>pom.xml</code>引入<code>infra</code>模块，便于<code>jc-club-domain</code>中的<code>service/impl</code>下的<code>SubjectCategoryDomainServiceImpl.java</code>来引用</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jc-club-subject<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.jingdianjichi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jc-club-domain<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.jingdianjichi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jc-club-infra<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>jc-club-domain</code>中的<code>entity</code>下的<code>SubjectCategoryBO.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jingdianjichi.subject.domain.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 题目分类(SubjectCategory)实体类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> makejava</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2023-10-01 21:49:59</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubjectCategoryBO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分类名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String categoryName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分类类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer categoryType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 图标连接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String imageUrl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 父级id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long parentId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer count;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 标签bo数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SubjectLabelBO&gt; labelBOList;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>jc-club-domain</code>中的<code>service</code>下的<code>SubjectCategoryDomainService.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jingdianjichi.subject.domain.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.subject.domain.entity.SubjectCategoryBO;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SubjectCategoryDomainService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增分类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(SubjectCategoryBO subjectCategoryBO)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询岗位大类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;SubjectCategoryBO&gt; <span class="title function_">queryCategory</span><span class="params">(SubjectCategoryBO subjectCategoryBO)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新分类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Boolean <span class="title function_">update</span><span class="params">(SubjectCategoryBO subjectCategoryBO)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除分类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Boolean <span class="title function_">delete</span><span class="params">(SubjectCategoryBO subjectCategoryBO)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询分类及标签</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;SubjectCategoryBO&gt; <span class="title function_">queryCategoryAndLabel</span><span class="params">(SubjectCategoryBO subjectCategoryBO)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>怎么将BO转为Category呢？这里需要在<code>jc-club-domain</code>中的<code>convert</code>包设置<code>SubjectCategoryConverter.java</code>，用到mapstruct。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SubjectCategoryConverter.java</span></span><br><span class="line"><span class="keyword">package</span> com.jingdianjichi.subject.domain.convert;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.subject.domain.entity.SubjectCategoryBO;</span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.subject.infra.basic.entity.SubjectCategory;</span><br><span class="line"><span class="keyword">import</span> org.mapstruct.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.mapstruct.factory.Mappers;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SubjectCategoryConverter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">SubjectCategoryConverter</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> Mappers.getMapper(SubjectCategoryConverter.class);</span><br><span class="line"></span><br><span class="line">    SubjectCategory <span class="title function_">convertBoToCategory</span><span class="params">(SubjectCategoryBO subjectCategoryBO)</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;SubjectCategoryBO&gt; <span class="title function_">convertBoToCategory</span><span class="params">(List&lt;SubjectCategory&gt; categoryList)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//此时`jc-club-domain`中的`service`下的`SubjectCategoryDomainServiceImpl.java`就可以调用这个了</span></span><br><span class="line"><span class="keyword">package</span> com.jingdianjichi.subject.domain.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubjectCategoryDomainServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">SubjectCategoryDomainService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SubjectCategoryService subjectCategoryService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(SubjectCategoryBO subjectCategoryBO)</span> &#123;</span><br><span class="line">        <span class="type">SubjectCategory</span> <span class="variable">subjectCategory</span> <span class="operator">=</span> SubjectCategoryConverter.INSTANCE</span><br><span class="line">                .convertBoToCategory(subjectCategoryBO); <span class="comment">//BO-&gt;SujectCategory</span></span><br><span class="line">        subjectCategory.setIsDeleted(IsDeletedFlagEnum.UN_DELETED.getCode());</span><br><span class="line">        subjectCategoryService.insert(subjectCategory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>jc-club-subject</code>中的<code>jc-club-application-controller</code>的<code>pom.xml</code>中新增<code>jc-club-domain</code>，目的是在创建<code>SubjectCategoryController</code>时能正常引入。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//pom.xml</span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.jingdianjichi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jc-club-infra<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.jingdianjichi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jc-club-domain<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>jc-club-subject</code>中的<code>jc-club-application-controller</code>的<code>SubjectCategoryController.java</code>。这里会涉及到在<code>jc-club-application-dto</code>模块下的从BO到DTO的转换。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SubjectCategoryDTO.java BO-&gt;DTO</span></span><br><span class="line"><span class="keyword">package</span> com.jingdianjichi.subject.application.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 题目分类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: ChickenWing</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2023/10/3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubjectCategoryDTO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分类名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String categoryName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分类类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer categoryType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 图标连接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String imageUrl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 父级id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long parentId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer count;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 标签信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SubjectLabelDTO&gt; labelDTOList;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//SubjectCategoryDTOConverter.java</span></span><br><span class="line"><span class="keyword">package</span> com.jingdianjichi.subject.application.convert;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.subject.application.dto.SubjectCategoryDTO;</span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.subject.domain.entity.SubjectCategoryBO;</span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.subject.infra.basic.entity.SubjectCategory;</span><br><span class="line"><span class="keyword">import</span> org.mapstruct.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.mapstruct.factory.Mappers;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 题目分类dto转换器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SubjectCategoryDTOConverter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">SubjectCategoryDTOConverter</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> Mappers.getMapper(SubjectCategoryDTOConverter.class);</span><br><span class="line"></span><br><span class="line">    List&lt;SubjectCategoryDTO&gt; <span class="title function_">convertBoToCategoryDTOList</span><span class="params">(List&lt;SubjectCategoryBO&gt; subjectCategoryDTO)</span>;</span><br><span class="line"></span><br><span class="line">    SubjectCategoryBO <span class="title function_">convertDtoToCategoryBO</span><span class="params">(SubjectCategoryDTO subjectCategoryDTO)</span>;</span><br><span class="line"></span><br><span class="line">    SubjectCategoryDTO <span class="title function_">convertBoToCategoryDTO</span><span class="params">(SubjectCategoryBO subjectCategoryBO)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SubjectCategoryController.java</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/subject/category&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubjectCategoryController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SubjectCategoryDomainService subjectCategoryDomainService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">add</span><span class="params">(<span class="meta">@RequestBody</span> SubjectCategoryDTO subjectCategoryDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            SubjectCategoryBO subjectCategoryBO=SubjectCategoryDTOConverter.INSTANCE.convertDtoToBO(subjectCategoryDTO);</span><br><span class="line">            subjectDomainService.add(subjectCategoryBO);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(<span class="literal">true</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="literal">false</span>); <span class="comment">//这里的返回结果在jc-club-common中的entity模块设计一个Result类来统一返回</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于会涉及到结果返回：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//jc-club-common/entity Result.java</span></span><br><span class="line"><span class="keyword">package</span> com.jingdianjichi.subject.common.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.subject.common.enums.ResultCodeEnum;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Result</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Boolean success;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Result <span class="title function_">ok</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Result</span>();</span><br><span class="line">        result.setSuccess(<span class="literal">true</span>);</span><br><span class="line">        result.setCode(ResultCodeEnum.SUCCESS.getCode());</span><br><span class="line">        result.setMessage(ResultCodeEnum.SUCCESS.getDesc());</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Result <span class="title function_">ok</span><span class="params">(T data)</span>&#123;</span><br><span class="line">        <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Result</span>();</span><br><span class="line">        result.setSuccess(<span class="literal">true</span>);</span><br><span class="line">        result.setCode(ResultCodeEnum.SUCCESS.getCode());</span><br><span class="line">        result.setMessage(ResultCodeEnum.SUCCESS.getDesc());</span><br><span class="line">        result.setData(data);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Result <span class="title function_">fail</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Result</span>();</span><br><span class="line">        result.setSuccess(<span class="literal">false</span>);</span><br><span class="line">        result.setCode(ResultCodeEnum.FAIL.getCode());</span><br><span class="line">        result.setMessage(ResultCodeEnum.FAIL.getDesc());</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Result <span class="title function_">fail</span><span class="params">(T data)</span>&#123;</span><br><span class="line">        <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Result</span>();</span><br><span class="line">        result.setSuccess(<span class="literal">false</span>);</span><br><span class="line">        result.setCode(ResultCodeEnum.FAIL.getCode());</span><br><span class="line">        result.setMessage(ResultCodeEnum.FAIL.getDesc());</span><br><span class="line">        result.setData(data);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//jc-club-common/enums ResultCodeEnum.java</span></span><br><span class="line"><span class="keyword">package</span> com.jingdianjichi.subject.common.enums;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">ResultCodeEnum</span> &#123;</span><br><span class="line"></span><br><span class="line">    SUCCESS(<span class="number">200</span>,<span class="string">&quot;成功&quot;</span>),</span><br><span class="line">    FAIL(<span class="number">500</span>,<span class="string">&quot;失败&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String desc;</span><br><span class="line"></span><br><span class="line">    ResultCodeEnum(<span class="type">int</span> code,String desc)&#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ResultCodeEnum <span class="title function_">getByCode</span><span class="params">(<span class="type">int</span> codeVal)</span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(ResultCodeEnum resultCodeEnum : ResultCodeEnum.values())&#123;</span><br><span class="line">            <span class="keyword">if</span>(resultCodeEnum.code == codeVal)&#123;</span><br><span class="line">                <span class="keyword">return</span> resultCodeEnum;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>增加日志lo4j2和fastjson在<code>jc-club-common</code>中：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">//pom.xml</span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.2.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.2.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>对应的<code>SubjectCategoryController.java</code>和<code>SubjectCategoryDomainServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SubjectCategoryController.java</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/subject/category&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubjectCategoryController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SubjectCategoryDomainService subjectCategoryDomainService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">add</span><span class="params">(<span class="meta">@RequestBody</span> SubjectCategoryDTO subjectCategoryDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">        	<span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;SubjectCategoryController.add.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(subjectCategoryDTO));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/*这里log.isInfoEnabled()的作用是如果不加log.isDebugEnabled()等</span></span><br><span class="line"><span class="comment">进行预先判断，当系统loglevel设置高于Debug或Info或Trace时，虽然系统不会答应出这些级别的日志，但是每次还是会拼接</span></span><br><span class="line"><span class="comment">参数字符串/序列化，影响系统的性能。*/</span></span><br><span class="line">            SubjectCategoryBO subjectCategoryBO=SubjectCategoryDTOConverter.INSTANCE.convertDtoToBO(subjectCategoryDTO);</span><br><span class="line">            subjectDomainService.add(subjectCategoryBO);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(<span class="literal">true</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="literal">false</span>); <span class="comment">//这里的返回结果在jc-club-common中的entity模块设计一个Result类来统一返回</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//SubjectCategoryDomainServiceImpl.java</span></span><br><span class="line"><span class="keyword">package</span> com.jingdianjichi.subject.domain.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubjectCategoryDomainServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">SubjectCategoryDomainService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SubjectCategoryService subjectCategoryService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(SubjectCategoryBO subjectCategoryBO)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;SubjectCategoryController.add.bo:&#123;&#125;&quot;</span>, JSON.toJSONString(subjectCategoryBO));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">SubjectCategory</span> <span class="variable">subjectCategory</span> <span class="operator">=</span> SubjectCategoryConverter.INSTANCE</span><br><span class="line">                .convertBoToCategory(subjectCategoryBO); <span class="comment">//BO-&gt;SujectCategory</span></span><br><span class="line">        subjectCategory.setIsDeleted(IsDeletedFlagEnum.UN_DELETED.getCode());</span><br><span class="line">        subjectCategoryService.insert(subjectCategory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>preconditions参数校验</strong>：</p>
<p>回到<code>SubjectCategoryController.java</code>，进行参数校验，在<code>pom.xml</code>中添加<code>guava</code>（注意参数校验放在controller）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">//jc-club-common/pom.xml</span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.2.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.2.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>19.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SubjectCategoryController.java</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">add</span><span class="params">(<span class="meta">@RequestBody</span> SubjectCategoryDTO subjectCategoryDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;SubjectCategoryController.add.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(subjectCategoryDTO));</span><br><span class="line">            &#125;</span><br><span class="line">            Preconditions.checkNotNull(subjectCategoryDTO.getCategoryType(), <span class="string">&quot;分类类型不能为空&quot;</span>);</span><br><span class="line">            Preconditions.checkArgument(!StringUtils.isBlank(subjectCategoryDTO.getCategoryName()), <span class="string">&quot;分类名称不能为空&quot;</span>);</span><br><span class="line">            Preconditions.checkNotNull(subjectCategoryDTO.getParentId(), <span class="string">&quot;分类父级id不能为空&quot;</span>);</span><br><span class="line">            <span class="type">SubjectCategoryBO</span> <span class="variable">subjectCategoryBO</span> <span class="operator">=</span> SubjectCategoryDTOConverter.INSTANCE.convertDtoToCategoryBO(subjectCategoryDTO);</span><br><span class="line">            subjectCategoryDomainService.add(subjectCategoryBO);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(<span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;SubjectCategoryController.add.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;新增分类失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h6 id="刷题模块接口定义"><a href="#刷题模块接口定义" class="headerlink" title="刷题模块接口定义"></a>刷题模块接口定义</h6><ol>
<li>新增分类</li>
<li>更新分类</li>
<li>查询分类</li>
<li>查询大类下分类</li>
<li>查询分类及标签（二期优化）</li>
<li>删除分类</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/10/mLyW9JI56dVsefR.png" alt="image-20240710165032544.png"></p>
<p>分类-&gt;标签</p>
<p>基本的-&gt;二次优化</p>
<p>数据库-&gt;缓存优化</p>
<ol>
<li><p>新增分类：POST：&#x2F;subject&#x2F;category&#x2F;add</p>
<p>请求体：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;categoryName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;缓存&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;parentId&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;categoryType&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;imageUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://image/category.icon&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>响应成功示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;success&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>查询分类：POST：&#x2F;subject&#x2F;category&#x2F;queryPrimaryCategory</p>
<p>请求体：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;categoryType&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>响应示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;success&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">		<span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;categoryName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;后端&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;categoryType&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;imageUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://image/category.icon&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;parentId&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">65</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>查询大类下分类：POST：&#x2F;subject&#x2F;category&#x2F;queryCategoryByPrimary</p>
<p>请求体：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;parentId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;categoryType&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>响应示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;success&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">		<span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;categoryName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;框架&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;categoryType&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;imageUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://image/123&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;parentId&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">		<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;categoryName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;并发&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;categoryType&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;imageUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://image/123&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;parentId&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">		<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;categoryName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jvm&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;categoryType&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;imageUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://image/123&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;parentId&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>查询分类及标签（二期优化）</p>
<p>请求体：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>响应示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;success&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">		<span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;categoryName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;缓存&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;categoryType&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;imageUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://image/category.icon&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;parentId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;labelDTOList&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">				<span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;labelName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Redis&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;sortNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">				<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;labelName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;集群&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;sortNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">				<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">23</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;labelName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;实际应用&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;sortNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">				<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">34</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;labelName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;多线程&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;sortNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">				<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">44</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;labelName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;数据一致性&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;sortNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">				<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">46</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;labelName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;分布式&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;sortNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">				<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">47</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;labelName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;持久化&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;sortNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">				<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">49</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;labelName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;事务&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;sortNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			<span class="punctuation">]</span></span><br><span class="line">		<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;categoryName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;数据库&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;categoryType&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;imageUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://image/category.icon&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;parentId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;labelDTOList&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">				<span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;labelName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;进程&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;sortNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">				<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;labelName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Mysql&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;sortNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">				<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;labelName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;索引&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;sortNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">				<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">23</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;labelName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;实际应用&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;sortNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">				<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">33</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;labelName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;存储引擎&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;sortNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">				<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">44</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;labelName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;数据一致性&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;sortNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">				<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">49</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;labelName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;事务&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;sortNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			<span class="punctuation">]</span></span><br><span class="line">		<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;categoryName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;JavaSE&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;categoryType&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;imageUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://image/category.icon&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;parentId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;labelDTOList&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">				<span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">15</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;labelName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;基础&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;sortNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			<span class="punctuation">]</span></span><br><span class="line">		<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;categoryName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;框架&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;categoryType&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;imageUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://image/category.icon&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;parentId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;labelDTOList&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">				<span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">38</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;labelName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Spring&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;sortNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">				<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">62</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;labelName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SpringBoot&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;sortNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			<span class="punctuation">]</span></span><br><span class="line">		<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;categoryName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;消息队列&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;categoryType&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;imageUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://image/category.icon&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;parentId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;labelDTOList&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">				<span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">15</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;labelName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;基础&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;sortNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">				<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">23</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;labelName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;实际应用&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;sortNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			<span class="punctuation">]</span></span><br><span class="line">		<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;categoryName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;代码管理工具&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;categoryType&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;imageUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://image/category.icon&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;parentId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;labelDTOList&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">				<span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">25</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;labelName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Git&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;sortNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			<span class="punctuation">]</span></span><br><span class="line">		<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">9</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;categoryName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;网络&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;categoryType&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;imageUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://image/category.icon&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;parentId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;labelDTOList&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">				<span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">15</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;labelName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;基础&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;sortNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			<span class="punctuation">]</span></span><br><span class="line">		<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;categoryName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;操作系统&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;categoryType&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;imageUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://image/category.icon&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;parentId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;labelDTOList&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">				<span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">15</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;labelName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;基础&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;sortNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			<span class="punctuation">]</span></span><br><span class="line">		<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;categoryName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;最佳实践&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;categoryType&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;imageUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://image/category.icon&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;parentId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;labelDTOList&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">				<span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">23</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;labelName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;实际应用&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;sortNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">				<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">53</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;labelName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Jvm&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;sortNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			<span class="punctuation">]</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>这里优化后的其实是把大分类-&gt;小分类-&gt;标签全都查完了，是用的多线程去实现的</p>
<p>数据查完之后，再通过遍历然后利用某些规则，前端就能很轻松的查到了</p>
</li>
<li><p>删除分类</p>
<p>请求体:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>响应示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;success&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>更新分类</p>
<p>请求体:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;categoryName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Spring&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;categoryType&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;parentId&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;imageUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://image/123&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>响应示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;success&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h6 id="题目列表及详情接口定义"><a href="#题目列表及详情接口定义" class="headerlink" title="题目列表及详情接口定义"></a>题目列表及详情接口定义</h6><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/10/mLyW9JI56dVsefR.png" alt="image-20240710165032544.png"></p>
<p>涉及到难度，创建时间，题目，点赞收藏评论，创建人</p>
<p>分页查询</p>
<ol>
<li><p>查询题目列表（POST:&#x2F;subject&#x2F;category&#x2F;querySubjectList）</p>
<p>请求体：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;pageIndex&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;pageSize&quot;</span><span class="punctuation">:</span><span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;labelId&quot;</span><span class="punctuation">:</span><span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;difficulty&quot;</span><span class="punctuation">:</span><span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>响应示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;code&quot;</span><span class="punctuation">:</span><span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;message&quot;</span><span class="punctuation">:</span><span class="string">&quot;查询成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span><span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;totalPage&quot;</span><span class="punctuation">:</span><span class="number">20</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;pageList&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;subjectName&quot;</span><span class="punctuation">:</span><span class="string">&quot;SpringBoot的自动装配原理是什么?&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;subjectId&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;difficulty&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;labelNames&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">                    <span class="string">&quot;并发&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;集合&quot;</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span>，</span><br><span class="line">    <span class="string">&quot;reqUuid&quot;</span>：<span class="string">&quot;1231231223&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;success&quot;</span>：<span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h6 id="分类接口开发"><a href="#分类接口开发" class="headerlink" title="分类接口开发"></a>分类接口开发</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SubjectCategoryController.java</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询岗位大类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/queryPrimaryCategory&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;List&lt;SubjectCategoryDTO&gt;&gt; <span class="title function_">queryPrimaryCategory</span><span class="params">(<span class="meta">@RequestBody</span> SubjectCategoryDTO subjectCategoryDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">SubjectCategoryBO</span> <span class="variable">subjectCategoryBO</span> <span class="operator">=</span> SubjectCategoryDTOConverter.INSTANCE.</span><br><span class="line">                    convertDtoToCategoryBO(subjectCategoryDTO);</span><br><span class="line">            List&lt;SubjectCategoryBO&gt; subjectCategoryBOList = subjectCategoryDomainService.queryCategory(subjectCategoryBO);</span><br><span class="line">            List&lt;SubjectCategoryDTO&gt; subjectCategoryDTOList = SubjectCategoryDTOConverter.INSTANCE.</span><br><span class="line">                    convertBoToCategoryDTOList(subjectCategoryBOList);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(subjectCategoryDTOList);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;SubjectCategoryController.queryPrimaryCategory.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;查询失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//domain包里 SubjectCategoryDomainService.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SubjectCategoryDomainService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增分类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(SubjectCategoryBO subjectCategoryBO)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询岗位大类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;SubjectCategoryBO&gt; <span class="title function_">queryCategory</span><span class="params">(SubjectCategoryBO subjectCategoryBO)</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//domain包里 SubjectCategoryDomainServiceImpl.java</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;SubjectCategoryBO&gt; <span class="title function_">queryCategory</span><span class="params">(SubjectCategoryBO subjectCategoryBO)</span> &#123;</span><br><span class="line">        <span class="type">SubjectCategory</span> <span class="variable">subjectCategory</span> <span class="operator">=</span> SubjectCategoryConverter.INSTANCE</span><br><span class="line">                .convertBoToCategory(subjectCategoryBO);</span><br><span class="line">        subjectCategory.setIsDeleted(IsDeletedFlagEnum.UN_DELETED.getCode());</span><br><span class="line">        List&lt;SubjectCategory&gt; subjectCategoryList = subjectCategoryService.queryCategory(subjectCategory);</span><br><span class="line">        List&lt;SubjectCategoryBO&gt; boList = SubjectCategoryConverter.INSTANCE</span><br><span class="line">                .convertBoToCategory(subjectCategoryList);</span><br><span class="line">        <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;SubjectCategoryController.queryPrimaryCategory.boList:&#123;&#125;&quot;</span>,</span><br><span class="line">                    JSON.toJSONString(boList));</span><br><span class="line">        &#125;</span><br><span class="line">        boList.forEach(bo -&gt; &#123;</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">subjectCount</span> <span class="operator">=</span> subjectCategoryService.querySubjectCount(bo.getId());</span><br><span class="line">            bo.setCount(subjectCount);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> boList;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>controller:用converter DTO-&gt;BO</p>
<p>domainservice: converter bo-&gt;category，用service带着category去查,用Dao去查（dao的接口+dao.xml,mapperscan能扫描到）数据库，返回List<SubjectCategory></p>
<p>controller:用converter bolist-&gt;dtolist</p>
<p>返回dtolist，用Result封装一下，查出来了</p>
<p>关于为什么能够用Result返回用postman可以查到，其实用了@RestController标识：[SpringBoot以及集成组件注解大全详解（一）——lomback &amp;&amp; JPA_@componentscan是复合注解吗-CSDN博客](<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_42133100/article/details/89084518?ops_request_misc=%7B%22request_id%22:%22172154818816800186530805%22,%22scm%22:%2220140713.130102334.pc_all.%22%7D&request_id=172154818816800186530805&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-1-89084518-null-null.142%5Ev100%5Epc_search_result_base8&utm_term=lomback%E4%B8%AD@data">https://blog.csdn.net/qq_42133100/article/details/89084518?ops_request_misc=%7B%22request%5Fid%22%3A%22172154818816800186530805%22%2C%22scm%22%3A%2220140713.130102334.pc%5Fall.%22%7D&amp;request_id=172154818816800186530805&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-1-89084518-null-null.142^v100^pc_search_result_base8&amp;utm_term=lomback中@data</a> RestController&amp;spm&#x3D;1018.2226.3001.4187)</p>
<p>[【MyBatis】Dao接口和Dao.xml文件如何建立连接-CSDN博客](<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45156425/article/details/120956070?ops_request_misc=%7B%22request_id%22:%22172154533316800207082850%22,%22scm%22:%2220140713.130102334.pc_all.%22%7D&request_id=172154533316800207082850&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-1-120956070-null-null.142%5Ev100%5Epc_search_result_base8&utm_term=mybatis%E5%92%8Cdao">https://blog.csdn.net/weixin_45156425/article/details/120956070?ops_request_misc=%7B%22request%5Fid%22%3A%22172154533316800207082850%22%2C%22scm%22%3A%2220140713.130102334.pc%5Fall.%22%7D&amp;request_id=172154533316800207082850&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-1-120956070-null-null.142^v100^pc_search_result_base8&amp;utm_term=mybatis和dao</a> xml&amp;spm&#x3D;1018.2226.3001.4187)</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/21/V6nFPGIOk5UmXSu.png" alt="image-20240721152600418.png"></p>
<p><strong>根据大类查询二级分类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//更新SubjectCategoryDomainService.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SubjectCategoryDomainService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增分类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(SubjectCategoryBO subjectCategoryBO)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询岗位大类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;SubjectCategoryBO&gt; <span class="title function_">queryCategory</span><span class="params">(SubjectCategoryBO subjectCategoryBO)</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//SubjectCategoryController.java</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据分类id查二级分类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/queryCategoryByPrimary&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;List&lt;SubjectCategoryDTO&gt;&gt; <span class="title function_">queryCategoryByPrimary</span><span class="params">(<span class="meta">@RequestBody</span> SubjectCategoryDTO subjectCategoryDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;SubjectCategoryController.queryCategoryByPrimary.dto:&#123;&#125;&quot;</span></span><br><span class="line">                        , JSON.toJSONString(subjectCategoryDTO));</span><br><span class="line">            &#125;</span><br><span class="line">            Preconditions.checkNotNull(subjectCategoryDTO.getParentId(), <span class="string">&quot;分类id不能为空&quot;</span>);</span><br><span class="line">            <span class="type">SubjectCategoryBO</span> <span class="variable">subjectCategoryBO</span> <span class="operator">=</span> SubjectCategoryDTOConverter.INSTANCE.</span><br><span class="line">                    convertDtoToCategoryBO(subjectCategoryDTO);</span><br><span class="line">            List&lt;SubjectCategoryBO&gt; subjectCategoryBOList = subjectCategoryDomainService.queryCategory(subjectCategoryBO);</span><br><span class="line">            List&lt;SubjectCategoryDTO&gt; subjectCategoryDTOList = SubjectCategoryDTOConverter.INSTANCE.</span><br><span class="line">                    convertBoToCategoryDTOList(subjectCategoryBOList);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(subjectCategoryDTOList);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;SubjectCategoryController.queryPrimaryCategory.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;查询失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>更新分类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新分类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/update&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> SubjectCategoryDTO subjectCategoryDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;SubjectCategoryController.update.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(subjectCategoryDTO));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">SubjectCategoryBO</span> <span class="variable">subjectCategoryBO</span> <span class="operator">=</span> SubjectCategoryDTOConverter.INSTANCE.</span><br><span class="line">                    convertDtoToCategoryBO(subjectCategoryDTO);</span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">result</span> <span class="operator">=</span> subjectCategoryDomainService.update(subjectCategoryBO);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;SubjectCategoryController.update.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;更新分类失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//SubjectCategoryDomainService</span></span><br><span class="line">Boolean <span class="title function_">update</span><span class="params">(SubjectCategoryBO subjectCategoryBO)</span>;</span><br><span class="line"><span class="comment">//SubjectCategoryDomainServiceImpl</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">update</span><span class="params">(SubjectCategoryBO subjectCategoryBO)</span> &#123;</span><br><span class="line">        <span class="type">SubjectCategory</span> <span class="variable">subjectCategory</span> <span class="operator">=</span> SubjectCategoryConverter.INSTANCE</span><br><span class="line">                .convertBoToCategory(subjectCategoryBO);</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> subjectCategoryService.update(subjectCategory);</span><br><span class="line">        <span class="keyword">return</span> count &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//SubjectCategoryService</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">update</span><span class="params">(SubjectCategory subjectCategory)</span>;</span><br><span class="line"><span class="comment">//SubjectCategoryServiceImpl</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">update</span><span class="params">(SubjectCategory subjectCategory)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.subjectCategoryDao.update(subjectCategory);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//SubjectCategoryDao</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">update</span><span class="params">(SubjectCategory subjectCategory)</span>;</span><br><span class="line"><span class="comment">//接下来就是通过SubjectCategoryD.xml和mybatis组件去进行数据库的操作</span></span><br></pre></td></tr></table></figure>

<p><strong>删除分类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除分类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/delete&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">delete</span><span class="params">(<span class="meta">@RequestBody</span> SubjectCategoryDTO subjectCategoryDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;SubjectCategoryController.delete.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(subjectCategoryDTO));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">SubjectCategoryBO</span> <span class="variable">subjectCategoryBO</span> <span class="operator">=</span> SubjectCategoryDTOConverter.INSTANCE.</span><br><span class="line">                    convertDtoToCategoryBO(subjectCategoryDTO);</span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">result</span> <span class="operator">=</span> subjectCategoryDomainService.delete(subjectCategoryBO);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;SubjectCategoryController.delete.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;删除分类失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//SubjectCategoryDomainService</span></span><br><span class="line">Boolean <span class="title function_">delete</span><span class="params">(SubjectCategoryBO subjectCategoryBO)</span>;</span><br><span class="line"><span class="comment">//SubjectCategoryDomainServiceImpl</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">delete</span><span class="params">(SubjectCategoryBO subjectCategoryBO)</span> &#123;</span><br><span class="line">        <span class="type">SubjectCategory</span> <span class="variable">subjectCategory</span> <span class="operator">=</span> SubjectCategoryConverter.INSTANCE</span><br><span class="line">                .convertBoToCategory(subjectCategoryBO);</span><br><span class="line">        subjectCategory.setIsDeleted(IsDeletedFlagEnum.DELETED.getCode()); <span class="comment">//设置已经删除字段</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> subjectCategoryService.update(subjectCategory);</span><br><span class="line">        <span class="keyword">return</span> count &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//IsDeletedFlagEnum 在common包下的enum中</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">IsDeletedFlagEnum</span> &#123;</span><br><span class="line"></span><br><span class="line">    DELETED(<span class="number">1</span>,<span class="string">&quot;已删除&quot;</span>),</span><br><span class="line">    UN_DELETED(<span class="number">0</span>,<span class="string">&quot;未删除&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String desc;</span><br><span class="line"></span><br><span class="line">    IsDeletedFlagEnum(<span class="type">int</span> code, String desc)&#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> IsDeletedFlagEnum <span class="title function_">getByCode</span><span class="params">(<span class="type">int</span> codeVal)</span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(IsDeletedFlagEnum resultCodeEnum : IsDeletedFlagEnum.values())&#123;</span><br><span class="line">            <span class="keyword">if</span>(resultCodeEnum.code == codeVal)&#123;</span><br><span class="line">                <span class="keyword">return</span> resultCodeEnum;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//SubjectCategoryService</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">deleteById</span><span class="params">(Long id)</span>;</span><br><span class="line"><span class="comment">//SubjectCategoryServiceImpl</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">deleteById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.subjectCategoryDao.deleteById(id) &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//SubjectCategoryDao</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">deleteById</span><span class="params">(Long id)</span>;</span><br><span class="line"><span class="comment">//接下来就是通过SubjectCategoryD.xml和mybatis组件去进行数据库的操作</span></span><br></pre></td></tr></table></figure>

<h6 id="题目标签接口定义"><a href="#题目标签接口定义" class="headerlink" title="题目标签接口定义"></a>题目标签接口定义</h6><ol>
<li><p>新增标签</p>
<p>请求体：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;labelName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SpringMVC&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sortNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>响应示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;success&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>更新标签</p>
<p>请求体：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;labelName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Spring&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sortNum&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>响应示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;success&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>删除标签</p>
<p>请求体：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>响应示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;success&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>根据分类查询标签</p>
<p>请求体：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>响应示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;success&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">		<span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;labelName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SpringBoot&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;sortNum&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">		<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;categoryId&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;labelName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SpringMVC&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;sortNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h6 id="标签基础模块开发"><a href="#标签基础模块开发" class="headerlink" title="标签基础模块开发"></a>标签基础模块开发</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SubjectLabelController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubjectLabelController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SubjectLabelDomainService subjectLabelDomainService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增标签</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">add</span><span class="params">(<span class="meta">@RequestBody</span> SubjectLabelDTO subjectLabelDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;SubjectLabelController.add.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(subjectLabelDTO));</span><br><span class="line">            &#125;</span><br><span class="line">            Preconditions.checkArgument(!StringUtils.isBlank(subjectLabelDTO.getLabelName()),</span><br><span class="line">                    <span class="string">&quot;标签名称不能为空&quot;</span>);</span><br><span class="line">            <span class="type">SubjectLabelBO</span> <span class="variable">subjectLabelBO</span> <span class="operator">=</span> SubjectLabelDTOConverter.INSTANCE.convertDtoToLabelBO(subjectLabelDTO);</span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">result</span> <span class="operator">=</span> subjectLabelDomainService.add(subjectLabelBO);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;SubjectLabelController.add.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;新增标签失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新标签</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/update&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> SubjectLabelDTO subjectLabelDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;SubjectLabelController.update.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(subjectLabelDTO));</span><br><span class="line">            &#125;</span><br><span class="line">            Preconditions.checkNotNull(subjectLabelDTO.getId(), <span class="string">&quot;标签id不能为空&quot;</span>);</span><br><span class="line">            <span class="type">SubjectLabelBO</span> <span class="variable">subjectLabelBO</span> <span class="operator">=</span> SubjectLabelDTOConverter.INSTANCE.convertDtoToLabelBO(subjectLabelDTO);</span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">result</span> <span class="operator">=</span> subjectLabelDomainService.update(subjectLabelBO);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;SubjectLabelController.update.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;更新标签失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除标签</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/delete&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">delete</span><span class="params">(<span class="meta">@RequestBody</span> SubjectLabelDTO subjectLabelDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;SubjectLabelController.delete.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(subjectLabelDTO));</span><br><span class="line">            &#125;</span><br><span class="line">            Preconditions.checkNotNull(subjectLabelDTO.getId(), <span class="string">&quot;标签id不能为空&quot;</span>);</span><br><span class="line">            <span class="type">SubjectLabelBO</span> <span class="variable">subjectLabelBO</span> <span class="operator">=</span> SubjectLabelDTOConverter.INSTANCE.convertDtoToLabelBO(subjectLabelDTO);</span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">result</span> <span class="operator">=</span> subjectLabelDomainService.delete(subjectLabelBO);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;SubjectLabelController.delete.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;删除标签失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询分类下标签</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/queryLabelByCategoryId&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;List&lt;SubjectLabelDTO&gt;&gt; <span class="title function_">queryLabelByCategoryId</span><span class="params">(<span class="meta">@RequestBody</span> SubjectLabelDTO subjectLabelDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;SubjectLabelController.queryLabelByCategoryId.dto:&#123;&#125;&quot;</span>,</span><br><span class="line">                        JSON.toJSONString(subjectLabelDTO));</span><br><span class="line">            &#125;</span><br><span class="line">            Preconditions.checkNotNull(subjectLabelDTO.getCategoryId(), <span class="string">&quot;分类id不能为空&quot;</span>);</span><br><span class="line">            <span class="type">SubjectLabelBO</span> <span class="variable">subjectLabelBO</span> <span class="operator">=</span> SubjectLabelDTOConverter.INSTANCE.convertDtoToLabelBO(subjectLabelDTO);</span><br><span class="line">            List&lt;SubjectLabelBO&gt; resultList = subjectLabelDomainService.queryLabelByCategoryId(subjectLabelBO);</span><br><span class="line">            List&lt;SubjectLabelDTO&gt; subjectLabelDTOS = SubjectLabelDTOConverter.INSTANCE.convertBOToLabelDTOList(resultList);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(subjectLabelDTOS);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;SubjectLabelController.queryLabelByCategoryId.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;查询分类下标签失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SubjectLabelDTOConverter</span></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SubjectLabelDTOConverter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">SubjectLabelDTOConverter</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> Mappers.getMapper(SubjectLabelDTOConverter.class);</span><br><span class="line"></span><br><span class="line">    SubjectLabelBO <span class="title function_">convertDtoToLabelBO</span><span class="params">(SubjectLabelDTO subjectLabelDTO)</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;SubjectLabelDTO&gt; <span class="title function_">convertBOToLabelDTOList</span><span class="params">(List&lt;SubjectLabelBO&gt; boList)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//SubjectLabelConverter</span></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SubjectLabelConverter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">SubjectLabelConverter</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> Mappers.getMapper(SubjectLabelConverter.class);</span><br><span class="line"></span><br><span class="line">    SubjectLabel <span class="title function_">convertBoToLabel</span><span class="params">(SubjectLabelBO subjectLabelBO)</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;SubjectLabelBO&gt; <span class="title function_">convertLabelToBoList</span><span class="params">(List&lt;SubjectLabel&gt; subjectLabelList)</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//SubjectLabelDTO</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubjectLabelDTO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分类id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long categoryId;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 标签分类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String labelName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 排序</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer sortNum;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//SubjectLabelBO</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubjectLabelBO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 标签分类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String labelName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 排序</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer sortNum;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分类id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long categoryId;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SubjectLabelDomainService</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SubjectLabelDomainService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增标签</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Boolean <span class="title function_">add</span><span class="params">(SubjectLabelBO subjectLabelBO)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新标签</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Boolean <span class="title function_">update</span><span class="params">(SubjectLabelBO subjectLabelBO)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除标签</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Boolean <span class="title function_">delete</span><span class="params">(SubjectLabelBO subjectLabelBO)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询分类下标签</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;SubjectLabelBO&gt; <span class="title function_">queryLabelByCategoryId</span><span class="params">(SubjectLabelBO subjectLabelBO)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//SubjectLabelDomainServiceImpl</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubjectLabelDomainServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">SubjectLabelDomainService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SubjectLabelService subjectLabelService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SubjectMappingService subjectMappingService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SubjectCategoryService subjectCategoryService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">add</span><span class="params">(SubjectLabelBO subjectLabelBO)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;SubjectLabelDomainServiceImpl.add.bo:&#123;&#125;&quot;</span>, JSON.toJSONString(subjectLabelBO));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">SubjectLabel</span> <span class="variable">subjectLabel</span> <span class="operator">=</span> SubjectLabelConverter.INSTANCE</span><br><span class="line">                .convertBoToLabel(subjectLabelBO);</span><br><span class="line">        subjectLabel.setIsDeleted(IsDeletedFlagEnum.UN_DELETED.getCode());</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> subjectLabelService.insert(subjectLabel);</span><br><span class="line">        <span class="keyword">return</span> count &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">update</span><span class="params">(SubjectLabelBO subjectLabelBO)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;SubjectLabelDomainServiceImpl.update.bo:&#123;&#125;&quot;</span>, JSON.toJSONString(subjectLabelBO));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">SubjectLabel</span> <span class="variable">subjectLabel</span> <span class="operator">=</span> SubjectLabelConverter.INSTANCE</span><br><span class="line">                .convertBoToLabel(subjectLabelBO);</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> subjectLabelService.update(subjectLabel);</span><br><span class="line">        <span class="keyword">return</span> count &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">delete</span><span class="params">(SubjectLabelBO subjectLabelBO)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;SubjectLabelDomainServiceImpl.update.bo:&#123;&#125;&quot;</span>, JSON.toJSONString(subjectLabelBO));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">SubjectLabel</span> <span class="variable">subjectLabel</span> <span class="operator">=</span> SubjectLabelConverter.INSTANCE</span><br><span class="line">                .convertBoToLabel(subjectLabelBO);</span><br><span class="line">        subjectLabel.setIsDeleted(IsDeletedFlagEnum.DELETED.getCode());</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> subjectLabelService.update(subjectLabel);</span><br><span class="line">        <span class="keyword">return</span> count &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;SubjectLabelBO&gt; <span class="title function_">queryLabelByCategoryId</span><span class="params">(SubjectLabelBO subjectLabelBO)</span> &#123;</span><br><span class="line">        <span class="comment">//如果当前分类是1级分类，则查询所有标签</span></span><br><span class="line">        <span class="type">SubjectCategory</span> <span class="variable">subjectCategory</span> <span class="operator">=</span> subjectCategoryService.queryById(subjectLabelBO.getCategoryId());</span><br><span class="line">        <span class="keyword">if</span>(CategoryTypeEnum.PRIMARY.getCode() == subjectCategory.getCategoryType())&#123;</span><br><span class="line">            <span class="type">SubjectLabel</span> <span class="variable">subjectLabel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubjectLabel</span>();</span><br><span class="line">            subjectLabel.setCategoryId(subjectLabelBO.getCategoryId());</span><br><span class="line">            List&lt;SubjectLabel&gt; labelList = subjectLabelService.queryByCondition(subjectLabel);</span><br><span class="line">            List&lt;SubjectLabelBO&gt; labelResultList = SubjectLabelConverter.INSTANCE.convertLabelToBoList(labelList);</span><br><span class="line">            <span class="keyword">return</span> labelResultList;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">categoryId</span> <span class="operator">=</span> subjectLabelBO.getCategoryId();</span><br><span class="line">        <span class="type">SubjectMapping</span> <span class="variable">subjectMapping</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubjectMapping</span>();</span><br><span class="line">        subjectMapping.setCategoryId(categoryId);</span><br><span class="line">        subjectMapping.setIsDeleted(IsDeletedFlagEnum.UN_DELETED.getCode());</span><br><span class="line">        List&lt;SubjectMapping&gt; mappingList = subjectMappingService.queryLabelId(subjectMapping);</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(mappingList)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//将mappingList转换为一个流（Stream）,使用map操作对流中的每个元素（SubjectMapping对象）应用一个函数,使用collect操作将流中的元素汇总或归纳到一个新的集合中</span></span><br><span class="line">        List&lt;Long&gt; labelIdList = mappingList.stream().map(SubjectMapping::getLabelId).collect(Collectors.toList());</span><br><span class="line">        List&lt;SubjectLabel&gt; labelList = subjectLabelService.batchQueryById(labelIdList);</span><br><span class="line">        List&lt;SubjectLabelBO&gt; boList = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        labelList.forEach(label -&gt; &#123; <span class="comment">//lamda表达式</span></span><br><span class="line">            <span class="type">SubjectLabelBO</span> <span class="variable">bo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubjectLabelBO</span>();</span><br><span class="line">            bo.setId(label.getId());</span><br><span class="line">            bo.setLabelName(label.getLabelName());</span><br><span class="line">            bo.setCategoryId(categoryId);</span><br><span class="line">            bo.setSortNum(label.getSortNum());</span><br><span class="line">            boList.add(bo);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> boList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//SubjectMappingService</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SubjectMappingService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过ID查询单条数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 实例对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SubjectMapping <span class="title function_">queryById</span><span class="params">(<span class="type">int</span> id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subjectMapping 实例对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 实例对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SubjectMapping <span class="title function_">insert</span><span class="params">(SubjectMapping subjectMapping)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subjectMapping 实例对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 实例对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">update</span><span class="params">(SubjectMapping subjectMapping)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过主键删除数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 是否成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">deleteById</span><span class="params">(<span class="type">int</span> id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询标签id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;SubjectMapping&gt; <span class="title function_">queryLabelId</span><span class="params">(SubjectMapping subjectMapping)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量插入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">batchInsert</span><span class="params">(List&lt;SubjectMapping&gt; mappingList)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//SubjectMappingServiceImpl</span></span><br><span class="line"><span class="meta">@Service(&quot;subjectMappingService&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubjectMappingServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">SubjectMappingService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SubjectMappingDao subjectMappingDao;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过ID查询单条数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 实例对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SubjectMapping <span class="title function_">queryById</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.subjectMappingDao.queryById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subjectMapping 实例对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 实例对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SubjectMapping <span class="title function_">insert</span><span class="params">(SubjectMapping subjectMapping)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.subjectMappingDao.insert(subjectMapping);</span><br><span class="line">        <span class="keyword">return</span> subjectMapping;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subjectMapping 实例对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 实例对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">update</span><span class="params">(SubjectMapping subjectMapping)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.subjectMappingDao.update(subjectMapping);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过主键删除数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 是否成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">deleteById</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.subjectMappingDao.deleteById(id) &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;SubjectMapping&gt; <span class="title function_">queryLabelId</span><span class="params">(SubjectMapping subjectMapping)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.subjectMappingDao.queryDistinctLabelId(subjectMapping);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">batchInsert</span><span class="params">(List&lt;SubjectMapping&gt; mappingList)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.subjectMappingDao.insertBatch(mappingList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="标签业务改动"><a href="#标签业务改动" class="headerlink" title="标签业务改动"></a>标签业务改动</h6><p>将一级分类和标签联系起来</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/28/cHv61yPJdFUGBVZ.png" alt="image-20240728114457915.png"></p>
<p><code>SubjectLabelDao.xml</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/28/AjiBfXphTF9ctyV.png" alt="image-20240728114229629.png"></p>
<p>domain层也跟着改</p>
<h6 id="题目模块接口定义"><a href="#题目模块接口定义" class="headerlink" title="题目模块接口定义"></a>题目模块接口定义</h6><ol>
<li><p>新增单选题目</p>
<p>请求体：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;subjectName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SpringBoot自动装配原理是什么？&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;subjectDifficult&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;subjectType&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;subjectScore&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;subjectParse&quot;</span><span class="punctuation">:</span> <span class="string">&quot;题目解析&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;categoryIds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">        <span class="number">5</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;labelIds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="number">3</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;optionList&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;optionType&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;optionContent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;自动的&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;isCorrect&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;optionType&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;optionContent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;其实是用配置文件&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;isCorrect&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>响应成功示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;success&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>新增多选题目</p>
<p>请求体：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;subjectName&quot;</span>: <span class="string">&quot;SpringBoot自动装配原理是什么？&quot;</span>,</span><br><span class="line">    <span class="string">&quot;subjectDifficult&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&quot;subjectType&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">&quot;subjectScore&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">&quot;subjectParse&quot;</span>: <span class="string">&quot;题目解析&quot;</span>,</span><br><span class="line">    <span class="string">&quot;categoryIds&quot;</span>: [</span><br><span class="line">        <span class="number">4</span>,</span><br><span class="line">        <span class="number">5</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;labelIds&quot;</span>: [</span><br><span class="line">        <span class="number">2</span>,</span><br><span class="line">        <span class="number">3</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;optionList&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;optionType&quot;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="string">&quot;optionContent&quot;</span>: <span class="string">&quot;自动的&quot;</span>,</span><br><span class="line">            <span class="string">&quot;isCorrect&quot;</span>: <span class="number">1</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;optionType&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="string">&quot;optionContent&quot;</span>: <span class="string">&quot;其实是用配置文件&quot;</span>,</span><br><span class="line">            <span class="string">&quot;isCorrect&quot;</span>: <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>响应成功示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;success&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">	<span class="string">&quot;code&quot;</span>: <span class="number">200</span>,</span><br><span class="line">	<span class="string">&quot;message&quot;</span>: <span class="string">&quot;成功&quot;</span>,</span><br><span class="line">	<span class="string">&quot;data&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>新增判断题目</p>
<p>请求体：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;subjectName&quot;</span>: <span class="string">&quot;SpringBoot自动装配原理是什么？&quot;</span>,</span><br><span class="line">    <span class="string">&quot;subjectDifficult&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&quot;subjectType&quot;</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="string">&quot;subjectScore&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">&quot;subjectParse&quot;</span>: <span class="string">&quot;题目解析&quot;</span>,</span><br><span class="line">    <span class="string">&quot;categoryIds&quot;</span>: [</span><br><span class="line">        <span class="number">4</span>,</span><br><span class="line">        <span class="number">5</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;labelIds&quot;</span>: [</span><br><span class="line">        <span class="number">2</span>,</span><br><span class="line">        <span class="number">3</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;optionList&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;isCorrect&quot;</span>: <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>响应成功示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;success&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">	<span class="string">&quot;code&quot;</span>: <span class="number">200</span>,</span><br><span class="line">	<span class="string">&quot;message&quot;</span>: <span class="string">&quot;成功&quot;</span>,</span><br><span class="line">	<span class="string">&quot;data&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>新增简答题目</p>
<p>请求体：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;subjectName&quot;</span>: <span class="string">&quot;Mysql是个什么东西？&quot;</span>,</span><br><span class="line">    <span class="string">&quot;subjectDifficult&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&quot;subjectType&quot;</span>: <span class="number">4</span>,</span><br><span class="line">    <span class="string">&quot;subjectScore&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">&quot;subjectParse&quot;</span>: <span class="string">&quot;题目解析2&quot;</span>,</span><br><span class="line">    <span class="string">&quot;subjectAnswer&quot;</span>: <span class="string">&quot;Mysql是个数据库&quot;</span>,</span><br><span class="line">    <span class="string">&quot;categoryIds&quot;</span>: [</span><br><span class="line">        <span class="number">5</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;labelIds&quot;</span>: [</span><br><span class="line">        <span class="number">11</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>响应示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;success&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">	<span class="string">&quot;code&quot;</span>: <span class="number">200</span>,</span><br><span class="line">	<span class="string">&quot;message&quot;</span>: <span class="string">&quot;成功&quot;</span>,</span><br><span class="line">	<span class="string">&quot;data&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询题目列表</p>
<p>请求体：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;pageNo&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">&quot;pageSize&quot;</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="string">&quot;labelId&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&quot;categoryId&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">&quot;subjectDifficult&quot;</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>响应示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;success&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">	<span class="string">&quot;code&quot;</span>: <span class="number">200</span>,</span><br><span class="line">	<span class="string">&quot;message&quot;</span>: <span class="string">&quot;成功&quot;</span>,</span><br><span class="line">	<span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;pageNo&quot;</span>: <span class="number">1</span>,</span><br><span class="line">		<span class="string">&quot;pageSize&quot;</span>: <span class="number">20</span>,</span><br><span class="line">		<span class="string">&quot;total&quot;</span>: <span class="number">1</span>,</span><br><span class="line">		<span class="string">&quot;totalPages&quot;</span>: <span class="number">1</span>,</span><br><span class="line">		<span class="string">&quot;result&quot;</span>: [</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="string">&quot;pageNo&quot;</span>: <span class="number">1</span>,</span><br><span class="line">				<span class="string">&quot;pageSize&quot;</span>: <span class="number">20</span>,</span><br><span class="line">				<span class="string">&quot;id&quot;</span>: <span class="number">9</span>,</span><br><span class="line">				<span class="string">&quot;subjectName&quot;</span>: <span class="string">&quot;SpringBoot自动装配原理是什么？&quot;</span>,</span><br><span class="line">				<span class="string">&quot;subjectDifficult&quot;</span>: <span class="number">1</span>,</span><br><span class="line">				<span class="string">&quot;subjectType&quot;</span>: <span class="number">4</span>,</span><br><span class="line">				<span class="string">&quot;subjectScore&quot;</span>: <span class="number">2</span>,</span><br><span class="line">				<span class="string">&quot;subjectParse&quot;</span>: <span class="string">&quot;题目解析&quot;</span></span><br><span class="line">			&#125;</span><br><span class="line">		],</span><br><span class="line">		<span class="string">&quot;start&quot;</span>: <span class="number">1</span>,</span><br><span class="line">		<span class="string">&quot;end&quot;</span>: <span class="number">20</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询题目列表</p>
<p>请求体：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;pageNo&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">&quot;pageSize&quot;</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="string">&quot;labelId&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&quot;categoryId&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">&quot;subjectDifficult&quot;</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>响应示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;success&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">	<span class="string">&quot;code&quot;</span>: <span class="number">200</span>,</span><br><span class="line">	<span class="string">&quot;message&quot;</span>: <span class="string">&quot;成功&quot;</span>,</span><br><span class="line">	<span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;pageNo&quot;</span>: <span class="number">1</span>,</span><br><span class="line">		<span class="string">&quot;pageSize&quot;</span>: <span class="number">20</span>,</span><br><span class="line">		<span class="string">&quot;total&quot;</span>: <span class="number">1</span>,</span><br><span class="line">		<span class="string">&quot;totalPages&quot;</span>: <span class="number">1</span>,</span><br><span class="line">		<span class="string">&quot;result&quot;</span>: [</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="string">&quot;pageNo&quot;</span>: <span class="number">1</span>,</span><br><span class="line">				<span class="string">&quot;pageSize&quot;</span>: <span class="number">20</span>,</span><br><span class="line">				<span class="string">&quot;id&quot;</span>: <span class="number">9</span>,</span><br><span class="line">				<span class="string">&quot;subjectName&quot;</span>: <span class="string">&quot;SpringBoot自动装配原理是什么？&quot;</span>,</span><br><span class="line">				<span class="string">&quot;subjectDifficult&quot;</span>: <span class="number">1</span>,</span><br><span class="line">				<span class="string">&quot;subjectType&quot;</span>: <span class="number">4</span>,</span><br><span class="line">				<span class="string">&quot;subjectScore&quot;</span>: <span class="number">2</span>,</span><br><span class="line">				<span class="string">&quot;subjectParse&quot;</span>: <span class="string">&quot;题目解析&quot;</span></span><br><span class="line">			&#125;</span><br><span class="line">		],</span><br><span class="line">		<span class="string">&quot;start&quot;</span>: <span class="number">1</span>,</span><br><span class="line">		<span class="string">&quot;end&quot;</span>: <span class="number">20</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询题目详情</p>
<p>请求体：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="number">100</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>响应体：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;success&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">	<span class="string">&quot;code&quot;</span>: <span class="number">200</span>,</span><br><span class="line">	<span class="string">&quot;message&quot;</span>: <span class="string">&quot;成功&quot;</span>,</span><br><span class="line">	<span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;pageNo&quot;</span>: <span class="number">1</span>,</span><br><span class="line">		<span class="string">&quot;pageSize&quot;</span>: <span class="number">20</span>,</span><br><span class="line">		<span class="string">&quot;id&quot;</span>: <span class="number">9</span>,</span><br><span class="line">		<span class="string">&quot;subjectName&quot;</span>: <span class="string">&quot;SpringBoot自动装配原理是什么？&quot;</span>,</span><br><span class="line">		<span class="string">&quot;subjectDifficult&quot;</span>: <span class="number">1</span>,</span><br><span class="line">		<span class="string">&quot;subjectType&quot;</span>: <span class="number">4</span>,</span><br><span class="line">		<span class="string">&quot;subjectScore&quot;</span>: <span class="number">2</span>,</span><br><span class="line">		<span class="string">&quot;subjectParse&quot;</span>: <span class="string">&quot;题目解析&quot;</span>,</span><br><span class="line">		<span class="string">&quot;subjectAnswer&quot;</span>: <span class="string">&quot;题目答案&quot;</span>,</span><br><span class="line">		<span class="string">&quot;labelName&quot;</span>: [</span><br><span class="line">			<span class="string">&quot;SpringBoot&quot;</span>,</span><br><span class="line">			<span class="string">&quot;SpringMVC&quot;</span></span><br><span class="line">		]</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h6 id="题目模块接口开发"><a href="#题目模块接口开发" class="headerlink" title="题目模块接口开发"></a>题目模块接口开发</h6><p>题目模块接口开发是程序员社区项目中用于管理题目信息的核心部分。它涉及一系列接口，用于实现题目的新增、查询、更新和删除等操作。这些接口包括但不限于：</p>
<ul>
<li>新增单选、多选、判断和简答题目的接口，允许用户提交题目名称、难度、类型、分数、解析、所属分类和标签等信息。</li>
<li>查询题目列表的接口，支持分页查询，并可根据分类、标签、难度等条件进行筛选。</li>
<li>查询题目详情的接口，通过题目ID获取详细信息，包括题目类型、内容、选项、正确答案和解析等。</li>
</ul>
<p>代码层面，题目模块接口开发使用了Spring Boot框架来构建RESTful API，并采用了DTO（Data Transfer Object）和BO（Business Object）模式来分离数据传输和业务逻辑。通过MapStruct库实现了DTO与BO之间的自动转换，以简化代码并减少重复性工作。此外，服务层（Service）和数据访问层（DAO）的分离确保了业务逻辑的清晰和数据访问的高效性。</p>
<p>在实现上，题目模块接口利用了Lombok库来自动生成getter、setter等方法，以及使用Spring框架的注解如<code>@RestController</code>和<code>@RequestMapping</code>来简化路由配置。日志记录采用SLF4J与Log4j2，确保了日志的灵活性和可配置性。此外，通过使用Spring的事务管理<code>@Transactional</code>，保证了数据操作的原子性和一致性。</p>
<p>整体而言，题目模块接口开发为程序员社区项目提供了一个稳定、可扩展且易于维护的后端服务，以支持题目内容的管理与展示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SubjectInfoBO</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubjectInfoBO</span> <span class="keyword">extends</span> <span class="title class_">PageInfo</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 题目名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String subjectName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 题目难度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer subjectDifficult;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 出题人名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String settleName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 题目类型 1单选 2多选 3判断 4简答</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer subjectType;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 题目分数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer subjectScore;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 题目解析</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String subjectParse;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 题目答案</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String subjectAnswer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分类id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Integer&gt; categoryIds;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 标签id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Integer&gt; labelIds;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 标签name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; labelName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 答案选项</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SubjectAnswerBO&gt; optionList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long categoryId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long labelId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String keyWord;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建人昵称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String createUser;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建人头像</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String createUserAvatar;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 题目数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer subjectCount;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否被当前用户点赞</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Boolean liked;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前题目点赞的数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer likedCount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下一题</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long nextSubjectId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 上一题</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long lastSubjectId;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//PageResult</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageResult</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">pageNo</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">pageSize</span> <span class="operator">=</span> <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">total</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">totalPages</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;T&gt; result = Collections.emptyList();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">start</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">end</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRecords</span><span class="params">(List&lt;T&gt; result)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.result = result;</span><br><span class="line">        <span class="keyword">if</span> (result != <span class="literal">null</span> &amp;&amp; result.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            setTotal(result.size());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTotal</span><span class="params">(Integer total)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.total = total;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.pageSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.totalPages = (total / <span class="built_in">this</span>.pageSize) + (total % <span class="built_in">this</span>.pageSize == <span class="number">0</span> ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.totalPages = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.start = (<span class="built_in">this</span>.pageSize &gt; <span class="number">0</span> ? (<span class="built_in">this</span>.pageNo - <span class="number">1</span>) * <span class="built_in">this</span>.pageSize : <span class="number">0</span>) + <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">this</span>.end = (<span class="built_in">this</span>.start - <span class="number">1</span> + <span class="built_in">this</span>.pageSize * (<span class="built_in">this</span>.pageNo &gt; <span class="number">0</span> ? <span class="number">1</span> : <span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPageSize</span><span class="params">(Integer pageSize)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.pageSize = pageSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPageNo</span><span class="params">(Integer pageNo)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.pageNo = pageNo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//PageInfo</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageInfo</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">pageNo</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">pageSize</span> <span class="operator">=</span> <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getPageNo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (pageNo == <span class="literal">null</span> || pageNo &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> pageNo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getPageSize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (pageSize == <span class="literal">null</span> || pageSize &lt; <span class="number">1</span> || pageSize &gt; Integer.MAX_VALUE) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">20</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> pageSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//SubjectAnswerBO</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubjectAnswerBO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 答案选项标识</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer optionType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 答案</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String optionContent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否正确</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer isCorrect;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//SubjectAnswerDTO</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubjectAnswerDTO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 答案选项标识</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer optionType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 答案</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String optionContent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否正确</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer isCorrect;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//SubjectOptionBO</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubjectOptionBO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 题目答案</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String subjectAnswer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 答案选项</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SubjectAnswerBO&gt; optionList;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SubjectInfo</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubjectInfo</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">71318372165220898L</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 题目名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String subjectName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 题目难度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer subjectDifficult;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 出题人名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String settleName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 题目类型 1单选 2多选 3判断 4简答</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer subjectType;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 题目分数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer subjectScore;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 题目解析</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String subjectParse;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建人</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String createdBy;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date createdTime;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改人</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String updateBy;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Integer isDeleted;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer subjectCount;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SubjectInfoDTO</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubjectInfoDTO</span> <span class="keyword">extends</span> <span class="title class_">PageInfo</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 题目名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String subjectName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 题目难度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer subjectDifficult;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 出题人名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String settleName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 题目类型 1单选 2多选 3判断 4简答</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer subjectType;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 题目分数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer subjectScore;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 题目解析</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String subjectParse;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 题目答案</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String subjectAnswer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分类id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Integer&gt; categoryIds;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 标签id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Integer&gt; labelIds;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 答案选项</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SubjectAnswerDTO&gt; optionList;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 标签name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; labelName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long categoryId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long labelId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String keyWord;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建人昵称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String createUser;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建人头像</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String createUserAvatar;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 题目数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer subjectCount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否被当前用户点赞</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Boolean liked;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前题目点赞的数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer likedCount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下一题</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long nextSubjectId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 上一题</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long lastSubjectId;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//SubjectTypeHandler</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SubjectTypeHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 枚举身份的识别</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SubjectInfoTypeEnum <span class="title function_">getHandlerType</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实际的题目的插入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(SubjectInfoBO subjectInfoBO)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实际的题目的插入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SubjectOptionBO <span class="title function_">query</span><span class="params">(<span class="type">int</span> subjectId)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//BriefTypeHandler</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BriefTypeHandler</span> <span class="keyword">implements</span> <span class="title class_">SubjectTypeHandler</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SubjectBriefService subjectBriefService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SubjectInfoTypeEnum <span class="title function_">getHandlerType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SubjectInfoTypeEnum.BRIEF;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(SubjectInfoBO subjectInfoBO)</span> &#123;</span><br><span class="line">        <span class="type">SubjectBrief</span> <span class="variable">subjectBrief</span> <span class="operator">=</span> BriefSubjectConverter.INSTANCE.convertBoToEntity(subjectInfoBO);</span><br><span class="line">        subjectBrief.setSubjectId(subjectInfoBO.getId().intValue());</span><br><span class="line">        subjectBrief.setIsDeleted(IsDeletedFlagEnum.UN_DELETED.getCode());</span><br><span class="line">        subjectBriefService.insert(subjectBrief);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SubjectOptionBO <span class="title function_">query</span><span class="params">(<span class="type">int</span> subjectId)</span> &#123;</span><br><span class="line">        <span class="type">SubjectBrief</span> <span class="variable">subjectBrief</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubjectBrief</span>();</span><br><span class="line">        subjectBrief.setSubjectId(subjectId);</span><br><span class="line">        <span class="type">SubjectBrief</span> <span class="variable">result</span> <span class="operator">=</span> subjectBriefService.queryByCondition(subjectBrief);</span><br><span class="line">        <span class="type">SubjectOptionBO</span> <span class="variable">subjectOptionBO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubjectOptionBO</span>();</span><br><span class="line">        subjectOptionBO.setSubjectAnswer(result.getSubjectAnswer());</span><br><span class="line">        <span class="keyword">return</span> subjectOptionBO;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//JudgeTypeHandler</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JudgeTypeHandler</span> <span class="keyword">implements</span> <span class="title class_">SubjectTypeHandler</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SubjectJudgeService subjectJudgeService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SubjectInfoTypeEnum <span class="title function_">getHandlerType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SubjectInfoTypeEnum.JUDGE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(SubjectInfoBO subjectInfoBO)</span> &#123;</span><br><span class="line">        <span class="comment">//判断题目的插入</span></span><br><span class="line">        <span class="type">SubjectJudge</span> <span class="variable">subjectJudge</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubjectJudge</span>();</span><br><span class="line">        <span class="type">SubjectAnswerBO</span> <span class="variable">subjectAnswerBO</span> <span class="operator">=</span> subjectInfoBO.getOptionList().get(<span class="number">0</span>);</span><br><span class="line">        subjectJudge.setSubjectId(subjectInfoBO.getId());</span><br><span class="line">        subjectJudge.setIsCorrect(subjectAnswerBO.getIsCorrect());</span><br><span class="line">        subjectJudge.setIsDeleted(IsDeletedFlagEnum.UN_DELETED.getCode());</span><br><span class="line">        subjectJudgeService.insert(subjectJudge);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SubjectOptionBO <span class="title function_">query</span><span class="params">(<span class="type">int</span> subjectId)</span> &#123;</span><br><span class="line">        <span class="type">SubjectJudge</span> <span class="variable">subjectJudge</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubjectJudge</span>();</span><br><span class="line">        subjectJudge.setSubjectId(Long.valueOf(subjectId));</span><br><span class="line">        List&lt;SubjectJudge&gt; result = subjectJudgeService.queryByCondition(subjectJudge);</span><br><span class="line">        List&lt;SubjectAnswerBO&gt; subjectAnswerBOList = JudgeSubjectConverter.INSTANCE.convertEntityToBoList(result);</span><br><span class="line">        <span class="type">SubjectOptionBO</span> <span class="variable">subjectOptionBO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubjectOptionBO</span>();</span><br><span class="line">        subjectOptionBO.setOptionList(subjectAnswerBOList);</span><br><span class="line">        <span class="keyword">return</span> subjectOptionBO;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//MultipleTypeHandler</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultipleTypeHandler</span> <span class="keyword">implements</span> <span class="title class_">SubjectTypeHandler</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SubjectMultipleService subjectMultipleService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SubjectInfoTypeEnum <span class="title function_">getHandlerType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SubjectInfoTypeEnum.MULTIPLE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(SubjectInfoBO subjectInfoBO)</span> &#123;</span><br><span class="line">        <span class="comment">//多选题目的插入</span></span><br><span class="line">        List&lt;SubjectMultiple&gt; subjectMultipleList = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        subjectInfoBO.getOptionList().forEach(option -&gt; &#123;</span><br><span class="line">            <span class="type">SubjectMultiple</span> <span class="variable">subjectMultiple</span> <span class="operator">=</span> MultipleSubjectConverter.INSTANCE.convertBoToEntity(option);</span><br><span class="line">            subjectMultiple.setSubjectId(subjectInfoBO.getId());</span><br><span class="line">            subjectMultiple.setIsDeleted(IsDeletedFlagEnum.UN_DELETED.getCode());</span><br><span class="line">            subjectMultipleList.add(subjectMultiple);</span><br><span class="line">        &#125;);</span><br><span class="line">        subjectMultipleService.batchInsert(subjectMultipleList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SubjectOptionBO <span class="title function_">query</span><span class="params">(<span class="type">int</span> subjectId)</span> &#123;</span><br><span class="line">        <span class="type">SubjectMultiple</span> <span class="variable">subjectMultiple</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubjectMultiple</span>();</span><br><span class="line">        subjectMultiple.setSubjectId(Long.valueOf(subjectId));</span><br><span class="line">        List&lt;SubjectMultiple&gt; result = subjectMultipleService.queryByCondition(subjectMultiple);</span><br><span class="line">        List&lt;SubjectAnswerBO&gt; subjectAnswerBOList = MultipleSubjectConverter.INSTANCE.convertEntityToBoList(result);</span><br><span class="line">        <span class="type">SubjectOptionBO</span> <span class="variable">subjectOptionBO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubjectOptionBO</span>();</span><br><span class="line">        subjectOptionBO.setOptionList(subjectAnswerBOList);</span><br><span class="line">        <span class="keyword">return</span> subjectOptionBO;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//RadioTypeHandler</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RadioTypeHandler</span> <span class="keyword">implements</span> <span class="title class_">SubjectTypeHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SubjectRadioService subjectRadioService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SubjectInfoTypeEnum <span class="title function_">getHandlerType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SubjectInfoTypeEnum.RADIO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(SubjectInfoBO subjectInfoBO)</span> &#123;</span><br><span class="line">        <span class="comment">//单选题目的插入</span></span><br><span class="line">        List&lt;SubjectRadio&gt; subjectRadioList = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        subjectInfoBO.getOptionList().forEach(option -&gt; &#123;</span><br><span class="line">            <span class="type">SubjectRadio</span> <span class="variable">subjectRadio</span> <span class="operator">=</span> RadioSubjectConverter.INSTANCE.convertBoToEntity(option);</span><br><span class="line">            subjectRadio.setSubjectId(subjectInfoBO.getId());</span><br><span class="line">            subjectRadio.setIsDeleted(IsDeletedFlagEnum.UN_DELETED.getCode());</span><br><span class="line">            subjectRadioList.add(subjectRadio);</span><br><span class="line">        &#125;);</span><br><span class="line">        subjectRadioService.batchInsert(subjectRadioList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SubjectOptionBO <span class="title function_">query</span><span class="params">(<span class="type">int</span> subjectId)</span> &#123;</span><br><span class="line">        <span class="type">SubjectRadio</span> <span class="variable">subjectRadio</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubjectRadio</span>();</span><br><span class="line">        subjectRadio.setSubjectId(Long.valueOf(subjectId));</span><br><span class="line">        List&lt;SubjectRadio&gt; result = subjectRadioService.queryByCondition(subjectRadio);</span><br><span class="line">        List&lt;SubjectAnswerBO&gt; subjectAnswerBOList = RadioSubjectConverter.INSTANCE.convertEntityToBoList(result);</span><br><span class="line">        <span class="type">SubjectOptionBO</span> <span class="variable">subjectOptionBO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubjectOptionBO</span>();</span><br><span class="line">        subjectOptionBO.setOptionList(subjectAnswerBOList);</span><br><span class="line">        <span class="keyword">return</span> subjectOptionBO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SubjectController</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/subject&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubjectController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SubjectInfoDomainService subjectInfoDomainService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RocketMQTemplate rocketMQTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增题目</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">add</span><span class="params">(<span class="meta">@RequestBody</span> SubjectInfoDTO subjectInfoDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;SubjectController.add.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(subjectInfoDTO));</span><br><span class="line">            &#125;</span><br><span class="line">            Preconditions.checkArgument(!StringUtils.isBlank(subjectInfoDTO.getSubjectName()),</span><br><span class="line">                    <span class="string">&quot;题目名称不能为空&quot;</span>);</span><br><span class="line">            Preconditions.checkNotNull(subjectInfoDTO.getSubjectDifficult(), <span class="string">&quot;题目难度不能为空&quot;</span>);</span><br><span class="line">            Preconditions.checkNotNull(subjectInfoDTO.getSubjectType(), <span class="string">&quot;题目类型不能为空&quot;</span>);</span><br><span class="line">            Preconditions.checkNotNull(subjectInfoDTO.getSubjectScore(), <span class="string">&quot;题目分数不能为空&quot;</span>);</span><br><span class="line">            Preconditions.checkArgument(!CollectionUtils.isEmpty(subjectInfoDTO.getCategoryIds())</span><br><span class="line">                    , <span class="string">&quot;分类id不能为空&quot;</span>);</span><br><span class="line">            Preconditions.checkArgument(!CollectionUtils.isEmpty(subjectInfoDTO.getLabelIds())</span><br><span class="line">                    , <span class="string">&quot;标签id不能为空&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">SubjectInfoBO</span> <span class="variable">subjectInfoBO</span> <span class="operator">=</span> SubjectInfoDTOConverter.INSTANCE.convertDTOToBO(subjectInfoDTO); <span class="comment">//转为BO</span></span><br><span class="line">            List&lt;SubjectAnswerBO&gt; subjectAnswerBOS =</span><br><span class="line">                    SubjectAnswerDTOConverter.INSTANCE.convertListDTOToBO(subjectInfoDTO.getOptionList()); <span class="comment">//单独添加回答</span></span><br><span class="line">            subjectInfoBO.setOptionList(subjectAnswerBOS);</span><br><span class="line">            subjectInfoDomainService.add(subjectInfoBO);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(<span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;SubjectCategoryController.add.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;新增题目失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询题目列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/getSubjectPage&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;PageResult&lt;SubjectInfoDTO&gt;&gt; <span class="title function_">getSubjectPage</span><span class="params">(<span class="meta">@RequestBody</span> SubjectInfoDTO subjectInfoDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;SubjectController.getSubjectPage.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(subjectInfoDTO));</span><br><span class="line">            &#125;</span><br><span class="line">            Preconditions.checkNotNull(subjectInfoDTO.getCategoryId(), <span class="string">&quot;分类id不能为空&quot;</span>);</span><br><span class="line">            Preconditions.checkNotNull(subjectInfoDTO.getLabelId(), <span class="string">&quot;标签id不能为空&quot;</span>);</span><br><span class="line">            <span class="type">SubjectInfoBO</span> <span class="variable">subjectInfoBO</span> <span class="operator">=</span> SubjectInfoDTOConverter.INSTANCE.convertDTOToBO(subjectInfoDTO);</span><br><span class="line">            subjectInfoBO.setPageNo(subjectInfoDTO.getPageNo()); <span class="comment">//页码</span></span><br><span class="line">            subjectInfoBO.setPageSize(subjectInfoDTO.getPageSize()); <span class="comment">//大小</span></span><br><span class="line">            PageResult&lt;SubjectInfoBO&gt; boPageResult = subjectInfoDomainService.getSubjectPage(subjectInfoBO);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(boPageResult);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;SubjectCategoryController.add.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;分页查询题目失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询题目信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/querySubjectInfo&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;SubjectInfoDTO&gt; <span class="title function_">querySubjectInfo</span><span class="params">(<span class="meta">@RequestBody</span> SubjectInfoDTO subjectInfoDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;SubjectController.querySubjectInfo.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(subjectInfoDTO));</span><br><span class="line">            &#125;</span><br><span class="line">            Preconditions.checkNotNull(subjectInfoDTO.getId(), <span class="string">&quot;题目id不能为空&quot;</span>);</span><br><span class="line">            <span class="type">SubjectInfoBO</span> <span class="variable">subjectInfoBO</span> <span class="operator">=</span> SubjectInfoDTOConverter.INSTANCE.convertDTOToBO(subjectInfoDTO);</span><br><span class="line">            <span class="type">SubjectInfoBO</span> <span class="variable">boResult</span> <span class="operator">=</span> subjectInfoDomainService.querySubjectInfo(subjectInfoBO);</span><br><span class="line">            <span class="type">SubjectInfoDTO</span> <span class="variable">dto</span> <span class="operator">=</span> SubjectInfoDTOConverter.INSTANCE.convertBOToDTO(boResult);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(dto);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;SubjectCategoryController.add.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;查询题目详情失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 全文检索</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/getSubjectPageBySearch&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;PageResult&lt;SubjectInfoEs&gt;&gt; <span class="title function_">getSubjectPageBySearch</span><span class="params">(<span class="meta">@RequestBody</span> SubjectInfoDTO subjectInfoDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;SubjectController.getSubjectPageBySearch.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(subjectInfoDTO));</span><br><span class="line">            &#125;</span><br><span class="line">            Preconditions.checkArgument(StringUtils.isNotBlank(subjectInfoDTO.getKeyWord()), <span class="string">&quot;关键词不能为空&quot;</span>);</span><br><span class="line">            <span class="type">SubjectInfoBO</span> <span class="variable">subjectInfoBO</span> <span class="operator">=</span> SubjectInfoDTOConverter.INSTANCE.convertDTOToBO(subjectInfoDTO);</span><br><span class="line">            subjectInfoBO.setPageNo(subjectInfoDTO.getPageNo());</span><br><span class="line">            subjectInfoBO.setPageSize(subjectInfoDTO.getPageSize());</span><br><span class="line">            PageResult&lt;SubjectInfoEs&gt; boPageResult = subjectInfoDomainService.getSubjectPageBySearch(subjectInfoBO);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(boPageResult);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;SubjectCategoryController.getSubjectPageBySearch.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;全文检索失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取题目贡献榜</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/getContributeList&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;List&lt;SubjectInfoDTO&gt;&gt; <span class="title function_">getContributeList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;SubjectInfoBO&gt; boList = subjectInfoDomainService.getContributeList();</span><br><span class="line">            List&lt;SubjectInfoDTO&gt; dtoList = SubjectInfoDTOConverter.INSTANCE.convertBOToDTOList(boList);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(dtoList);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;SubjectCategoryController.getContributeList.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;获取贡献榜失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试mq发送</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/pushMessage&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">pushMessage</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> <span class="type">int</span> id)</span> &#123;</span><br><span class="line">        rocketMQTemplate.convertAndSend(<span class="string">&quot;test-topic&quot;</span>, <span class="string">&quot;早上好&quot;</span> + id);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SubjectInfoDTOConverter</span></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SubjectInfoDTOConverter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">SubjectInfoDTOConverter</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> Mappers.getMapper(SubjectInfoDTOConverter.class);</span><br><span class="line"></span><br><span class="line">    SubjectInfoBO <span class="title function_">convertDTOToBO</span><span class="params">(SubjectInfoDTO subjectInfoDTO)</span>;</span><br><span class="line"></span><br><span class="line">    SubjectInfoDTO <span class="title function_">convertBOToDTO</span><span class="params">(SubjectInfoBO subjectInfoBO)</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;SubjectInfoDTO&gt; <span class="title function_">convertBOToDTOList</span><span class="params">(List&lt;SubjectInfoBO&gt; subjectInfoBO)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//SubjectAnswerDTOConverter</span></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SubjectAnswerDTOConverter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">SubjectAnswerDTOConverter</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> Mappers.getMapper(SubjectAnswerDTOConverter.class);</span><br><span class="line"></span><br><span class="line">    SubjectAnswerBO <span class="title function_">convertDTOToBO</span><span class="params">(SubjectAnswerDTO subjectAnswerDTO)</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;SubjectAnswerBO&gt; <span class="title function_">convertListDTOToBO</span><span class="params">(List&lt;SubjectAnswerDTO&gt; dtoList)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//SubjectInfoConverter</span></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SubjectInfoConverter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">SubjectInfoConverter</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> Mappers.getMapper(SubjectInfoConverter.class);</span><br><span class="line"></span><br><span class="line">    SubjectInfo <span class="title function_">convertBoToInfo</span><span class="params">(SubjectInfoBO subjectInfoBO)</span>;</span><br><span class="line"></span><br><span class="line">    SubjectInfoBO <span class="title function_">convertOptionToBo</span><span class="params">(SubjectOptionBO subjectOptionBO)</span>;</span><br><span class="line"></span><br><span class="line">    SubjectInfoBO <span class="title function_">convertOptionAndInfoToBo</span><span class="params">(SubjectOptionBO subjectOptionBO,SubjectInfo subjectInfo)</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;SubjectInfoBO&gt; <span class="title function_">convertListInfoToBO</span><span class="params">(List&lt;SubjectInfo&gt; subjectInfoList)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SubjectInfoDomainService</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SubjectInfoDomainService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增题目</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(SubjectInfoBO subjectInfoBO)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分页查询</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    PageResult&lt;SubjectInfoBO&gt; <span class="title function_">getSubjectPage</span><span class="params">(SubjectInfoBO subjectInfoBO)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询题目信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SubjectInfoBO <span class="title function_">querySubjectInfo</span><span class="params">(SubjectInfoBO subjectInfoBO)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 全文检索</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    PageResult&lt;SubjectInfoEs&gt; <span class="title function_">getSubjectPageBySearch</span><span class="params">(SubjectInfoBO subjectInfoBO)</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;SubjectInfoBO&gt; <span class="title function_">getContributeList</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubjectInfoDomainServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">SubjectInfoDomainService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SubjectInfoService subjectInfoService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SubjectMappingService subjectMappingService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SubjectLabelService subjectLabelService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SubjectTypeHandlerFactory subjectTypeHandlerFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SubjectEsService subjectEsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SubjectLikedDomainService subjectLikedDomainService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserRpc userRpc;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisUtil redisUtil;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">RANK_KEY</span> <span class="operator">=</span> <span class="string">&quot;subject_rank&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(SubjectInfoBO subjectInfoBO)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;SubjectInfoDomainServiceImpl.add.bo:&#123;&#125;&quot;</span>, JSON.toJSONString(subjectInfoBO));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">SubjectInfo</span> <span class="variable">subjectInfo</span> <span class="operator">=</span> SubjectInfoConverter.INSTANCE.convertBoToInfo(subjectInfoBO);</span><br><span class="line">        subjectInfo.setIsDeleted(IsDeletedFlagEnum.UN_DELETED.getCode());</span><br><span class="line">        subjectInfoService.insert(subjectInfo);</span><br><span class="line">        <span class="type">SubjectTypeHandler</span> <span class="variable">handler</span> <span class="operator">=</span> subjectTypeHandlerFactory.getHandler(subjectInfo.getSubjectType()); <span class="comment">//题目类型关系工厂</span></span><br><span class="line">        subjectInfoBO.setId(subjectInfo.getId());</span><br><span class="line">        handler.add(subjectInfoBO);</span><br><span class="line">        List&lt;Integer&gt; categoryIds = subjectInfoBO.getCategoryIds();</span><br><span class="line">        List&lt;Integer&gt; labelIds = subjectInfoBO.getLabelIds();</span><br><span class="line">        List&lt;SubjectMapping&gt; mappingList = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        categoryIds.forEach(categoryId -&gt; &#123; <span class="comment">//category和label多对多的关系</span></span><br><span class="line">            labelIds.forEach(labelId -&gt; &#123;</span><br><span class="line">                <span class="type">SubjectMapping</span> <span class="variable">subjectMapping</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubjectMapping</span>();</span><br><span class="line">                subjectMapping.setSubjectId(subjectInfo.getId());</span><br><span class="line">                subjectMapping.setCategoryId(Long.valueOf(categoryId));</span><br><span class="line">                subjectMapping.setLabelId(Long.valueOf(labelId));</span><br><span class="line">                subjectMapping.setIsDeleted(IsDeletedFlagEnum.UN_DELETED.getCode());</span><br><span class="line">                mappingList.add(subjectMapping);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">        subjectMappingService.batchInsert(mappingList);</span><br><span class="line">        <span class="comment">//同步到es</span></span><br><span class="line">        <span class="type">SubjectInfoEs</span> <span class="variable">subjectInfoEs</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubjectInfoEs</span>();</span><br><span class="line">        subjectInfoEs.setDocId(<span class="keyword">new</span> <span class="title class_">IdWorkerUtil</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>).nextId());</span><br><span class="line">        subjectInfoEs.setSubjectId(subjectInfo.getId());</span><br><span class="line">        subjectInfoEs.setSubjectAnswer(subjectInfoBO.getSubjectAnswer());</span><br><span class="line">        subjectInfoEs.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>().getTime());</span><br><span class="line">        subjectInfoEs.setCreateUser(<span class="string">&quot;Roger&quot;</span>);</span><br><span class="line">        subjectInfoEs.setSubjectName(subjectInfo.getSubjectName());</span><br><span class="line">        subjectInfoEs.setSubjectType(subjectInfo.getSubjectType());</span><br><span class="line">        subjectEsService.insert(subjectInfoEs);</span><br><span class="line">        <span class="comment">//redis放入zadd计入排行榜</span></span><br><span class="line">        redisUtil.addScore(RANK_KEY, LoginUtil.getLoginId(), <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//实现了分页查询逻辑，并且将查询到的数据和相关的标签信息封装到业务对象中，最后包装成一个分页结果返回。</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PageResult&lt;SubjectInfoBO&gt; <span class="title function_">getSubjectPage</span><span class="params">(SubjectInfoBO subjectInfoBO)</span> &#123;</span><br><span class="line">        PageResult&lt;SubjectInfoBO&gt; pageResult = <span class="keyword">new</span> <span class="title class_">PageResult</span>&lt;&gt;();</span><br><span class="line">        pageResult.setPageNo(subjectInfoBO.getPageNo());</span><br><span class="line">        pageResult.setPageSize(subjectInfoBO.getPageSize());</span><br><span class="line">        <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> (subjectInfoBO.getPageNo() - <span class="number">1</span>) * subjectInfoBO.getPageSize();</span><br><span class="line">        <span class="type">SubjectInfo</span> <span class="variable">subjectInfo</span> <span class="operator">=</span> SubjectInfoConverter.INSTANCE.convertBoToInfo(subjectInfoBO);</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> subjectInfoService.countByCondition(subjectInfo, subjectInfoBO.getCategoryId()</span><br><span class="line">                , subjectInfoBO.getLabelId()); <span class="comment">//根据条件查询满足要求的题目总数。</span></span><br><span class="line">        <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> pageResult;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;SubjectInfo&gt; subjectInfoList = subjectInfoService.queryPage(subjectInfo, subjectInfoBO.getCategoryId()</span><br><span class="line">                , subjectInfoBO.getLabelId(), start, subjectInfoBO.getPageSize());</span><br><span class="line">        List&lt;SubjectInfoBO&gt; subjectInfoBOS = SubjectInfoConverter.INSTANCE.convertListInfoToBO(subjectInfoList);</span><br><span class="line">        subjectInfoBOS.forEach(info -&gt; &#123;</span><br><span class="line">            <span class="type">SubjectMapping</span> <span class="variable">subjectMapping</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubjectMapping</span>();</span><br><span class="line">            subjectMapping.setSubjectId(info.getId());</span><br><span class="line">            List&lt;SubjectMapping&gt; mappingList = subjectMappingService.queryLabelId(subjectMapping);</span><br><span class="line">            List&lt;Long&gt; labelIds = mappingList.stream().map(SubjectMapping::getLabelId).collect(Collectors.toList());</span><br><span class="line">            List&lt;SubjectLabel&gt; labelList = subjectLabelService.batchQueryById(labelIds);</span><br><span class="line">            List&lt;String&gt; labelNames = labelList.stream().map(SubjectLabel::getLabelName).collect(Collectors.toList());</span><br><span class="line">            info.setLabelName(labelNames);</span><br><span class="line">        &#125;);</span><br><span class="line">        pageResult.setRecords(subjectInfoBOS);</span><br><span class="line">        pageResult.setTotal(count);</span><br><span class="line">        <span class="keyword">return</span> pageResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SubjectInfoBO <span class="title function_">querySubjectInfo</span><span class="params">(SubjectInfoBO subjectInfoBO)</span> &#123;</span><br><span class="line">        <span class="type">SubjectInfo</span> <span class="variable">subjectInfo</span> <span class="operator">=</span> subjectInfoService.queryById(subjectInfoBO.getId());</span><br><span class="line">        <span class="type">SubjectTypeHandler</span> <span class="variable">handler</span> <span class="operator">=</span> subjectTypeHandlerFactory.getHandler(subjectInfo.getSubjectType());</span><br><span class="line">        <span class="type">SubjectOptionBO</span> <span class="variable">optionBO</span> <span class="operator">=</span> handler.query(subjectInfo.getId().intValue());</span><br><span class="line">        <span class="type">SubjectInfoBO</span> <span class="variable">bo</span> <span class="operator">=</span> SubjectInfoConverter.INSTANCE.convertOptionAndInfoToBo(optionBO, subjectInfo);</span><br><span class="line">        <span class="type">SubjectMapping</span> <span class="variable">subjectMapping</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubjectMapping</span>();</span><br><span class="line">        subjectMapping.setSubjectId(subjectInfo.getId());</span><br><span class="line">        subjectMapping.setIsDeleted(IsDeletedFlagEnum.UN_DELETED.getCode());</span><br><span class="line">        List&lt;SubjectMapping&gt; mappingList = subjectMappingService.queryLabelId(subjectMapping);</span><br><span class="line">        List&lt;Long&gt; labelIdList = mappingList.stream().map(SubjectMapping::getLabelId).collect(Collectors.toList());</span><br><span class="line">        List&lt;SubjectLabel&gt; labelList = subjectLabelService.batchQueryById(labelIdList);</span><br><span class="line">        List&lt;String&gt; labelNameList = labelList.stream().map(SubjectLabel::getLabelName).collect(Collectors.toList());</span><br><span class="line">        bo.setLabelName(labelNameList);</span><br><span class="line">        bo.setLiked(subjectLikedDomainService.isLiked(subjectInfoBO.getId().toString(), LoginUtil.getLoginId()));</span><br><span class="line">        bo.setLikedCount(subjectLikedDomainService.getLikedCount(subjectInfoBO.getId().toString()));</span><br><span class="line">        assembleSubjectCursor(subjectInfoBO, bo);</span><br><span class="line">        <span class="keyword">return</span> bo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">assembleSubjectCursor</span><span class="params">(SubjectInfoBO subjectInfoBO, SubjectInfoBO bo)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">categoryId</span> <span class="operator">=</span> subjectInfoBO.getCategoryId();</span><br><span class="line">        <span class="type">Long</span> <span class="variable">labelId</span> <span class="operator">=</span> subjectInfoBO.getLabelId();</span><br><span class="line">        <span class="type">Long</span> <span class="variable">subjectId</span> <span class="operator">=</span> subjectInfoBO.getId();</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(categoryId) || Objects.isNull(labelId)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">nextSubjectId</span> <span class="operator">=</span> subjectInfoService.querySubjectIdCursor(subjectId, categoryId, labelId, <span class="number">1</span>);</span><br><span class="line">        bo.setNextSubjectId(nextSubjectId);</span><br><span class="line">        <span class="type">Long</span> <span class="variable">lastSubjectId</span> <span class="operator">=</span> subjectInfoService.querySubjectIdCursor(subjectId, categoryId, labelId, <span class="number">0</span>);</span><br><span class="line">        bo.setLastSubjectId(lastSubjectId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PageResult&lt;SubjectInfoEs&gt; <span class="title function_">getSubjectPageBySearch</span><span class="params">(SubjectInfoBO subjectInfoBO)</span> &#123;</span><br><span class="line">        <span class="type">SubjectInfoEs</span> <span class="variable">subjectInfoEs</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubjectInfoEs</span>();</span><br><span class="line">        subjectInfoEs.setPageNo(subjectInfoBO.getPageNo());</span><br><span class="line">        subjectInfoEs.setPageSize(subjectInfoBO.getPageSize());</span><br><span class="line">        subjectInfoEs.setKeyWord(subjectInfoBO.getKeyWord());</span><br><span class="line">        <span class="keyword">return</span> subjectEsService.querySubjectList(subjectInfoEs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;SubjectInfoBO&gt; <span class="title function_">getContributeList</span><span class="params">()</span> &#123;</span><br><span class="line">        Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; typedTuples = redisUtil.rankWithScore(RANK_KEY, <span class="number">0</span>, <span class="number">5</span>);</span><br><span class="line">        <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;getContributeList.typedTuples:&#123;&#125;&quot;</span>, JSON.toJSONString(typedTuples));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(typedTuples)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;SubjectInfoBO&gt; boList = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        typedTuples.forEach((rank -&gt; &#123;</span><br><span class="line">            <span class="type">SubjectInfoBO</span> <span class="variable">subjectInfoBO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubjectInfoBO</span>();</span><br><span class="line">            subjectInfoBO.setSubjectCount(rank.getScore().intValue());</span><br><span class="line">            <span class="type">UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span> userRpc.getUserInfo(rank.getValue());</span><br><span class="line">            subjectInfoBO.setCreateUser(userInfo.getNickName());</span><br><span class="line">            subjectInfoBO.setCreateUserAvatar(userInfo.getAvatar());</span><br><span class="line">            boList.add(subjectInfoBO);</span><br><span class="line">        &#125;));</span><br><span class="line">        <span class="keyword">return</span> boList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service(&quot;subjectInfoService&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubjectInfoServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">SubjectInfoService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SubjectInfoDao subjectInfoDao;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过ID查询单条数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 实例对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SubjectInfo <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.subjectInfoDao.queryById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subjectInfo 实例对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 实例对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SubjectInfo <span class="title function_">insert</span><span class="params">(SubjectInfo subjectInfo)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.subjectInfoDao.insert(subjectInfo);</span><br><span class="line">        <span class="keyword">return</span> subjectInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subjectInfo 实例对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 实例对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SubjectInfo <span class="title function_">update</span><span class="params">(SubjectInfo subjectInfo)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.subjectInfoDao.update(subjectInfo);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.queryById(subjectInfo.getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过主键删除数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 是否成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">deleteById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.subjectInfoDao.deleteById(id) &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">countByCondition</span><span class="params">(SubjectInfo subjectInfo, Long categoryId, Long labelId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.subjectInfoDao.countByCondition(subjectInfo, categoryId, labelId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;SubjectInfo&gt; <span class="title function_">queryPage</span><span class="params">(SubjectInfo subjectInfo, Long categoryId, Long labelId, <span class="type">int</span> start, Integer pageSize)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.subjectInfoDao.queryPage(subjectInfo, categoryId, labelId, start, pageSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;SubjectInfo&gt; <span class="title function_">getContributeCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.subjectInfoDao.getContributeCount();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">querySubjectIdCursor</span><span class="params">(Long subjectId, Long categoryId, Long labelId, <span class="type">int</span> cursor)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.subjectInfoDao.querySubjectIdCursor(subjectId, categoryId, labelId, cursor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SubjectInfoService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过ID查询单条数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 实例对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SubjectInfo <span class="title function_">queryById</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subjectInfo 实例对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 实例对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SubjectInfo <span class="title function_">insert</span><span class="params">(SubjectInfo subjectInfo)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subjectInfo 实例对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 实例对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SubjectInfo <span class="title function_">update</span><span class="params">(SubjectInfo subjectInfo)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过主键删除数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 是否成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">deleteById</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">countByCondition</span><span class="params">(SubjectInfo subjectInfo, Long categoryId, Long labelId)</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;SubjectInfo&gt; <span class="title function_">queryPage</span><span class="params">(SubjectInfo subjectInfo, Long categoryId, Long labelId, <span class="type">int</span> start, Integer pageSize)</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;SubjectInfo&gt; <span class="title function_">getContributeCount</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    Long <span class="title function_">querySubjectIdCursor</span><span class="params">(Long subjectId, Long categoryId, Long labelId, <span class="type">int</span> cursor)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SubjectInfoDao</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过ID查询单条数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 实例对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SubjectInfo <span class="title function_">queryById</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询指定行数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subjectInfo 查询条件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 对象列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;SubjectInfo&gt; <span class="title function_">queryAllByLimit</span><span class="params">(SubjectInfo subjectInfo)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 统计总行数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subjectInfo 查询条件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 总行数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">long</span> <span class="title function_">count</span><span class="params">(SubjectInfo subjectInfo)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subjectInfo 实例对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 影响行数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">insert</span><span class="params">(SubjectInfo subjectInfo)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量新增数据（MyBatis原生foreach方法）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> entities List&lt;SubjectInfo&gt; 实例对象列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 影响行数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">insertBatch</span><span class="params">(<span class="meta">@Param(&quot;entities&quot;)</span> List&lt;SubjectInfo&gt; entities)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量新增或按主键更新数据（MyBatis原生foreach方法）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> entities List&lt;SubjectInfo&gt; 实例对象列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 影响行数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> org.springframework.jdbc.BadSqlGrammarException 入参是空List的时候会抛SQL语句错误的异常，请自行校验入参</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">insertOrUpdateBatch</span><span class="params">(<span class="meta">@Param(&quot;entities&quot;)</span> List&lt;SubjectInfo&gt; entities)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subjectInfo 实例对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 影响行数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">update</span><span class="params">(SubjectInfo subjectInfo)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过主键删除数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 影响行数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">deleteById</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">countByCondition</span><span class="params">(<span class="meta">@Param(&quot;subjectInfo&quot;)</span> SubjectInfo subjectInfo,</span></span><br><span class="line"><span class="params">                         <span class="meta">@Param(&quot;categoryId&quot;)</span> Long categoryId,</span></span><br><span class="line"><span class="params">                         <span class="meta">@Param(&quot;labelId&quot;)</span> Long labelId)</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;SubjectInfo&gt; <span class="title function_">queryPage</span><span class="params">(<span class="meta">@Param(&quot;subjectInfo&quot;)</span> SubjectInfo subjectInfo,</span></span><br><span class="line"><span class="params">                                <span class="meta">@Param(&quot;categoryId&quot;)</span> Long categoryId,</span></span><br><span class="line"><span class="params">                                <span class="meta">@Param(&quot;labelId&quot;)</span> Long labelId,</span></span><br><span class="line"><span class="params">                                <span class="meta">@Param(&quot;start&quot;)</span> <span class="type">int</span> start,</span></span><br><span class="line"><span class="params">                                <span class="meta">@Param(&quot;pageSize&quot;)</span> Integer pageSize)</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;SubjectInfo&gt; <span class="title function_">getContributeCount</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    Long <span class="title function_">querySubjectIdCursor</span><span class="params">(<span class="meta">@Param(&quot;subjectId&quot;)</span> Long subjectId,</span></span><br><span class="line"><span class="params">                              <span class="meta">@Param(&quot;categoryId&quot;)</span> Long categoryId,</span></span><br><span class="line"><span class="params">                              <span class="meta">@Param(&quot;labelId&quot;)</span> Long labelId,</span></span><br><span class="line"><span class="params">                              <span class="meta">@Param(&quot;cursor&quot;)</span> <span class="type">int</span> cursor)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>JacksonConverter（对于返回值的处理）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jingdianjichi.subject.application.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonInclude;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.SerializationFeature;</span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.subject.application.interceptor.LoginInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.converter.HttpMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.converter.json.MappingJackson2HttpMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * mvc的全局处理</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: ChickenWing</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2023/10/7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalConfig</span> <span class="keyword">extends</span> <span class="title class_">WebMvcConfigurationSupport</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configureMessageConverters</span><span class="params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.configureMessageConverters(converters);</span><br><span class="line">        converters.add(mappingJackson2HttpMessageConverter());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">LoginInterceptor</span>())</span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义mappingJackson2HttpMessageConverter</span></span><br><span class="line"><span class="comment">     * 目前实现：空值忽略，空字段可返回</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> MappingJackson2HttpMessageConverter <span class="title function_">mappingJackson2HttpMessageConverter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        objectMapper.configure(SerializationFeature.FAIL_ON_EMPTY_BEANS, <span class="literal">false</span>); <span class="comment">//这行代码配置ObjectMapper，使其在序列化时不会因空Bean而失败。</span></span><br><span class="line">        objectMapper.setSerializationInclusion(JsonInclude.Include.NON_NULL); <span class="comment">//这行代码设置序列化时只包含非空的字段。（即返回的json结果中不会含有值为Null的字段）</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MappingJackson2HttpMessageConverter</span>(objectMapper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>SQL拦截器自动翻译（mybatis提供的）</strong></p>
<p>SqlStatementInterceptor 主要作用是监控MyBatis的SQL执行时间，并根据不同的执行时间记录不同级别的日志</p>
<p>MybatisPlusAllSqlLog这个类实现了<code>InnerInterceptor</code>接口，它是MyBatis-Plus框架提供的一个内部拦截器接口，用于拦截SQL的执行。这个类有两个主要的重写方法：</p>
<ul>
<li><code>beforeQuery</code>: 在查询执行前调用，记录SQL信息。</li>
<li><code>beforeUpdate</code>: 在更新执行前调用，记录SQL信息。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SqlStatementInterceptor 主要作用是监控MyBatis的SQL执行时间，并根据不同的执行时间记录不同级别的日志</span></span><br><span class="line"><span class="keyword">package</span> com.jingdianjichi.subject.infra.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.cache.CacheKey;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.executor.Executor;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.BoundSql;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.MappedStatement;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.plugin.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.ResultHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.RowBounds;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Intercepts(&#123;</span></span><br><span class="line"><span class="meta">        @Signature(type = Executor.class, method = &quot;update&quot;, args = &#123;MappedStatement.class,</span></span><br><span class="line"><span class="meta">                Object.class&#125;),</span></span><br><span class="line"><span class="meta">        @Signature(type = Executor.class, method = &quot;query&quot;, args = &#123;MappedStatement.class,</span></span><br><span class="line"><span class="meta">                Object.class, RowBounds.class, ResultHandler.class, CacheKey.class, BoundSql.class&#125;)&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlStatementInterceptor</span> <span class="keyword">implements</span> <span class="title class_">Interceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="string">&quot;sys-sql&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> invocation.proceed();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">timeConsuming</span> <span class="operator">=</span> System.currentTimeMillis() - startTime;</span><br><span class="line">            log.info(<span class="string">&quot;执行SQL:&#123;&#125;ms&quot;</span>, timeConsuming);</span><br><span class="line">            <span class="keyword">if</span> (timeConsuming &gt; <span class="number">999</span> &amp;&amp; timeConsuming &lt; <span class="number">5000</span>) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;执行SQL大于1s:&#123;&#125;ms&quot;</span>, timeConsuming);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (timeConsuming &gt;= <span class="number">5000</span> &amp;&amp; timeConsuming &lt; <span class="number">10000</span>) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;执行SQL大于5s:&#123;&#125;ms&quot;</span>, timeConsuming);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (timeConsuming &gt;= <span class="number">10000</span>) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;执行SQL大于10s:&#123;&#125;ms&quot;</span>, timeConsuming);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">plugin</span><span class="params">(Object target)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Plugin.wrap(target, <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setProperties</span><span class="params">(Properties properties)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//MybatisPlusAllSqlLog</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisPlusAllSqlLog</span> <span class="keyword">implements</span> <span class="title class_">InnerInterceptor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="string">&quot;sys-sql&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">beforeQuery</span><span class="params">(Executor executor, MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        logInfo(boundSql, ms, parameter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">beforeUpdate</span><span class="params">(Executor executor, MappedStatement ms, Object parameter)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="type">BoundSql</span> <span class="variable">boundSql</span> <span class="operator">=</span> ms.getBoundSql(parameter);</span><br><span class="line">        logInfo(boundSql, ms, parameter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">logInfo</span><span class="params">(BoundSql boundSql, MappedStatement ms, Object parameter)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;parameter = &quot;</span> + parameter);</span><br><span class="line">            <span class="comment">// 获取到节点的id,即sql语句的id</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">sqlId</span> <span class="operator">=</span> ms.getId();</span><br><span class="line">            log.info(<span class="string">&quot;sqlId = &quot;</span> + sqlId);</span><br><span class="line">            <span class="comment">// 获取节点的配置</span></span><br><span class="line">            <span class="type">Configuration</span> <span class="variable">configuration</span> <span class="operator">=</span> ms.getConfiguration();</span><br><span class="line">            <span class="comment">// 获取到最终的sql语句</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> getSql(configuration, boundSql, sqlId);</span><br><span class="line">            log.info(<span class="string">&quot;完整的sql:&#123;&#125;&quot;</span>, sql);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;异常:&#123;&#125;&quot;</span>, e.getLocalizedMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 封装了一下sql语句，使得结果返回完整xml路径下的sql语句节点id + sql语句</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getSql</span><span class="params">(Configuration configuration, BoundSql boundSql, String sqlId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sqlId + <span class="string">&quot;:&quot;</span> + showSql(configuration, boundSql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 进行？的替换</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">showSql</span><span class="params">(Configuration configuration, BoundSql boundSql)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取参数</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">parameterObject</span> <span class="operator">=</span> boundSql.getParameterObject();</span><br><span class="line">        List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();</span><br><span class="line">        <span class="comment">// sql语句中多个空格都用一个空格代替</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> boundSql.getSql().replaceAll(<span class="string">&quot;[\\s]+&quot;</span>, <span class="string">&quot; &quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!CollectionUtils.isEmpty(parameterMappings) &amp;&amp; parameterObject != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 获取类型处理器注册器，类型处理器的功能是进行java类型和数据库类型的转换</span></span><br><span class="line">            <span class="type">TypeHandlerRegistry</span> <span class="variable">typeHandlerRegistry</span> <span class="operator">=</span> configuration.getTypeHandlerRegistry();</span><br><span class="line">            <span class="comment">// 如果根据parameterObject.getClass(）可以找到对应的类型，则替换</span></span><br><span class="line">            <span class="keyword">if</span> (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) &#123;</span><br><span class="line">                sql = sql.replaceFirst(<span class="string">&quot;\\?&quot;</span>,</span><br><span class="line">                        Matcher.quoteReplacement(getParameterValue(parameterObject)));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// MetaObject主要是封装了originalObject对象，提供了get和set的方法用于获取和设置originalObject的属性值,主要支持对JavaBean、Collection、Map三种类型对象的操作</span></span><br><span class="line">                <span class="type">MetaObject</span> <span class="variable">metaObject</span> <span class="operator">=</span> configuration.newMetaObject(parameterObject);</span><br><span class="line">                <span class="keyword">for</span> (ParameterMapping parameterMapping : parameterMappings) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">propertyName</span> <span class="operator">=</span> parameterMapping.getProperty();</span><br><span class="line">                    <span class="keyword">if</span> (metaObject.hasGetter(propertyName)) &#123;</span><br><span class="line">                        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> metaObject.getValue(propertyName);</span><br><span class="line">                        sql = sql.replaceFirst(<span class="string">&quot;\\?&quot;</span>,</span><br><span class="line">                                Matcher.quoteReplacement(getParameterValue(obj)));</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (boundSql.hasAdditionalParameter(propertyName)) &#123;</span><br><span class="line">                        <span class="comment">// 该分支是动态sql</span></span><br><span class="line">                        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> boundSql.getAdditionalParameter(propertyName);</span><br><span class="line">                        sql = sql.replaceFirst(<span class="string">&quot;\\?&quot;</span>,</span><br><span class="line">                                Matcher.quoteReplacement(getParameterValue(obj)));</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// 打印出缺失，提醒该参数缺失并防止错位</span></span><br><span class="line">                        sql = sql.replaceFirst(<span class="string">&quot;\\?&quot;</span>, <span class="string">&quot;缺失&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sql;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果参数是String，则添加单引号， 如果是日期，则转换为时间格式器并加单引号； 对参数是null和不是null的情况作了处理</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getParameterValue</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">        String value;</span><br><span class="line">        <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            value = <span class="string">&quot;&#x27;&quot;</span> + obj.toString() + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Date) &#123;</span><br><span class="line">            <span class="type">DateFormat</span> <span class="variable">formatter</span> <span class="operator">=</span> DateFormat.getDateTimeInstance(DateFormat.DEFAULT,</span><br><span class="line">                    DateFormat.DEFAULT, Locale.CHINA);</span><br><span class="line">            value = <span class="string">&quot;&#x27;&quot;</span> + formatter.format(<span class="keyword">new</span> <span class="title class_">Date</span>()) + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (obj != <span class="literal">null</span>) &#123;</span><br><span class="line">                value = obj.toString();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                value = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><h4 id="传统部署形式"><a href="#传统部署形式" class="headerlink" title="传统部署形式"></a>传统部署形式</h4><p>在starter模块的pom.xml中</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">//配置的版本等内容</span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-boot.version</span>&gt;</span>2.4.2<span class="tag">&lt;/<span class="name">spring-boot.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-cloud-alibaba.version</span>&gt;</span>2021.1<span class="tag">&lt;/<span class="name">spring-cloud-alibaba.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>2020.0.6<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">....</span><br><span class="line">//打包的名字</span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--打包成jar包时的名字--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>打包好Jar包,复制到服务器上,java -jar运行即可</p>
<p>但是这样还是比较复杂</p>
<h4 id="CI-CD-jenkins自动打包集成和部署"><a href="#CI-CD-jenkins自动打包集成和部署" class="headerlink" title="CI&#x2F;CD jenkins自动打包集成和部署"></a>CI&#x2F;CD jenkins自动打包集成和部署</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker search jenkins</span><br><span class="line">docker pull jenkins/jenkins:lts</span><br><span class="line">docker run -d -u root -p 8080:8080 -p 50000:50000 -v /var/jenkins_home:/var/jenkins_home -v /etc/localtime:/etc/localtime --name jenkins jenkins/jenkins:lts</span><br><span class="line">docker ps -a</span><br></pre></td></tr></table></figure>

<p>然后配置一些密码，maven，拉一些包，配置pom.xml，配置路径，就可以打包好，写一个shell脚本然后运行就行了</p>
<p>[shell脚本语言(超全超详细)-CSDN博客](<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43288201/article/details/105643692?ops_request_misc=&request_id=&biz_id=102&utm_term=shell">https://blog.csdn.net/weixin_43288201/article/details/105643692?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=shell</a> 脚本 ^&amp;utm_medium&#x3D;distribute.pc_search_result.none-task-blog-2<del>all</del>sobaiduweb~default-5-105643692.142^v100^pc_search_result_base8&amp;spm&#x3D;1018.2226.3001.4187)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cp /var/jenkins_home/workspace/programmer-club-subject/programmer-club-subject/programmer-club-starter/target/programmer-club-starter.jar /var/jenkins_home/jar/</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">APP_NAME=programmer-club-starter.jar</span><br><span class="line">LOG_NAME=programmer-club-starter.log</span><br><span class="line"></span><br><span class="line">pid=`ps -ef | grep $APP_NAME | grep -v grep|awk &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line"></span><br><span class="line">function is_exist()&#123;</span><br><span class="line">pid=`ps -ef | grep $APP_NAME | grep -v grep|awk &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">if [ -z $&#123;pid&#125; ]; then</span><br><span class="line">String=&quot;notExist&quot;</span><br><span class="line">echo $String</span><br><span class="line">else</span><br><span class="line">String=&quot;exist&quot;</span><br><span class="line">echo $String</span><br><span class="line">fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">str=$(is_exist)</span><br><span class="line">if [ $&#123;str&#125; = &quot;exist&quot; ]; then</span><br><span class="line">echo &quot; 检测到已经启动的程序，pid 是 $&#123;pid&#125; &quot;</span><br><span class="line">kill -9 $pid</span><br><span class="line">else</span><br><span class="line">echo &quot; 程序没有启动了 &quot;</span><br><span class="line">echo &quot;$&#123;APP_NAME&#125; is not running&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">str=$(is_exist)</span><br><span class="line">if [ $&#123;str&#125; = &quot;exist&quot; ]; then</span><br><span class="line">echo &quot;$&#123;APP_NAME&#125; 已经启动了. pid=$&#123;pid&#125; .&quot;</span><br><span class="line">else</span><br><span class="line">source /etc/profile</span><br><span class="line">BUILD_ID=dontKillMe</span><br><span class="line">nohup java -Xms300m -Xmx300m -jar /var/jenkins_home/jar/$APP_NAME   &gt;$LOG_NAME 2&gt;&amp;1 &amp;</span><br><span class="line">echo &quot;程序已重新启动...&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>这个脚本中获取PID的命令：</p>
<ol>
<li><code>ps -ef</code>：这个命令列出了当前系统上所有正在运行的进程。<code>-e</code>选项表示显示所有进程，<code>-f</code>选项表示显示完整格式。</li>
<li><code>grep $APP_NAME</code>：<code>grep</code>命令用于搜索包含指定文本的行。在这里，它搜索包含<code>APP_NAME</code>变量值（即<code>programmer-club-starter.jar</code>）的行。</li>
<li><code>grep -v grep</code>：这个命令用于排除包含<code>grep</code>本身的行，<code>-v</code>选项表示显示不包含匹配文本的行。</li>
<li><code>awk &#39;&#123;print $2&#125;&#39;</code>：<code>awk</code>是一个强大的文本处理工具。在这里，它用于打印每行的第二个字段，即进程ID（PID）。在Unix&#x2F;Linux系统中，<code>ps -ef</code>命令的输出中，PID通常位于第二列。</li>
</ol>
<h3 id="2-OSS模块-jc-club-oss"><a href="#2-OSS模块-jc-club-oss" class="headerlink" title="2. OSS模块(jc-club-oss)"></a>2. OSS模块(jc-club-oss)</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/28/XtN8V5Dq4orKgFP.png" alt="image-20240728193051763.png"></p>
<h4 id="OSS模块设计"><a href="#OSS模块设计" class="headerlink" title="OSS模块设计"></a>OSS模块设计</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/17/DutXl68xcz4QmRr.png" alt="image-20240717153600388.png"></p>
<p>注意：考虑 oss 的扩展性和切换性。</p>
<p>目前对接的 minio，要考虑，如果作为公共的 oss 服务，如何切换到其他的阿里云 oss 或者对接京东云的 oss。作为基础的 oss 服务，切换等等动作，不应该要求业务方进行改造，以及对切换有感知。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/17/Ag6VbxBDoSRjn4O.png" alt="image-20240717153706800.png"></p>
<h4 id="minio模块开发"><a href="#minio模块开发" class="headerlink" title="minio模块开发"></a>minio模块开发</h4><p>controller-&gt;service-&gt;adaper（阿里&#x2F;minio，适配器模式，不用工厂＋策略的是因为工厂+策略的传入的参数之类的差不多，所以用适配器）-&gt;具体操作</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Java_Mr_Jin/article/details/125643455?ops_request_misc=%7B%22request_id%22:%22172205057816800211579712%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=172205057816800211579712&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-125643455-null-null.142%5Ev100%5Epc_search_result_base8&utm_term=minio&spm=1018.2226.3001.4187">minio安装部署及使用-CSDN博客</a></p>
<p><code>pom.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.minio<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>minio<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> //spingcloud的nacos</span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//application.yml</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">4000</span></span><br><span class="line"><span class="attr">minio:</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">http://117.72.14.166:9000</span></span><br><span class="line">  <span class="attr">accessKey:</span> <span class="string">minioadmin</span></span><br><span class="line">  <span class="attr">secretKey:</span> <span class="string">minioadmin</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">  	<span class="attr">type:</span></span><br><span class="line">  		<span class="string">minio</span></span><br><span class="line"> <span class="string">/*</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">`server.port:</span> <span class="number">4000</span><span class="string">`：这行配置指定了应用程序运行的端口号为4000。</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="string">`minio`部分：配置了MinIO服务的相关属性。</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">`url`：MinIO服务的URL地址，这里是`http://117.72.14.166:9000`。</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">`accessKey`和`secretKey`：访问MinIO服务的密钥和私钥，这里都设置为`minioadmin`。</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="string">`storage.service.type.minio`：指定存储服务的类型为MinIO。</span></span><br><span class="line"> <span class="string">*/</span></span><br></pre></td></tr></table></figure>

<p><code>Miniocofig.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jingdianjichi.oss.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.minio.MinioClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * minio配置管理</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: ChickenWing</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2023/10/11</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MinioConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * minioUrl</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;minio.url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * minio账户</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;minio.accessKey&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String accessKey;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * minio密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;minio.secretKey&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String secretKey;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造minioClient</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MinioClient <span class="title function_">getMinioClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> MinioClient.builder().endpoint(url).credentials(accessKey, secretKey).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>MinioUtil.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jingdianjichi.oss.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.oss.entity.FileInfo;</span><br><span class="line"><span class="keyword">import</span> io.minio.*;</span><br><span class="line"><span class="keyword">import</span> io.minio.errors.*;</span><br><span class="line"><span class="keyword">import</span> io.minio.http.Method;</span><br><span class="line"><span class="keyword">import</span> io.minio.messages.Bucket;</span><br><span class="line"><span class="keyword">import</span> io.minio.messages.Item;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.security.InvalidKeyException;</span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * minio文件操作工具</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: ChickenWing</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2023/10/11</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MinioUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> MinioClient minioClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建bucket桶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createBucket</span><span class="params">(String bucket)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">exists</span> <span class="operator">=</span> minioClient.bucketExists(BucketExistsArgs.builder().bucket(bucket).build());</span><br><span class="line">        <span class="keyword">if</span> (!exists) &#123;</span><br><span class="line">            minioClient.makeBucket(MakeBucketArgs.builder().bucket(bucket).build());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 上传文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">uploadFile</span><span class="params">(InputStream inputStream, String bucket, String objectName)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        minioClient.putObject(PutObjectArgs.builder().bucket(bucket).object(objectName)</span><br><span class="line">                .stream(inputStream, -<span class="number">1</span>, <span class="number">5242889L</span>).build());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 列出所有桶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getAllBucket</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        List&lt;Bucket&gt; buckets = minioClient.listBuckets();</span><br><span class="line">        <span class="keyword">return</span> buckets.stream().map(Bucket::name).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 列出当前桶及文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;FileInfo&gt; <span class="title function_">getAllFile</span><span class="params">(String bucket)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Iterable&lt;Result&lt;Item&gt;&gt; results = minioClient.listObjects(</span><br><span class="line">                ListObjectsArgs.builder().bucket(bucket).build());</span><br><span class="line">        List&lt;FileInfo&gt; fileInfoList = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Result&lt;Item&gt; result : results) &#123;</span><br><span class="line">            <span class="type">FileInfo</span> <span class="variable">fileInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInfo</span>();</span><br><span class="line">            <span class="type">Item</span> <span class="variable">item</span> <span class="operator">=</span> result.get();</span><br><span class="line">            fileInfo.setFileName(item.objectName());</span><br><span class="line">            fileInfo.setDirectoryFlag(item.isDir());</span><br><span class="line">            fileInfo.setEtag(item.etag());</span><br><span class="line">            fileInfoList.add(fileInfo);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> fileInfoList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下载文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> InputStream <span class="title function_">downLoad</span><span class="params">(String bucket, String objectName)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> minioClient.getObject(</span><br><span class="line">                GetObjectArgs.builder().bucket(bucket).object(objectName).build()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除桶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteBucket</span><span class="params">(String bucket)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        minioClient.removeBucket(</span><br><span class="line">                RemoveBucketArgs.builder().bucket(bucket).build()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteObject</span><span class="params">(String bucket, String objectName)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        minioClient.removeObject(</span><br><span class="line">                RemoveObjectArgs.builder().bucket(bucket).object(objectName).build()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取文件url</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPreviewFileUrl</span><span class="params">(String bucketName, String objectName)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">            <span class="type">GetPresignedObjectUrlArgs</span> <span class="variable">args</span> <span class="operator">=</span> GetPresignedObjectUrlArgs.builder()</span><br><span class="line">                    .method(Method.GET)</span><br><span class="line">                    .bucket(bucketName).object(objectName).build();</span><br><span class="line">            <span class="keyword">return</span> minioClient.getPresignedObjectUrl(args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>FileInfo.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileInfo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String fileName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Boolean directoryFlag;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String etag;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getFileName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fileName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setFileName</span><span class="params">(String fileName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.fileName = fileName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">getDirectoryFlag</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> directoryFlag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDirectoryFlag</span><span class="params">(Boolean directoryFlag)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.directoryFlag = directoryFlag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getEtag</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> etag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEtag</span><span class="params">(String etag)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.etag = etag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>FileController.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> FileService fileService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/testGetAllBuckets&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">testGetAllBuckets</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        List&lt;String&gt; allBucket = fileService.getAllBucket();</span><br><span class="line">        <span class="keyword">return</span> allBucket.get(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/getUrl&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUrl</span><span class="params">(String bucketName, String objectName)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> fileService.getUrl(bucketName, objectName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 上传文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/upload&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">upload</span><span class="params">(MultipartFile uploadFile, String bucket, String objectName)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> fileService.uploadFile(uploadFile, bucket, objectName);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(url);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>fileService.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StorageAdapter storageAdapter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FileService</span><span class="params">(StorageAdapter storageAdapter)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.storageAdapter = storageAdapter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 列出所有桶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getAllBucket</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> storageAdapter.getAllBucket();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取文件路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUrl</span><span class="params">(String bucketName,String objectName)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> storageAdapter.getUrl(bucketName,objectName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 上传文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">uploadFile</span><span class="params">(MultipartFile uploadFile, String bucket, String objectName)</span>&#123;</span><br><span class="line">        storageAdapter.uploadFile(uploadFile,bucket,objectName);</span><br><span class="line">        objectName = objectName + <span class="string">&quot;/&quot;</span> + uploadFile.getOriginalFilename();</span><br><span class="line">        <span class="keyword">return</span> storageAdapter.getUrl(bucket, objectName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>StorageConfig.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@RefreshScope</span> <span class="comment">//实现nacos动态的配置刷新</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StorageConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;storage.service.type&#125;&quot;)</span>  <span class="comment">//这里的注解是从pom.xml中去读的</span></span><br><span class="line">    <span class="keyword">private</span> String storageType;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@RefreshScope</span> <span class="comment">//实现nacos动态的配置刷新</span></span><br><span class="line">    <span class="keyword">public</span> StorageAdapter <span class="title function_">storageService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;minio&quot;</span>.equals(storageType)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MinioStorageAdapter</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;aliyun&quot;</span>.equals(storageType)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AliStorageAdapter</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;未找到对应的文件存储处理器&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>StorageAdapter.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">StorageAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建bucket桶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createBucket</span><span class="params">(String bucket)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 上传文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">uploadFile</span><span class="params">(MultipartFile uploadFile, String bucket, String objectName)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 列出所有桶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;String&gt; <span class="title function_">getAllBucket</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 列出当前桶及文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;FileInfo&gt; <span class="title function_">getAllFile</span><span class="params">(String bucket)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下载文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    InputStream <span class="title function_">downLoad</span><span class="params">(String bucket, String objectName)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除桶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deleteBucket</span><span class="params">(String bucket)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deleteObject</span><span class="params">(String bucket, String objectName)</span>;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">getUrl</span><span class="params">(String bucket, String objectName)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>MinioStorageAdapter.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jingdianjichi.oss.adapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.oss.entity.FileInfo;</span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.oss.util.MinioUtil;</span><br><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * minioIO存储适配器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MinioStorageAdapter</span> <span class="keyword">implements</span> <span class="title class_">StorageAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> MinioUtil minioUtil;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * minioUrl</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;minio.url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createBucket</span><span class="params">(String bucket)</span> &#123;</span><br><span class="line">        minioUtil.createBucket(bucket);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">uploadFile</span><span class="params">(MultipartFile uploadFile, String bucket, String objectName)</span> &#123;</span><br><span class="line">        minioUtil.createBucket(bucket);</span><br><span class="line">        <span class="keyword">if</span> (objectName != <span class="literal">null</span>) &#123;</span><br><span class="line">            minioUtil.uploadFile(uploadFile.getInputStream(), bucket, objectName + <span class="string">&quot;/&quot;</span> + uploadFile.getOriginalFilename());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            minioUtil.uploadFile(uploadFile.getInputStream(), bucket, uploadFile.getOriginalFilename());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getAllBucket</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> minioUtil.getAllBucket();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;FileInfo&gt; <span class="title function_">getAllFile</span><span class="params">(String bucket)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> minioUtil.getAllFile(bucket);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> InputStream <span class="title function_">downLoad</span><span class="params">(String bucket, String objectName)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> minioUtil.downLoad(bucket, objectName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteBucket</span><span class="params">(String bucket)</span> &#123;</span><br><span class="line">        minioUtil.deleteBucket(bucket);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteObject</span><span class="params">(String bucket, String objectName)</span> &#123;</span><br><span class="line">        minioUtil.deleteObject(bucket, objectName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUrl</span><span class="params">(String bucket, String objectName)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> url + <span class="string">&quot;/&quot;</span> + bucket + <span class="string">&quot;/&quot;</span> + objectName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里相当于做了个适配器，这里用的是minio的，如果要用阿里的服务就要切到另一套了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jingdianjichi.oss.adapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.oss.entity.FileInfo;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 阿里云oss适配器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AliStorageAdapter</span> <span class="keyword">implements</span> <span class="title class_">StorageAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createBucket</span><span class="params">(String bucket)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">uploadFile</span><span class="params">(MultipartFile uploadFile, String bucket, String objectName)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getAllBucket</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;String&gt; bucketNameList = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        bucketNameList.add(<span class="string">&quot;aliyun&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> bucketNameList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;FileInfo&gt; <span class="title function_">getAllFile</span><span class="params">(String bucket)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> InputStream <span class="title function_">downLoad</span><span class="params">(String bucket, String objectName)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteBucket</span><span class="params">(String bucket)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteObject</span><span class="params">(String bucket, String objectName)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUrl</span><span class="params">(String bucket, String objectName)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="OSS模块配合nacos实现动态切换"><a href="#OSS模块配合nacos实现动态切换" class="headerlink" title="OSS模块配合nacos实现动态切换"></a>OSS模块配合nacos实现动态切换</h4><p>nacos 作为配置中心，可以实现动态配置，适用于比如动态数据源切换，动态切换 oss。</p>
<p><strong>这里要配合<code>RefreshScope</code>注解去使用</strong>，实现动态刷新（minio-&gt;ali）。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_71777195/article/details/126319418?ops_request_misc=%7B%22request_id%22:%22172205984816800185890242%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=172205984816800185890242&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_click~default-1-126319418-null-null.142%5Ev100%5Epc_search_result_base8&utm_term=RefreshScope&spm=1018.2226.3001.4187">一文带你理解@RefreshScope注解实现动态刷新原理-CSDN博客</a></p>
<h5 id="集成naocs动态配置"><a href="#集成naocs动态配置" class="headerlink" title="集成naocs动态配置"></a>集成naocs动态配置</h5><p>配置</p>
<ol>
<li><p>jc-club-oss&#x2F;pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.minio<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>minio<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>jc-club-oss&#x2F;src&#x2F;main&#x2F;java&#x2F;com&#x2F;jingdianjichi&#x2F;oss&#x2F;controller&#x2F;FileController.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileController</span>&#123; </span><br><span class="line">	<span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> FileService fileService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NacosValue(value = &quot;$&#123;storage.service.type&#125;&quot;, autoRefreshed = true)</span></span><br><span class="line">    <span class="keyword">private</span> String storageType;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/testGetAllBuckets&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">testGetAllBuckets</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        List&lt;String&gt; allBucket = fileService.getAllBucket();</span><br><span class="line">        <span class="keyword">return</span> allBucket.get(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/testNacos&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">testNacos</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> storageType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>jc-club-oss&#x2F;src&#x2F;main&#x2F;resources&#x2F;bootstrap.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">jc-club-oss-dev</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">117.72</span><span class="number">.14</span><span class="number">.166</span><span class="string">:8848</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">DEFAULT_GROUP</span></span><br><span class="line">        <span class="attr">namespace:</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">117.72</span><span class="number">.14</span><span class="number">.166</span><span class="string">:8848</span></span><br><span class="line"><span class="string">/*</span></span><br><span class="line"><span class="string">Spring</span> <span class="string">应用名称：</span></span><br><span class="line"></span><br><span class="line"><span class="attr">application.name:</span> <span class="string">jc-club-oss-dev：定义了Spring应用的名称为jc-club-oss-dev。</span></span><br><span class="line"><span class="string">激活的配置文件：</span></span><br><span class="line"></span><br><span class="line"><span class="attr">profiles.active:</span> <span class="string">dev：指定了激活的配置文件为dev，这意味着在启动时会加载application-dev.yaml或application-dev.properties等配置文件。</span></span><br><span class="line"><span class="string">Nacos</span> <span class="string">配置：</span></span><br><span class="line"></span><br><span class="line"><span class="attr">cloud.nacos.config.server-addr:</span> <span class="number">117.72</span><span class="number">.14</span><span class="number">.166</span><span class="string">:8848：定义了Nacos配置服务器的地址，这里是117.72.14.166:8848。</span></span><br><span class="line"><span class="attr">cloud.nacos.config.prefix:</span> <span class="string">$&#123;spring.application.name&#125;：定义了配置的前缀，这里使用了$&#123;spring.application.name&#125;，即应用名称作为前缀。</span></span><br><span class="line"><span class="attr">cloud.nacos.config.group:</span> <span class="string">DEFAULT_GROUP：定义了配置的分组，这里是DEFAULT_GROUP。</span></span><br><span class="line"><span class="string">cloud.nacos.config.namespace：这里没有指定具体的命名空间，通常用于区分不同环境的配置。</span></span><br><span class="line"><span class="attr">cloud.nacos.config.file-extension:</span> <span class="string">yaml：指定了配置文件的扩展名，这里是yaml。</span></span><br><span class="line"><span class="string">Nacos</span> <span class="string">服务发现：</span></span><br><span class="line"></span><br><span class="line"><span class="attr">cloud.nacos.discovery.enabled:</span> <span class="literal">true</span><span class="string">：启用了Nacos的服务发现功能。</span></span><br><span class="line"><span class="attr">cloud.nacos.discovery.server-addr:</span> <span class="number">117.72</span><span class="number">.14</span><span class="number">.166</span><span class="string">:8848：定义了Nacos服务发现服务器的地址，与配置服务器地址一致。</span></span><br><span class="line"><span class="string">配置的作用</span></span><br><span class="line"><span class="string">配置管理：通过Nacos配置中心，应用可以动态地读取和更新配置，而不需要重启应用。这对于微服务架构中的配置管理非常有用。</span></span><br><span class="line"><span class="string">服务发现：通过Nacos服务注册中心，应用可以注册自身服务并发现其他服务，从而实现服务间的调用。</span></span><br><span class="line"><span class="string">使用场景</span></span><br><span class="line"><span class="string">在微服务架构中，使用Nacos进行配置管理和服务发现可以提高系统的可维护性和可扩展性。</span></span><br><span class="line"><span class="string">动态配置更新：应用可以根据Nacos配置中心的配置变化自动更新其配置，而不需要人工干预。*/</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>通过在nacos界面修改：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">storage:</span></span><br><span class="line">	<span class="attr">service:</span></span><br><span class="line">		<span class="attr">type:</span> <span class="string">minio/aliyun</span></span><br></pre></td></tr></table></figure>

<p>即可通过**@Configuration**注解的<code>Storage.java</code>中的<code>@Bean、@RefreshScope</code>注解的storageService方法会创建适配器的对应的StorageAdapter，拿到minio&#x2F;阿里云的oss服务。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44296929/article/details/139138784?ops_request_misc=%7B%22request_id%22:%22172208236416800222858291%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=172208236416800222858291&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-139138784-null-null.142%5Ev100%5Epc_search_result_base8&utm_term=@Configuration%E7%B1%BB&spm=1018.2226.3001.4187">@Configuration注解使用详解【记录】-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_46190243/article/details/105604483?spm=1001.2101.3001.6650.1&utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~PaidSort-1-105604483-blog-135087635.235%5Ev43%5Epc_blog_bottom_relevance_base7&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~PaidSort-1-105604483-blog-135087635.235%5Ev43%5Epc_blog_bottom_relevance_base7&utm_relevant_index=2">Spring 常用注解@Configuration，@Bean，@Component，@Service，@Controller，@Repository，@Entity的区分与学习_@entity @repository 区别-CSDN博客</a></p>
<h3 id="3-登录鉴权模块"><a href="#3-登录鉴权模块" class="headerlink" title="3. 登录鉴权模块"></a>3. 登录鉴权模块</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/28/l9Wx8Itu31GewjT.png" alt="image-20240728193217684.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/29/txUbV5a1osP7f2z.png" alt="image-20240729100733585.png"></p>
<h4 id="技术选型-1"><a href="#技术选型-1" class="headerlink" title="技术选型"></a>技术选型</h4><p><strong>Sa-Token</strong> 是一个轻量级 Java 权限认证框架，主要解决：<strong>登录认证</strong>、<strong>权限认证</strong>、<strong>单点登录</strong>、<strong>OAuth2.0</strong>、<strong>分布式Session会话</strong>、<strong>微服务网关鉴权</strong> 等一系列权限相关问题。</p>
<p>Sa-Token 旨在以简单、优雅的方式完成系统的权限认证部分，以登录认证为例，你只需要：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 会话登录，参数填登录人的账号id </span></span><br><span class="line">StpUtil.login(<span class="number">10001</span>);</span><br></pre></td></tr></table></figure>

<p>无需实现任何接口，无需创建任何配置文件，只需要这一句静态代码的调用，便可以完成会话登录认证。</p>
<p>如果一个接口需要登录后才能访问，我们只需调用以下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 校验当前客户端是否已经登录，如果未登录则抛出 `NotLoginException` 异常</span></span><br><span class="line">StpUtil.checkLogin();</span><br></pre></td></tr></table></figure>

<p>在 Sa-Token 中，大多数功能都可以一行代码解决：</p>
<p>踢人下线：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将账号id为 10077 的会话踢下线 </span></span><br><span class="line">StpUtil.kickout(<span class="number">10077</span>);复制到剪贴板错误复制成功</span><br></pre></td></tr></table></figure>

<p>权限认证：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注解鉴权：只有具备 `user:add` 权限的会话才可以进入方法</span></span><br><span class="line"><span class="meta">@SaCheckPermission(&quot;user:add&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">insert</span><span class="params">(SysUser user)</span> &#123;</span><br><span class="line">    <span class="comment">// ... </span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;用户增加&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>路由拦截鉴权：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据路由划分模块，不同模块不同鉴权 </span></span><br><span class="line">registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">SaInterceptor</span>(handler -&gt; &#123;</span><br><span class="line">    SaRouter.match(<span class="string">&quot;/user/**&quot;</span>, r -&gt; StpUtil.checkPermission(<span class="string">&quot;user&quot;</span>));</span><br><span class="line">    SaRouter.match(<span class="string">&quot;/admin/**&quot;</span>, r -&gt; StpUtil.checkPermission(<span class="string">&quot;admin&quot;</span>));</span><br><span class="line">    SaRouter.match(<span class="string">&quot;/goods/**&quot;</span>, r -&gt; StpUtil.checkPermission(<span class="string">&quot;goods&quot;</span>));</span><br><span class="line">    SaRouter.match(<span class="string">&quot;/orders/**&quot;</span>, r -&gt; StpUtil.checkPermission(<span class="string">&quot;orders&quot;</span>));</span><br><span class="line">    SaRouter.match(<span class="string">&quot;/notice/**&quot;</span>, r -&gt; StpUtil.checkPermission(<span class="string">&quot;notice&quot;</span>));</span><br><span class="line">    <span class="comment">// 更多模块... </span></span><br><span class="line">&#125;)).addPathPatterns(<span class="string">&quot;/**&quot;</span>);</span><br><span class="line"><span class="number">9</span></span><br></pre></td></tr></table></figure>

<p>当你受够 Shiro、SpringSecurity 等框架的三拜九叩之后，你就会明白，相对于这些传统老牌框架，Sa-Token 的 API 设计是多么的简单、优雅！</p>
<p><a target="_blank" rel="noopener" href="https://sa-token.cc/doc.html#/?id=sa-token-%E5%8A%9F%E8%83%BD%E4%B8%80%E8%A7%88">Sa-Token 功能一览</a></p>
<p>Sa-Token 目前主要五大功能模块：登录认证、权限认证、单点登录、OAuth2.0、微服务鉴权。</p>
<ul>
<li><strong>登录认证</strong> —— 单端登录、多端登录、同端互斥登录、七天内免登录。</li>
<li><strong>权限认证</strong> —— 权限认证、角色认证、会话二级认证。</li>
<li><strong>踢人下线</strong> —— 根据账号id踢人下线、根据Token值踢人下线。</li>
<li><strong>注解式鉴权</strong> —— 优雅的将鉴权与业务代码分离。</li>
<li><strong>路由拦截式鉴权</strong> —— 根据路由拦截鉴权，可适配 restful 模式。</li>
<li><strong>Session会话</strong> —— 全端共享Session,单端独享Session,自定义Session,方便的存取值。</li>
<li><strong>持久层扩展</strong> —— 可集成 Redis，重启数据不丢失。</li>
<li><strong>前后台分离</strong> —— APP、小程序等不支持 Cookie 的终端也可以轻松鉴权。</li>
<li><strong>Token风格定制</strong> —— 内置六种 Token 风格，还可：自定义 Token 生成策略。</li>
<li><strong>记住我模式</strong> —— 适配 [记住我] 模式，重启浏览器免验证。</li>
<li><strong>二级认证</strong> —— 在已登录的基础上再次认证，保证安全性。</li>
<li><strong>模拟他人账号</strong> —— 实时操作任意用户状态数据。</li>
<li><strong>临时身份切换</strong> —— 将会话身份临时切换为其它账号。</li>
<li><strong>同端互斥登录</strong> —— 像QQ一样手机电脑同时在线，但是两个手机上互斥登录。</li>
<li><strong>账号封禁</strong> —— 登录封禁、按照业务分类封禁、按照处罚阶梯封禁。</li>
<li><strong>密码加密</strong> —— 提供基础加密算法，可快速 MD5、SHA1、SHA256、AES 加密。</li>
<li><strong>会话查询</strong> —— 提供方便灵活的会话查询接口。</li>
<li><strong>Http Basic认证</strong> —— 一行代码接入 Http Basic、Digest 认证。</li>
<li><strong>全局侦听器</strong> —— 在用户登陆、注销、被踢下线等关键性操作时进行一些AOP操作。</li>
<li><strong>全局过滤器</strong> —— 方便的处理跨域，全局设置安全响应头等操作。</li>
<li><strong>多账号体系认证</strong> —— 一个系统多套账号分开鉴权（比如商城的 User 表和 Admin 表）</li>
<li><strong>单点登录</strong> —— 内置三种单点登录模式：同域、跨域、同Redis、跨Redis、前后端分离等架构都可以搞定。</li>
<li><strong>单点注销</strong> —— 任意子系统内发起注销，即可全端下线。</li>
<li><strong>OAuth2.0认证</strong> —— 轻松搭建 OAuth2.0 服务，支持openid模式 。</li>
<li><strong>分布式会话</strong> —— 提供共享数据中心分布式会话方案。</li>
<li><strong>微服务网关鉴权</strong> —— 适配Gateway、ShenYu、Zuul等常见网关的路由拦截认证。</li>
<li><strong>RPC调用鉴权</strong> —— 网关转发鉴权，RPC调用鉴权，让服务调用不再裸奔</li>
<li><strong>临时Token认证</strong> —— 解决短时间的 Token 授权问题。</li>
<li><strong>独立Redis</strong> —— 将权限缓存与业务缓存分离。</li>
<li><strong>Quick快速登录认证</strong> —— 为项目零代码注入一个登录页面。</li>
<li><strong>标签方言</strong> —— 提供 Thymeleaf 标签方言集成包，提供 beetl 集成示例。</li>
<li><strong>jwt集成</strong> —— 提供三种模式的 jwt 集成方案，提供 token 扩展参数能力。</li>
<li><strong>RPC调用状态传递</strong> —— 提供 dubbo、grpc 等集成包，在RPC调用时登录状态不丢失。</li>
<li><strong>参数签名</strong> —— 提供跨系统API调用签名校验模块，防参数篡改，防请求重放。</li>
<li><strong>自动续签</strong> —— 提供两种Token过期策略，灵活搭配使用，还可自动续签。</li>
<li><strong>开箱即用</strong> —— 提供SpringMVC、WebFlux、Solon 等常见框架集成包，开箱即用。</li>
<li><strong>最新技术栈</strong> —— 适配最新技术栈：支持 SpringBoot 3.x，jdk 17。</li>
</ul>
<p>功能结构图：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/28/1Duqo9p4fe2VWCL.png" alt="image-20240728132015039.png"></p>
<h4 id="鉴权设计-RBAC模型"><a href="#鉴权设计-RBAC模型" class="headerlink" title="鉴权设计-RBAC模型"></a>鉴权设计-RBAC模型</h4><p><strong>RBAC 模型（role-based access control）</strong></p>
<p>非常成熟的安全的模型概念，基于角色帮助我们把授权和用户的访问控制来做结合。</p>
<p>User（用户）用户就是指我们的系统使用者。</p>
<p>PerMission（权限）用户我们对系统的操作，访问哪些东西，可以操作写入操作等等。实际的例子，比如新增题目。</p>
<p>Role（角色）我们去把一组的权限，去做集合，就得到了角色。</p>
<p>核心思想其实就是把角色和权限做关联，实现整体的一个灵活访问，提高我们的系统的安全性和管理型。基于这个模型，我们的开发速度还有粒度的粗细也都是十分好控制的。</p>
<p>优点：</p>
<p>灵活，安全，简化管理。</p>
<p><strong>三种RBAC模型：</strong></p>
<ol>
<li><p><strong>RBAC-0 模型</strong></p>
<p>用户和角色是一个多对多的关系，角色和权限也是一个多对多关系。</p>
</li>
<li><p><strong>RBAC-1 模型</strong></p>
<p>多了一个继承的概念。</p>
<p>比如一个业务部门，经理，主管，营业员。主管的权限肯定不能大于经理，营业员不能大于主管。</p>
<p>子角色的范围一定会小于父角色。</p>
</li>
<li><p><strong>RBAC-2 模型</strong></p>
<p>角色互斥，基数约束，先决条件等等。</p>
<ul>
<li>角色互斥：同一个用户，不能被分配到复制的角色，比如说，你是一个采购，那你就不能分配销售。</li>
<li>基数约束：一个角色分配的用户数量是有限的。比如有一个公司的架构师，最多只能有三个。</li>
<li>先决条件：你想获得架构师的角色，那你必然得先是一个资深工程师的角色。</li>
</ul>
</li>
</ol>
<p><strong>权限</strong>：</p>
<ul>
<li>他的含义其实是非常广泛的，可以是菜单，页面，字段，数据。<ul>
<li>菜单权限</li>
<li>页面权限</li>
<li>字段权限</li>
<li>数据权限</li>
<li>操作权限</li>
</ul>
</li>
</ul>
<p><strong>用户组：</strong></p>
<ul>
<li>平台的用户基数非常大，角色也非常的多，如果说我给每个用户都操作一下角色，就非常的麻烦。</li>
<li>抽象一层组的概念，把同类的用户，放在一起，直接拥有相同的权限。</li>
<li>非常有益于减少工作量，一些管理方面也非常合适。用户组抽象到实际中，其实就是部门啊，科室啊。</li>
</ul>
<h4 id="鉴权数据模型设计"><a href="#鉴权数据模型设计" class="headerlink" title="鉴权数据模型设计"></a>鉴权数据模型设计</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/28/ERumTNky47Z1xAK.jpg" alt="4aaca7492044e3e4d3c9d55c9b05c39.jpg"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for auth_permission</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `auth_permission`;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> `auth_permission`</span><br><span class="line">(</span><br><span class="line">    `id`             <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span> AUTO_INCREMENT,</span><br><span class="line">    `name`           <span class="type">varchar</span>(<span class="number">64</span>)  <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;权限名称&#x27;</span>,</span><br><span class="line">    `parent_id`      <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;父id&#x27;</span>,</span><br><span class="line">    `type`           tinyint(<span class="number">4</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;权限类型 0菜单 1操作&#x27;</span>,</span><br><span class="line">    `menu_url`       <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;菜单路由&#x27;</span>,</span><br><span class="line">    `status`         tinyint(<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;状态 0启用 1禁用&#x27;</span>,</span><br><span class="line">    `<span class="keyword">show</span>`           tinyint(<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;展示状态 0展示 1隐藏&#x27;</span>,</span><br><span class="line">    `icon`           <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;图标&#x27;</span>,</span><br><span class="line">    `permission_key` <span class="type">varchar</span>(<span class="number">64</span>)  <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;权限唯一标识&#x27;</span>,</span><br><span class="line">    `created_by`     <span class="type">varchar</span>(<span class="number">32</span>)  <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建人&#x27;</span>,</span><br><span class="line">    `created_time`   datetime     <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">    `update_by`      <span class="type">varchar</span>(<span class="number">32</span>)  <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新人&#x27;</span>,</span><br><span class="line">    `update_time`    datetime     <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">    `is_deleted`     <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;是否被删除 0为删除 1已删除&#x27;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">2</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of auth_permission</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> `auth_permission`</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;新增题目&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;ladiwd/www&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;http://1.png&#x27;</span>, <span class="string">&#x27;subject:add1&#x27;</span>, <span class="string">&#x27;oYA4HtwGJEsLio6pGrhx5Hzv9XD0&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;2024-02-28 03:20:38&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;2023-11-12 16:17:12&#x27;</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for auth_role</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `auth_role`;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> `auth_role`</span><br><span class="line">(</span><br><span class="line">    `id`           <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span> AUTO_INCREMENT,</span><br><span class="line">    `role_name`    <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;角色名称&#x27;</span>,</span><br><span class="line">    `role_key`     <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;角色唯一标识&#x27;</span>,</span><br><span class="line">    `created_by`   <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建人&#x27;</span>,</span><br><span class="line">    `created_time` datetime    <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">    `update_by`    <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新人&#x27;</span>,</span><br><span class="line">    `update_time`  datetime    <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">    `is_deleted`   <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;是否被删除 0未删除 1已删除&#x27;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">3</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of auth_role</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> `auth_role`</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;管理员&#x27;</span>, <span class="string">&#x27;admin_user&#x27;</span>, <span class="string">&#x27;oYA4HtwGJEsLio6pGrhx5Hzv9XD0&#x27;</span>, <span class="string">&#x27;2024-02-28 03:20:44&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;2023-11-12 16:16:07&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT INTO</span> `auth_role`</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;普通用户&#x27;</span>, <span class="string">&#x27;normal_user&#x27;</span>, <span class="string">&#x27;oYA4HtwGJEsLio6pGrhx5Hzv9XD0&#x27;</span>, <span class="string">&#x27;2024-02-28 03:20:44&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;2023-11-12 16:16:10&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for auth_role_permission</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `auth_role_permission`;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> `auth_role_permission`</span><br><span class="line">(</span><br><span class="line">    `id`            <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span> AUTO_INCREMENT,</span><br><span class="line">    `role_id`       <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;角色id&#x27;</span>,</span><br><span class="line">    `permission_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;权限id&#x27;</span>,</span><br><span class="line">    `created_by`    <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建人&#x27;</span>,</span><br><span class="line">    `created_time`  datetime    <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">    `update_by`     <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新人&#x27;</span>,</span><br><span class="line">    `update_time`   datetime    <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">    `is_deleted`    <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">2</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;角色权限关联表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of auth_role_permission</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for auth_user</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `auth_user`;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> `auth_user`</span><br><span class="line">(</span><br><span class="line">    `id`           <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">    `user_name`    <span class="type">varchar</span>(<span class="number">32</span>)  <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户名称/账号&#x27;</span>,</span><br><span class="line">    `nick_name`    <span class="type">varchar</span>(<span class="number">32</span>)  <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;昵称&#x27;</span>,</span><br><span class="line">    `email`        <span class="type">varchar</span>(<span class="number">32</span>)  <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;邮箱&#x27;</span>,</span><br><span class="line">    `phone`        <span class="type">varchar</span>(<span class="number">32</span>)  <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;手机号&#x27;</span>,</span><br><span class="line">    `password`     <span class="type">varchar</span>(<span class="number">64</span>)  <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;密码&#x27;</span>,</span><br><span class="line">    `sex`          tinyint(<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;性别&#x27;</span>,</span><br><span class="line">    `avatar`       <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;头像&#x27;</span>,</span><br><span class="line">    `status`       tinyint(<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;状态 0启用 1禁用&#x27;</span>,</span><br><span class="line">    `introduce`    <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;个人介绍&#x27;</span>,</span><br><span class="line">    `ext_json`     <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;特殊字段&#x27;</span>,</span><br><span class="line">    `created_by`   <span class="type">varchar</span>(<span class="number">32</span>)  <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建人&#x27;</span>,</span><br><span class="line">    `created_time` datetime     <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">    `update_by`    <span class="type">varchar</span>(<span class="number">32</span>)  <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新人&#x27;</span>,</span><br><span class="line">    `update_time`  datetime     <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">    `is_deleted`   <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;是否被删除 0未删除 1已删除&#x27;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;用户信息表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of auth_user</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for auth_user_role</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `auth_user_role`;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> `auth_user_role`</span><br><span class="line">(</span><br><span class="line">    `id`           <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">    `user_id`      <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户id&#x27;</span>,</span><br><span class="line">    `role_id`      <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;角色id&#x27;</span>,</span><br><span class="line">    `created_by`   <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建人&#x27;</span>,</span><br><span class="line">    `created_time` datetime    <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">    `update_by`    <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新人&#x27;</span>,</span><br><span class="line">    `update_time`  datetime    <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">    `is_deleted`   <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;用户角色表&#x27;</span>;</span><br></pre></td></tr></table></figure>



<h4 id="鉴权架构设计"><a href="#鉴权架构设计" class="headerlink" title="鉴权架构设计"></a>鉴权架构设计</h4><p><strong>jc-club-auth</strong>：这个服务承载了我们所有的基础数据源。他<strong>不管鉴权，只管数据相关的持久化操作以及业务操作</strong>，提供出各种各样的权限相关的接口。</p>
<p><strong>nacos：</strong>将 auth 服务以及 subject 服务都注册到上面。内部进行调用，不对外暴露。通过 nacos 实现我们的服务发现。</p>
<p><strong>gateway（网关）</strong>：网关层会<strong>对外提供服务</strong>，<strong>内部实现路由，鉴权</strong>。整体我们采取 token 的方式来与前端进行交互。由网关来决定当前用户是否可以操作到后面的业务逻辑。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/28/hWNqz4F7CsrRXdg.png" alt="image-20240728144400289.png"></p>
<p>鉴权、路由等处理都由网关来做。</p>
<h4 id="鉴权功能设计"><a href="#鉴权功能设计" class="headerlink" title="鉴权功能设计"></a>鉴权功能设计</h4><ol>
<li><p>用户基础模块 </p>
<ul>
<li>新增用户</li>
<li>修改用户</li>
<li>删除用户</li>
<li>用户启用</li>
<li>用户禁用</li>
<li>用户密码加密</li>
</ul>
</li>
<li><p>角色基础模块 </p>
<ul>
<li>新增角色</li>
<li>修改角色</li>
<li>删除角色</li>
<li>角色与用户的关联</li>
</ul>
</li>
<li><p>权限基础模块 </p>
<ul>
<li><p>新增权限</p>
</li>
<li><p>修改权限</p>
</li>
<li><p>删除权限</p>
</li>
<li><p>权限禁用与启用</p>
</li>
<li><p>权限的展示与隐藏</p>
</li>
<li><p>权限与角色关联</p>
</li>
</ul>
</li>
<li><p>登录注册模块 </p>
<ul>
<li>注册用户与验证</li>
</ul>
<ol>
<li><p>短信的方式，通过向手机号发送验证码，来实现用户的验证并登录（考虑的成本是短信的费用）</p>
</li>
<li><p>邮箱的注册登录。</p>
<p>用户注册的时候，留一个邮箱，我们往邮箱里通过邮箱服务器发送一个链接，用户点击之后，实现一个激活，激活成功之后就完成了注册。（0 成本，坏处这种发送的邮件很容易进垃圾箱）</p>
</li>
<li><p>个人公众号模式（个人开发者无公司的，比较适合使用，0 成本）</p>
<p>用户登录的时候，弹出我们的这个公众号的码。扫码后，用户输入我们提示的验证码。可以随机比如说 nadbuge，通过我们的公众号对接的回调。能拿到一定的信息，用户的 openId。进而记录用户的信息</p>
</li>
<li><p>企业的服务号（必须要有营业执照，自己玩的不上线的话，也可以用测试号）</p>
<p>好处就是不仅打通了各种回调，而且还能拿到用户的信息。</p>
</li>
</ol>
<ul>
<li>登录功能</li>
</ul>
<p>  传统的 pc 形式，都是登录之后，写入 cookie。前端再次请求的时候，带着 cookie 一个身份识别就可以完成认证。</p>
<p>  坏处是什么？小程序呀，app 呀，其实是没有 cookie 这个概念的。</p>
<p>  <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_53895518/article/details/136869614">单点登录(SSO)详解——超详细-CSDN博客</a></p>
<p>  为了更好的扩展，我们就直接选择 <strong>token的模式</strong>。token 放入 header 来实现用户身份的识别与鉴权。</p>
<ul>
<li>踢人下线</li>
</ul>
<p>  发现风险用户，可以通过后台直接把用户踢掉，禁止其再访问，token 也可以直接置为失效的形式。</p>
<ul>
<li>集成 redis （保存token）</li>
</ul>
<p>  如果说我们选择了 token，然后不做 token 的保存，服务重启呀，分布式微服务啊，数据是无法共享并且会产生丢失问题，所以用 redis 来存储一些信息，实现共享。</p>
<ul>
<li><p>自定义我们的 token 风格和前缀 </p>
<p>比如正常的 token 可能是 uuid，我们可以选择其他形式。</p>
<p>然后就是 token 的前端的传递，也可以去定义前缀，固定前缀才生效。</p>
</li>
<li><p>记住我</p>
</li>
</ul>
<p>  当我们去勾选记住我的时候，下次登录就自动实现了。</p>
<p>  前后端分离，没有 token 的时候，必然会产生无法实现的问题，我们就选择在前端的 localstorage 来做。</p>
</li>
<li><p>网关统一鉴权 </p>
<p>校验权限，校验用户的角色等等的东西，就放在网关里面统一去做。</p>
<p>不放在网关，导致每个微服务，全要引入的鉴权的框架，不断的去写重复的代码。</p>
<p>数据的权限获取产生问题：</p>
<ol>
<li>网关直接对接数据库，实现查询。</li>
<li>redis 中获取数据，获取不到的时候还是要像第一种一样去数据库里查。</li>
<li>redis 中获取缓存，没有的话，从 auth 服务里面获取相关的信息。</li>
<li>直接从 redis 读取。</li>
</ol>
</li>
</ol>
<h4 id="auth模块配置"><a href="#auth模块配置" class="headerlink" title="auth模块配置"></a>auth模块配置</h4><p><code>jc-club-auth-application/pom.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> //用于 Spring Cloud 项目中，通过 Feign 客户端简化 HTTP 客户端的调用。</span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> //用于 Spring Cloud 项目中，提供客户端负载均衡功能。</span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> //自动生成 getter、setter、构造函数等。</span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>jc-club-auth-application-controller/pom.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- sa-token 依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.dev33<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sa-token-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.37.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.jingdianjichi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jc-club-auth-domain<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.jingdianjichi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jc-club-auth-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>jc-club-auth-starter/pom.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.jingdianjichi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jc-club-auth-infra<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.jingdianjichi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jc-club-auth-application-controller<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> //nacos</span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>jc-club-auth-domain/pom.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.jingdianjichi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jc-club-auth-infra<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.jingdianjichi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jc-club-auth-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.12.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.12.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.code.gson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>jc-club-auth-infra/pom.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- jdbcStarter --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- druid连接池 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- mysql --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- mybatisplus --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.jingdianjichi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jc-club-auth-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="登录-详情在用户模块"><a href="#登录-详情在用户模块" class="headerlink" title="登录(详情在用户模块)"></a>登录(详情在用户模块)</h4><p>注意openid就是username</p>
<p><strong>Sa-token</strong></p>
<p><a target="_blank" rel="noopener" href="https://sa-token.cc/doc.html#/up/not-cookie">前后端分离 (sa-token.cc)</a></p>
<p>在auth模块中的<code>UserController.java</code>中实现</p>
<p><code>jc-club-auth: UserController</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;doLogin&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;SaTokenInfo&gt; <span class="title function_">doLogin</span><span class="params">(<span class="meta">@RequestParam(&quot;validCode&quot;)</span> String validCode)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Preconditions.checkArgument(!StringUtils.isBlank(validCode), <span class="string">&quot;验证码不能为空!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(authUserDomainService.doLogin(validCode));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;UserController.doLogin.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;用户登录失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>jc-club-auth:AuthUserDomainServiceImpl</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SaTokenInfo <span class="title function_">doLogin</span><span class="params">(String validCode)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">loginKey</span> <span class="operator">=</span> redisUtil.buildKey(LOGIN_PREFIX, validCode);</span><br><span class="line">    <span class="type">String</span> <span class="variable">openId</span> <span class="operator">=</span> redisUtil.get(loginKey);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(openId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">AuthUserBO</span> <span class="variable">authUserBO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthUserBO</span>();</span><br><span class="line">    authUserBO.setUserName(openId);</span><br><span class="line">    <span class="built_in">this</span>.register(authUserBO);</span><br><span class="line">    StpUtil.login(openId);</span><br><span class="line">    <span class="type">SaTokenInfo</span> <span class="variable">tokenInfo</span> <span class="operator">=</span> StpUtil.getTokenInfo();</span><br><span class="line">    <span class="keyword">return</span> tokenInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="微服务注册到nacos"><a href="#微服务注册到nacos" class="headerlink" title="微服务注册到nacos"></a>微服务注册到nacos</h4><p>阿里云脚手架用于组件&#x2F;版本的选择兼容，非常方便: <a href="">start.aliyun.com</a></p>
<h5 id="oss服务-nacos"><a href="#oss服务-nacos" class="headerlink" title="oss服务-&gt;nacos"></a>oss服务-&gt;nacos</h5><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/29/zDoegrTpUiBQHu5.png" alt="image-20240729102012839.png"></p>
<p><code>pom.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> //构建 Web 应用程序所需的 Spring MVC 和 Tomcat。</span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> //不会包含默认的日志框架</span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.minio<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span> //用于与 Minio 对象存储服务进行交互的客户端库。</span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>minio<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span> //</span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> //减少样板代码，自动生成 getter、setter 等。</span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> //用于集成 Nacos 配置中心，提供配置管理功能。</span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> //替换默认的日志框架，使用 Log4j2 作为日志记录器。</span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> //用于 Spring Cloud 应用的引导类，帮助应用启动时加载配置(bootstrap.yaml)。</span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> //用于集成 Nacos 服务发现，提供服务注册与发现功能。</span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里要用到<code>bootstrap.yaml</code>去在nacos中注册:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">jc-club-oss-dev</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">117.72</span><span class="number">.14</span><span class="number">.166</span><span class="string">:8848</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">DEFAULT_GROUP</span></span><br><span class="line">        <span class="attr">namespace:</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">117.72</span><span class="number">.14</span><span class="number">.166</span><span class="string">:8848</span> <span class="string">//部署有nacos的云服务器的地址</span></span><br></pre></td></tr></table></figure>

<p>启动程序就注册上去了</p>
<h5 id="（gateway-nacos）Spring-Cloud-Gateway搭建及路由配置"><a href="#（gateway-nacos）Spring-Cloud-Gateway搭建及路由配置" class="headerlink" title="（gateway-&gt;nacos）Spring Cloud Gateway搭建及路由配置"></a>（gateway-&gt;nacos）Spring Cloud Gateway搭建及路由配置</h5><p><code>pom.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.minio<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>minio<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>bootstrap.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">jc-club-gateway-dev</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">117.72</span><span class="number">.14</span><span class="number">.166</span><span class="string">:8848</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">DEFAULT_GROUP</span></span><br><span class="line">        <span class="attr">namespace:</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">117.72</span><span class="number">.14</span><span class="number">.166</span><span class="string">:8848</span></span><br></pre></td></tr></table></figure>

<p><code>application.yaml</code>，用于路由转发</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">5000</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">oss</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://jc-club-oss-dev</span> <span class="string">//使用</span> <span class="string">lb://</span> <span class="string">前缀表示这是一个负载均衡器的调用。jc-club-oss-dev</span> <span class="string">是服务名，Spring</span> <span class="string">Cloud</span> <span class="string">Gateway</span> <span class="string">将通过服务发现找到对应的实例。</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/oss/**</span> <span class="string">//路由匹配条件</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=1</span> <span class="string">//过滤器用于从请求路径中去除前缀。</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">auth</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://jc-club-auth-dev</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/auth/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">subject</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://jc-club-subject-dev</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/subject/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=1</span></span><br></pre></td></tr></table></figure>

<p>运行及注册到nacos中，并且可以通过网关进行路由转发到对应的微服务上。</p>
<h5 id="鉴权-刷题-nacos"><a href="#鉴权-刷题-nacos" class="headerlink" title="鉴权+刷题-&gt;nacos"></a>鉴权+刷题-&gt;nacos</h5><p><strong>auth:</strong></p>
<p><code>starter/pom.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.jingdianjichi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jc-club-auth-infra<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.jingdianjichi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jc-club-auth-application-controller<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>bootstrap.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">jc-club-gateway-dev</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">117.72</span><span class="number">.14</span><span class="number">.166</span><span class="string">:8848</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">DEFAULT_GROUP</span></span><br><span class="line">        <span class="attr">namespace:</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">117.72</span><span class="number">.14</span><span class="number">.166</span><span class="string">:8848</span></span><br></pre></td></tr></table></figure>

<p><strong>subject：</strong></p>
<p><code>starter/pom.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.jingdianjichi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jc-club-application-controller<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.jingdianjichi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jc-club-application-mq<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.jingdianjichi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jc-club-infra<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>bootstrap.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">jc-club-subject-dev</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">117.72</span><span class="number">.14</span><span class="number">.166</span><span class="string">:8848</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">DEFAULT_GROUP</span></span><br><span class="line">        <span class="attr">namespace:</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">117.72</span><span class="number">.14</span><span class="number">.166</span><span class="string">:8848</span></span><br></pre></td></tr></table></figure>

<h4 id="Sa-Token集成Redis"><a href="#Sa-Token集成Redis" class="headerlink" title="Sa-Token集成Redis"></a>Sa-Token集成Redis</h4><p><a target="_blank" rel="noopener" href="https://sa-token.cc/doc.html#/up/integ-redis">集成 Redis (sa-token.cc)</a></p>
<p><a target="_blank" rel="noopener" href="https://sa-token.cc/doc.html#/up/integ-redis">redis.io&#x2F;docs&#x2F;management&#x2F;config</a></p>
<h4 id="gateway网关（sa-token）基于redis实现分布式会话鉴权"><a href="#gateway网关（sa-token）基于redis实现分布式会话鉴权" class="headerlink" title="gateway网关（sa-token）基于redis实现分布式会话鉴权"></a>gateway网关（sa-token）基于redis实现分布式会话鉴权</h4><p><strong>gateway 集成 redis 及 refactor 鉴权</strong></p>
<p><strong>pom文件写入</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 省略了之前的部分，下面的是新增的 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Sa-Token 权限认证（Reactor响应式集成）, 在线文档：https://sa-token.cc --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.dev33<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sa-token-reactor-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.37.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Sa-Token 整合 Redis （使用 jackson 序列化方式） --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.dev33<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sa-token-redis-jackson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.37.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.code.gson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>gateway的<code>applicaiton.yaml</code>,修改网关配置文件</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">5000</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">oss</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://jc-club-oss-dev</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/oss/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">auth</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://jc-club-auth-dev</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/auth/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">subject</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://jc-club-subject-dev</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/subject/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">practice</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://jc-club-practice-dev</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/practice/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">circle</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://jc-club-circle</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/circle/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">interview</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://jc-club-interview</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/interview/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=1</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="comment"># Redis数据库索引（默认为0）</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">1</span></span><br><span class="line">    <span class="comment"># Redis服务器地址</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">117.72</span><span class="number">.14</span><span class="number">.166</span></span><br><span class="line">    <span class="comment"># Redis服务器连接端口</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="comment"># Redis服务器连接密码（默认为空）</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">jichi1234</span></span><br><span class="line">    <span class="comment"># 连接超时时间</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">2s</span></span><br><span class="line">    <span class="attr">lettuce:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="comment"># 连接池最大连接数</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">200</span></span><br><span class="line">        <span class="comment"># 连接池最大阻塞等待时间（使用负值表示没有限制）</span></span><br><span class="line">        <span class="attr">max-wait:</span> <span class="string">-1ms</span></span><br><span class="line">        <span class="comment"># 连接池中的最大空闲连接</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">10</span></span><br><span class="line">        <span class="comment"># 连接池中的最小空闲连接</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">sa-token:</span></span><br><span class="line">  <span class="comment"># token 名称（同时也是 cookie 名称）</span></span><br><span class="line">  <span class="attr">token-name:</span> <span class="string">satoken</span></span><br><span class="line">  <span class="comment"># token 有效期（单位：秒） 默认30天，-1 代表永久有效</span></span><br><span class="line">  <span class="attr">timeout:</span> <span class="number">2592000</span></span><br><span class="line">  <span class="comment"># token 最低活跃频率（单位：秒），如果 token 超过此时间没有访问系统就会被冻结，默认-1 代表不限制，永不冻结</span></span><br><span class="line">  <span class="attr">active-timeout:</span> <span class="number">-1</span></span><br><span class="line">  <span class="comment"># 是否允许同一账号多地同时登录 （为 true 时允许一起登录, 为 false 时新登录挤掉旧登录）</span></span><br><span class="line">  <span class="attr">is-concurrent:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 在多人登录同一账号时，是否共用一个 token （为 true 时所有登录共用一个 token, 为 false 时每次登录新建一个 token）</span></span><br><span class="line">  <span class="attr">is-share:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># token 风格（默认可取值：uuid、simple-uuid、random-32、random-64、random-128、tik）</span></span><br><span class="line">  <span class="attr">token-style:</span> <span class="string">random-32</span></span><br><span class="line">  <span class="comment"># 是否输出操作日志</span></span><br><span class="line">  <span class="attr">is-log:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">token-prefix:</span> <span class="string">jichi</span></span><br></pre></td></tr></table></figure>

<p><code>jc-club-auth-starter/application.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"> <span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3011</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">qvQP7MBvSkbyGzLzlRaPp9swmOmkqdVkVgBNPQF7pMlImathGYopQcWR2CuZMZAkL1xrDHwut9Hbr2TZ4qmr2Q==</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://117.72.14.166:3306/jc-club?serverTimezone=Asia/Shanghai&amp;useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">    <span class="attr">druid:</span></span><br><span class="line">      <span class="attr">initial-size:</span> <span class="number">20</span></span><br><span class="line">      <span class="attr">min-idle:</span> <span class="number">20</span></span><br><span class="line">      <span class="attr">connectionProperties:</span> <span class="string">config.decrypt=true;config.decrypt.key=$&#123;publicKey&#125;;</span></span><br><span class="line">      <span class="attr">max-active:</span> <span class="number">100</span></span><br><span class="line">      <span class="attr">max-wait:</span> <span class="number">60000</span></span><br><span class="line">      <span class="attr">stat-view-servlet:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">url-pattern:</span> <span class="string">/druid/*</span></span><br><span class="line">        <span class="attr">login-username:</span> <span class="string">admin</span></span><br><span class="line">        <span class="attr">login-password:</span> <span class="number">123456</span></span><br><span class="line">      <span class="attr">filter:</span></span><br><span class="line">        <span class="attr">stat:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">slow-sql-millis:</span> <span class="number">2000</span></span><br><span class="line">          <span class="attr">log-slow-sql:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">wall:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">config:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="comment"># Redis数据库索引（默认为0）</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">1</span></span><br><span class="line">    <span class="comment"># Redis服务器地址</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">117.72</span><span class="number">.14</span><span class="number">.166</span></span><br><span class="line">    <span class="comment"># Redis服务器连接端口</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="comment"># Redis服务器连接密码（默认为空）</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">jichi1234</span></span><br><span class="line">    <span class="comment"># 连接超时时间</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">2s</span></span><br><span class="line">    <span class="attr">lettuce:</span> <span class="comment">#lettuce连接池</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="comment"># 连接池最大连接数</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">200</span></span><br><span class="line">        <span class="comment"># 连接池最大阻塞等待时间（使用负值表示没有限制）</span></span><br><span class="line">        <span class="attr">max-wait:</span> <span class="string">-1ms</span></span><br><span class="line">        <span class="comment"># 连接池中的最大空闲连接</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">10</span></span><br><span class="line">        <span class="comment"># 连接池中的最小空闲连接</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">publicKey:</span> <span class="string">MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAMJzo9TiSuOGAMR2Zma25lWdtR1oxq6RcZYnWE9vcYLNKxUOkBlvSfMrbS25KtlJi+hIzikfCoyTDB0VI5gB3Q8CAwEAAQ==</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">config:</span> <span class="string">classpath:log4j2-spring.xml</span></span><br><span class="line"><span class="attr">sa-token:</span></span><br><span class="line">  <span class="comment"># token 名称（同时也是 cookie 名称）</span></span><br><span class="line">  <span class="attr">token-name:</span> <span class="string">satoken</span></span><br><span class="line">  <span class="comment"># token 有效期（单位：秒） 默认30天，-1 代表永久有效</span></span><br><span class="line">  <span class="attr">timeout:</span> <span class="number">2592000</span></span><br><span class="line">  <span class="comment"># token 最低活跃频率（单位：秒），如果 token 超过此时间没有访问系统就会被冻结，默认-1 代表不限制，永不冻结</span></span><br><span class="line">  <span class="attr">active-timeout:</span> <span class="number">-1</span></span><br><span class="line">  <span class="comment"># 是否允许同一账号多地同时登录 （为 true 时允许一起登录, 为 false 时新登录挤掉旧登录）</span></span><br><span class="line">  <span class="attr">is-concurrent:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 在多人登录同一账号时，是否共用一个 token （为 true 时所有登录共用一个 token, 为 false 时每次登录新建一个 token）</span></span><br><span class="line">  <span class="attr">is-share:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># token 风格（默认可取值：uuid、simple-uuid、random-32、random-64、random-128、tik）</span></span><br><span class="line">  <span class="attr">token-style:</span> <span class="string">random-32</span></span><br><span class="line">  <span class="comment"># 是否输出操作日志</span></span><br><span class="line">  <span class="attr">is-log:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">token-prefix:</span> <span class="string">jichi</span></span><br></pre></td></tr></table></figure>

<p><strong>网关自定义权限接口扩展</strong> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StpInterfaceImpl</span> <span class="keyword">implements</span> <span class="title class_">StpInterface</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisUtil redisUtil;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">authPermissionPrefix</span> <span class="operator">=</span> <span class="string">&quot;auth.permission&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">authRolePrefix</span> <span class="operator">=</span> <span class="string">&quot;auth.role&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getPermissionList</span><span class="params">(Object loginId, String loginType)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getAuth(loginId.toString(), authPermissionPrefix);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getRoleList</span><span class="params">(Object loginId, String loginType)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getAuth(loginId.toString(), authRolePrefix);</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><code>jc-club-gateway:SaTokenConfigure</code>，satoken配置。</p>
<p>这个配置类的主要作用是：</p>
<ul>
<li>拦截所有请求。</li>
<li>根据请求的路径，执行不同的权限校验逻辑，确保只有具有相应权限的用户才能访问特定的资源。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SaTokenConfigure</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SaReactorFilter <span class="title function_">getSaReactorFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SaReactorFilter</span>()</span><br><span class="line">                <span class="comment">// 拦截地址</span></span><br><span class="line">                .addInclude(<span class="string">&quot;/**&quot;</span>)</span><br><span class="line">                <span class="comment">// 鉴权方法：每次访问进入</span></span><br><span class="line">                .setAuth(obj -&gt; &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;-------- 前端访问path：&quot;</span> + SaHolder.getRequest().getRequestPath());</span><br><span class="line">                    <span class="comment">// 登录校验 -- 拦截所有路由，并排除/user/doLogin 用于开放登录</span></span><br><span class="line">                    SaRouter.match(<span class="string">&quot;/auth/**&quot;</span>, <span class="string">&quot;/auth/user/doLogin&quot;</span>, r -&gt; StpUtil.checkRole(<span class="string">&quot;admin&quot;</span>));</span><br><span class="line">                    SaRouter.match(<span class="string">&quot;/oss/**&quot;</span>, r -&gt; StpUtil.checkLogin());</span><br><span class="line">                    SaRouter.match(<span class="string">&quot;/subject/subject/add&quot;</span>, r -&gt; StpUtil.checkPermission(<span class="string">&quot;subject:add&quot;</span>));</span><br><span class="line">                    SaRouter.match(<span class="string">&quot;/subject/**&quot;</span>, r -&gt; StpUtil.checkLogin());</span><br><span class="line">                &#125;)</span><br><span class="line">                ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="网关全局异常处理（sa-token-mono）"><a href="#网关全局异常处理（sa-token-mono）" class="headerlink" title="网关全局异常处理（sa-token mono）"></a>网关全局异常处理（sa-token mono）</h4><p>Sa-token 提供的示例，适用于单体项目的全局异常捕获。我们选择了微服务架构，则就要变为通过网关来进行全局异常的处理，我们希望，权限发生异常的时候，可以统一做 401 的返回，前端进行跳转登录。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/06/FqMnKyZGQum9sSr.png" alt="image-20240729142433511.png"></p>
<p><code>GatewayExceptionHandler.java</code></p>
<p>这个全局异常处理器的主要作用是：</p>
<ul>
<li>捕获并处理网关中的异常。</li>
<li>根据异常类型返回不同的状态码和消息。</li>
<li>将异常信息序列化为 JSON 格式，并设置正确的 <code>Content-Type</code> 发送回客户端。</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/aofengdaxia/article/details/129265983?ops_request_misc=%7B%22request_id%22:%22172223483416800182161820%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=172223483416800182161820&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-129265983-null-null.142%5Ev100%5Epc_search_result_base8&utm_term=ErrorWebExceptionHandler&spm=1018.2226.3001.4187">深入学习ErrorWebExceptionHandler-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/crazymakercircle/article/details/124120506?ops_request_misc=%7B%22request_id%22:%22172223509816800186538079%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=172223509816800186538079&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-124120506-null-null.142%5Ev100%5Epc_search_result_base8&utm_term=mono&spm=1018.2226.3001.4187">Flux、Mono、Reactor 实战（史上最全）_reactor mono-CSDN博客</a></p>
<p>[响应式编程二Mono，Flux简单介绍_flux mono-CSDN博客](<a target="_blank" rel="noopener" href="https://blog.csdn.net/lsdstone/article/details/134983206?ops_request_misc=&request_id=&biz_id=102&utm_term=mono">https://blog.csdn.net/lsdstone/article/details/134983206?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=mono</a> java响应式&amp;utm_medium&#x3D;distribute.pc_search_result.none-task-blog-2<del>all</del>sobaiduweb~default-2-134983206.142^v100^pc_search_result_base8&amp;spm&#x3D;1018.2226.3001.4187)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GatewayExceptionHandler</span> <span class="keyword">implements</span> <span class="title class_">ErrorWebExceptionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>(); <span class="comment">//创建了一个ObjectMapper实例，用于将Java对象转换为JSON格式。</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">handle</span><span class="params">(ServerWebExchange serverWebExchange, Throwable throwable)</span> &#123; <span class="comment">//处理异常的方法，返回一个Mono&lt;Void&gt;类型，表示异步操作的完成。</span></span><br><span class="line">        <span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> serverWebExchange.getRequest();</span><br><span class="line">        <span class="type">ServerHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> serverWebExchange.getResponse();</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">code</span> <span class="operator">=</span> <span class="number">200</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (throwable <span class="keyword">instanceof</span> SaTokenException) &#123;</span><br><span class="line">            code = <span class="number">401</span>;</span><br><span class="line">            message = <span class="string">&quot;用户无权限&quot;</span>;</span><br><span class="line">            throwable.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            code = <span class="number">500</span>;</span><br><span class="line">            message = <span class="string">&quot;系统繁忙&quot;</span>;</span><br><span class="line">            throwable.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> Result.fail(code, message);</span><br><span class="line">        response.getHeaders().setContentType(MediaType.APPLICATION_JSON);</span><br><span class="line">        <span class="keyword">return</span> response.writeWith(Mono.fromSupplier(() -&gt; &#123;</span><br><span class="line">            <span class="comment">/*使用response.writeWith方法，结合Mono.fromSupplier来异步写入响应体。</span></span><br><span class="line"><span class="comment">在Mono.fromSupplier中：</span></span><br><span class="line"><span class="comment">使用objectMapper.writeValueAsBytes(result)将Result对象序列化为JSON格式的字节数组。</span></span><br><span class="line"><span class="comment">使用DataBufferFactory.wrap(bytes)将字节数组包装成数据缓冲区，以便写入响应体*/</span></span><br><span class="line">            <span class="type">DataBufferFactory</span> <span class="variable">dataBufferFactory</span> <span class="operator">=</span> response.bufferFactory();</span><br><span class="line">            <span class="type">byte</span>[] bytes = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                bytes = objectMapper.writeValueAsBytes(result); <span class="comment">//json格式字节数组</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> dataBufferFactory.wrap(bytes); <span class="comment">//包装成数据缓冲区</span></span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ResultCodeEnum.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">ResultCodeEnum</span> &#123;</span><br><span class="line"></span><br><span class="line">    SUCCESS(<span class="number">200</span>,<span class="string">&quot;成功&quot;</span>),</span><br><span class="line">    FAIL(<span class="number">500</span>,<span class="string">&quot;失败&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String desc;</span><br><span class="line"></span><br><span class="line">    ResultCodeEnum(<span class="type">int</span> code, String desc)&#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ResultCodeEnum <span class="title function_">getByCode</span><span class="params">(<span class="type">int</span> codeVal)</span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(ResultCodeEnum resultCodeEnum : ResultCodeEnum.values())&#123;</span><br><span class="line">            <span class="keyword">if</span>(resultCodeEnum.code == codeVal)&#123;</span><br><span class="line">                <span class="keyword">return</span> resultCodeEnum;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Result.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Result</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Boolean success;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Result <span class="title function_">ok</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Result</span>();</span><br><span class="line">        result.setSuccess(<span class="literal">true</span>);</span><br><span class="line">        result.setCode(ResultCodeEnum.SUCCESS.getCode());</span><br><span class="line">        result.setMessage(ResultCodeEnum.SUCCESS.getDesc());</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Result <span class="title function_">ok</span><span class="params">(T data)</span> &#123;</span><br><span class="line">        <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Result</span>();</span><br><span class="line">        result.setSuccess(<span class="literal">true</span>);</span><br><span class="line">        result.setCode(ResultCodeEnum.SUCCESS.getCode());</span><br><span class="line">        result.setMessage(ResultCodeEnum.SUCCESS.getDesc());</span><br><span class="line">        result.setData(data);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Result <span class="title function_">fail</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Result</span>();</span><br><span class="line">        result.setSuccess(<span class="literal">false</span>);</span><br><span class="line">        result.setCode(ResultCodeEnum.FAIL.getCode());</span><br><span class="line">        result.setMessage(ResultCodeEnum.FAIL.getDesc());</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Result <span class="title function_">fail</span><span class="params">(T data)</span> &#123;</span><br><span class="line">        <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Result</span>();</span><br><span class="line">        result.setSuccess(<span class="literal">false</span>);</span><br><span class="line">        result.setCode(ResultCodeEnum.FAIL.getCode());</span><br><span class="line">        result.setMessage(ResultCodeEnum.FAIL.getDesc());</span><br><span class="line">        result.setData(data);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Result <span class="title function_">fail</span><span class="params">(Integer code,String message)</span> &#123;</span><br><span class="line">        <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Result</span>();</span><br><span class="line">        result.setSuccess(<span class="literal">false</span>);</span><br><span class="line">        result.setCode(code);</span><br><span class="line">        result.setMessage(message);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="gateway实现redis权限数据拉取-gateway"><a href="#gateway实现redis权限数据拉取-gateway" class="headerlink" title="gateway实现redis权限数据拉取(gateway)"></a>gateway实现redis权限数据拉取(gateway)</h4><p><strong>RedisTemplate-&gt;RedisConfig(重写序列化，@Bean创建RedisTemplate bean)-&gt;RedisUtil(封装对redis的操作，具体是用redistemplate来操作的)</strong></p>
<p>为什么重写redistemplate?</p>
<ul>
<li>这里不重新他的一个序列化会造成一个乱码的问题，重写了RedisTemplate:<ul>
<li>objectMapper-&gt;Jackson2jsonRedisSerializer-&gt;redisTemplate，注意@Bean注入</li>
</ul>
</li>
</ul>
<p>网关读取权限内容有三种形式。</p>
<p>1、网关层直接与数据库交互</p>
<p>2、网关层与 redis 进行交互</p>
<p>3、网关层与 redis 进行交互，redis 没有，则通过 feign 调用 auth 服务获取。</p>
<p>选择第二种形式，完全信任缓存，同时引出数据库与缓存数据一致性的方案。</p>
<p><code>pom.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.code.gson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>自定义获取权限改为从 redis:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jingdianjichi.club.gateway.auth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.dev33.satoken.stp.StpInterface;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.commons.lang.StringUtils;</span><br><span class="line"><span class="keyword">import</span> com.google.gson.Gson;</span><br><span class="line"><span class="keyword">import</span> com.google.gson.reflect.TypeToken;</span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.club.gateway.entity.AuthPermission;</span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.club.gateway.entity.AuthRole;</span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.club.gateway.redis.RedisUtil;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StpInterfaceImpl</span> <span class="keyword">implements</span> <span class="title class_">StpInterface</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisUtil redisUtil;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">authPermissionPrefix</span> <span class="operator">=</span> <span class="string">&quot;auth.permission&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">authRolePrefix</span> <span class="operator">=</span> <span class="string">&quot;auth.role&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getPermissionList</span><span class="params">(Object loginId, String loginType)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getAuth(loginId.toString(), authPermissionPrefix);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getRoleList</span><span class="params">(Object loginId, String loginType)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getAuth(loginId.toString(), authRolePrefix);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; <span class="title function_">getAuth</span><span class="params">(String loginId, String prefix)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">authKey</span> <span class="operator">=</span> redisUtil.buildKey(prefix, loginId.toString());</span><br><span class="line">        <span class="type">String</span> <span class="variable">authValue</span> <span class="operator">=</span> redisUtil.get(authKey);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(authValue)) &#123; <span class="comment">//若空返回空</span></span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;String&gt; authList = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (authRolePrefix.equals(prefix)) &#123;</span><br><span class="line">            List&lt;AuthRole&gt; roleList = <span class="keyword">new</span> <span class="title class_">Gson</span>().fromJson(authValue, <span class="keyword">new</span> <span class="title class_">TypeToken</span>&lt;List&lt;AuthRole&gt;&gt;() &#123;</span><br><span class="line">            &#125;.getType());</span><br><span class="line">            authList = roleList.stream().map(AuthRole::getRoleKey).collect(Collectors.toList());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (authPermissionPrefix.equals(prefix)) &#123;</span><br><span class="line">            List&lt;AuthPermission&gt; permissionList = <span class="keyword">new</span> <span class="title class_">Gson</span>().fromJson(authValue, <span class="keyword">new</span> <span class="title class_">TypeToken</span>&lt;List&lt;AuthPermission&gt;&gt;() &#123;</span><br><span class="line">            &#125;.getType());</span><br><span class="line">            authList = permissionList.stream().map(AuthPermission::getPermissionKey).collect(Collectors.toList());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> authList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RedisTemplate 重写优化：原生 redis 的 template 的序列化器会产生乱码问题，重写改为 jackson。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_42623400/article/details/115791984?ops_request_misc=%7B%22request_id%22:%22172225253916800225574987%22,%22scm%22:%2220140713.130102334.pc_all.%22%7D&request_id=172225253916800225574987&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-1-115791984-null-null.142%5Ev100%5Epc_search_result_base8&utm_term=redistemplate%E5%92%8Cjackson&spm=1018.2226.3001.4187">Spring date-redis中RedisTemplate的Jackson序列化设置_redistemplate序列化时date带有类型信息-CSDN博客</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jingdianjichi.club.gateway.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonAutoDetect;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonTypeInfo;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.PropertyAccessor;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.DeserializationFeature;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.RedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line">   <span class="comment">/*总结来说，通过在RedisConfig类中使用@Bean注解定义redisTemplate方法，Spring容器会在启动时创建并注册这个RedisTemplate Bean。之后，应用程序的其他部分可以通过@Autowired或@Resource注解来自动获取并使用这个Bean。*/</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String,Object&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span>&#123;</span><br><span class="line">        RedisTemplate&lt;String,Object&gt; redisTemplate = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">        RedisSerializer&lt;String&gt; redisSerializer = <span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>();</span><br><span class="line">        redisTemplate.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        redisTemplate.setKeySerializer(redisSerializer);</span><br><span class="line">        redisTemplate.setHashKeySerializer(redisSerializer);</span><br><span class="line">        redisTemplate.setValueSerializer(jackson2JsonRedisSerializer());</span><br><span class="line">        redisTemplate.setHashValueSerializer(jackson2JsonRedisSerializer());</span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Jackson2JsonRedisSerializer&lt;Object&gt; <span class="title function_">jackson2JsonRedisSerializer</span><span class="params">()</span>&#123;</span><br><span class="line">        Jackson2JsonRedisSerializer&lt;Object&gt; jsonRedisSerializer = <span class="keyword">new</span> <span class="title class_">Jackson2JsonRedisSerializer</span>&lt;&gt;(Object.class); </span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY); <span class="comment">//设置 ObjectMapper 的访问级别，使其能够序列化所有字段，无论它们是否有 public 访问权限。</span></span><br><span class="line">        objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES,<span class="literal">false</span>);</span><br><span class="line">        objectMapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL, JsonTypeInfo.As.PROPERTY);</span><br><span class="line">        jsonRedisSerializer.setObjectMapper(objectMapper); <span class="comment">//将配置好的 ObjectMapper 设置到 Jackson2JsonRedisSerializer 中。</span></span><br><span class="line">        <span class="keyword">return</span> jsonRedisSerializer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RedisUtil 的封装</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jingdianjichi.club.gateway.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Stream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * RedisUtil工具类</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: ChickenWing</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2023/1/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate; <span class="comment">//通过DI拿到被RedisConfig改后的RedisTemplate</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CACHE_KEY_SEPARATOR</span> <span class="operator">=</span> <span class="string">&quot;.&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建缓存key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">buildKey</span><span class="params">(String... strObjs)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Stream.of(strObjs).collect(Collectors.joining(CACHE_KEY_SEPARATOR));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否存在key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">exist</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.hasKey(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">del</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.delete(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(String key, String value)</span> &#123;</span><br><span class="line">        redisTemplate.opsForValue().set(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">setNx</span><span class="params">(String key, String value, Long time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForValue().setIfAbsent(key, value, time, timeUnit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">get</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (String) redisTemplate.opsForValue().get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">zAdd</span><span class="params">(String key, String value, Long score)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForZSet().add(key, value, Double.valueOf(String.valueOf(score)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">countZset</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForZSet().size(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Set&lt;String&gt; <span class="title function_">rangeZset</span><span class="params">(String key, <span class="type">long</span> start, <span class="type">long</span> end)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForZSet().range(key, start, end);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">removeZset</span><span class="params">(String key, Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForZSet().remove(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeZsetList</span><span class="params">(String key, Set&lt;String&gt; value)</span> &#123;</span><br><span class="line">        value.stream().forEach((val) -&gt; redisTemplate.opsForZSet().remove(key, val));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Double <span class="title function_">score</span><span class="params">(String key, Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForZSet().score(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Set&lt;String&gt; <span class="title function_">rangeByScore</span><span class="params">(String key, <span class="type">long</span> start, <span class="type">long</span> end)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForZSet().rangeByScore(key, Double.valueOf(String.valueOf(start)), Double.valueOf(String.valueOf(end)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">addScore</span><span class="params">(String key, Object obj, <span class="type">double</span> score)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForZSet().incrementScore(key, obj, score);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">rank</span><span class="params">(String key, Object obj)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForZSet().rank(key, obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="用户模块开发-auth-user"><a href="#用户模块开发-auth-user" class="headerlink" title="用户模块开发(auth_user)"></a>用户模块开发(auth_user)</h4><p>依然有从DTO-&gt;BO-&gt;entity的converter，此部分忽略掉描述</p>
<h5 id="controller包"><a href="#controller包" class="headerlink" title="controller包"></a>controller包</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user/&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AuthUserDomainService authUserDomainService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户注册</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;register&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">register</span><span class="params">(<span class="meta">@RequestBody</span> AuthUserDTO authUserDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;UserController.register.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(authUserDTO));</span><br><span class="line">            &#125;</span><br><span class="line">            checkUserInfo(authUserDTO);</span><br><span class="line">            <span class="type">AuthUserBO</span> <span class="variable">authUserBO</span> <span class="operator">=</span> AuthUserDTOConverter.INSTANCE.convertDTOToBO(authUserDTO);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(authUserDomainService.register(authUserBO));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;UserController.register.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;注册用户失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改用户信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;update&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> AuthUserDTO authUserDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;UserController.update.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(authUserDTO));</span><br><span class="line">            &#125;</span><br><span class="line">            checkUserInfo(authUserDTO);</span><br><span class="line">            <span class="type">AuthUserBO</span> <span class="variable">authUserBO</span> <span class="operator">=</span> AuthUserDTOConverter.INSTANCE.convertDTOToBO(authUserDTO);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(authUserDomainService.update(authUserBO));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;UserController.update.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;更新用户信息失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取用户信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;getUserInfo&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;AuthUserDTO&gt; <span class="title function_">getUserInfo</span><span class="params">(<span class="meta">@RequestBody</span> AuthUserDTO authUserDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;UserController.getUserInfo.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(authUserDTO));</span><br><span class="line">            &#125;</span><br><span class="line">            Preconditions.checkArgument(!StringUtils.isBlank(authUserDTO.getUserName()), <span class="string">&quot;用户名不能为空&quot;</span>);</span><br><span class="line">            <span class="type">AuthUserBO</span> <span class="variable">authUserBO</span> <span class="operator">=</span> AuthUserDTOConverter.INSTANCE.convertDTOToBO(authUserDTO);</span><br><span class="line">            <span class="type">AuthUserBO</span> <span class="variable">userInfo</span> <span class="operator">=</span> authUserDomainService.getUserInfo(authUserBO);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(AuthUserDTOConverter.INSTANCE.convertBOToDTO(userInfo));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;UserController.update.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;更新用户信息失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量获取用户信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;listByIds&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;List&lt;AuthUserDTO&gt;&gt; <span class="title function_">listUserInfoByIds</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;String&gt; userNameList)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;UserController.listUserInfoByIds.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(userNameList));</span><br><span class="line">            &#125;</span><br><span class="line">            Preconditions.checkArgument(!CollectionUtils.isEmpty(userNameList), <span class="string">&quot;id集合不能为空&quot;</span>);</span><br><span class="line">            List&lt;AuthUserBO&gt; userInfos = authUserDomainService.listUserInfoByIds(userNameList);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(AuthUserDTOConverter.INSTANCE.convertBOToDTO(userInfos));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;UserController.listUserInfoByIds.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;批量获取用户信息失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户退出</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;logOut&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">logOut</span><span class="params">(<span class="meta">@RequestParam</span> String userName)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;UserController.logOut.userName:&#123;&#125;&quot;</span>, userName);</span><br><span class="line">            Preconditions.checkArgument(!StringUtils.isBlank(userName), <span class="string">&quot;用户名不能为空&quot;</span>);</span><br><span class="line">            StpUtil.logout(userName);</span><br><span class="line">            <span class="keyword">return</span> Result.ok();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;UserController.logOut.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;用户登出失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除用户</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;delete&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">delete</span><span class="params">(<span class="meta">@RequestBody</span> AuthUserDTO authUserDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;UserController.delete.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(authUserDTO));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">AuthUserBO</span> <span class="variable">authUserBO</span> <span class="operator">=</span> AuthUserDTOConverter.INSTANCE.convertDTOToBO(authUserDTO);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(authUserDomainService.update(authUserBO));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;UserController.update.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;删除用户信息失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkUserInfo</span><span class="params">(<span class="meta">@RequestBody</span> AuthUserDTO authUserDTO)</span> &#123;</span><br><span class="line">        Preconditions.checkArgument(!StringUtils.isBlank(authUserDTO.getUserName()), <span class="string">&quot;用户名不能为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户启用/禁用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;changeStatus&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">changeStatus</span><span class="params">(<span class="meta">@RequestBody</span> AuthUserDTO authUserDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;UserController.changeStatus.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(authUserDTO));</span><br><span class="line">            &#125;</span><br><span class="line">            Preconditions.checkNotNull(authUserDTO.getStatus(), <span class="string">&quot;用户状态不能为空&quot;</span>);</span><br><span class="line">            <span class="type">AuthUserBO</span> <span class="variable">authUserBO</span> <span class="operator">=</span> AuthUserDTOConverter.INSTANCE.convertDTOToBO(authUserDTO);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(authUserDomainService.update(authUserBO));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;UserController.changeStatus.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;启用/禁用用户信息失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;doLogin&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;SaTokenInfo&gt; <span class="title function_">doLogin</span><span class="params">(<span class="meta">@RequestParam(&quot;validCode&quot;)</span> String validCode)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Preconditions.checkArgument(!StringUtils.isBlank(validCode), <span class="string">&quot;验证码不能为空!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(authUserDomainService.doLogin(validCode));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;UserController.doLogin.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;用户登录失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询登录状态，浏览器访问： http://localhost:8081/user/isLogin</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;isLogin&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">isLogin</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;当前会话是否登录：&quot;</span> + StpUtil.isLogin();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="domain包"><a href="#domain包" class="headerlink" title="domain包"></a>domain包</h5><p><code>AuthUserDomainServiceImpl.java（用户注册、更新、删除、登录和信息查询，redis）</code></p>
<ol>
<li>资源注入</li>
</ol>
<ul>
<li><code>@Resource</code>：用于自动注入Spring管理的Bean，如各种服务（<code>Service</code>）和<code>RedisUtil</code>。</li>
</ul>
<ol start="2">
<li>成员变量</li>
</ol>
<ul>
<li>定义了用于构建Redis键的前缀、盐值（<code>salt</code>）、登录验证码前缀（<code>LOGIN_PREFIX</code>）。</li>
</ul>
<ol start="3">
<li>注册方法</li>
</ol>
<ul>
<li><code>@Override</code>：覆盖接口中定义的方法。</li>
<li><code>@SneakyThrows</code>：使用Lombok注解来隐藏抛出的异常。</li>
<li><code>@Transactional</code>：声明事务支持，指定异常回滚。</li>
<li><code>public Boolean register(AuthUserBO authUserBO)</code>：注册用户的方法。</li>
</ul>
<ol start="4">
<li>注册逻辑</li>
</ol>
<ul>
<li>检查用户是否存在。</li>
<li>密码加密存储。（md5+salt）</li>
<li>设置默认头像和昵称。</li>
<li>插入用户数据到数据库。</li>
<li>建立用户与角色的关联。</li>
<li>将角色和权限信息存储到Redis。</li>
</ul>
<ol start="5">
<li>更新和删除方法</li>
</ol>
<ul>
<li><code>public Boolean update(AuthUserBO authUserBO)</code>：更新用户信息的方法。</li>
<li><code>public Boolean delete(AuthUserBO authUserBO)</code>：逻辑删除用户的方法，同时更新Redis中的缓存。</li>
</ul>
<ol start="6">
<li>登录和获取用户信息方法</li>
</ol>
<ul>
<li><code>public SaTokenInfo doLogin(String validCode)</code>：处理用户登录的方法，使用<code>Sa-Token</code>进行认证。</li>
<li><code>public AuthUserBO getUserInfo(AuthUserBO authUserBO)</code>：根据用户名获取用户信息的方法。</li>
</ul>
<ol start="7">
<li>批量获取用户信息方法</li>
</ol>
<ul>
<li><code>public List&lt;AuthUserBO&gt; listUserInfoByIds(List&lt;String&gt; userNameList)</code>：根据用户ID列表批量获取用户信息的方法。</li>
</ul>
<ol start="8">
<li>事务和异常处理</li>
</ol>
<ul>
<li>注册、更新和删除方法使用<code>@Transactional</code>注解，确保操作的原子性。</li>
<li>使用<code>@SneakyThrows</code>来处理可能抛出的异常，避免显式声明异常。</li>
</ul>
<ol start="9">
<li>日志记录</li>
</ol>
<ul>
<li><code>log</code>变量用于记录日志信息。</li>
</ul>
<ol start="10">
<li>缓存操作</li>
</ol>
<ul>
<li>使用<code>RedisUtil</code>进行Redis的读写操作，如存储用户的角色和权限信息。</li>
</ul>
<ol start="11">
<li>密码安全</li>
</ol>
<ul>
<li>使用<code>SaSecureUtil.md5BySalt</code>方法对用户密码进行MD5加盐加密。</li>
</ul>
<ol start="12">
<li>默认资源</li>
</ol>
<ul>
<li>为新用户设置了默认的头像和昵称。</li>
</ul>
<ol start="13">
<li>服务交互</li>
</ol>
<ul>
<li>通过调用<code>AuthUserService</code>、<code>AuthUserRoleService</code>等的方法，实现业务逻辑。</li>
</ul>
<p>这个<code>AuthUserDomainServiceImpl</code>类通过实现<code>AuthUserDomainService</code>接口，提供了用户注册、更新、删除、登录和信息查询等服务，同时与Redis缓存进行交互，以提高系统的响应速度和性能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthUserDomainServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AuthUserDomainService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AuthUserService authUserService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AuthUserRoleService authUserRoleService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AuthPermissionService authPermissionService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AuthRolePermissionService authRolePermissionService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AuthRoleService authRoleService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">salt</span> <span class="operator">=</span> <span class="string">&quot;chicken&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisUtil redisUtil;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">authPermissionPrefix</span> <span class="operator">=</span> <span class="string">&quot;auth.permission&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">authRolePrefix</span> <span class="operator">=</span> <span class="string">&quot;auth.role&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LOGIN_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;loginCode&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">register</span><span class="params">(AuthUserBO authUserBO)</span> &#123;</span><br><span class="line">        <span class="comment">//校验用户是否存在</span></span><br><span class="line">        <span class="type">AuthUser</span> <span class="variable">existAuthUser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthUser</span>();</span><br><span class="line">        existAuthUser.setUserName(authUserBO.getUserName());</span><br><span class="line">        List&lt;AuthUser&gt; existUser = authUserService.queryByCondition(existAuthUser);</span><br><span class="line">        <span class="keyword">if</span> (existUser.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">AuthUser</span> <span class="variable">authUser</span> <span class="operator">=</span> AuthUserBOConverter.INSTANCE.convertBOToEntity(authUserBO);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(authUser.getPassword())) &#123;</span><br><span class="line">            authUser.setPassword(SaSecureUtil.md5BySalt(authUser.getPassword(), salt));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(authUser.getAvatar())) &#123;</span><br><span class="line">            authUser.setAvatar(<span class="string">&quot;http://117.72.10.84:9000/user/icon/微信图片_20231203153718(1).png&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(authUser.getNickName())) &#123;</span><br><span class="line">            authUser.setNickName(<span class="string">&quot;lzrj&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        authUser.setStatus(AuthUserStatusEnum.OPEN.getCode());</span><br><span class="line">        authUser.setIsDeleted(IsDeletedFlagEnum.UN_DELETED.getCode());</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> authUserService.insert(authUser);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//建立一个初步的角色的关联</span></span><br><span class="line">        <span class="type">AuthRole</span> <span class="variable">authRole</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthRole</span>();</span><br><span class="line">        authRole.setRoleKey(AuthConstant.NORMAL_USER);</span><br><span class="line">        <span class="type">AuthRole</span> <span class="variable">roleResult</span> <span class="operator">=</span> authRoleService.queryByCondition(authRole);</span><br><span class="line">        <span class="type">Long</span> <span class="variable">roleId</span> <span class="operator">=</span> roleResult.getId();</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> authUser.getId();</span><br><span class="line">        <span class="type">AuthUserRole</span> <span class="variable">authUserRole</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthUserRole</span>();</span><br><span class="line">        authUserRole.setUserId(userId);</span><br><span class="line">        authUserRole.setRoleId(roleId);</span><br><span class="line">        authUserRole.setIsDeleted(IsDeletedFlagEnum.UN_DELETED.getCode());</span><br><span class="line">        authUserRoleService.insert(authUserRole);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">roleKey</span> <span class="operator">=</span> redisUtil.buildKey(authRolePrefix, authUser.getUserName());</span><br><span class="line">        List&lt;AuthRole&gt; roleList = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        roleList.add(authRole);</span><br><span class="line">        redisUtil.set(roleKey, <span class="keyword">new</span> <span class="title class_">Gson</span>().toJson(roleList));</span><br><span class="line"></span><br><span class="line">        <span class="type">AuthRolePermission</span> <span class="variable">authRolePermission</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthRolePermission</span>();</span><br><span class="line">        authRolePermission.setRoleId(roleId);</span><br><span class="line">        List&lt;AuthRolePermission&gt; rolePermissionList = authRolePermissionService.</span><br><span class="line">                queryByCondition(authRolePermission);</span><br><span class="line"></span><br><span class="line">        List&lt;Long&gt; permissionIdList = rolePermissionList.stream()</span><br><span class="line">                .map(AuthRolePermission::getPermissionId).collect(Collectors.toList());</span><br><span class="line">        <span class="comment">//根据roleId查权限</span></span><br><span class="line">        List&lt;AuthPermission&gt; permissionList = authPermissionService.queryByRoleList(permissionIdList);</span><br><span class="line">        <span class="type">String</span> <span class="variable">permissionKey</span> <span class="operator">=</span> redisUtil.buildKey(authPermissionPrefix, authUser.getUserName());</span><br><span class="line">        redisUtil.set(permissionKey, <span class="keyword">new</span> <span class="title class_">Gson</span>().toJson(permissionList));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> count &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">update</span><span class="params">(AuthUserBO authUserBO)</span> &#123;</span><br><span class="line">        <span class="type">AuthUser</span> <span class="variable">authUser</span> <span class="operator">=</span> AuthUserBOConverter.INSTANCE.convertBOToEntity(authUserBO);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> authUserService.updateByUserName(authUser);</span><br><span class="line">        <span class="keyword">return</span> count &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">delete</span><span class="params">(AuthUserBO authUserBO)</span> &#123;</span><br><span class="line">        <span class="type">AuthUser</span> <span class="variable">authUser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthUser</span>();</span><br><span class="line">        authUser.setId(authUserBO.getId());</span><br><span class="line">        authUser.setIsDeleted(IsDeletedFlagEnum.DELETED.getCode());</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> authUserService.update(authUser);</span><br><span class="line">        <span class="comment">//有任何的更新，都要与缓存进行同步的修改</span></span><br><span class="line">        <span class="keyword">return</span> count &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SaTokenInfo <span class="title function_">doLogin</span><span class="params">(String validCode)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">loginKey</span> <span class="operator">=</span> redisUtil.buildKey(LOGIN_PREFIX, validCode);</span><br><span class="line">        <span class="type">String</span> <span class="variable">openId</span> <span class="operator">=</span> redisUtil.get(loginKey);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(openId)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">AuthUserBO</span> <span class="variable">authUserBO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthUserBO</span>();</span><br><span class="line">        authUserBO.setUserName(openId);</span><br><span class="line">        <span class="built_in">this</span>.register(authUserBO);</span><br><span class="line">        StpUtil.login(openId);</span><br><span class="line">        <span class="type">SaTokenInfo</span> <span class="variable">tokenInfo</span> <span class="operator">=</span> StpUtil.getTokenInfo();</span><br><span class="line">        <span class="keyword">return</span> tokenInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AuthUserBO <span class="title function_">getUserInfo</span><span class="params">(AuthUserBO authUserBO)</span> &#123;</span><br><span class="line">        <span class="type">AuthUser</span> <span class="variable">authUser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthUser</span>();</span><br><span class="line">        authUser.setUserName(authUserBO.getUserName());</span><br><span class="line">        List&lt;AuthUser&gt; userList = authUserService.queryByCondition(authUser);</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(userList)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AuthUserBO</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">AuthUser</span> <span class="variable">user</span> <span class="operator">=</span> userList.get(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> AuthUserBOConverter.INSTANCE.convertEntityToBO(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;AuthUserBO&gt; <span class="title function_">listUserInfoByIds</span><span class="params">(List&lt;String&gt; userNameList)</span> &#123;</span><br><span class="line">        List&lt;AuthUser&gt; userList = authUserService.listUserInfoByIds(userNameList);</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(userList)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> AuthUserBOConverter.INSTANCE.convertEntityToBO(userList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="infra层"><a href="#infra层" class="headerlink" title="infra层"></a>infra层</h5><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/28/ERumTNky47Z1xAK.jpg" alt="4aaca7492044e3e4d3c9d55c9b05c39.jpg"></p>
<p>对这五张表的增删查改</p>
<h5 id="常见加密-密码加密"><a href="#常见加密-密码加密" class="headerlink" title="常见加密&amp;密码加密"></a>常见加密&amp;密码加密</h5><p><strong>前言</strong></p>
<p>数据库如果说存储明文的密码是非常的危险的，一旦被攻击啊，或者数据泄漏，用户的信息疯狂的暴露出去，黑客什么都能干，这是非常不行，所以我们要做加密，让黑客即使拿到了密码信息， 也不知道原始的密码，就登录不成功。</p>
<p><strong>加密的方式</strong></p>
<ol>
<li><p>摘要加密</p>
<p>md5，sha1，sha256</p>
<p>摘要主要就是哈希值，通过我们的散列的算法。摘要的概念主要是验证完整性和唯一性，不管我们的密码是多长啊，或者多复杂的啊，得到的值都是固定长度。</p>
<p>摘要加密有一定的风险。123456 用 md5 加密。他其实是固定的，大家也可以到一些网站有反解密。</p>
</li>
<li><p>对称加密</p>
<p>我们约定了一个密钥。这个密钥一定要好好保存，不能泄漏，一旦泄漏就可以进行想你想的解密了。</p>
<p>加密的过程：密码+密钥 生成</p>
<p>解密的过程：密文+密钥 反解</p>
<p>密钥一定一定要做好其中的保存。</p>
<p>常见的对称加密的算法：AES，DES，3DESC，SM4</p>
</li>
<li><p>非对称加密</p>
<p>一个公钥，一个私钥。</p>
<p>公钥去加密，私钥去解密。</p>
<p>私钥去加密，公钥去解密。</p>
<p>常见的算法：RSA，ECC，国密的 SM2</p>
<p>算法的时性能上，差一点，加密的数量没有对称加密快。</p>
</li>
</ol>
<p><strong>加盐？是做饭吗？</strong></p>
<p>摘要算法比如 md5，光加密 123456，结果都是一样的，如果是破解的库里正好有这个 md5 就很容易知道逆向是 123456。来一手加盐。盐是随机的字符串，他来与原密码进行一波二次加密。这样获取到的很难破解出来。如果不加盐，简单密码很容易撞库的。</p>
<p><code>AuthUserDomainServiceImpl.java</code>，satoken:md5+salt，这里的salt是一个字符串</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">register</span><span class="params">(AuthUserBO authUserBO)</span> &#123;</span><br><span class="line">    <span class="comment">//校验用户是否存在</span></span><br><span class="line">    <span class="type">AuthUser</span> <span class="variable">existAuthUser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthUser</span>();</span><br><span class="line">    existAuthUser.setUserName(authUserBO.getUserName());</span><br><span class="line">    List&lt;AuthUser&gt; existUser = authUserService.queryByCondition(existAuthUser);</span><br><span class="line">    <span class="keyword">if</span> (existUser.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">AuthUser</span> <span class="variable">authUser</span> <span class="operator">=</span> AuthUserBOConverter.INSTANCE.convertBOToEntity(authUserBO);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isNotBlank(authUser.getPassword())) &#123;</span><br><span class="line">        authUser.setPassword(SaSecureUtil.md5BySalt(authUser.getPassword(), salt)); <span class="comment">//satoken:md5+salt，这里的salt是一个字符串</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(authUser.getAvatar())) &#123;</span><br><span class="line">        authUser.setAvatar(<span class="string">&quot;http://117.72.10.84:9000/user/icon/微信图片_20231203153718(1).png&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">   	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="角色模块开发-auth-role"><a href="#角色模块开发-auth-role" class="headerlink" title="角色模块开发(auth_role)"></a>角色模块开发(auth_role)</h4><h5 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h5><p><code>RolePermissionController.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jingdianjichi.auth.application.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.google.common.base.Preconditions;</span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.auth.application.convert.AuthRolePermissionDTOConverter;</span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.auth.application.dto.AuthRolePermissionDTO;</span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.auth.domain.entity.AuthRolePermissionBO;</span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.auth.domain.service.AuthRolePermissionDomainService;</span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.auth.entity.Result;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.CollectionUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 角色权限controller</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: ChickenWing</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2023/11/2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/rolePermission/&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RolePermissionController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AuthRolePermissionDomainService authRolePermissionDomainService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增角色权限关联关系</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">add</span><span class="params">(<span class="meta">@RequestBody</span> AuthRolePermissionDTO authRolePermissionDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;RolePermissionController.add.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(authRolePermissionDTO));</span><br><span class="line">            &#125;</span><br><span class="line">            Preconditions.checkArgument(!CollectionUtils.isEmpty(authRolePermissionDTO.getPermissionIdList()),<span class="string">&quot;权限关联不能为空&quot;</span>);</span><br><span class="line">            Preconditions.checkNotNull(authRolePermissionDTO.getRoleId(),<span class="string">&quot;角色不能为空!&quot;</span>);</span><br><span class="line">            <span class="type">AuthRolePermissionBO</span> <span class="variable">rolePermissionBO</span> <span class="operator">=</span> AuthRolePermissionDTOConverter.INSTANCE.convertDTOToBO(authRolePermissionDTO);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(authRolePermissionDomainService.add(rolePermissionBO));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;PermissionController.add.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;新增角色权限失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>RoleController.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jingdianjichi.auth.application.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.google.common.base.Preconditions;</span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.auth.application.convert.AuthRoleDTOConverter;</span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.auth.application.dto.AuthRoleDTO;</span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.auth.domain.entity.AuthRoleBO;</span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.auth.domain.service.AuthRoleDomainService;</span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.auth.entity.Result;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 角色controller</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: ChickenWing</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2023/11/2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/role/&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RoleController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AuthRoleDomainService authRoleDomainService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增角色</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">add</span><span class="params">(<span class="meta">@RequestBody</span> AuthRoleDTO authRoleDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;RoleController.add.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(authRoleDTO));</span><br><span class="line">            &#125;</span><br><span class="line">            Preconditions.checkArgument(!StringUtils.isBlank(authRoleDTO.getRoleKey()), <span class="string">&quot;角色key不能为空&quot;</span>);</span><br><span class="line">            Preconditions.checkArgument(!StringUtils.isBlank(authRoleDTO.getRoleName()), <span class="string">&quot;角色名称不能为空&quot;</span>);</span><br><span class="line">            <span class="type">AuthRoleBO</span> <span class="variable">authRoleBO</span> <span class="operator">=</span> AuthRoleDTOConverter.INSTANCE.convertDTOToBO(authRoleDTO);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(authRoleDomainService.add(authRoleBO));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;UserController.register.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;新增角色失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改角色</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;update&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> AuthRoleDTO authRoleDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;RoleController.update.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(authRoleDTO));</span><br><span class="line">            &#125;</span><br><span class="line">            Preconditions.checkNotNull(authRoleDTO.getId(), <span class="string">&quot;角色id不能为空&quot;</span>);</span><br><span class="line">            <span class="type">AuthRoleBO</span> <span class="variable">authRoleBO</span> <span class="operator">=</span> AuthRoleDTOConverter.INSTANCE.convertDTOToBO(authRoleDTO);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(authRoleDomainService.update(authRoleBO));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;RoleController.update.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;更新角色信息失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除角色</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;delete&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">delete</span><span class="params">(<span class="meta">@RequestBody</span> AuthRoleDTO authRoleDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;RoleController.delete.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(authRoleDTO));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">AuthRoleBO</span> <span class="variable">authRoleBO</span> <span class="operator">=</span> AuthRoleDTOConverter.INSTANCE.convertDTOToBO(authRoleDTO);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(authRoleDomainService.delete(authRoleBO));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;RoleController.delete.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;删除角色信息失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>PermissionController.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jingdianjichi.auth.application.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.google.common.base.Preconditions;</span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.auth.application.convert.AuthPermissionDTOConverter;</span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.auth.application.dto.AuthPermissionDTO;</span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.auth.domain.entity.AuthPermissionBO;</span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.auth.domain.service.AuthPermissionDomainService;</span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.auth.entity.Result;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 权限controller</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: ChickenWing</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2023/11/2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/permission/&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PermissionController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AuthPermissionDomainService authPermissionDomainService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增权限</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">add</span><span class="params">(<span class="meta">@RequestBody</span> AuthPermissionDTO authPermissionDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;PermissionController.add.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(authPermissionDTO));</span><br><span class="line">            &#125;</span><br><span class="line">            Preconditions.checkArgument(!StringUtils.isBlank(authPermissionDTO.getName()), <span class="string">&quot;权限名称不能为空&quot;</span>);</span><br><span class="line">            Preconditions.checkNotNull(authPermissionDTO.getParentId(), <span class="string">&quot;权限父id不能为空&quot;</span>);</span><br><span class="line">            <span class="type">AuthPermissionBO</span> <span class="variable">permissionBO</span> <span class="operator">=</span> AuthPermissionDTOConverter.INSTANCE.convertDTOToBO(authPermissionDTO);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(authPermissionDomainService.add(permissionBO));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;PermissionController.add.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;新增权限失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改权限</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;update&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> AuthPermissionDTO authPermissionDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;PermissionController.update.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(authPermissionDTO));</span><br><span class="line">            &#125;</span><br><span class="line">            Preconditions.checkNotNull(authPermissionDTO.getId(), <span class="string">&quot;权限id不能为空&quot;</span>);</span><br><span class="line">            <span class="type">AuthPermissionBO</span> <span class="variable">permissionBO</span> <span class="operator">=</span> AuthPermissionDTOConverter.INSTANCE.convertDTOToBO(authPermissionDTO);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(authPermissionDomainService.update(permissionBO));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;PermissionController.update.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;更新权限信息失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除权限</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;delete&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">delete</span><span class="params">(<span class="meta">@RequestBody</span> AuthPermissionDTO authPermissionDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;PermissionController.delete.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(authPermissionDTO));</span><br><span class="line">            &#125;</span><br><span class="line">            Preconditions.checkNotNull(authPermissionDTO.getId(), <span class="string">&quot;权限id不能为空&quot;</span>);</span><br><span class="line">            <span class="type">AuthPermissionBO</span> <span class="variable">permissionBO</span> <span class="operator">=</span> AuthPermissionDTOConverter.INSTANCE.convertDTOToBO(authPermissionDTO);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(authPermissionDomainService.delete(permissionBO));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;PermissionController.delete.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;删除权限信息失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询用户权限</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;getPermission&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">getPermission</span><span class="params">(String userName)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;PermissionController.getPermission.userName:&#123;&#125;&quot;</span>,userName);</span><br><span class="line">            Preconditions.checkArgument(!StringUtils.isBlank(userName), <span class="string">&quot;用户id不能为空&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(authPermissionDomainService.getPermission(userName));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;PermissionController.getPermission.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;查询用户权限信息失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="domain"><a href="#domain" class="headerlink" title="domain"></a>domain</h5><p><code>AuthPermissionDomainServiceImpl.java</code>(权限)</p>
<ol>
<li>业务方法实现</li>
</ol>
<ul>
<li><code>@Override</code>：覆盖接口中定义的方法。</li>
<li><code>public Boolean add(AuthPermissionBO authPermissionBO)</code>：添加权限的方法，将业务对象（BO）转换为实体对象（Entity），设置未删除标志，并插入数据库。</li>
<li><code>public Boolean update(AuthPermissionBO authPermissionBO)</code>：更新权限的方法，将BO转换为Entity，并更新数据库。</li>
<li><code>public Boolean delete(AuthPermissionBO authPermissionBO)</code>：逻辑删除权限的方法，更新删除标志。</li>
</ul>
<ol start="2">
<li>权限获取方法</li>
</ol>
<ul>
<li><pre><code class="java">public List&lt;String&gt; getPermission(String userName)
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  ：根据用户名获取权限列表的方法。</span><br><span class="line"></span><br><span class="line">  - 使用`RedisUtil`构建权限的Redis键。</span><br><span class="line">  - 从Redis中获取权限的JSON字符串。</span><br><span class="line">  - 如果Redis中没有数据，则返回空列表。</span><br><span class="line">  - 使用Gson反序列化JSON字符串为`AuthPermission`列表。</span><br><span class="line">  - 从权限列表中提取权限键（Permission Key）。</span><br><span class="line"></span><br><span class="line">3. 日志记录</span><br><span class="line"></span><br><span class="line">- `log`变量用于记录日志信息。</span><br><span class="line"></span><br><span class="line">4. 缓存操作</span><br><span class="line"></span><br><span class="line">- 使用`RedisUtil`进行Redis的读写操作，如获取用户权限信息。</span><br><span class="line"></span><br><span class="line">5. 数据转换</span><br><span class="line"></span><br><span class="line">- 使用`AuthPermissionBOConverter`将业务对象（BO）转换为数据库实体（Entity）。</span><br><span class="line"></span><br><span class="line">6. 逻辑删除</span><br><span class="line"></span><br><span class="line">- 设置`IsDeletedFlagEnum.UN_DELETED.getCode()`和`IsDeletedFlagEnum.DELETED.getCode()`来标记记录的删除状态。</span><br><span class="line"></span><br><span class="line">这个`AuthPermissionDomainServiceImpl`类通过实现`AuthPermissionDomainService`接口，提供了权限的增删改以及根据用户名获取权限列表的服务。它利用了Redis缓存来提高获取权限列表的性能，并采用了逻辑删除的方式来管理权限数据。通过这种方式，应用程序可以灵活地进行权限控制和验证。</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line">@Service</span><br><span class="line">@Slf4j</span><br><span class="line">public class AuthPermissionDomainServiceImpl implements AuthPermissionDomainService &#123;</span><br><span class="line"></span><br><span class="line">    @Resource</span><br><span class="line">    private AuthPermissionService authPermissionService;</span><br><span class="line"></span><br><span class="line">    @Resource</span><br><span class="line">    private RedisUtil redisUtil;</span><br><span class="line"></span><br><span class="line">    private String authPermissionPrefix = &quot;auth.permission&quot;;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Boolean add(AuthPermissionBO authPermissionBO) &#123;</span><br><span class="line">        AuthPermission authPermission = AuthPermissionBOConverter.INSTANCE.convertBOToEntity(authPermissionBO);</span><br><span class="line">        authPermission.setIsDeleted(IsDeletedFlagEnum.UN_DELETED.getCode());</span><br><span class="line">        Integer count = authPermissionService.insert(authPermission);</span><br><span class="line">        return count &gt; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Boolean update(AuthPermissionBO authPermissionBO) &#123;</span><br><span class="line">        AuthPermission authPermission = AuthPermissionBOConverter.INSTANCE.convertBOToEntity(authPermissionBO);</span><br><span class="line">        Integer count = authPermissionService.update(authPermission);</span><br><span class="line">        return count &gt; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Boolean delete(AuthPermissionBO authPermissionBO) &#123;</span><br><span class="line">        AuthPermission authPermission = new AuthPermission();</span><br><span class="line">        authPermission.setId(authPermissionBO.getId());</span><br><span class="line">        authPermission.setIsDeleted(IsDeletedFlagEnum.DELETED.getCode());</span><br><span class="line">        Integer count = authPermissionService.update(authPermission);</span><br><span class="line">        return count &gt; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public List&lt;String&gt; getPermission(String userName) &#123;</span><br><span class="line">        String permissionKey = redisUtil.buildKey(authPermissionPrefix, userName);</span><br><span class="line">        String permissionValue = redisUtil.get(permissionKey);</span><br><span class="line">        if (StringUtils.isBlank(permissionValue)) &#123;</span><br><span class="line">            return Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;AuthPermission&gt; permissionList = new Gson().fromJson(permissionValue,</span><br><span class="line">                new TypeToken&lt;List&lt;AuthPermission&gt;&gt;() &#123;</span><br><span class="line">                &#125;.getType());</span><br><span class="line">        List&lt;String&gt; authList = permissionList.stream().map(AuthPermission::getPermissionKey).collect(Collectors.toList());</span><br><span class="line">        return authList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
<p><code>AuthRoleDomainServiceImpl</code>（角色）</p>
<ol>
<li>业务方法实现@Override：覆盖接口中定义的方法。</li>
<li>添加角色方法public Boolean add(AuthRoleBO authRoleBO)：<ul>
<li>添加角色的方法。<ul>
<li>使用 AuthRoleBOConverter 将业务对象（BO）转换为实体对象（Entity）。</li>
<li>设置角色未删除标志。</li>
<li>调用 authRoleService 的 insert 方法将实体插入数据库。</li>
<li>返回操作影响的行数是否大于0。</li>
</ul>
</li>
</ul>
</li>
<li>更新角色方法public Boolean update(AuthRoleBO authRoleBO)：<ul>
<li>更新角色的方法。<ul>
<li>类似于添加方法，但调用 update 方法更新数据库中的实体。</li>
</ul>
</li>
</ul>
</li>
<li>删除角色方法public Boolean delete(AuthRoleBO authRoleBO)：<ul>
<li>逻辑删除角色的方法。<ul>
<li>创建一个新的 AuthRole 实体，设置ID和逻辑删除标志。</li>
<li>调用 authRoleService 的 update 方法更新数据库中的实体。8.</li>
</ul>
</li>
</ul>
</li>
<li>日志记录log <ul>
<li>变量用于记录日志信息。</li>
</ul>
</li>
<li>逻辑删除设置 <ul>
<li>IsDeletedFlagEnum.UN_DELETED.getCode() 和 IsDeletedFlagEnum.DELETED.getCode() 来标记记录的删除状态。</li>
</ul>
</li>
</ol>
<p>这个 AuthRoleDomainServiceImpl 类通过实现 AuthRoleDomainService 接口，提供了角色的增删改服务。它利用了逻辑删除的方式来管理角色数据，通过这种方式，应用程序可以灵活地进行角色管理和权限分配。注意，代码中没有显示具体的日志输出语句，但 @Slf4j 注解会在类中添加日志变量，可以在方法中使用 log 进行日志记录。此外，@SneakyThrows 注解未在此代码片段中使用，如果存在，它通常用于隐藏方法抛出的异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthRoleDomainServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AuthRoleDomainService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AuthRoleService authRoleService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">add</span><span class="params">(AuthRoleBO authRoleBO)</span> &#123;</span><br><span class="line">        <span class="type">AuthRole</span> <span class="variable">authRole</span> <span class="operator">=</span> AuthRoleBOConverter.INSTANCE.convertBOToEntity(authRoleBO);</span><br><span class="line">        authRole.setIsDeleted(IsDeletedFlagEnum.UN_DELETED.getCode());</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> authRoleService.insert(authRole);</span><br><span class="line">        <span class="keyword">return</span> count &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">update</span><span class="params">(AuthRoleBO authRoleBO)</span> &#123;</span><br><span class="line">        <span class="type">AuthRole</span> <span class="variable">authRole</span> <span class="operator">=</span> AuthRoleBOConverter.INSTANCE.convertBOToEntity(authRoleBO);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> authRoleService.update(authRole);</span><br><span class="line">        <span class="keyword">return</span> count &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">delete</span><span class="params">(AuthRoleBO authRoleBO)</span> &#123;</span><br><span class="line">        <span class="type">AuthRole</span> <span class="variable">authRole</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthRole</span>();</span><br><span class="line">        authRole.setId(authRoleBO.getId());</span><br><span class="line">        authRole.setIsDeleted(IsDeletedFlagEnum.DELETED.getCode());</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> authRoleService.update(authRole);</span><br><span class="line">        <span class="keyword">return</span> count &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>AuthRolePermissionDomainServiceImpl.java</code>(角色权限关联)</p>
<p>添加角色权限关联方法</p>
<ul>
<li><pre><code>public Boolean add(AuthRolePermissionBO authRolePermissionBO)
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  ：添加角色与权限关联的方法。</span><br><span class="line"></span><br><span class="line">  - 首先创建一个`AuthRolePermission`列表，用于存储多个角色权限关联对象。</span><br><span class="line">  - 通过`authRolePermissionBO`获取角色ID。</span><br><span class="line">  - 遍历`authRolePermissionBO`中的权限ID列表。</span><br><span class="line">  - 对于每个权限ID，创建一个新的`AuthRolePermission`实体，设置角色ID、权限ID和未删除标志。</span><br><span class="line">  - 将创建的实体添加到列表中。</span><br><span class="line">  - 使用`authRolePermissionService`的`batchInsert`方法批量插入关联数据到数据库。</span><br><span class="line">  - 返回操作影响的行数是否大于0。</span><br><span class="line"></span><br><span class="line">这个`AuthRolePermissionDomainServiceImpl`类通过实现`AuthRolePermissionDomainService`接口，提供了添加角色与权限关联的服务。它允许一个角色与多个权限进行关联，通过批量插入的方式提高数据存储的效率。使用逻辑删除来管理角色权限关联数据，使得数据不会从数据库中真正删除，便于进行数据恢复或审计。注意，代码中没有提供删除或更新角色权限关联的实现，这可能是因为这些功能要么不需要实现，要么在其他部分的代码中实现。</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line">@Service</span><br><span class="line">@Slf4j</span><br><span class="line">public class AuthRolePermissionDomainServiceImpl implements AuthRolePermissionDomainService &#123;</span><br><span class="line"></span><br><span class="line">    @Resource</span><br><span class="line">    private AuthRolePermissionService authRolePermissionService;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Boolean add(AuthRolePermissionBO authRolePermissionBO) &#123;</span><br><span class="line">        List&lt;AuthRolePermission&gt; rolePermissionList = new LinkedList&lt;&gt;();</span><br><span class="line">        Long roleId = authRolePermissionBO.getRoleId();</span><br><span class="line">        authRolePermissionBO.getPermissionIdList().forEach(permissionId -&gt; &#123;</span><br><span class="line">            AuthRolePermission authRolePermission = new AuthRolePermission();</span><br><span class="line">            authRolePermission.setRoleId(roleId);</span><br><span class="line">            authRolePermission.setPermissionId(permissionId);</span><br><span class="line">            authRolePermission.setIsDeleted(IsDeletedFlagEnum.UN_DELETED.getCode());</span><br><span class="line">            rolePermissionList.add(authRolePermission);</span><br><span class="line">        &#125;);</span><br><span class="line">        int count = authRolePermissionService.batchInsert(rolePermissionList);</span><br><span class="line">        return count &gt; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
<h5 id="infra层-1"><a href="#infra层-1" class="headerlink" title="infra层"></a>infra层</h5><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/28/ERumTNky47Z1xAK.jpg" alt="4aaca7492044e3e4d3c9d55c9b05c39.jpg"></p>
<h4 id="用户角色关联-user-role-这里主要是infra层的东西"><a href="#用户角色关联-user-role-这里主要是infra层的东西" class="headerlink" title="用户角色关联(user_role,这里主要是infra层的东西)"></a>用户角色关联(user_role,这里主要是infra层的东西)</h4><h5 id="controller（UserController的注册模块）"><a href="#controller（UserController的注册模块）" class="headerlink" title="controller（UserController的注册模块）"></a>controller（UserController的注册模块）</h5><p>其实就是UserController，在进行register等相关操作时会进行与默认角色的关联</p>
<h5 id="domain-1"><a href="#domain-1" class="headerlink" title="domain"></a>domain</h5><p><code>AuthUserRoleDomainServiceImpl.java</code></p>
<ol>
<li><strong>用户存在性检查</strong>：首先检查要注册的用户是否已存在。如果存在，则返回<code>true</code>。</li>
<li><strong>用户BO转换</strong>：将<code>AuthUserBO</code>（业务对象）转换为<code>AuthUser</code>实体。</li>
<li><strong>密码加密</strong>：如果用户密码不为空，则使用MD5加盐的方式加密密码。</li>
<li><strong>默认头像和昵称</strong>：如果用户没有提供头像或昵称，则设置默认值。</li>
<li><strong>用户状态设置</strong>：设置用户状态为开启（<code>AuthUserStatusEnum.OPEN</code>）和未删除（<code>IsDeletedFlagEnum.UN_DELETED</code>）。</li>
<li><strong>用户插入数据库</strong>：将用户实体插入数据库，并检查插入操作是否成功。</li>
<li><strong>角色关联</strong>：为新用户分配一个默认角色（普通用户），并将角色与用户关联。</li>
<li><strong>Redis缓存角色信息</strong>：使用Redis缓存用户的角色信息，以便快速检索。</li>
<li><strong>权限查询与缓存</strong>：查询角色拥有的权限，并将权限信息缓存到Redis。</li>
<li><strong>事务管理</strong>：使用<code>@Transactional</code>注解确保方法在出现异常时可以回滚。（也可以用TransactionnalTemplate）</li>
<li><strong>异常处理</strong>：使用<code>@SneakyThrows</code>注解来重新抛出检查型异常。</li>
<li><strong>返回结果</strong>：如果用户插入成功，则返回<code>true</code>。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span> <span class="comment">//事务</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">register</span><span class="params">(AuthUserBO authUserBO)</span> &#123;</span><br><span class="line">    <span class="comment">//校验用户是否存在</span></span><br><span class="line">    <span class="type">AuthUser</span> <span class="variable">existAuthUser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthUser</span>();</span><br><span class="line">    existAuthUser.setUserName(authUserBO.getUserName());</span><br><span class="line">    List&lt;AuthUser&gt; existUser = authUserService.queryByCondition(existAuthUser);</span><br><span class="line">    <span class="keyword">if</span> (existUser.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">AuthUser</span> <span class="variable">authUser</span> <span class="operator">=</span> AuthUserBOConverter.INSTANCE.convertBOToEntity(authUserBO);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isNotBlank(authUser.getPassword())) &#123;</span><br><span class="line">        authUser.setPassword(SaSecureUtil.md5BySalt(authUser.getPassword(), salt));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(authUser.getAvatar())) &#123;</span><br><span class="line">        authUser.setAvatar(<span class="string">&quot;http://117.72.10.84:9000/user/icon/微信图片_20231203153718(1).png&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(authUser.getNickName())) &#123;</span><br><span class="line">        authUser.setNickName(<span class="string">&quot;lzrj&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    authUser.setStatus(AuthUserStatusEnum.OPEN.getCode());</span><br><span class="line">    authUser.setIsDeleted(IsDeletedFlagEnum.UN_DELETED.getCode());</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> authUserService.insert(authUser);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//建立一个初步的角色的关联</span></span><br><span class="line">    <span class="type">AuthRole</span> <span class="variable">authRole</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthRole</span>();</span><br><span class="line">    authRole.setRoleKey(AuthConstant.NORMAL_USER);</span><br><span class="line">    <span class="type">AuthRole</span> <span class="variable">roleResult</span> <span class="operator">=</span> authRoleService.queryByCondition(authRole);</span><br><span class="line">    <span class="type">Long</span> <span class="variable">roleId</span> <span class="operator">=</span> roleResult.getId();</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> authUser.getId();</span><br><span class="line">    <span class="type">AuthUserRole</span> <span class="variable">authUserRole</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthUserRole</span>();</span><br><span class="line">    authUserRole.setUserId(userId);</span><br><span class="line">    authUserRole.setRoleId(roleId);</span><br><span class="line">    authUserRole.setIsDeleted(IsDeletedFlagEnum.UN_DELETED.getCode());</span><br><span class="line">    authUserRoleService.insert(authUserRole);</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">roleKey</span> <span class="operator">=</span> redisUtil.buildKey(authRolePrefix, authUser.getUserName());</span><br><span class="line">    List&lt;AuthRole&gt; roleList = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">    roleList.add(authRole);</span><br><span class="line">    redisUtil.set(roleKey, <span class="keyword">new</span> <span class="title class_">Gson</span>().toJson(roleList));</span><br><span class="line"></span><br><span class="line">    <span class="type">AuthRolePermission</span> <span class="variable">authRolePermission</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthRolePermission</span>();</span><br><span class="line">    authRolePermission.setRoleId(roleId);</span><br><span class="line">    List&lt;AuthRolePermission&gt; rolePermissionList = authRolePermissionService.</span><br><span class="line">            queryByCondition(authRolePermission);</span><br><span class="line"></span><br><span class="line">    List&lt;Long&gt; permissionIdList = rolePermissionList.stream()</span><br><span class="line">            .map(AuthRolePermission::getPermissionId).collect(Collectors.toList());</span><br><span class="line">    <span class="comment">//根据roleId查权限</span></span><br><span class="line">    List&lt;AuthPermission&gt; permissionList = authPermissionService.queryByRoleList(permissionIdList);</span><br><span class="line">    <span class="type">String</span> <span class="variable">permissionKey</span> <span class="operator">=</span> redisUtil.buildKey(authPermissionPrefix, authUser.getUserName());</span><br><span class="line">    redisUtil.set(permissionKey, <span class="keyword">new</span> <span class="title class_">Gson</span>().toJson(permissionList));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> count &gt; <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为什么这里遇到@Transactional注解：<a target="_blank" rel="noopener" href="https://blog.csdn.net/minghao0508/article/details/124374637?ops_request_misc=%7B%22request_id%22:%22172243354616800175766334%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=172243354616800175766334&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-124374637-null-null.142%5Ev100%5Epc_search_result_base8&utm_term=@Transactional&spm=1018.2226.3001.4187">Spring——事务注解@Transactional【建议收藏】-CSDN博客</a></p>
<p><code>@Transactional</code> 注解在 Java 应用程序中，尤其是在使用 Spring 框架时，是一个非常重要的特性。这个注解通常用于声明方法在执行时应该被视为一个事务的边界。以下是使用 <code>@Transactional</code> 注解的一些主要原因：</p>
<ol>
<li><strong>确保数据一致性</strong>：在涉及数据库操作的方法中，<code>@Transactional</code> 确保方法执行过程中的所有数据库操作要么全部成功，要么在遇到异常时全部撤销，以保持数据的一致性。</li>
<li><strong>简化代码</strong>：使用 <code>@Transactional</code> 注解可以避免在每个数据库操作后手动管理事务的开始和提交，简化了代码。</li>
<li><strong>声明式事务管理</strong>：Spring 支持声明式事务管理，<code>@Transactional</code> 注解就是这一概念的实现之一，它允许将事务管理逻辑从业务逻辑代码中分离出来。</li>
<li><strong>回滚策略</strong>：通过 <code>@Transactional</code> 注解，可以定义哪些异常会导致事务回滚。在您提供的代码中，<code>rollbackFor = Exception.class</code> 表示如果抛出任何类型的异常，事务都会回滚。</li>
<li><strong>支持嵌套事务</strong>：当一个事务方法调用另一个带有 <code>@Transactional</code> 注解的方法时，Spring 会处理这些方法之间的事务嵌套。</li>
<li><strong>提高性能</strong>：Spring 事务管理器可以针对不同的事务策略进行优化，比如懒加载事务、使用适当的隔离级别等，以提高应用程序性能。</li>
<li><strong>可伸缩性</strong>：随着应用程序的扩展，<code>@Transactional</code> 注解可以很容易地应用于新的方法或类，而不需要对现有代码进行大量修改。</li>
</ol>
<p>在您的代码示例中，<code>@Transactional</code> 注解应用于注册用户的方法上，这意味着从检查用户是否存在到用户信息写入数据库、角色和权限信息缓存到 Redis 的整个过程被视为一个单一的事务。如果在这个过程的任何地方发生异常，整个操作将回滚，以确保用户信息和相关的角色、权限设置要么完全应用，要么完全不应用，避免数据不一致的问题。</p>
<p><code>auth-domain</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jingdianjichi.auth.domain.constants;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * auth服务常量</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthConstant</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NORMAL_USER</span> <span class="operator">=</span> <span class="string">&quot;normal_user&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="infra层-2"><a href="#infra层-2" class="headerlink" title="infra层"></a>infra层</h5><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/07/28/ERumTNky47Z1xAK.jpg" alt="4aaca7492044e3e4d3c9d55c9b05c39.jpg"></p>
<p>接下来回到gateway模块，在用户登录时做好与redis的交互就可以打通了。</p>
<h4 id="权限模块开发-auth-permission"><a href="#权限模块开发-auth-permission" class="headerlink" title="权限模块开发(auth_permission)"></a>权限模块开发(auth_permission)</h4><h5 id="controller层"><a href="#controller层" class="headerlink" title="controller层"></a>controller层</h5><p><code>PermissionController.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/permission/&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PermissionController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AuthPermissionDomainService authPermissionDomainService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增权限</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">add</span><span class="params">(<span class="meta">@RequestBody</span> AuthPermissionDTO authPermissionDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;PermissionController.add.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(authPermissionDTO));</span><br><span class="line">            &#125;</span><br><span class="line">            Preconditions.checkArgument(!StringUtils.isBlank(authPermissionDTO.getName()), <span class="string">&quot;权限名称不能为空&quot;</span>);</span><br><span class="line">            Preconditions.checkNotNull(authPermissionDTO.getParentId(), <span class="string">&quot;权限父id不能为空&quot;</span>);</span><br><span class="line">            <span class="type">AuthPermissionBO</span> <span class="variable">permissionBO</span> <span class="operator">=</span> AuthPermissionDTOConverter.INSTANCE.convertDTOToBO(authPermissionDTO);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(authPermissionDomainService.add(permissionBO));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;PermissionController.add.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;新增权限失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改权限</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;update&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> AuthPermissionDTO authPermissionDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;PermissionController.update.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(authPermissionDTO));</span><br><span class="line">            &#125;</span><br><span class="line">            Preconditions.checkNotNull(authPermissionDTO.getId(), <span class="string">&quot;权限id不能为空&quot;</span>);</span><br><span class="line">            <span class="type">AuthPermissionBO</span> <span class="variable">permissionBO</span> <span class="operator">=</span> AuthPermissionDTOConverter.INSTANCE.convertDTOToBO(authPermissionDTO);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(authPermissionDomainService.update(permissionBO));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;PermissionController.update.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;更新权限信息失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除权限</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;delete&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">delete</span><span class="params">(<span class="meta">@RequestBody</span> AuthPermissionDTO authPermissionDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;PermissionController.delete.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(authPermissionDTO));</span><br><span class="line">            &#125;</span><br><span class="line">            Preconditions.checkNotNull(authPermissionDTO.getId(), <span class="string">&quot;权限id不能为空&quot;</span>);</span><br><span class="line">            <span class="type">AuthPermissionBO</span> <span class="variable">permissionBO</span> <span class="operator">=</span> AuthPermissionDTOConverter.INSTANCE.convertDTOToBO(authPermissionDTO);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(authPermissionDomainService.delete(permissionBO));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;PermissionController.delete.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;删除权限信息失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询用户权限</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;getPermission&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">getPermission</span><span class="params">(String userName)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;PermissionController.getPermission.userName:&#123;&#125;&quot;</span>,userName);</span><br><span class="line">            Preconditions.checkArgument(!StringUtils.isBlank(userName), <span class="string">&quot;用户id不能为空&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(authPermissionDomainService.getPermission(userName));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;PermissionController.getPermission.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;查询用户权限信息失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>AuthPermissionDTO.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthPermissionDTO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Long parentId;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Integer type;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String menuUrl;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Integer show;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String icon;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String permissionKey;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>AuthPermissionDTOConverter.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AuthPermissionDTOConverter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">AuthPermissionDTOConverter</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> Mappers.getMapper(AuthPermissionDTOConverter.class);</span><br><span class="line"></span><br><span class="line">    AuthPermissionBO <span class="title function_">convertDTOToBO</span><span class="params">(AuthPermissionDTO authPermissionDTO)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="domain层"><a href="#domain层" class="headerlink" title="domain层"></a>domain层</h5><p><code>AuthPermissionBOConverter.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AuthPermissionBOConverter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">AuthPermissionBOConverter</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> Mappers.getMapper(AuthPermissionBOConverter.class);</span><br><span class="line"></span><br><span class="line">    AuthPermission <span class="title function_">convertBOToEntity</span><span class="params">(AuthPermissionBO authPermissionBO)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>AuthPermissionBO.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthPermissionBO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Long parentId;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Integer type;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String menuUrl;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Integer show;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String icon;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String permissionKey;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>AuthPermissionService.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthPermissionDomainServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AuthPermissionDomainService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AuthPermissionService authPermissionService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisUtil redisUtil;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">authPermissionPrefix</span> <span class="operator">=</span> <span class="string">&quot;auth.permission&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">add</span><span class="params">(AuthPermissionBO authPermissionBO)</span> &#123;</span><br><span class="line">        <span class="type">AuthPermission</span> <span class="variable">authPermission</span> <span class="operator">=</span> AuthPermissionBOConverter.INSTANCE.convertBOToEntity(authPermissionBO);</span><br><span class="line">        authPermission.setIsDeleted(IsDeletedFlagEnum.UN_DELETED.getCode());</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> authPermissionService.insert(authPermission);</span><br><span class="line">        <span class="keyword">return</span> count &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">update</span><span class="params">(AuthPermissionBO authPermissionBO)</span> &#123;</span><br><span class="line">        <span class="type">AuthPermission</span> <span class="variable">authPermission</span> <span class="operator">=</span> AuthPermissionBOConverter.INSTANCE.convertBOToEntity(authPermissionBO);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> authPermissionService.update(authPermission);</span><br><span class="line">        <span class="keyword">return</span> count &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">delete</span><span class="params">(AuthPermissionBO authPermissionBO)</span> &#123;</span><br><span class="line">        <span class="type">AuthPermission</span> <span class="variable">authPermission</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthPermission</span>();</span><br><span class="line">        authPermission.setId(authPermissionBO.getId());</span><br><span class="line">        authPermission.setIsDeleted(IsDeletedFlagEnum.DELETED.getCode());</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> authPermissionService.update(authPermission);</span><br><span class="line">        <span class="keyword">return</span> count &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getPermission</span><span class="params">(String userName)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">permissionKey</span> <span class="operator">=</span> redisUtil.buildKey(authPermissionPrefix, userName);</span><br><span class="line">        <span class="type">String</span> <span class="variable">permissionValue</span> <span class="operator">=</span> redisUtil.get(permissionKey);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(permissionValue)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;AuthPermission&gt; permissionList = <span class="keyword">new</span> <span class="title class_">Gson</span>().fromJson(permissionValue,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">TypeToken</span>&lt;List&lt;AuthPermission&gt;&gt;() &#123;</span><br><span class="line">                &#125;.getType());</span><br><span class="line">        List&lt;String&gt; authList = permissionList.stream().map(AuthPermission::getPermissionKey).collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> authList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="infra层-3"><a href="#infra层-3" class="headerlink" title="infra层"></a>infra层</h5><p><code>AuthPermission.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthPermission</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">56518358607843924L</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Long parentId;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Integer type;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String menuUrl;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Integer show;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String icon;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String permissionKey;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建人</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String createdBy;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date createdTime;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新人</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String updateBy;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Integer isDeleted;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getParentId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> parentId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setParentId</span><span class="params">(Long parentId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.parentId = parentId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setType</span><span class="params">(Integer type)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.type = type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMenuUrl</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> menuUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMenuUrl</span><span class="params">(String menuUrl)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.menuUrl = menuUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getStatus</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setStatus</span><span class="params">(Integer status)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.status = status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getShow</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> show;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setShow</span><span class="params">(Integer show)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.show = show;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getIcon</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> icon;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setIcon</span><span class="params">(String icon)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.icon = icon;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPermissionKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> permissionKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPermissionKey</span><span class="params">(String permissionKey)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.permissionKey = permissionKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCreatedBy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> createdBy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCreatedBy</span><span class="params">(String createdBy)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.createdBy = createdBy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getCreatedTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> createdTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCreatedTime</span><span class="params">(Date createdTime)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.createdTime = createdTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUpdateBy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> updateBy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUpdateBy</span><span class="params">(String updateBy)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.updateBy = updateBy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getUpdateTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> updateTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUpdateTime</span><span class="params">(Date updateTime)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.updateTime = updateTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getIsDeleted</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> isDeleted;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setIsDeleted</span><span class="params">(Integer isDeleted)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.isDeleted = isDeleted;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>AuthPermissionDao.xml</code></p>
<ul>
<li><code>type</code>, <code>show</code>：这些列名使用了反引号，因为 <code>type</code> 和 <code>show</code> 是 MySQL 的保留字。在 SQL 中，保留字是具有特定意义的关键字，如果用作列名或表名，需要用反引号括起来，以避免语法错误。</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--新增所有列--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insert&quot;</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span> <span class="attr">useGeneratedKeys</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    insert into auth_permission(name, parent_id, `type`, menu_url, status, `show`, icon, permission_key, created_by, created_time, update_by, update_time, is_deleted)</span><br><span class="line">    values (#&#123;name&#125;, #&#123;parentId&#125;, #&#123;type&#125;, #&#123;menuUrl&#125;, #&#123;status&#125;, #&#123;show&#125;, #&#123;icon&#125;, #&#123;permissionKey&#125;, #&#123;createdBy&#125;, #&#123;createdTime&#125;, #&#123;updateBy&#125;, #&#123;updateTime&#125;, #&#123;isDeleted&#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>AuthPermissionServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service(&quot;authPermissionService&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthPermissionServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AuthPermissionService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AuthPermissionDao authPermissionDao;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过ID查询单条数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 实例对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AuthPermission <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.authPermissionDao.queryById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authPermission 实例对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 实例对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">insert</span><span class="params">(AuthPermission authPermission)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.authPermissionDao.insert(authPermission);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authPermission 实例对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 实例对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">update</span><span class="params">(AuthPermission authPermission)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.authPermissionDao.update(authPermission);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过主键删除数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 是否成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">deleteById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.authPermissionDao.deleteById(id) &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;AuthPermission&gt; <span class="title function_">queryByRoleList</span><span class="params">(List&lt;Long&gt; roleIdList)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.authPermissionDao.queryByRoleList(roleIdList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="角色权限关联开发（auth-role-permission）"><a href="#角色权限关联开发（auth-role-permission）" class="headerlink" title="角色权限关联开发（auth_role_permission）"></a>角色权限关联开发（auth_role_permission）</h4><h5 id="controller-1"><a href="#controller-1" class="headerlink" title="controller"></a>controller</h5><p><code>RolePermissionController</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/rolePermission/&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RolePermissionController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AuthRolePermissionDomainService authRolePermissionDomainService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增角色权限关联关系</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">add</span><span class="params">(<span class="meta">@RequestBody</span> AuthRolePermissionDTO authRolePermissionDTO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;RolePermissionController.add.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(authRolePermissionDTO));</span><br><span class="line">            &#125;</span><br><span class="line">            Preconditions.checkArgument(!CollectionUtils.isEmpty(authRolePermissionDTO.getPermissionIdList()),<span class="string">&quot;权限关联不能为空&quot;</span>);</span><br><span class="line">            Preconditions.checkNotNull(authRolePermissionDTO.getRoleId(),<span class="string">&quot;角色不能为空!&quot;</span>);</span><br><span class="line">            <span class="type">AuthRolePermissionBO</span> <span class="variable">rolePermissionBO</span> <span class="operator">=</span> AuthRolePermissionDTOConverter.INSTANCE.convertDTOToBO(authRolePermissionDTO);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(authRolePermissionDomainService.add(rolePermissionBO));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;PermissionController.add.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;新增角色权限失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>AuthRolePermissionDTO.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthRolePermissionDTO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">459343371709166261L</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Long roleId;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Long permissionId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Long&gt; permissionIdList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="domain层-1"><a href="#domain层-1" class="headerlink" title="domain层"></a>domain层</h5><p><code>AuthRolePermissionDomainServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthRolePermissionDomainServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AuthRolePermissionDomainService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AuthRolePermissionService authRolePermissionService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">add</span><span class="params">(AuthRolePermissionBO authRolePermissionBO)</span> &#123;</span><br><span class="line">        List&lt;AuthRolePermission&gt; rolePermissionList = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Long</span> <span class="variable">roleId</span> <span class="operator">=</span> authRolePermissionBO.getRoleId();</span><br><span class="line">        authRolePermissionBO.getPermissionIdList().forEach(permissionId -&gt; &#123;</span><br><span class="line">            <span class="type">AuthRolePermission</span> <span class="variable">authRolePermission</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthRolePermission</span>();</span><br><span class="line">            authRolePermission.setRoleId(roleId);</span><br><span class="line">            authRolePermission.setPermissionId(permissionId);</span><br><span class="line">            authRolePermission.setIsDeleted(IsDeletedFlagEnum.UN_DELETED.getCode());</span><br><span class="line">            rolePermissionList.add(authRolePermission);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> authRolePermissionService.batchInsert(rolePermissionList);</span><br><span class="line">        <span class="keyword">return</span> count &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>AuthRolePermissionBO.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthRolePermissionBO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">459343371709166261L</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Long roleId;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Long permissionId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Long&gt; permissionIdList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="infra层-4"><a href="#infra层-4" class="headerlink" title="infra层"></a>infra层</h5><p><code>AuthRolePermissionServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service(&quot;authRolePermissionService&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthRolePermissionServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AuthRolePermissionService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AuthRolePermissionDao authRolePermissionDao;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过ID查询单条数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 实例对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AuthRolePermission <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.authRolePermissionDao.queryById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authRolePermission 实例对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 实例对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AuthRolePermission <span class="title function_">insert</span><span class="params">(AuthRolePermission authRolePermission)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.authRolePermissionDao.insert(authRolePermission);</span><br><span class="line">        <span class="keyword">return</span> authRolePermission;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">batchInsert</span><span class="params">(List&lt;AuthRolePermission&gt; authRolePermissionList)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.authRolePermissionDao.insertBatch(authRolePermissionList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authRolePermission 实例对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 实例对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AuthRolePermission <span class="title function_">update</span><span class="params">(AuthRolePermission authRolePermission)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.authRolePermissionDao.update(authRolePermission);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.queryById(authRolePermission.getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过主键删除数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 是否成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">deleteById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.authRolePermissionDao.deleteById(id) &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;AuthRolePermission&gt; <span class="title function_">queryByCondition</span><span class="params">(AuthRolePermission authRolePermission)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.authRolePermissionDao.queryAllByLimit(authRolePermission);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>AuthRolePermission.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthRolePermission</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">459343371709166261L</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Long roleId;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Long permissionId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建人</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String createdBy;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date createdTime;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新人</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String updateBy;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Integer isDeleted;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getRoleId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> roleId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRoleId</span><span class="params">(Long roleId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.roleId = roleId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getPermissionId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> permissionId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPermissionId</span><span class="params">(Long permissionId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.permissionId = permissionId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCreatedBy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> createdBy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCreatedBy</span><span class="params">(String createdBy)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.createdBy = createdBy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getCreatedTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> createdTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCreatedTime</span><span class="params">(Date createdTime)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.createdTime = createdTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUpdateBy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> updateBy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUpdateBy</span><span class="params">(String updateBy)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.updateBy = updateBy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getUpdateTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> updateTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUpdateTime</span><span class="params">(Date updateTime)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.updateTime = updateTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getIsDeleted</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> isDeleted;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setIsDeleted</span><span class="params">(Integer isDeleted)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.isDeleted = isDeleted;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="缓存与数据一致性问题（延迟双删）"><a href="#缓存与数据一致性问题（延迟双删）" class="headerlink" title="缓存与数据一致性问题（延迟双删）"></a>缓存与数据一致性问题（延迟双删）</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/02/vgMZ7Fy3fRPnJj6.jpg" alt="1699108963209-2ec4047e-03ee-4f39-99ed-9210e4efc363[1].jpeg"></p>
<p>根据以上的流程没有问题，但是当数据变更的时候，如何把缓存变到最新，使我们下面要讨论的问题。</p>
<ol>
<li><p>更新了数据库，再更新缓存</p>
<p>假设数据库更新成功，缓存更新失败，在缓存失效和过期的时候，读取到的都是老数据缓存。</p>
</li>
<li><p>更新缓存，更新数据库</p>
<p>缓存更新成功了，数据库更新失败，是不是读取的缓存的都是错误的。</p>
</li>
</ol>
<p>以上两种，全都不推荐。</p>
<ol start="3">
<li><p>先删除缓存，再更新数据库</p>
<p>有一定的使用量。即使数据库更新失败。缓存也可以会刷。</p>
<p>存在的问题是什么？</p>
<p>高并发情况下！！</p>
<p>比如说有两个线程，一个是 A 线程，一个是 B 线程。</p>
<p>A 线程把数据删了，正在更新数据库，这个时候 B 线程来了，发现缓存没了，又查数据，又放入缓存。缓存里面存的就一直是老数据了。</p>
</li>
</ol>
<p><strong>延迟双删：</strong>:star:</p>
<ul>
<li>**延时是确保 **修改数据库 -&gt; 清空缓存前，其他事务的更改缓存操作已经执行完。<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_35890572/article/details/108538712?ops_request_misc=%7B%22request_id%22:%22172258242116800222864858%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=172258242116800222864858&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-108538712-null-null.142%5Ev100%5Epc_search_result_base8&utm_term=%E7%BC%93%E5%AD%98%E5%8F%8C%E5%88%A0&spm=1018.2226.3001.4187&ydreferer=aHR0cHM6Ly9zby5jc2RuLm5ldC9zby9zZWFyY2g/c3BtPTEwMDAuMjExNS4zMDAxLjQ0OTgmcT0lRTclQkMlOTMlRTUlQUQlOTglRTUlOEYlOEMlRTUlODglQTAmdD0mdT0=&ydreferer=aHR0cHM6Ly9zby5jc2RuLm5ldC9zby9zZWFyY2g/c3BtPTEwMDAuMjExNS4zMDAxLjQ0OTgmcT0lRTclQkMlOTMlRTUlQUQlOTglRTUlOEYlOEMlRTUlODglQTAmdD0mdT0=&ydreferer=aHR0cHM6Ly9zby5jc2RuLm5ldC9zby9zZWFyY2g/c3BtPTEwMDAuMjExNS4zMDAxLjQ0OTgmcT0lRTclQkMlOTMlRTUlQUQlOTglRTUlOEYlOEMlRTUlODglQTAmdD0mdT0=&ydreferer=aHR0cHM6Ly9zby5jc2RuLm5ldC9zby9zZWFyY2g/c3BtPTEwMDAuMjExNS4zMDAxLjQ0OTgmcT0lRTclQkMlOTMlRTUlQUQlOTglRTUlOEYlOEMlRTUlODglQTAmdD0mdT0=&ydreferer=aHR0cHM6Ly9zby5jc2RuLm5ldC9zby9zZWFyY2g/c3BtPTEwMDAuMjExNS4zMDAxLjQ0OTgmcT0lRTclQkMlOTMlRTUlQUQlOTglRTUlOEYlOEMlRTUlODglQTAmdD0mdT0=&ydreferer=aHR0cHM6Ly9zby5jc2RuLm5ldC9zby9zZWFyY2g/c3BtPTEwMDAuMjExNS4zMDAxLjQ0OTgmcT0lRTclQkMlOTMlRTUlQUQlOTglRTUlOEYlOEMlRTUlODglQTAmdD0mdT0=&ydreferer=aHR0cHM6Ly9zby5jc2RuLm5ldC9zby9zZWFyY2g/c3BtPTEwMDAuMjExNS4zMDAxLjQ0OTgmcT0lRTclQkMlOTMlRTUlQUQlOTglRTUlOEYlOEMlRTUlODglQTAmdD0mdT0=&ydreferer=aHR0cHM6Ly9zby5jc2RuLm5ldC9zby9zZWFyY2g/c3BtPTEwMDAuMjExNS4zMDAxLjQ0OTgmcT0lRTclQkMlOTMlRTUlQUQlOTglRTUlOEYlOEMlRTUlODglQTAmdD0mdT0=&ydreferer=aHR0cHM6Ly9zby5jc2RuLm5ldC9zby9zZWFyY2g/c3BtPTEwMDAuMjExNS4zMDAxLjQ0OTgmcT0lRTclQkMlOTMlRTUlQUQlOTglRTUlOEYlOEMlRTUlODglQTAmdD0mdT0=&ydreferer=aHR0cHM6Ly9zby5jc2RuLm5ldC9zby9zZWFyY2g/c3BtPTEwMDAuMjExNS4zMDAxLjQ0OTgmcT0lRTclQkMlOTMlRTUlQUQlOTglRTUlOEYlOEMlRTUlODglQTAmdD0mdT0=&ydreferer=aHR0cHM6Ly9zby5jc2RuLm5ldC9zby9zZWFyY2g/c3BtPTEwMDAuMjExNS4zMDAxLjQ0OTgmcT0lRTclQkMlOTMlRTUlQUQlOTglRTUlOEYlOEMlRTUlODglQTAmdD0mdT0=&ydreferer=aHR0cHM6Ly9zby5jc2RuLm5ldC9zby9zZWFyY2g/c3BtPTEwMDAuMjExNS4zMDAxLjQ0OTgmcT0lRTclQkMlOTMlRTUlQUQlOTglRTUlOEYlOEMlRTUlODglQTAmdD0mdT0=&ydreferer=aHR0cHM6Ly9zby5jc2RuLm5ldC9zby9zZWFyY2g/c3BtPTEwMDAuMjExNS4zMDAxLjQ0OTgmcT0lRTclQkMlOTMlRTUlQUQlOTglRTUlOEYlOEMlRTUlODglQTAmdD0mdT0=&ydreferer=aHR0cHM6Ly9zby5jc2RuLm5ldC9zby9zZWFyY2g/c3BtPTEwMDAuMjExNS4zMDAxLjQ0OTgmcT0lRTclQkMlOTMlRTUlQUQlOTglRTUlOEYlOEMlRTUlODglQTAmdD0mdT0=&ydreferer=aHR0cHM6Ly9zby5jc2RuLm5ldC9zby9zZWFyY2g/c3BtPTEwMDAuMjExNS4zMDAxLjQ0OTgmcT0lRTclQkMlOTMlRTUlQUQlOTglRTUlOEYlOEMlRTUlODglQTAmdD0mdT0=">redis缓存为什么要延时双删-CSDN博客</a></li>
</ul>
<p><strong>扩展思路</strong></p>
<ol>
<li><p>消息队列补偿</p>
<p>删除失败的缓存，作为消息打入 mq，mq 消费者进行监听，再次进行重试刷缓存。</p>
</li>
<li><p>canal</p>
<p>监听数据库的变化，做一个公共服务，专门来对接缓存刷新。优点业务解耦，业务太多冗余代码复杂度。</p>
</li>
</ol>
<h4 id="网关与auth微服务缓存打通"><a href="#网关与auth微服务缓存打通" class="headerlink" title="网关与auth微服务缓存打通"></a>网关与auth微服务缓存打通</h4><p>主要跟注册有关</p>
<p><code>AuthUserDomainServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">register</span><span class="params">(AuthUserBO authUserBO)</span> &#123;</span><br><span class="line">    <span class="comment">//校验用户是否存在</span></span><br><span class="line">    <span class="type">AuthUser</span> <span class="variable">existAuthUser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthUser</span>();</span><br><span class="line">    existAuthUser.setUserName(authUserBO.getUserName());</span><br><span class="line">    List&lt;AuthUser&gt; existUser = authUserService.queryByCondition(existAuthUser);</span><br><span class="line">    <span class="keyword">if</span> (existUser.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">AuthUser</span> <span class="variable">authUser</span> <span class="operator">=</span> AuthUserBOConverter.INSTANCE.convertBOToEntity(authUserBO);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isNotBlank(authUser.getPassword())) &#123;</span><br><span class="line">        authUser.setPassword(SaSecureUtil.md5BySalt(authUser.getPassword(), salt));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(authUser.getAvatar())) &#123;</span><br><span class="line">        authUser.setAvatar(<span class="string">&quot;http://117.72.10.84:9000/user/icon/微信图片_20231203153718(1).png&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(authUser.getNickName())) &#123;</span><br><span class="line">        authUser.setNickName(<span class="string">&quot;别名&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    authUser.setStatus(AuthUserStatusEnum.OPEN.getCode());</span><br><span class="line">    authUser.setIsDeleted(IsDeletedFlagEnum.UN_DELETED.getCode());</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> authUserService.insert(authUser);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//建立一个初步的角色的关联</span></span><br><span class="line">    <span class="type">AuthRole</span> <span class="variable">authRole</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthRole</span>();</span><br><span class="line">    authRole.setRoleKey(AuthConstant.NORMAL_USER); <span class="comment">//普通角色</span></span><br><span class="line">    <span class="type">AuthRole</span> <span class="variable">roleResult</span> <span class="operator">=</span> authRoleService.queryByCondition(authRole); <span class="comment">//查到对应的角色返回结果，这里主要是拿角色的id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">roleId</span> <span class="operator">=</span> roleResult.getId();</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> authUser.getId();</span><br><span class="line">    <span class="type">AuthUserRole</span> <span class="variable">authUserRole</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthUserRole</span>();</span><br><span class="line">    authUserRole.setUserId(userId); <span class="comment">//用户角色 设置 userId</span></span><br><span class="line">    authUserRole.setRoleId(roleId); <span class="comment">//用户角色 设置 roleId</span></span><br><span class="line">    authUserRole.setIsDeleted(IsDeletedFlagEnum.UN_DELETED.getCode());</span><br><span class="line">    authUserRoleService.insert(authUserRole);</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">roleKey</span> <span class="operator">=</span> redisUtil.buildKey(authRolePrefix, authUser.getUserName()); <span class="comment">//key:角色前缀+用户名</span></span><br><span class="line">    List&lt;AuthRole&gt; roleList = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">    roleList.add(authRole);</span><br><span class="line">    redisUtil.set(roleKey, <span class="keyword">new</span> <span class="title class_">Gson</span>().toJson(roleList)); <span class="comment">//key:角色前缀+用户名 value:列表形式的role，在这里只有普通用户</span></span><br><span class="line"></span><br><span class="line">    <span class="type">AuthRolePermission</span> <span class="variable">authRolePermission</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthRolePermission</span>();</span><br><span class="line">    authRolePermission.setRoleId(roleId); <span class="comment">//给角色权限设置roleId</span></span><br><span class="line">    List&lt;AuthRolePermission&gt; rolePermissionList = authRolePermissionService.</span><br><span class="line">            queryByCondition(authRolePermission); <span class="comment">//查询到权限list</span></span><br><span class="line"></span><br><span class="line">    List&lt;Long&gt; permissionIdList = rolePermissionList.stream()  <span class="comment">//拿到角色list对应的权限id list</span></span><br><span class="line">            .map(AuthRolePermission::getPermissionId).collect(Collectors.toList());</span><br><span class="line">    List&lt;AuthPermission&gt; permissionList = authPermissionService.queryByRoleList(permissionIdList);<span class="comment">//根据权限id list查询权限本身list</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">permissionKey</span> <span class="operator">=</span> redisUtil.buildKey(authPermissionPrefix, authUser.getUserName());<span class="comment">//key:权限前缀+用户名</span></span><br><span class="line">    redisUtil.set(permissionKey, <span class="keyword">new</span> <span class="title class_">Gson</span>().toJson(permissionList));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> count &gt; <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>AuthPermissionDao.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;AuthPermission&gt; <span class="title function_">queryByRoleList</span><span class="params">(<span class="meta">@Param(&quot;list&quot;)</span> List&lt;Long&gt; roleIdList)</span>;</span><br></pre></td></tr></table></figure>

<p><code>AuthPermissionDao.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;queryByRoleList&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;AuthPermissionMap&quot;</span>&gt;</span></span><br><span class="line">    select * from auth_permission</span><br><span class="line">    where id in</span><br><span class="line">    <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">open</span>=<span class="string">&quot;(&quot;</span> <span class="attr">close</span>=<span class="string">&quot;)&quot;</span> <span class="attr">collection</span>=<span class="string">&quot;list&quot;</span> <span class="attr">item</span>=<span class="string">&quot;id&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span>&gt;</span></span><br><span class="line">        #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>[mybatis中resultMap的理解_result map-CSDN博客](<a target="_blank" rel="noopener" href="https://blog.csdn.net/u012843873/article/details/80198185?ops_request_misc=%7B%22request_id%22:%22172259150816800178584486%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=172259150816800178584486&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~baidu_landing_v2~default-1-80198185-null-null.142%5Ev100%5Epc_search_result_base8&utm_term=mybatic">https://blog.csdn.net/u012843873/article/details/80198185?ops_request_misc=%7B%22request%5Fid%22%3A%22172259150816800178584486%22%2C%22scm%22%3A%2220140713.130102334..%22%7D&amp;request_id=172259150816800178584486&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~baidu_landing_v2~default-1-80198185-null-null.142^v100^pc_search_result_base8&amp;utm_term=mybatic</a> resultmap&amp;spm&#x3D;1018.2226.3001.4187)</p>
<p>回到网关层</p>
<p><code>StpInterfaceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StpInterfaceImpl</span> <span class="keyword">implements</span> <span class="title class_">StpInterface</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisUtil redisUtil;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">authPermissionPrefix</span> <span class="operator">=</span> <span class="string">&quot;auth.permission&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">authRolePrefix</span> <span class="operator">=</span> <span class="string">&quot;auth.role&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getPermissionList</span><span class="params">(Object loginId, String loginType)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getAuth(loginId.toString(), authPermissionPrefix);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getRoleList</span><span class="params">(Object loginId, String loginType)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getAuth(loginId.toString(), authRolePrefix);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; <span class="title function_">getAuth</span><span class="params">(String loginId, String prefix)</span> &#123; <span class="comment">//根据register过程中创建的Redis key进行查询，包含角色和权限两种</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">authKey</span> <span class="operator">=</span> redisUtil.buildKey(prefix, loginId.toString());</span><br><span class="line">        <span class="type">String</span> <span class="variable">authValue</span> <span class="operator">=</span> redisUtil.get(authKey);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(authValue)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;String&gt; authList = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (authRolePrefix.equals(prefix)) &#123; <span class="comment">//角色List</span></span><br><span class="line">            List&lt;AuthRole&gt; roleList = <span class="keyword">new</span> <span class="title class_">Gson</span>().fromJson(authValue, <span class="keyword">new</span> <span class="title class_">TypeToken</span>&lt;List&lt;AuthRole&gt;&gt;() &#123;</span><br><span class="line">            &#125;.getType());</span><br><span class="line">            authList = roleList.stream().map(AuthRole::getRoleKey).collect(Collectors.toList());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (authPermissionPrefix.equals(prefix)) &#123; <span class="comment">//权限List </span></span><br><span class="line">            List&lt;AuthPermission&gt; permissionList = <span class="keyword">new</span> <span class="title class_">Gson</span>().fromJson(authValue, <span class="keyword">new</span> <span class="title class_">TypeToken</span>&lt;List&lt;AuthPermission&gt;&gt;() &#123;</span><br><span class="line">            &#125;.getType());</span><br><span class="line">            authList = permissionList.stream().map(AuthPermission::getPermissionKey).collect(Collectors.toList());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> authList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在登录后就会拿到token，在redis中存放有k v，保存有登录状态。在网关层会有拦截器根据路由进行对应的拦截，验证是否登录&#x2F;有权限。</p>
<p>拿到token之后，就可以通过isLogin去验证是否登录了（在请求header中带有isLogin）</p>
<p><a target="_blank" rel="noopener" href="https://sa-token.cc/doc.html#/use/jur-auth">权限认证 (sa-token.cc)</a></p>
<h4 id="登录开发（微信公众号，测试号）"><a href="#登录开发（微信公众号，测试号）" class="headerlink" title="登录开发（微信公众号，测试号）"></a>登录开发（微信公众号，测试号）</h4><p>全流程：扫码微信-&gt;微信发送消息到服务器，校验签名确保来自微信（get）-&gt;服务器再把消息进行包装， 通过前缀+验证码（一个随机数）作为redis key，fromUserName(openId)作为value存到redis，并把包含验证码的消息发送到微信-&gt;用户验证码（微信）,从redis拿到openId（即用户名）-&gt;用satoken用openId进行登录，然后利用satoken返回一个token，后续登录就会带上这个token</p>
<p>这里用的是测试号，并不会生成真正的验证码到手机上，只是为了开发接口。</p>
<p>登录注册模块 </p>
<ul>
<li><p>注册用户与验证 </p>
<ol>
<li><p>短信的方式，通过向手机号发送验证码，来实现用户的验证并登录（考虑的成本是短信的费用）</p>
</li>
<li><p>邮箱的注册登录。</p>
<p>用户注册的时候，留一个邮箱，我们往邮箱里通过邮箱服务器发送一个链接，用户点击之后，实现一个激活，激活成功之后就完成了注册。（0 成本，坏处这种发送的邮件很容易进垃圾箱）</p>
</li>
<li><p>个人公众号模式（个人开发者无公司的，比较适合使用，0 成本）</p>
<p>用户登录的时候，弹出我们的这个公众号的码。扫码后，用户输入我们提示的验证码。可以随机比如说 nadbuge，通过我们的公众号对接的回调。能拿到一定的信息，用户的 openId。进而记录用户的信息</p>
</li>
<li><p>企业的服务号（必须要有营业执照，自己玩的不上线的话，也可以用测试号）</p>
<p>好处就是不仅打通了各种回调，而且还能拿到用户的信息。</p>
</li>
</ol>
</li>
<li><p>登录功能 </p>
<p>传统的 pc 形式，都是登录之后，写入 cookie。前端再次请求的时候，带着 cookie 一个身份识别就可以完成认证。</p>
<p>坏处是什么？小程序呀，app 呀，其实是没有 cookie 这个概念的。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_53895518/article/details/136869614">单点登录(SSO)详解——超详细-CSDN博客</a></p>
<p>为了更好的扩展，我们就直接选择 <strong>token的模式</strong>。token 放入 header 来实现用户身份的识别与鉴权。</p>
</li>
<li><p>踢人下线 </p>
<p>发现风险用户，可以通过后台直接把用户踢掉，禁止其再访问，token 也可以直接置为失效的形式。</p>
</li>
<li><p>集成 redis （保存token）</p>
<p>如果说我们选择了 token，然后不做 token 的保存，服务重启呀，分布式微服务啊，数据是无法共享并且会产生丢失问题，所以用 redis 来存储一些信息，实现共享。</p>
</li>
<li><p>自定义我们的 token 风格和前缀 </p>
<p>比如正常的 token 可能是 uuid，我们可以选择其他形式。</p>
<p>然后就是 token 的前端的传递，也可以去定义前缀，固定前缀才生效。</p>
</li>
<li><p>记住我 </p>
<p>当我们去勾选记住我的时候，下次登录就自动实现了。</p>
<p>前后端分离，没有 token 的时候，必然会产生无法实现的问题，我们就选择在前端的 localstorage 来做。</p>
</li>
</ul>
<h5 id="登录流程"><a href="#登录流程" class="headerlink" title="登录流程"></a>登录流程</h5><p>整体采取个人号的登录模式，选取某信号的 openId 作为用户的唯一标识！</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/03/31axL8tWMH9CJKG.png" alt="image-20240803115222050.png"></p>
<p>整体流程：</p>
<ol>
<li><p>用户扫公众号码。然后发一条消息：验证码。</p>
</li>
<li><p>通过 api 回复一个随机的验证码。存入 redis</p>
<ul>
<li>key: 前缀+验证码</li>
<li>value: fromUsername(也就是openId)</li>
</ul>
</li>
<li><p>用户在验证码框输入之后，点击登录，进入我们的注册模块，同时关联角色和权限。就实现了网关的统一鉴权。</p>
</li>
<li><p>用户就可以进行操作，用户可以根据个人的 openId 来维护个人信息。</p>
</li>
<li><p>用户登录成功之后，返回 token，前端的所有请求都带着 token 就可以访问了。</p>
</li>
</ol>
<h5 id="服务设计"><a href="#服务设计" class="headerlink" title="服务设计"></a>服务设计</h5><ol>
<li><p>开一个新的服务，叫我们的 jc-club-wechat。专门用于对接微信的 api 和微信的消息的回调。</p>
<ul>
<li>回调：关注公众号，发送验证码</li>
</ul>
</li>
<li><p>通过 nacos 注册中心来调用我们的 auth 服务，来实现用户的注册。</p>
</li>
<li><p>另一种扩展方案，wechat 和 auth 不直接交互。</p>
<ul>
<li>通过 mq 来做。wechat 接收回调后，反向发出 mq。自身的 auth 来订阅 mq 进行消费。</li>
</ul>
</li>
</ol>
<h5 id="公众号开发文档"><a href="#公众号开发文档" class="headerlink" title="公众号开发文档"></a>公众号开发文档</h5><p><strong>里面的例子只有python的没有java的</strong></p>
<p>测试号地址：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/debug/cgi-bin/sandboxinfo?action=showinfo&t=sandbox/index">https://mp.weixin.qq.com/debug/cgi-bin/sandboxinfo?action=showinfo&amp;t=sandbox/index</a></p>
<p>公众号开发文档：<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/doc/offiaccount/Getting_Started/Overview.html">https://developers.weixin.qq.com/doc/offiaccount/Getting_Started/Overview.html</a></p>
<p>回调消息接入指南：<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Access_Overview.html">https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Access_Overview.html</a></p>
<p>接收公众号消息体文档：<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Receiving_standard_messages.html">https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Receiving_standard_messages.html</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/03/MTJeu7qvbZUz6Gj.png" alt="image-20240803115835247.png"></p>
<h5 id="公众号验签开发"><a href="#公众号验签开发" class="headerlink" title="公众号验签开发"></a>公众号验签开发</h5><p><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Access_Overview.html"></a></p>
<p>用户向公众号发送消息时，公众号方收到的消息发送者是一个OpenID，是使用用户微信号加密后的结果，每个用户对每个公众号有一个唯一的OpenID。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/03/eoJgcICb9mVwtAU.png" alt="image-20240803120538428.png"></p>
<ol>
<li><p><strong>填写服务器配置：</strong></p>
<p>登录微信公众平台官网后，在公众平台官网的开发-基本设置页面，勾选协议成为开发者，点击“修改配置”按钮，填写服务器地址（URL）、Token和EncodingAESKey，其中URL是开发者用来接收微信消息和事件的接口URL。Token可由开发者可以任意填写，用作生成签名（该Token会和接口URL中包含的Token进行比对，从而验证安全性）。EncodingAESKey由开发者手动填写或随机生成，将用作消息体加解密密钥。</p>
<p>同时，开发者可选择消息加解密方式：明文模式、兼容模式和安全模式。模式的选择与服务器配置在提交后都会立即生效，请开发者谨慎填写及选择。加解密方式的默认状态为明文模式，选择兼容模式和安全模式需要提前配置好相关加解密代码，<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Message_encryption_and_decryption_instructions.html">详情请参考消息体签名及加解密部分的文档</a> 。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/03/gGtxFwBLzdaubWE.png" alt="image-20240803122144007.png"></p>
</li>
<li><p>验证消息的确来自微信服务器</p>
<p>开发者提交信息后，微信服务器将发送GET请求到填写的服务器地址URL上，GET请求携带参数如下表所示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/03/bQCGk9zgyfWIvw6.png" alt="image-20240803122337758.png"></p>
<p><code>CallBackController.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;callback&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">callback</span><span class="params">(<span class="meta">@RequestParam(&quot;signature&quot;)</span> String signature,</span></span><br><span class="line"><span class="params">                       <span class="meta">@RequestParam(&quot;timestamp&quot;)</span> String timestamp,</span></span><br><span class="line"><span class="params">                       <span class="meta">@RequestParam(&quot;nonce&quot;)</span> String nonce,</span></span><br><span class="line"><span class="params">                       <span class="meta">@RequestParam(&quot;echostr&quot;)</span> String echostr)</span> &#123;</span><br><span class="line">    log.info(<span class="string">&quot;get验签请求参数：signature:&#123;&#125;，timestamp:&#123;&#125;，nonce:&#123;&#125;，echostr:&#123;&#125;&quot;</span>,</span><br><span class="line">            signature, timestamp, nonce, echostr);</span><br><span class="line">    <span class="type">String</span> <span class="variable">shaStr</span> <span class="operator">=</span> SHA1.getSHA1(token, timestamp, nonce, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (signature.equals(shaStr)) &#123;</span><br><span class="line">        <span class="keyword">return</span> echostr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里signature是微信根据传入的token、timestamp、nonce根据sha1计算生成的，是微信回调来的。</p>
</li>
</ol>
<h5 id="内网穿透（natapp）"><a href="#内网穿透（natapp）" class="headerlink" title="内网穿透（natapp）"></a>内网穿透（natapp）</h5><p>不同电脑下载地址：<a target="_blank" rel="noopener" href="https://natapp.cn/#download">https://natapp.cn/#download</a></p>
<p>内网穿透使用指南：</p>
<p><a target="_blank" rel="noopener" href="https://natapp.cn/article/natapp_newbie">https://natapp.cn/article/natapp_newbie</a></p>
<p>windows 启动方式：</p>
<p>进到目录下，运行exe</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start natapp -authtoken=xxxx</span><br></pre></td></tr></table></figure>

<p>配置内网穿透：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/03/jQLXpdPHckq6bOv.png" alt="image-20240803122710792.png"></p>
<p>会生成一个公网的分配的地址，从本地地址-&gt;公网地址，实现穿透</p>
<h5 id="监听用户行为-自动回复消息-消息事件监听-策略模式实现解耦"><a href="#监听用户行为-自动回复消息-消息事件监听-策略模式实现解耦" class="headerlink" title="监听用户行为&amp;自动回复消息(消息事件监听+策略模式实现解耦)"></a>监听用户行为&amp;自动回复消息(消息事件监听+策略模式实现解耦)</h5><h6 id="controller-2"><a href="#controller-2" class="headerlink" title="controller"></a>controller</h6><p><strong>解释关键点</strong></p>
<ul>
<li>**<code>MessageUtil.parseXml</code>**：这是一个自定义方法，用于将 XML 格式的字符串解析成 <code>Map&lt;String, String&gt;</code>。</li>
<li>**<code>WxChatMsgHandler</code> 和 <code>wxChatMsgFactory</code>**：<code>WxChatMsgHandler</code> 是一个处理微信消息的接口或类，<code>wxChatMsgFactory</code> 是一个工厂类，用于根据消息类型获取对应的消息处理器。</li>
<li>**<code>msgTypeKey</code>**：这个字符串键值用于标识不同的消息类型，例如 “text”、”image”、”event.subscribe” 等。</li>
</ul>
<p><strong>主要逻辑流程</strong></p>
<ol>
<li>接收并记录微信发送的消息。</li>
<li>将 XML 格式的消息解析成 <code>Map</code>。</li>
<li>提取消息类型和事件类型。</li>
<li>构建消息类型键值，并根据键值从工厂中获取对应的消息处理器。<ul>
<li>subscribe消息</li>
<li>text消息</li>
</ul>
</li>
<li>使用消息处理器处理消息，返回处理结果。</li>
</ol>
<p><code>CallBackController.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> <span class="string">&quot;adwidhaidwoaid&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> WxChatMsgFactory wxChatMsgFactory;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping(value = &quot;callback&quot;, produces = &quot;application/xml;charset=UTF-8&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">callback</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestBody</span> String requestBody,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(&quot;signature&quot;)</span> String signature,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(&quot;timestamp&quot;)</span> String timestamp,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(&quot;nonce&quot;)</span> String nonce,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;msg_signature&quot;, required = false)</span> String msgSignature)</span> &#123;</span><br><span class="line">    log.info(<span class="string">&quot;接收到微信消息：requestBody：&#123;&#125;&quot;</span>, requestBody);</span><br><span class="line">    Map&lt;String, String&gt; messageMap = MessageUtil.parseXml(requestBody);</span><br><span class="line">    <span class="type">String</span> <span class="variable">msgType</span> <span class="operator">=</span> messageMap.get(<span class="string">&quot;MsgType&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">event</span> <span class="operator">=</span> messageMap.get(<span class="string">&quot;Event&quot;</span>) == <span class="literal">null</span> ? <span class="string">&quot;&quot;</span> : messageMap.get(<span class="string">&quot;Event&quot;</span>);</span><br><span class="line">    log.info(<span class="string">&quot;msgType:&#123;&#125;,event:&#123;&#125;&quot;</span>, msgType, event);</span><br><span class="line"></span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    sb.append(msgType);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(event)) &#123;</span><br><span class="line">        sb.append(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">        sb.append(event);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">msgTypeKey</span> <span class="operator">=</span> sb.toString();</span><br><span class="line">    <span class="type">WxChatMsgHandler</span> <span class="variable">wxChatMsgHandler</span> <span class="operator">=</span> wxChatMsgFactory.getHandlerByMsgType(msgTypeKey);</span><br><span class="line">    <span class="keyword">if</span> (Objects.isNull(wxChatMsgHandler)) &#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">replyContent</span> <span class="operator">=</span> wxChatMsgHandler.dealMsg(messageMap);</span><br><span class="line">    log.info(<span class="string">&quot;replyContent:&#123;&#125;&quot;</span>, replyContent);</span><br><span class="line">    <span class="keyword">return</span> replyContent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Utils"><a href="#Utils" class="headerlink" title="Utils"></a>Utils</h6><p><code>MessageUtil.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析微信发来的请求（String-&gt;XML）.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg 消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> map</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, String&gt; <span class="title function_">parseXml</span><span class="params">(<span class="keyword">final</span> String msg)</span> &#123;</span><br><span class="line">        <span class="comment">// 将解析结果存储在HashMap中</span></span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从request中取得输入流</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(msg.getBytes(StandardCharsets.UTF_8.name()))) &#123;</span><br><span class="line">            <span class="comment">// 读取输入流</span></span><br><span class="line">            <span class="type">SAXReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SAXReader</span>(); <span class="comment">//saxreader</span></span><br><span class="line">            <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> reader.read(inputStream);</span><br><span class="line">            <span class="comment">// 得到xml根元素</span></span><br><span class="line">            <span class="type">Element</span> <span class="variable">root</span> <span class="operator">=</span> document.getRootElement();</span><br><span class="line">            <span class="comment">// 得到根元素的所有子节点</span></span><br><span class="line">            List&lt;Element&gt; elementList = root.elements();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 遍历所有子节点</span></span><br><span class="line">            <span class="keyword">for</span> (Element e : elementList) &#123;</span><br><span class="line">                map.put(e.getName(), e.getText());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="handler"><a href="#handler" class="headerlink" title="handler"></a>handler</h6><p><code>WxChatMsgHandler.java</code></p>
<p>有两个类继承它：</p>
<ul>
<li><p><code>SubscribeMsgHandler.java</code></p>
</li>
<li><p><code>ReceiveTextMsgHandler.java</code></p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">WxChatMsgHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    WxChatMsgTypeEnum <span class="title function_">getMsgType</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">dealMsg</span><span class="params">(Map&lt;String, String&gt; messageMap)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jingdianjichi.wx.handler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jingdianjichi.wx.redis.RedisUtil;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReceiveTextMsgHandler</span> <span class="keyword">implements</span> <span class="title class_">WxChatMsgHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_WORD</span> <span class="operator">=</span> <span class="string">&quot;验证码&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LOGIN_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;loginCode&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisUtil redisUtil;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> WxChatMsgTypeEnum <span class="title function_">getMsgType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> WxChatMsgTypeEnum.TEXT_MSG;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">dealMsg</span><span class="params">(Map&lt;String, String&gt; messageMap)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;接收到文本消息事件&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> messageMap.get(<span class="string">&quot;Content&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!KEY_WORD.equals(content)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fromUserName</span> <span class="operator">=</span> messageMap.get(<span class="string">&quot;FromUserName&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">toUserName</span> <span class="operator">=</span> messageMap.get(<span class="string">&quot;ToUserName&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> random.nextInt(<span class="number">1000</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">numKey</span> <span class="operator">=</span> redisUtil.buildKey(LOGIN_PREFIX, String.valueOf(num));</span><br><span class="line">        redisUtil.setNx(numKey, fromUserName, <span class="number">5L</span>, TimeUnit.MINUTES);</span><br><span class="line">        <span class="type">String</span> <span class="variable">numContent</span> <span class="operator">=</span> <span class="string">&quot;您当前的验证码是：&quot;</span> + num + <span class="string">&quot;！ 5分钟内有效&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">replyContent</span> <span class="operator">=</span> <span class="string">&quot;&lt;xml&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &lt;ToUserName&gt;&lt;![CDATA[&quot;</span> + fromUserName + <span class="string">&quot;]]&gt;&lt;/ToUserName&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &lt;FromUserName&gt;&lt;![CDATA[&quot;</span> + toUserName + <span class="string">&quot;]]&gt;&lt;/FromUserName&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &lt;CreateTime&gt;12345678&lt;/CreateTime&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &lt;MsgType&gt;&lt;![CDATA[text]]&gt;&lt;/MsgType&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &lt;Content&gt;&lt;![CDATA[&quot;</span> + numContent + <span class="string">&quot;]]&gt;&lt;/Content&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;/xml&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> replyContent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jingdianjichi.wx.handler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubscribeMsgHandler</span> <span class="keyword">implements</span> <span class="title class_">WxChatMsgHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> WxChatMsgTypeEnum <span class="title function_">getMsgType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> WxChatMsgTypeEnum.SUBSCRIBE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">dealMsg</span><span class="params">(Map&lt;String, String&gt; messageMap)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;触发用户关注事件！&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">fromUserName</span> <span class="operator">=</span> messageMap.get(<span class="string">&quot;FromUserName&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">toUserName</span> <span class="operator">=</span> messageMap.get(<span class="string">&quot;ToUserName&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">subscribeContent</span> <span class="operator">=</span> <span class="string">&quot;感谢您的关注&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> <span class="string">&quot;&lt;xml&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &lt;ToUserName&gt;&lt;![CDATA[&quot;</span> + fromUserName + <span class="string">&quot;]]&gt;&lt;/ToUserName&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &lt;FromUserName&gt;&lt;![CDATA[&quot;</span> + toUserName + <span class="string">&quot;]]&gt;&lt;/FromUserName&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &lt;CreateTime&gt;12345678&lt;/CreateTime&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &lt;MsgType&gt;&lt;![CDATA[text]]&gt;&lt;/MsgType&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &lt;Content&gt;&lt;![CDATA[&quot;</span> + subscribeContent + <span class="string">&quot;]]&gt;&lt;/Content&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;/xml&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h6><p>这里也用到了<code>RedisUtil.java</code>，和gateway模块的一致，所以后续思路可以把这部分提取出来当成common模块的。</p>
<p><code>ReceiveTextMsgHandler.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">numKey</span> <span class="operator">=</span> redisUtil.buildKey(LOGIN_PREFIX, String.valueOf(num));</span><br><span class="line">        redisUtil.setNx(numKey, fromUserName, <span class="number">5L</span>, TimeUnit.MINUTES); <span class="comment">//key为登录的前缀（字符串）+验证码（validCode）</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">numContent</span> <span class="operator">=</span> <span class="string">&quot;您当前的验证码是：&quot;</span> + num + <span class="string">&quot;！ 5分钟内有效&quot;</span>;</span><br></pre></td></tr></table></figure>

<h5 id="公众号登录验证码逻辑"><a href="#公众号登录验证码逻辑" class="headerlink" title="公众号登录验证码逻辑"></a>公众号登录验证码逻辑</h5><p><code>UserController.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;doLogin&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;SaTokenInfo&gt; <span class="title function_">doLogin</span><span class="params">(<span class="meta">@RequestParam(&quot;validCode&quot;)</span> String validCode)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Preconditions.checkArgument(!StringUtils.isBlank(validCode), <span class="string">&quot;验证码不能为空!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(authUserDomainService.doLogin(validCode));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;UserController.doLogin.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;用户登录失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>AuthUserDomainServiceImpl.java</code></p>
<p>通过前缀+验证码-&gt;从redis拿到openId（即用户名），用satoken用openId进行登录，然后利用satoken返回一个token</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SaTokenInfo <span class="title function_">doLogin</span><span class="params">(String validCode)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">loginKey</span> <span class="operator">=</span> redisUtil.buildKey(LOGIN_PREFIX, validCode);</span><br><span class="line">    <span class="type">String</span> <span class="variable">openId</span> <span class="operator">=</span> redisUtil.get(loginKey);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(openId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">AuthUserBO</span> <span class="variable">authUserBO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthUserBO</span>();</span><br><span class="line">    authUserBO.setUserName(openId);</span><br><span class="line">    <span class="built_in">this</span>.register(authUserBO); <span class="comment">//校验是否存在，存在直接返回，不存在就注册</span></span><br><span class="line">    StpUtil.login(openId);</span><br><span class="line">    <span class="type">SaTokenInfo</span> <span class="variable">tokenInfo</span> <span class="operator">=</span> StpUtil.getTokenInfo();</span><br><span class="line">    <span class="keyword">return</span> tokenInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="第二部分"><a href="#第二部分" class="headerlink" title="第二部分"></a>第二部分</h2><h3 id="前后端部署"><a href="#前后端部署" class="headerlink" title="前后端部署"></a>前后端部署</h3><p>前端：</p>
<p>下好node.js，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm install</span><br></pre></td></tr></table></figure>

<p>下载好依赖。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/03/FmTDQI2UK3zPi1k.png" alt="image-20240803195320973.png"></p>
<p>后端：</p>
<p>如果服务器没那么大空间，Jenkins跑起来有点困难，可以就配置好相关配置后install打好jar包，扔到服务器上：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup java -jar ***.jar</span><br></pre></td></tr></table></figure>





<h3 id="细节优化"><a href="#细节优化" class="headerlink" title="细节优化"></a>细节优化</h3><p>1、分类和标签的性能优化，一次性查询出来，组装成树结构</p>
<p>2、去出题的按钮的权限交互。用户登录成功后，返回给前端，当前用户的相关权限。前端存到本地 localstorage 里面，进行按钮级别的前端交互。对于一些敏感的写操作，后端也应该提供一些权限接口</p>
<p>3、退出功能，token 失效的功能</p>
<p>4、个人信息页面的查询功能。</p>
<p>5、上传头像的功能。</p>
<p>6、每次注册的时候，相同的 openId 要做校验。</p>
<h4 id="1-避免重复注册"><a href="#1-避免重复注册" class="headerlink" title="1. 避免重复注册"></a>1. 避免重复注册</h4><p><code>AuthUserDomainServiceImpl.java</code></p>
<p>注意这里调了register的接口：登录—&gt;注册（如果已经注册了就返回，没有注册就注册）-&gt;返回satoken提供了的tokenInfo。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SaTokenInfo <span class="title function_">doLogin</span><span class="params">(String validCode)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">loginKey</span> <span class="operator">=</span> redisUtil.buildKey(LOGIN_PREFIX, validCode);</span><br><span class="line">    <span class="type">String</span> <span class="variable">openId</span> <span class="operator">=</span> redisUtil.get(loginKey);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(openId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">AuthUserBO</span> <span class="variable">authUserBO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthUserBO</span>();</span><br><span class="line">    authUserBO.setUserName(openId);</span><br><span class="line">    <span class="built_in">this</span>.register(authUserBO);</span><br><span class="line">    StpUtil.login(openId);</span><br><span class="line">    <span class="type">SaTokenInfo</span> <span class="variable">tokenInfo</span> <span class="operator">=</span> StpUtil.getTokenInfo();</span><br><span class="line">    <span class="keyword">return</span> tokenInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>AuthUserDomainServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">register</span><span class="params">(AuthUserBO authUserBO)</span> &#123;</span><br><span class="line">    <span class="comment">//校验用户是否存在</span></span><br><span class="line">    <span class="type">AuthUser</span> <span class="variable">existAuthUser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthUser</span>();</span><br><span class="line">    existAuthUser.setUserName(authUserBO.getUserName());</span><br><span class="line">    List&lt;AuthUser&gt; existUser = authUserService.queryByCondition(existAuthUser);</span><br><span class="line">    <span class="keyword">if</span> (existUser.size() &gt; <span class="number">0</span>) &#123; <span class="comment">//这里如果已经注册过了，就直接返回了</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-个人信息查询"><a href="#2-个人信息查询" class="headerlink" title="2.个人信息查询"></a>2.个人信息查询</h4><p><code>UserController.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;getUserInfo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;AuthUserDTO&gt; <span class="title function_">getUserInfo</span><span class="params">(<span class="meta">@RequestBody</span> AuthUserDTO authUserDTO)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;UserController.getUserInfo.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(authUserDTO));</span><br><span class="line">        &#125;</span><br><span class="line">        Preconditions.checkArgument(!StringUtils.isBlank(authUserDTO.getUserName()), <span class="string">&quot;用户名不能为空&quot;</span>);</span><br><span class="line">        <span class="type">AuthUserBO</span> <span class="variable">authUserBO</span> <span class="operator">=</span> AuthUserDTOConverter.INSTANCE.convertDTOToBO(authUserDTO);</span><br><span class="line">        <span class="type">AuthUserBO</span> <span class="variable">userInfo</span> <span class="operator">=</span> authUserDomainService.getUserInfo(authUserBO);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(AuthUserDTOConverter.INSTANCE.convertBOToDTO(userInfo));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;UserController.update.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;更新用户信息失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>authUserDomainServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> AuthUserBO <span class="title function_">getUserInfo</span><span class="params">(AuthUserBO authUserBO)</span> &#123;</span><br><span class="line">    <span class="type">AuthUser</span> <span class="variable">authUser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthUser</span>();</span><br><span class="line">    authUser.setUserName(authUserBO.getUserName());</span><br><span class="line">    List&lt;AuthUser&gt; userList = authUserService.queryByCondition(authUser);</span><br><span class="line">    <span class="keyword">if</span> (CollectionUtils.isEmpty(userList)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AuthUserBO</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">AuthUser</span> <span class="variable">user</span> <span class="operator">=</span> userList.get(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> AuthUserBOConverter.INSTANCE.convertEntityToBO(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>authUserServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;AuthUser&gt; <span class="title function_">queryByCondition</span><span class="params">(AuthUser authUser)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.authUserDao.queryAllByLimit(authUser);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-用户退出"><a href="#3-用户退出" class="headerlink" title="3.用户退出"></a>3.用户退出</h4><p><code>UserController.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;logOut&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">logOut</span><span class="params">(<span class="meta">@RequestParam</span> String userName)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;UserController.logOut.userName:&#123;&#125;&quot;</span>, userName);</span><br><span class="line">        Preconditions.checkArgument(!StringUtils.isBlank(userName), <span class="string">&quot;用户名不能为空&quot;</span>);</span><br><span class="line">        StpUtil.logout(userName);</span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;UserController.logOut.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;用户登出失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-用户上传头像"><a href="#4-用户上传头像" class="headerlink" title="4. 用户上传头像"></a>4. 用户上传头像</h4><p><code>oss</code>模块下的<code>FileController.java</code></p>
<p><strong>接口定义</strong>：<code>/upload</code> 是一个 HTTP 请求映射，用于接收文件上传请求。</p>
<p><strong>参数</strong>：<code>MultipartFile uploadFile</code> 是上传的文件，<code>String bucket</code> 是桶的名称，<code>String objectName</code> 是对象名称（文件路径）。</p>
<p><strong>调用服务</strong>：调用 <code>fileService.uploadFile</code> 方法上传文件，并获取文件的 URL。</p>
<p><strong>返回结果</strong>：使用 <code>Result.ok(url)</code> 返回上传后的文件 URL。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/upload&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">upload</span><span class="params">(MultipartFile uploadFile, String bucket, String objectName)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> fileService.uploadFile(uploadFile, bucket, objectName);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>fileService.java</code></p>
<p><strong>调用适配器</strong>：调用 <code>storageAdapter.uploadFile</code> 方法，将文件上传到指定的桶和对象名称。</p>
<p><strong>更新对象名称</strong>：将 <code>objectName</code> 更新为 <code>objectName + &quot;/&quot; + uploadFile.getOriginalFilename()</code>，这一步是为了构建文件的完整路径。</p>
<p><strong>获取 URL</strong>：调用 <code>storageAdapter.getUrl</code> 方法，获取文件的访问 URL 并返回。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">uploadFile</span><span class="params">(MultipartFile uploadFile, String bucket, String objectName)</span>&#123;</span><br><span class="line">    storageAdapter.uploadFile(uploadFile,bucket,objectName);</span><br><span class="line">    objectName = objectName + <span class="string">&quot;/&quot;</span> + uploadFile.getOriginalFilename();</span><br><span class="line">    <span class="keyword">return</span> storageAdapter.getUrl(bucket, objectName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>MinioStorageAdapter.java</code></p>
<p><strong>创建桶</strong>：调用 <code>minioUtil.createBucket(bucket)</code> 方法，确保桶存在。如果桶不存在则创建。</p>
<p><strong>上传文件</strong>：根据 <code>objectName</code> 是否为空，决定文件上传的路径。如果 <code>objectName</code> 不为空，则将文件上传到 <code>objectName + &quot;/&quot; + uploadFile.getOriginalFilename()</code>。如果为空，则上传到 <code>uploadFile.getOriginalFilename()</code>。</p>
<p><strong>获取 URL</strong>：构建并返回文件的 URL。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">uploadFile</span><span class="params">(MultipartFile uploadFile, String bucket, String objectName)</span> &#123;</span><br><span class="line">    minioUtil.createBucket(bucket);</span><br><span class="line">    <span class="keyword">if</span> (objectName != <span class="literal">null</span>) &#123;</span><br><span class="line">        minioUtil.uploadFile(uploadFile.getInputStream(), bucket, objectName + <span class="string">&quot;/&quot;</span> + uploadFile.getOriginalFilename());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        minioUtil.uploadFile(uploadFile.getInputStream(), bucket, uploadFile.getOriginalFilename());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getUrl</span><span class="params">(String bucket, String objectName)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> url + <span class="string">&quot;/&quot;</span> + bucket + <span class="string">&quot;/&quot;</span> + objectName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-分类题目数量更新"><a href="#5-分类题目数量更新" class="headerlink" title="5.分类题目数量更新"></a>5.分类题目数量更新</h4><p><code>SubjectCategoryController.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/queryPrimaryCategory&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;List&lt;SubjectCategoryDTO&gt;&gt; <span class="title function_">queryPrimaryCategory</span><span class="params">(<span class="meta">@RequestBody</span> SubjectCategoryDTO subjectCategoryDTO)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">SubjectCategoryBO</span> <span class="variable">subjectCategoryBO</span> <span class="operator">=</span> SubjectCategoryDTOConverter.INSTANCE.</span><br><span class="line">                convertDtoToCategoryBO(subjectCategoryDTO);</span><br><span class="line">        List&lt;SubjectCategoryBO&gt; subjectCategoryBOList = subjectCategoryDomainService.queryCategory(subjectCategoryBO);</span><br><span class="line">        List&lt;SubjectCategoryDTO&gt; subjectCategoryDTOList = SubjectCategoryDTOConverter.INSTANCE.</span><br><span class="line">                convertBoToCategoryDTOList(subjectCategoryBOList);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(subjectCategoryDTOList);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;SubjectCategoryController.queryPrimaryCategory.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;查询失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SubjectCategoryDomainServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;SubjectCategoryBO&gt; <span class="title function_">queryCategory</span><span class="params">(SubjectCategoryBO subjectCategoryBO)</span> &#123;</span><br><span class="line">    <span class="type">SubjectCategory</span> <span class="variable">subjectCategory</span> <span class="operator">=</span> SubjectCategoryConverter.INSTANCE</span><br><span class="line">            .convertBoToCategory(subjectCategoryBO);</span><br><span class="line">    subjectCategory.setIsDeleted(IsDeletedFlagEnum.UN_DELETED.getCode());</span><br><span class="line">    List&lt;SubjectCategory&gt; subjectCategoryList = subjectCategoryService.queryCategory(subjectCategory);</span><br><span class="line">    List&lt;SubjectCategoryBO&gt; boList = SubjectCategoryConverter.INSTANCE</span><br><span class="line">            .convertBoToCategory(subjectCategoryList);</span><br><span class="line">    <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">        log.info(<span class="string">&quot;SubjectCategoryController.queryPrimaryCategory.boList:&#123;&#125;&quot;</span>,</span><br><span class="line">                JSON.toJSONString(boList));</span><br><span class="line">    &#125;</span><br><span class="line">    boList.forEach(bo -&gt; &#123;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">subjectCount</span> <span class="operator">=</span> subjectCategoryService.querySubjectCount(bo.getId());</span><br><span class="line">        bo.setCount(subjectCount);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> boList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SubjectCategoryServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;SubjectCategory&gt; <span class="title function_">queryCategory</span><span class="params">(SubjectCategory subjectCategory)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.subjectCategoryDao.queryCategory(subjectCategory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">querySubjectCount</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.subjectCategoryDao.querySubjectCount(id);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>SubjectCategoryDao.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;querySubjectCount&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;java.lang.Integer&quot;</span>&gt;</span></span><br><span class="line">    select count(distinct subject_id)</span><br><span class="line">    from subject_mapping a,</span><br><span class="line">         subject_label b</span><br><span class="line">    where a.label_id = b.id</span><br><span class="line">    and b.category_id = #&#123;id&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="6-分类标签性能优化-star"><a href="#6-分类标签性能优化-star" class="headerlink" title="6. 分类标签性能优化:star:"></a>6. 分类标签性能优化:star:</h4><p><code>SubjectCategoryDomainServiceImpl.java</code>核心是使用<code>CompletableFuture</code>和Java流来并行处理任务：</p>
<ol>
<li>对每个<code>category</code>，启动一个异步任务来获取标签列表，并将任务结果以<code>CompletableFuture</code>的形式收集到列表中。</li>
<li>遍历<code>completableFutureList</code>，获取每个任务的结果，并将非空结果合并到<code>map</code>中。 <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_45721579/article/details/131384231?ops_request_misc=&request_id=&biz_id=102&utm_term=CompletableFuture.supplyAsync&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-1-131384231.nonecase&spm=1018.2226.3001.4187">【Java 8 新特性】Java CompletableFuture supplyAsync()详解_completablefuture.supplyasync-CSDN博客</a></li>
<li>通过这种方式，可以并行处理多个任务，提高了程序的效率。</li>
</ol>
<p><code>SubjectCategoryController.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询分类及标签一次性</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/queryCategoryAndLabel&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;List&lt;SubjectCategoryDTO&gt;&gt; <span class="title function_">queryCategoryAndLabel</span><span class="params">(<span class="meta">@RequestBody</span> SubjectCategoryDTO subjectCategoryDTO)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;SubjectCategoryController.queryCategoryAndLabel.dto:&#123;&#125;&quot;</span></span><br><span class="line">                    , JSON.toJSONString(subjectCategoryDTO));</span><br><span class="line">        &#125;</span><br><span class="line">        Preconditions.checkNotNull(subjectCategoryDTO.getId(), <span class="string">&quot;分类id不能为空&quot;</span>);</span><br><span class="line">        <span class="type">SubjectCategoryBO</span> <span class="variable">subjectCategoryBO</span> <span class="operator">=</span> SubjectCategoryDTOConverter.INSTANCE.</span><br><span class="line">                convertDtoToCategoryBO(subjectCategoryDTO);</span><br><span class="line">        List&lt;SubjectCategoryBO&gt; subjectCategoryBOList = subjectCategoryDomainService.queryCategoryAndLabel(subjectCategoryBO); <span class="comment">//查种类和标签</span></span><br><span class="line">        List&lt;SubjectCategoryDTO&gt; dtoList = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        subjectCategoryBOList.forEach(bo -&gt; &#123;</span><br><span class="line">            <span class="type">SubjectCategoryDTO</span> <span class="variable">dto</span> <span class="operator">=</span> SubjectCategoryDTOConverter.INSTANCE.convertBoToCategoryDTO(bo);</span><br><span class="line">            List&lt;SubjectLabelDTO&gt; labelDTOList = SubjectLabelDTOConverter.INSTANCE.convertBOToLabelDTOList(bo.getLabelBOList());</span><br><span class="line">            dto.setLabelDTOList(labelDTOList);</span><br><span class="line">            dtoList.add(dto);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(dtoList);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;SubjectCategoryController.queryPrimaryCategory.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;查询失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>自定义线程工厂：</strong></p>
<p><code>CustomNameThreadFactory.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入所需的类和接口。</span></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadFactory;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomNameThreadFactory</span> <span class="keyword">implements</span> <span class="title class_">ThreadFactory</span> &#123;</span><br><span class="line">    <span class="comment">// 用于生成线程池编号的静态原子类。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">poolNumber</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 线程所属的线程组。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadGroup group;</span><br><span class="line">    <span class="comment">// 用于生成线程编号的原子类。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">threadNumber</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 线程名称的前缀。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String namePrefix;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造函数，接受一个字符串参数来设置线程名称的前缀。</span></span><br><span class="line">    CustomNameThreadFactory(String name) &#123;</span><br><span class="line">        <span class="type">SecurityManager</span> <span class="variable">s</span> <span class="operator">=</span> System.getSecurityManager();</span><br><span class="line">        <span class="comment">// 如果存在安全管理器，则使用安全管理器的线程组，否则使用当前线程的线程组。</span></span><br><span class="line">        group = (s != <span class="literal">null</span>) ? s.getThreadGroup() : Thread.currentThread().getThreadGroup();</span><br><span class="line">        <span class="comment">// 如果传入的名称为空或空白，则默认使用 &quot;pool&quot; 作为名称。</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(name)) &#123;</span><br><span class="line">            name = <span class="string">&quot;pool&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 构造线程名称的前缀，包括线程池编号和 &quot;-thread-&quot;。</span></span><br><span class="line">        namePrefix = name + <span class="string">&quot;-&quot;</span> + poolNumber.getAndIncrement() + <span class="string">&quot;-thread-&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现 ThreadFactory 接口的 newThread 方法，用于创建新的线程。</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Thread <span class="title function_">newThread</span><span class="params">(Runnable r)</span> &#123;</span><br><span class="line">        <span class="comment">// 创建一个新的线程，使用 group 作为线程组，r 作为要执行的任务。</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(group, r,</span><br><span class="line">                <span class="comment">// 线程名称由前缀、线程编号和递增后的编号组成。</span></span><br><span class="line">                namePrefix + threadNumber.getAndIncrement(),</span><br><span class="line">                <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 如果线程是守护线程，则将其设置为非守护线程。</span></span><br><span class="line">        <span class="keyword">if</span> (t.isDaemon())&#123;</span><br><span class="line">            t.setDaemon(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果线程的优先级不是普通优先级，则将其设置为普通优先级。</span></span><br><span class="line">        <span class="keyword">if</span> (t.getPriority() != Thread.NORM_PRIORITY)&#123;</span><br><span class="line">            t.setPriority(Thread.NORM_PRIORITY);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 返回新创建的线程。</span></span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SubjectCategoryDomainServiceImpl.java</code></p>
<p><strong>创建并初始化<code>SubjectCategory</code>对象</strong>：</p>
<ul>
<li>设置<code>ParentId</code>为<code>categoryId</code>。</li>
<li>设置<code>IsDeleted</code>为未删除状态。</li>
</ul>
<p><strong>查询类别列表</strong>：</p>
<ul>
<li>调用<code>subjectCategoryService.queryCategory</code>方法查询类别列表。</li>
</ul>
<p><strong>日志记录</strong>：</p>
<ul>
<li>记录查询结果的日志。</li>
</ul>
<p><strong>转换类别列表</strong>：</p>
<ul>
<li>使用<code>SubjectCategoryConverter</code>将<code>SubjectCategory</code>列表转换为<code>SubjectCategoryBO</code>列表。</li>
</ul>
<p><strong>并行处理标签列表</strong>：</p>
<ul>
<li>为每个类别创建一个异步任务，调用<code>getLabelBOList</code>方法获取标签列表。</li>
<li>使用<code>CompletableFuture</code>并行处理这些任务。</li>
</ul>
<p><strong>收集并合并结果</strong>：</p>
<ul>
<li>等待所有异步任务完成，并将结果合并到一个<code>Map&lt;Long, List&lt;SubjectLabelBO&gt;&gt;</code>中。</li>
</ul>
<p><strong>设置标签列表</strong>：</p>
<ul>
<li>为每个<code>SubjectCategoryBO</code>对象设置对应的标签列表。</li>
</ul>
<p><strong>返回结果</strong>：</p>
<ul>
<li>返回包含标签列表的<code>SubjectCategoryBO</code>列表。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> ThreadPoolExecutor labelThreadPool;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;SubjectCategoryBO&gt; <span class="title function_">queryCategoryAndLabel</span><span class="params">(SubjectCategoryBO subjectCategoryBO)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> subjectCategoryBO.getId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">cacheKey</span> <span class="operator">=</span> <span class="string">&quot;categoryAndLabel.&quot;</span> + subjectCategoryBO.getId();</span><br><span class="line">    List&lt;SubjectCategoryBO&gt; subjectCategoryBOS = cacheUtil.getResult(cacheKey,</span><br><span class="line">            SubjectCategoryBO.class, (key) -&gt; getSubjectCategoryBOS(id));</span><br><span class="line">    <span class="keyword">return</span> subjectCategoryBOS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> List&lt;SubjectCategoryBO&gt; <span class="title function_">getSubjectCategoryBOS</span><span class="params">(Long categoryId)</span> &#123;</span><br><span class="line">        <span class="type">SubjectCategory</span> <span class="variable">subjectCategory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubjectCategory</span>();</span><br><span class="line">        subjectCategory.setParentId(categoryId);</span><br><span class="line">        subjectCategory.setIsDeleted(IsDeletedFlagEnum.UN_DELETED.getCode());</span><br><span class="line">        List&lt;SubjectCategory&gt; subjectCategoryList = subjectCategoryService.queryCategory(subjectCategory);</span><br><span class="line">        <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;SubjectCategoryController.queryCategoryAndLabel.subjectCategoryList:&#123;&#125;&quot;</span>,</span><br><span class="line">                    JSON.toJSONString(subjectCategoryList));</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;SubjectCategoryBO&gt; categoryBOList = SubjectCategoryConverter.INSTANCE.convertBoToCategory(subjectCategoryList);</span><br><span class="line">        Map&lt;Long, List&lt;SubjectLabelBO&gt;&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        List&lt;CompletableFuture&lt;Map&lt;Long, List&lt;SubjectLabelBO&gt;&gt;&gt;&gt; completableFutureList = categoryBOList.stream().map(category -&gt;</span><br><span class="line">                CompletableFuture.supplyAsync(() -&gt; getLabelBOList(category), labelThreadPool).collect(Collectors.toList()); <span class="comment">//对于每个category，调用异步的CompletableFuture.supplyAsync()执行getLabelBOList方法和ThreadPoolExecutor作为Executor去多线程+异步的获取labelBOList</span></span><br><span class="line">        completableFutureList.forEach(future -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Map&lt;Long, List&lt;SubjectLabelBO&gt;&gt; resultMap = future.get();</span><br><span class="line">                <span class="keyword">if</span> (!MapUtils.isEmpty(resultMap)) &#123;</span><br><span class="line">                    map.putAll(resultMap);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        categoryBOList.forEach(categoryBO -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (!CollectionUtils.isEmpty(map.get(categoryBO.getId()))) &#123;</span><br><span class="line">                categoryBO.setLabelBOList(map.get(categoryBO.getId()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> categoryBOList;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//通过Category查找对应的labelList</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;Long, List&lt;SubjectLabelBO&gt;&gt; <span class="title function_">getLabelBOList</span><span class="params">(SubjectCategoryBO category)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;getLabelBOList:&#123;&#125;&quot;</span>, JSON.toJSONString(category));</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;Long, List&lt;SubjectLabelBO&gt;&gt; labelMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">SubjectMapping</span> <span class="variable">subjectMapping</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubjectMapping</span>();</span><br><span class="line">        subjectMapping.setCategoryId(category.getId());</span><br><span class="line">        List&lt;SubjectMapping&gt; mappingList = subjectMappingService.queryLabelId(subjectMapping);</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(mappingList)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;Long&gt; labelIdList = mappingList.stream().map(SubjectMapping::getLabelId).collect(Collectors.toList());</span><br><span class="line">        List&lt;SubjectLabel&gt; labelList = subjectLabelService.batchQueryById(labelIdList);</span><br><span class="line">        List&lt;SubjectLabelBO&gt; labelBOList = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        labelList.forEach(label -&gt; &#123;</span><br><span class="line">            <span class="type">SubjectLabelBO</span> <span class="variable">subjectLabelBO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubjectLabelBO</span>();</span><br><span class="line">            subjectLabelBO.setId(label.getId());</span><br><span class="line">            subjectLabelBO.setLabelName(label.getLabelName());</span><br><span class="line">            subjectLabelBO.setCategoryId(label.getCategoryId());</span><br><span class="line">            subjectLabelBO.setSortNum(label.getSortNum());</span><br><span class="line">            labelBOList.add(subjectLabelBO);</span><br><span class="line">        &#125;);</span><br><span class="line">        labelMap.put(category.getId(), labelBOList);</span><br><span class="line">        <span class="keyword">return</span> labelMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码的核心是使用<code>CompletableFuture</code>和Java流来并行处理任务：</p>
<ol>
<li>对每个<code>category</code>，启动一个异步任务来获取标签列表，并将任务结果以<code>CompletableFuture</code>的形式收集到列表中。</li>
<li>遍历<code>completableFutureList</code>，获取每个任务的结果，并将非空结果合并到<code>map</code>中。 <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_45721579/article/details/131384231?ops_request_misc=&request_id=&biz_id=102&utm_term=CompletableFuture.supplyAsync&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-1-131384231.nonecase&spm=1018.2226.3001.4187">【Java 8 新特性】Java CompletableFuture supplyAsync()详解_completablefuture.supplyasync-CSDN博客</a></li>
<li>通过这种方式，可以并行处理多个任务，提高了程序的效率。</li>
</ol>
<h4 id="7-用户权限获取"><a href="#7-用户权限获取" class="headerlink" title="7. 用户权限获取"></a>7. 用户权限获取</h4><p><code>AuthPermissionDomainServiceImpl.java</code></p>
<p>将存储在Redis中的权限数据转换为一个易于使用的权限键列表，以便在应用程序中进行权限检查。如果Redis中没有找到用户的权限数据，则返回一个空列表。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getPermission</span><span class="params">(String userName)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">permissionKey</span> <span class="operator">=</span> redisUtil.buildKey(authPermissionPrefix, userName);</span><br><span class="line">    <span class="type">String</span> <span class="variable">permissionValue</span> <span class="operator">=</span> redisUtil.get(permissionKey);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(permissionValue)) &#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;AuthPermission&gt; permissionList = <span class="keyword">new</span> <span class="title class_">Gson</span>().fromJson(permissionValue,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">TypeToken</span>&lt;List&lt;AuthPermission&gt;&gt;() &#123;</span><br><span class="line">            &#125;.getType()); <span class="comment">//使用Google的Gson库将权限字符串反序列化为AuthPermission对象的列表。TypeToken用于指定泛型类型。</span></span><br><span class="line">    List&lt;String&gt; authList = permissionList.stream().map(AuthPermission::getPermissionKey).collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">return</span> authList; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="8-利用minio-mc突破图片7天权限"><a href="#8-利用minio-mc突破图片7天权限" class="headerlink" title="8. 利用minio&#x2F;mc突破图片7天权限"></a>8. 利用minio&#x2F;mc突破图片7天权限</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/06/iTOqVzkRdl74BUm.jpg" alt="93d2be17b7b8562a08d456c5484f684.jpg"></p>
<p>有两个问题：</p>
<ol>
<li>minio上传头像只能保存7天</li>
<li>生成的url很长，需要简化</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">docker pull minio/mc</span><br><span class="line"></span><br><span class="line">docker run -it --entrypoint=/bin/sh minio/mc</span><br><span class="line"></span><br><span class="line">mc config host add &lt;ALIAS&gt; &lt;YOUR-S3-ENDPOINT&gt; &lt;YOUR-ACCESS-KEY&gt; &lt;YOUR-SECRET-KEY&gt; [--api API-SIGNATURE]</span><br><span class="line"></span><br><span class="line">mc config host add minio http://xxx.xx.xx.xxx:9000 GrVCPXySKgGoJiGgXmtv 0xlqSI9GXvnBOtp0GwUj5OshKNBk9JgwoexotbVV</span><br><span class="line"></span><br><span class="line">mc ls minio</span><br><span class="line"></span><br><span class="line">mc anonymous //可以设置什么</span><br><span class="line"></span><br><span class="line">mc anonymous set download minio/jichi</span><br></pre></td></tr></table></figure>

<p>url: bucket+name</p>
<p><code>FileController.java</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/06/QEXLm8GRkTVxA9D.png" alt="image-20240806154518945.png"></p>
<p><code>MinioStorageAdapter.java</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/06/XORypnF7lIDZNE1.png" alt="image-20240806154356089.png"></p>
<p><code>FileController.java</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/06/jVz5AyCNiQKt9EG.png" alt="image-20240806154533525.png"></p>
<p><code>MinioStorageAdapter.java</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/06/1F5kzqREVeBYw4m.png" alt="image-20240806154622450.png"></p>
<h3 id="功能规划"><a href="#功能规划" class="headerlink" title="功能规划"></a>功能规划</h3><h4 id="搜索功能（完成）"><a href="#搜索功能（完成）" class="headerlink" title="搜索功能（完成）"></a>搜索功能（完成）</h4><p>全文检索，技术选型 es。</p>
<p>安装 es。</p>
<p>xxl-job 定时任务，去做一个数据同步，全量数据导入</p>
<p>es 全文检索，做高亮</p>
<h4 id="点赞（完成）"><a href="#点赞（完成）" class="headerlink" title="点赞（完成）"></a>点赞（完成）</h4><p>自己点赞过的，这里肯定要有一个点赞过的 icon 的一个标识</p>
<p>后面的数量，意味着这道题目被多少个人点过赞。</p>
<p>如何去防刷点赞。疯狂的点赞，取消点赞。前端配合防抖，后端的点赞数量放到 redis 里面。数据库的持久化，可以通过定时任务来定时的刷新同步。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/03/gHmp6AnyT9C8jsZ.png" alt="image-20240803193709660.png"></p>
<h4 id="我的点赞（完成）"><a href="#我的点赞（完成）" class="headerlink" title="我的点赞（完成）"></a>我的点赞（完成）</h4><p>展示，我们当前当过赞的所有的数据，来进行一波展示。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/03/wI1p4UvNideb9cR.png" alt="image-20240803193658610.png"></p>
<h4 id="收藏（完成）"><a href="#收藏（完成）" class="headerlink" title="收藏（完成）"></a>收藏（完成）</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/03/eUzZPhtopQYduEB.png" alt="image-20240803193734357.png"></p>
<h4 id="我的收藏（完成）"><a href="#我的收藏（完成）" class="headerlink" title="我的收藏（完成）"></a>我的收藏（完成）</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/03/ChN7JM9nvoSWVbL.png" alt="image-20240803193755102.png"></p>
<h4 id="纠错（完成）"><a href="#纠错（完成）" class="headerlink" title="纠错（完成）"></a>纠错（完成）</h4><p>纠错当用户发现题目有问题，错误的话，就可以通过这个方式，来进行反馈。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/03/BNAG4PQK8wgXjxV.png" alt="image-20240803193910438.png"></p>
<h4 id="快速刷题（完成）"><a href="#快速刷题（完成）" class="headerlink" title="快速刷题（完成）"></a>快速刷题（完成）</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/03/CzO3mXaAthjT6cF.png" alt="image-20240803193936006.png"></p>
<p>在这个位置去加一个上一题，下一题。</p>
<h4 id="贡献榜（完成）"><a href="#贡献榜（完成）" class="headerlink" title="贡献榜（完成）"></a>贡献榜（完成）</h4><p>按照我的周维度，月维度，来做数据的存储。zset。和 redis 做大量的交互。</p>
<h4 id="feign-的微服务间调用（完成）"><a href="#feign-的微服务间调用（完成）" class="headerlink" title="feign 的微服务间调用（完成）"></a>feign 的微服务间调用（完成）</h4><p>会涉及到微服务之间的逻辑调用。这个就用 feign 了。</p>
<h4 id="打通用户上下文（完成）"><a href="#打通用户上下文（完成）" class="headerlink" title="打通用户上下文（完成）"></a>打通用户上下文（完成）</h4><p>配合 threadlocal，基于 token 来实现用户信息的上下文传递。</p>
<h4 id="二级缓存的使用（完成）"><a href="#二级缓存的使用（完成）" class="headerlink" title="二级缓存的使用（完成）"></a>二级缓存的使用（完成）</h4><p>点赞里面。</p>
<h3 id="用户上下文打通"><a href="#用户上下文打通" class="headerlink" title="用户上下文打通"></a>用户上下文打通</h3><p>链路流程：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/12/jRBZS5OvlwY3xzC.png" alt="image-20240812140358717.png"></p>
<p>详细设计：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/12/6veaby7irSgQWqo.png" alt="image-20240812140516313.png"></p>
<p><code>Loginfilter</code>(实现<code>Globalfilter接口</code>，通过filter拿到token，解析出<strong>loginId</strong>，然后传到后面的过滤链中)</p>
<p>-&gt;<code>LoginInterceptor</code>(实现<code>HandlerInterceptor</code>，检验<strong>loginId</strong>是否存在且非空，如果存在，将其保存到自定义的线程局部变量上下文<code>LoginContextHolder</code>中，通过<code>InheritableThreadLocal</code>来实现)</p>
<p>以上都不拦截doLogin操作</p>
<h4 id="gateway网关自定义拦截header"><a href="#gateway网关自定义拦截header" class="headerlink" title="gateway网关自定义拦截header"></a>gateway网关自定义拦截header</h4><p><code>LoginFilter.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入Spring组件注解，标识这是一个Spring组件</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="comment">// 使用lombok的@Slf4j注解自动为类生成日志对象</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现GlobalFilter接口的filter方法，该方法会在请求被路由之前调用</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// 使用@SneakyThrows注解来避免显式声明异常，简化代码</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取请求和响应对象</span></span><br><span class="line">        <span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest();</span><br><span class="line">        <span class="type">ServerHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> exchange.getResponse();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建请求的构建器，用于修改请求头信息</span></span><br><span class="line">        ServerHttpRequest.<span class="type">Builder</span> <span class="variable">mutate</span> <span class="operator">=</span> request.mutate();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获取请求的URL路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> request.getURI().getPath();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 记录请求的URL到日志</span></span><br><span class="line">        log.info(<span class="string">&quot;LoginFilter.filter.url:&#123;&#125;&quot;</span>, url);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果请求的URL是&quot;/user/doLogin&quot;，则直接放行，不进行拦截</span></span><br><span class="line">        <span class="keyword">if</span> (url.equals(<span class="string">&quot;/user/doLogin&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 尝试获取当前请求的token信息，这里使用了SaToken框架</span></span><br><span class="line">        <span class="type">SaTokenInfo</span> <span class="variable">tokenInfo</span> <span class="operator">=</span> StpUtil.getTokenInfo();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 将token信息记录到日志中，这里使用了Gson库来将对象转换为JSON字符串</span></span><br><span class="line">        log.info(<span class="string">&quot;LoginFilter.filter.url:&#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">Gson</span>().toJson(tokenInfo));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 从token信息中获取登录用户的ID</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">loginId</span> <span class="operator">=</span> (String) tokenInfo.getLoginId();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 将登录用户的ID添加到请求头中</span></span><br><span class="line">        mutate.header(<span class="string">&quot;loginId&quot;</span>, loginId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 将修改后的请求和原始的响应以及过滤器链一起构建成一个新的ServerWebExchange对象</span></span><br><span class="line">        <span class="comment">// 并调用chain.filter方法继续过滤链的执行</span></span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange.mutate().request(mutate.build()).build());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过filter拿到token，解析出loginId，然后传到后面的过滤链中。</p>
<h4 id="基于threadLocal实现上下文传递"><a href="#基于threadLocal实现上下文传递" class="headerlink" title="基于threadLocal实现上下文传递"></a>基于threadLocal实现上下文传递</h4><p>mvc的全局处理：<code>GlobalConfig.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 标记这个类是一个Spring配置类</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalConfig</span> <span class="keyword">extends</span> <span class="title class_">WebMvcConfigurationSupport</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 覆盖configureMessageConverters方法来添加自定义的消息转换器</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configureMessageConverters</span><span class="params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> &#123;</span><br><span class="line">        <span class="comment">// 首先调用父类的configureMessageConverters方法</span></span><br><span class="line">        <span class="built_in">super</span>.configureMessageConverters(converters);</span><br><span class="line">        <span class="comment">// 添加一个MappingJackson2HttpMessageConverter到转换器列表中</span></span><br><span class="line">        converters.add(mappingJackson2HttpMessageConverter());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 覆盖addInterceptors方法来添加自定义的拦截器</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        <span class="comment">// 添加一个自定义的拦截器LoginInterceptor</span></span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">LoginInterceptor</span>())</span><br><span class="line">                <span class="comment">// 拦截所有路径</span></span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/**&quot;</span>)</span><br><span class="line">                <span class="comment">// 排除/user/doLogin路径，不对登录请求进行拦截</span></span><br><span class="line">                .excludePathPatterns(<span class="string">&quot;/user/doLogin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义的MappingJackson2HttpMessageConverter实现</span></span><br><span class="line"><span class="comment">     * 目前实现的功能：</span></span><br><span class="line"><span class="comment">     * - 忽略空值，即使对象的字段为null也不会在JSON中出现</span></span><br><span class="line"><span class="comment">     * - 只序列化非空字段，空字段不会被序列化到JSON中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> MappingJackson2HttpMessageConverter <span class="title function_">mappingJackson2HttpMessageConverter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 创建ObjectMapper实例</span></span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        <span class="comment">// 配置ObjectMapper，当对象的字段为null时不抛出异常</span></span><br><span class="line">        objectMapper.configure(SerializationFeature.FAIL_ON_EMPTY_BEANS, <span class="literal">false</span>);</span><br><span class="line">        <span class="comment">// 设置序列化时包含非空字段</span></span><br><span class="line">        objectMapper.setSerializationInclusion(JsonInclude.Include.NON_NULL);</span><br><span class="line">        <span class="comment">// 创建MappingJackson2HttpMessageConverter并使用自定义的ObjectMapper</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MappingJackson2HttpMessageConverter</span>(objectMapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>登录拦截器：<code>LoginInterceptor.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在请求处理之前执行的方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 从请求头中获取loginId</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">loginId</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;loginId&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 判断loginId是否存在且非空</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(loginId)) &#123;</span><br><span class="line">            <span class="comment">// 如果存在，将其保存到自定义的线程局部变量上下文LoginContextHolder中</span></span><br><span class="line">            LoginContextHolder.set(<span class="string">&quot;loginId&quot;</span>, loginId);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 返回true表示继续执行拦截器链中的下一个拦截器或处理器</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 请求处理完成后执行的方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, <span class="meta">@Nullable</span> Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 从上下文中移除loginId，清理线程局部变量</span></span><br><span class="line">        LoginContextHolder.remove();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>登录上下文对象: <code>LoginContextHolder</code></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/yexiguafu/article/details/103900568?ops_request_misc=%7B%22request_id%22:%22172344903416800207094300%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=172344903416800207094300&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-103900568-null-null.142%5Ev100%5Epc_search_result_base8&utm_term=inheritablethreadlocal&spm=1018.2226.3001.4187">InheritableThreadLocal详解-CSDN博客</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginContextHolder</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用InheritableThreadLocal来创建线程局部变量，允许子线程继承父线程的值</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> InheritableThreadLocal&lt;Map&lt;String, Object&gt;&gt; THREAD_LOCAL =</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InheritableThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将键值对放入线程局部变量中</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(String key, Object val)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = getThreadLocalMap();</span><br><span class="line">        map.put(key, val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据键从线程局部变量中获取值</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">get</span><span class="params">(String key)</span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; threadLocalMap = getThreadLocalMap();</span><br><span class="line">        <span class="keyword">return</span> threadLocalMap.get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 专门用于获取loginId的方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getLoginId</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (String) getThreadLocalMap().get(<span class="string">&quot;loginId&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清除线程局部变量中的所有数据</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">()</span>&#123;</span><br><span class="line">        THREAD_LOCAL.remove();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取线程局部变量中存储的Map，如果Map不存在，则创建一个新的Map</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, Object&gt; <span class="title function_">getThreadLocalMap</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = THREAD_LOCAL.get();</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(map)) &#123;</span><br><span class="line">            map = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;(); <span class="comment">// 使用线程安全的ConcurrentHashMap</span></span><br><span class="line">            THREAD_LOCAL.set(map);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后就可以根据这个上下文，封装一下，去拿loginId</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getLoginId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> LoginContextHolder.getLoginId();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="微服务之间的Feign调用"><a href="#微服务之间的Feign调用" class="headerlink" title="微服务之间的Feign调用"></a>微服务之间的Feign调用</h4><p><strong>微服务之间的调用</strong></p>
<p>openfeign 是 spring cloud 搞出来的一个升级版，netflix 的 feign 这个不维护了。</p>
<p>openfeign 他就是声明式的 webservice 的客户端，使用 feign，编写调用更加的简单，主要打上注解就可以进行一个调用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">responese</span> <span class="operator">=</span> service.hello();</span><br></pre></td></tr></table></figure>

<p>一行代码直接搞定。</p>
<p>feign 就帮助我们把 http 的调用编的非常的容易和方便，他整体的实现就是利用了 resttemplate 对 http 的一个封装。</p>
<p>feign 通过注解的方式配置之后，就可以完成接口的自动绑定，那我们调用 feign 的时候就像调接口一样，内置负载。内部封装了 ribbon。</p>
<p><strong>实操：</strong></p>
<p>首先，微服务之间要暴露出提供给其他服务的接口。在这里以<code>auth</code>包中的接口暴露给<code>subject</code>包的接口为例。</p>
<p><strong>auth:</strong></p>
<p><code>jc-club-auth-api</code>包中的<code>UserFeignService</code>接口，这里注意<code>@FeignClient</code>注解后面的<code>&quot;jc-club-auth-dev&quot;</code>实则是在<code>starter</code>包中对应的<code>bootstrap.yaml</code>中的服务名称（这个东西是注册到nacos上面的）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;jc-club-auth-dev&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserFeignService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用该接口实则是调用的对应的domainService</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/user/getUserInfo&quot;)</span></span><br><span class="line">    Result&lt;AuthUserDTO&gt; <span class="title function_">getUserInfo</span><span class="params">(<span class="meta">@RequestBody</span> AuthUserDTO authUserDTO)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/user/listByIds&quot;)</span></span><br><span class="line">    Result&lt;List&lt;AuthUserDTO&gt;&gt; <span class="title function_">listUserInfoByIds</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;String&gt; userNameList)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对应的domainService</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> AuthUserBO <span class="title function_">getUserInfo</span><span class="params">(AuthUserBO authUserBO)</span> &#123;</span><br><span class="line">    <span class="type">AuthUser</span> <span class="variable">authUser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthUser</span>();</span><br><span class="line">    authUser.setUserName(authUserBO.getUserName());</span><br><span class="line">    List&lt;AuthUser&gt; userList = authUserService.queryByCondition(authUser);</span><br><span class="line">    <span class="keyword">if</span> (CollectionUtils.isEmpty(userList)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AuthUserBO</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">AuthUser</span> <span class="variable">user</span> <span class="operator">=</span> userList.get(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> AuthUserBOConverter.INSTANCE.convertEntityToBO(user);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;AuthUserBO&gt; <span class="title function_">listUserInfoByIds</span><span class="params">(List&lt;String&gt; userNameList)</span> &#123;</span><br><span class="line">    List&lt;AuthUser&gt; userList = authUserService.listUserInfoByIds(userNameList);</span><br><span class="line">    <span class="keyword">if</span> (CollectionUtils.isEmpty(userList)) &#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> AuthUserBOConverter.INSTANCE.convertEntityToBO(userList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在<code>jc-club-auth-application-controller</code>包中的<code>pom.xml</code>文件中，添加对该api包的依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.jingdianjichi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jc-club-auth-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p><strong>subject:</strong></p>
<p>在<code>jc-club-subject</code>的<code>infra</code>包中的<code>pom.xml</code>中添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.jingdianjichi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jc-club-auth-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>jc-club-subject</code>的<code>infra</code>包中添加<code>UserRpc.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserRpc</span> &#123;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//auth-api模块中的UserFeignService接口</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserFeignService userFeignService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> UserInfo <span class="title function_">getUserInfo</span><span class="params">(String userName)</span> &#123;</span><br><span class="line">        <span class="type">AuthUserDTO</span> <span class="variable">authUserDTO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthUserDTO</span>();</span><br><span class="line">        authUserDTO.setUserName(userName);</span><br><span class="line">        <span class="comment">//调用UserFeignService中暴露的接口</span></span><br><span class="line">        Result&lt;AuthUserDTO&gt; result = userFeignService.getUserInfo(authUserDTO);</span><br><span class="line">        <span class="type">UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserInfo</span>();</span><br><span class="line">        <span class="keyword">if</span> (!result.getSuccess()) &#123;</span><br><span class="line">            <span class="keyword">return</span> userInfo;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">AuthUserDTO</span> <span class="variable">data</span> <span class="operator">=</span> result.getData();</span><br><span class="line">        userInfo.setUserName(data.getUserName());</span><br><span class="line">        userInfo.setNickName(data.getNickName());</span><br><span class="line">        userInfo.setAvatar(data.getAvatar());</span><br><span class="line">        <span class="keyword">return</span> userInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进行测试，能拿到userInfo</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/subject/category&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestFeignController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserRpc userRpc;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;testFeign&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFeign</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span> userRpc.getUserInfo(<span class="string">&quot;lzrj&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;testFeign.userInfo:&#123;&#125;&quot;</span>, userInfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>openFeign</code>拦截器实现用户上下文打通</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> feign.RequestInterceptor;</span><br><span class="line"><span class="keyword">import</span> feign.RequestTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将Feign拦截器注册为Spring组件</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignRequestInterceptor</span> <span class="keyword">implements</span> <span class="title class_">RequestInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现apply方法，该方法将在Feign客户端发出请求之前被调用</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(RequestTemplate requestTemplate)</span> &#123;</span><br><span class="line">        <span class="comment">// 从RequestContextHolder获取当前的ServletRequestAttributes</span></span><br><span class="line">        <span class="type">ServletRequestAttributes</span> <span class="variable">requestAttributes</span> <span class="operator">=</span> (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 从ServletRequestAttributes中获取HttpServletRequest对象</span></span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> requestAttributes.getRequest();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查HttpServletRequest是否非空</span></span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(request)) &#123;</span><br><span class="line">            <span class="comment">// 从HttpServletRequest的请求头中获取loginId</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">loginId</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;loginId&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 检查loginId是否非空且非仅包含空白字符</span></span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isNotBlank(loginId)) &#123;</span><br><span class="line">                <span class="comment">// 如果loginId存在，将其添加到Feign请求模板的请求头中</span></span><br><span class="line">                requestTemplate.header(<span class="string">&quot;loginId&quot;</span>, loginId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RequestInterceptor <span class="title function_">requestInterceptor</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FeignRequestInterceptor</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过<code>FeignRequestInterceptor</code>在调用微服务之前，就可以把相关请求的loginId封装到请求中，进行跨微服务的loginId的传递：</p>
<h3 id="guava本地缓存-已经升级成Caffiene"><a href="#guava本地缓存-已经升级成Caffiene" class="headerlink" title="guava本地缓存(已经升级成Caffiene)"></a>guava本地缓存(已经升级成Caffiene)</h3><p>泛型+函数式编程</p>
<p><strong>guava:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.google.common.cache.Cache;</span><br><span class="line"><span class="keyword">import</span> com.google.common.cache.CacheBuilder;</span><br><span class="line"><span class="keyword">import</span> com.google.common.collect.Lists;</span><br><span class="line"><span class="keyword">import</span> com.google.gson.JsonObject;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.CollectionUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将CacheUtil类标记为Spring组件</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheUtil</span>&lt;K, V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用Guava的CacheBuilder构建一个本地缓存</span></span><br><span class="line">    <span class="keyword">private</span> Cache&lt;String, String&gt; localCache =</span><br><span class="line">            CacheBuilder.newBuilder()</span><br><span class="line">                    <span class="comment">// 设置缓存最大容量为5000</span></span><br><span class="line">                    .maximumSize(<span class="number">5000</span>)</span><br><span class="line">                    <span class="comment">// 设置写入后10秒过期</span></span><br><span class="line">                    .expireAfterWrite(<span class="number">10</span>, TimeUnit.SECONDS)</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据缓存键获取缓存结果，如果缓存未命中则调用function获取数据并缓存结果</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;V&gt; <span class="title function_">getResult</span><span class="params">(String cacheKey, Class&lt;V&gt; clazz,</span></span><br><span class="line"><span class="params">                             Function&lt;String, List&lt;V&gt;&gt; function)</span> &#123;</span><br><span class="line">        List&lt;V&gt; resultList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 尝试从缓存中获取内容</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> localCache.getIfPresent(cacheKey);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(content)) &#123;</span><br><span class="line">            <span class="comment">// 如果缓存中有数据，解析JSON字符串到List中</span></span><br><span class="line">            resultList = JSON.parseArray(content, clazz);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果缓存未命中，调用function获取数据</span></span><br><span class="line">            resultList = function.apply(cacheKey);</span><br><span class="line">            <span class="comment">// 如果获取的数据不为空，则将数据序列化为JSON字符串并缓存</span></span><br><span class="line">            <span class="keyword">if</span> (!CollectionUtils.isEmpty(resultList)) &#123;</span><br><span class="line">                localCache.put(cacheKey, JSON.toJSONString(resultList));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resultList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据缓存键获取Map类型的缓存结果，如果缓存未命中则调用function获取数据并缓存结果</span></span><br><span class="line">    <span class="comment">// 注意：此方法的实现目前为空，需要根据具体需求进行实现</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;K, V&gt; <span class="title function_">getMapResult</span><span class="params">(String cacheKey, Class&lt;V&gt; clazz,</span></span><br><span class="line"><span class="params">                                  Function&lt;String, Map&lt;K, V&gt;&gt; function)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这用到了<code>queryCategoryAndLabel</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;SubjectCategoryBO&gt; <span class="title function_">queryCategoryAndLabel</span><span class="params">(SubjectCategoryBO subjectCategoryBO)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> subjectCategoryBO.getId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">cacheKey</span> <span class="operator">=</span> <span class="string">&quot;categoryAndLabel.&quot;</span> + subjectCategoryBO.getId();</span><br><span class="line">    <span class="comment">// 调用本地缓存</span></span><br><span class="line">    List&lt;SubjectCategoryBO&gt; subjectCategoryBOS = cacheUtil.getResult(cacheKey,</span><br><span class="line">            SubjectCategoryBO.class, (key) -&gt; getSubjectCategoryBOS(id)); <span class="comment">//如果本地缓存没有 就调用getSubjectCategoryBOS</span></span><br><span class="line">    <span class="keyword">return</span> subjectCategoryBOS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="全文检索功能"><a href="#全文检索功能" class="headerlink" title="全文检索功能"></a>全文检索功能</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/JENREY/article/details/81290535?ops_request_misc=%7B%22request_id%22:%22172354172816800222897865%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=172354172816800222897865&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-81290535-null-null.142%5Ev100%5Epc_search_result_base8&utm_term=elasticsearch&spm=1018.2226.3001.4187">ElasticSearch从入门到精通，史上最全（持续更新，未完待续，每天一点点）_elasticsearch从入门到精通,史上最全-CSDN博客</a></p>
<h4 id="功能设计"><a href="#功能设计" class="headerlink" title="功能设计"></a>功能设计</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/13/JGn2mjVoUIRkDYg.png" alt="image-20240813172543714.png"></p>
<p>技术选型：elasticsearch。</p>
<p>目的是，网站现在整体的题目预计会到好几百，方便快速的搜索到自己想看的内容。</p>
<p>实现形式：</p>
<ul>
<li><p>同步：新增题目-&gt;MYSQL-&gt;es</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/13/SyGl8MZvtJxaC46.png" alt="image-20240813172750581.png"></p>
</li>
<li><p>异步：mysql 存储完后，发送 mq</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/13/8AlqQE3mfD6evGH.png" alt="image-20240813172810340.png"></p>
</li>
<li><p>异步canal：监听 mysql 变更的 binlog，实现 es 的存储</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/13/zlsu95tIUGHRw7D.png" alt="image-20240813172928624.png"></p>
</li>
</ul>
<h4 id="实际操作"><a href="#实际操作" class="headerlink" title="实际操作"></a>实际操作</h4><p>[通过HTTP的方式操作ES-CSDN博客](<a target="_blank" rel="noopener" href="https://blog.csdn.net/sss294438204/article/details/122884953?ops_request_misc=%7B%22request_id%22:%22172355571716800211536069%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=172355571716800211536069&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-2-122884953-null-null.142%5Ev100%5Epc_search_result_base8&utm_term=es">https://blog.csdn.net/sss294438204/article/details/122884953?ops_request_misc=%7B%22request%5Fid%22%3A%22172355571716800211536069%22%2C%22scm%22%3A%2220140713.130102334..%22%7D&amp;request_id=172355571716800211536069&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-2-122884953-null-null.142^v100^pc_search_result_base8&amp;utm_term=es</a> http&amp;spm&#x3D;1018.2226.3001.4187)</p>
<p>接口：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/13/kIjp4gbOqEHxtJC.png" alt="image-20240813212925046.png"></p>
<h4 id="es分词问题"><a href="#es分词问题" class="headerlink" title="es分词问题"></a>es分词问题</h4><p>原生的不太行，用这个</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.3.1/elasticsearch-analysis-ik-7.3.1.zip</span><br></pre></td></tr></table></figure>

<p>解压后，上传到服务器 的 ik 文件夹下面：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mkdir /soft/ik</span><br><span class="line"></span><br><span class="line">进入容器内部</span><br><span class="line">docker exec -it elasticsearch /bin/bash</span><br><span class="line">cd plugins</span><br><span class="line">mkdir ik</span><br><span class="line"></span><br><span class="line">回到外部</span><br><span class="line">docker cp /soft/ik/. 73438a827b55:/usr/share/elasticsearch/plugins/ik</span><br><span class="line"></span><br><span class="line">重启es</span><br><span class="line">docker restart 73438a827b55</span><br></pre></td></tr></table></figure>

<h4 id="编码-试手"><a href="#编码-试手" class="headerlink" title="编码: 试手"></a>编码: 试手</h4><p><code>subject-infra</code>层<code>pom.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>TestFeignController.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;testCreateIndex&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCreateIndex</span><span class="params">()</span> &#123;</span><br><span class="line">       subjectEsService.createIndex();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@GetMapping(&quot;addDocs&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addDocs</span><span class="params">()</span> &#123;</span><br><span class="line">       subjectEsService.addDoc();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@GetMapping(&quot;find&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">find</span><span class="params">()</span> &#123;</span><br><span class="line">       subjectEsService.find();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@GetMapping(&quot;search&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">search</span><span class="params">()</span> &#123;</span><br><span class="line">       subjectEsService.search();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>实体类：<code>SubjectInfoEs.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Document(indexName = &quot;subject_index&quot;, createIndex = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubjectInfoEs</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Long)</span></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Text, analyzer = &quot;ik_smart&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String subjectName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Text, analyzer = &quot;ik_smart&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String subjectAnswer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Keyword)</span></span><br><span class="line">    <span class="keyword">private</span> String createUser;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Date, index = false)</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SubjectEsRepository.java</code>，继承自<code>ElasticsearchRepository</code>。这个接口是Spring Data Elasticsearch的一部分，用于提供对Elasticsearch的访问和操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SubjectEsRepository</span> <span class="keyword">extends</span> <span class="title class_">ElasticsearchRepository</span>&lt;SubjectInfoEs, Long&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SubjectEsService.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SubjectEsService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createIndex</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addDoc</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">find</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">search</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SubjectEsServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubjectEsServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">SubjectEsService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ElasticsearchRestTemplate elasticsearchRestTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SubjectEsRepository subjectEsRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createIndex</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">IndexOperations</span> <span class="variable">indexOperations</span> <span class="operator">=</span></span><br><span class="line">                elasticsearchRestTemplate.indexOps(SubjectInfoEs.class);</span><br><span class="line">        indexOperations.create();</span><br><span class="line">        <span class="type">Document</span> <span class="variable">mapping</span> <span class="operator">=</span> indexOperations.createMapping(SubjectInfoEs.class);</span><br><span class="line">        indexOperations.putMapping(mapping);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addDoc</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;SubjectInfoEs&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        list.add(<span class="keyword">new</span> <span class="title class_">SubjectInfoEs</span>(<span class="number">1L</span>,<span class="string">&quot;redis是什么&quot;</span>,<span class="string">&quot;redis是一个缓存&quot;</span>,<span class="string">&quot;鸡翅&quot;</span>,<span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line">        list.add(<span class="keyword">new</span> <span class="title class_">SubjectInfoEs</span>(<span class="number">2L</span>,<span class="string">&quot;mysql是什么&quot;</span>,<span class="string">&quot;mysql是数据库&quot;</span>,<span class="string">&quot;鸡翅&quot;</span>,<span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line">        subjectEsRepository.saveAll(list);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">find</span><span class="params">()</span> &#123;</span><br><span class="line">        Iterable&lt;SubjectInfoEs&gt; all = subjectEsRepository.findAll();</span><br><span class="line">        <span class="keyword">for</span> (SubjectInfoEs subjectInfoEs : all)&#123;</span><br><span class="line">            log.info(<span class="string">&quot;subjectInfoEs:&#123;&#125;&quot;</span>,JSON.toJSONString(subjectInfoEs));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">search</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">NativeSearchQuery</span> <span class="variable">nativeSearchQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NativeSearchQueryBuilder</span>()</span><br><span class="line">                .withQuery(QueryBuilders.matchQuery(<span class="string">&quot;subjectName&quot;</span>,<span class="string">&quot;redis&quot;</span>))</span><br><span class="line">                .build();</span><br><span class="line">        SearchHits&lt;SubjectInfoEs&gt; search = elasticsearchRestTemplate.</span><br><span class="line">                search(nativeSearchQuery, SubjectInfoEs.class);</span><br><span class="line">        List&lt;SearchHit&lt;SubjectInfoEs&gt;&gt; searchHits = search.getSearchHits();</span><br><span class="line">        log.info(<span class="string">&quot;searchHits:&#123;&#125;&quot;</span>, JSON.toJSONString(searchHits));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>subject-starter</code>中的<code>application.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">elasticsearch:</span></span><br><span class="line"> <span class="attr">rest:</span></span><br><span class="line">  <span class="string">uris:http://172.72.14.166:9200</span></span><br></pre></td></tr></table></figure>

<h4 id="编码：自定义封装es集群连接统一管理"><a href="#编码：自定义封装es集群连接统一管理" class="headerlink" title="编码：自定义封装es集群连接统一管理"></a>编码：自定义封装es集群连接统一管理</h4><p>希望的一个目的</p>
<ol>
<li>有自己的封装好的工具</li>
<li>集群，索引等等都要兼容的配置的概念</li>
<li>不想用 data 的这种方式，不够扩展</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/14/IyEW14MJOe8gP9w.png" alt="image-20240814112513230.png"></p>
<p>配置类：读取配置文件自定义的属性，支持集群，节点等等一些信息</p>
<ol>
<li>@Configuration + @ConfigurationProperties + @Data（必须提供set方法）</li>
<li>@Configuration +  @Value</li>
</ol>
<p>集群类：集群的名称、集群的节点</p>
<p>索引类：集群名称、索引名称</p>
<p>封装的请求类：查询条件、查询字段、页数、条数、快照、快照缓存时间、排序字段、排序类型、高亮</p>
<p>封装的返回类：文档id（保证唯一）、所有跟restClient交互的封装成一个Map</p>
<p>自定义工具类：目的就是为了提供一个RestHighLevelClient，在原生client的基础上封装一些好用的api</p>
<p>整体基于 es 的原生的 client 来去做。</p>
<p><code>subject-infra</code>层<code>pom.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>es集群类<code>EsClusterConfig.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EsClusterConfig</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 集群名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 集群节点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String nodes;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>EsConfigProperties.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;es.cluster&quot;)</span> <span class="comment">//这部分是跟application.yaml中的对应</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EsConfigProperties</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;EsClusterConfig&gt; esConfigs = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;EsClusterConfig&gt; <span class="title function_">getEsConfigs</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> esConfigs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEsConfigs</span><span class="params">(List&lt;EsClusterConfig&gt; esConfigs)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.esConfigs = esConfigs;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>subject-starter</code>中的<code>application.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">es:</span></span><br><span class="line">  <span class="attr">cluster:</span></span><br><span class="line">    <span class="string">esConfigs[0]:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">73438a827b55</span></span><br><span class="line">      <span class="attr">nodes:</span> <span class="number">117.72</span><span class="number">.14</span><span class="number">.166</span><span class="string">:9200</span></span><br></pre></td></tr></table></figure>

<p><code>EsIndexInfo.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EsIndexInfo</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 集群名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String clusterName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 索引名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String indexName;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>EsSearchRequest.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EsSearchRequest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询条件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> BoolQueryBuilder bq;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询字段</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String[] fields;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 页数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> from;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 条数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 需要快照</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Boolean needScroll;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 快照缓存时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long minutes;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 排序字段</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String sortName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 排序类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> SortOrder sortOrder;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 高亮builder</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> HighlightBuilder highlightBuilder;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>EsSourceData.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EsSourceData</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String docId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; data;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>EsRestClient.java</code></p>
<p>这个类封装了与Elasticsearch集群交互的常见操作</p>
<ol>
<li><strong>类定义和日志记录</strong>：使用<code>@Component</code>注解表明这是一个Spring组件，使用<code>@Slf4j</code>来引入日志记录功能。</li>
<li><strong>客户端映射</strong>：<code>clientMap</code>是一个静态的<code>HashMap</code>，用于存储不同Elasticsearch集群的<code>RestHighLevelClient</code>实例。</li>
<li><strong>配置属性注入</strong>：通过<code>@Resource</code>注解注入<code>EsConfigProperties</code>，这是一个配置属性类，用于获取Elasticsearch集群的配置信息。</li>
<li><strong>请求选项</strong>：定义了一个静态的<code>RequestOptions</code>对象<code>COMMON_OPTIONS</code>，用于后续的请求。</li>
<li><strong>初始化方法</strong>：<code>initialize</code>方法在组件初始化时被调用，用于根据配置创建和初始化<code>RestHighLevelClient</code>实例。</li>
<li><strong>创建客户端方法</strong>：<code>initRestClient</code>是一个私有方法，用于根据给定的集群配置创建<code>RestHighLevelClient</code>实例。</li>
<li><strong>获取客户端方法</strong>：<code>getClient</code>是一个静态方法，用于根据集群名称获取对应的<code>RestHighLevelClient</code>实例。</li>
<li><strong>文档操作</strong>：类中定义了一系列的静态方法，用于执行Elasticsearch中的文档操作，如插入(<code>insertDoc</code>)、更新(<code>updateDoc</code>)、批量更新(<code>batchUpdateDoc</code>)、删除(<code>delete</code>和<code>deleteDoc</code>)、检查文档是否存在(<code>isExistDocById</code>)、获取文档(<code>getDocById</code>)等。</li>
<li><strong>搜索功能</strong>：<code>searchWithTermQuery</code>方法用于执行基于布尔查询构建器的搜索请求，并支持高亮显示、排序和滚动(scroll)。</li>
<li><strong>批量插入</strong>：<code>batchInsertDoc</code>方法用于批量插入文档。</li>
<li><strong>更新查询</strong>：<code>updateByQuery</code>方法允许执行基于查询的更新操作。</li>
<li><strong>分词功能</strong>：<code>getAnalyze</code>方法提供了一个分词功能，可以对输入的文本进行分词。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EsRestClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, RestHighLevelClient&gt; clientMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> EsConfigProperties esConfigProperties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> RequestOptions COMMON_OPTIONS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        RequestOptions.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> RequestOptions.DEFAULT.toBuilder();</span><br><span class="line">        COMMON_OPTIONS = builder.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;EsClusterConfig&gt; esConfigs = esConfigProperties.getEsConfigs();</span><br><span class="line">        <span class="keyword">for</span> (EsClusterConfig esConfig : esConfigs) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;initialize.config.name:&#123;&#125;,node:&#123;&#125;&quot;</span>, esConfig.getName(), esConfig.getNodes());</span><br><span class="line">            <span class="type">RestHighLevelClient</span> <span class="variable">restHighLevelClient</span> <span class="operator">=</span> initRestClient(esConfig);</span><br><span class="line">            <span class="keyword">if</span> (restHighLevelClient != <span class="literal">null</span>) &#123;</span><br><span class="line">                clientMap.put(esConfig.getName(), restHighLevelClient);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.error(<span class="string">&quot;config.name:&#123;&#125;,node:&#123;&#125;.initError&quot;</span>, esConfig.getName(), esConfig.getNodes());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient <span class="title function_">initRestClient</span><span class="params">(EsClusterConfig esClusterConfig)</span> &#123;</span><br><span class="line">        String[] ipPortArr = esClusterConfig.getNodes().split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        List&lt;HttpHost&gt; httpHostList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(ipPortArr.length);</span><br><span class="line">        <span class="keyword">for</span> (String ipPort : ipPortArr) &#123;</span><br><span class="line">            String[] ipPortInfo = ipPort.split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (ipPortInfo.length == <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="type">HttpHost</span> <span class="variable">httpHost</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHost</span>(ipPortInfo[<span class="number">0</span>], NumberUtils.toInt(ipPortInfo[<span class="number">1</span>]));</span><br><span class="line">                httpHostList.add(httpHost);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        HttpHost[] httpHosts = <span class="keyword">new</span> <span class="title class_">HttpHost</span>[httpHostList.size()];</span><br><span class="line">        httpHostList.toArray(httpHosts);</span><br><span class="line"></span><br><span class="line">        <span class="type">RestClientBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> RestClient.builder(httpHosts);</span><br><span class="line">        <span class="type">RestHighLevelClient</span> <span class="variable">restHighLevelClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(builder);</span><br><span class="line">        <span class="keyword">return</span> restHighLevelClient;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//返回集群名称对应的RestHighLevelClient</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> RestHighLevelClient <span class="title function_">getClient</span><span class="params">(String clusterName)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> clientMap.get(clusterName);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//新增文档</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">insertDoc</span><span class="params">(EsIndexInfo esIndexInfo, EsSourceData esSourceData)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">IndexRequest</span> <span class="variable">indexRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexRequest</span>(esIndexInfo.getIndexName());</span><br><span class="line">            indexRequest.source(esSourceData.getData());</span><br><span class="line">            indexRequest.id(esSourceData.getDocId());</span><br><span class="line">            getClient(esIndexInfo.getClusterName()).index(indexRequest, COMMON_OPTIONS);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;insertDoc.exception:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">updateDoc</span><span class="params">(EsIndexInfo esIndexInfo, EsSourceData esSourceData)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">UpdateRequest</span> <span class="variable">updateRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UpdateRequest</span>();</span><br><span class="line">            updateRequest.index(esIndexInfo.getIndexName());</span><br><span class="line">            updateRequest.id(esSourceData.getDocId());</span><br><span class="line">            updateRequest.doc(esSourceData.getData());</span><br><span class="line">            getClient(esIndexInfo.getClusterName()).update(updateRequest, COMMON_OPTIONS);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;updateDoc.exception:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">batchUpdateDoc</span><span class="params">(EsIndexInfo esIndexInfo,</span></span><br><span class="line"><span class="params">                                         List&lt;EsSourceData&gt; esSourceDataList)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="type">BulkRequest</span> <span class="variable">bulkRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BulkRequest</span>();</span><br><span class="line">            <span class="keyword">for</span> (EsSourceData esSourceData : esSourceDataList) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">docId</span> <span class="operator">=</span> esSourceData.getDocId();</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.isNotBlank(docId)) &#123;</span><br><span class="line">                    <span class="type">UpdateRequest</span> <span class="variable">updateRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UpdateRequest</span>();</span><br><span class="line">                    updateRequest.index(esIndexInfo.getIndexName());</span><br><span class="line">                    updateRequest.id(esSourceData.getDocId());</span><br><span class="line">                    updateRequest.doc(esSourceData.getData());</span><br><span class="line">                    bulkRequest.add(updateRequest);</span><br><span class="line">                    flag = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">                <span class="type">BulkResponse</span> <span class="variable">bulk</span> <span class="operator">=</span> getClient(esIndexInfo.getClusterName()).bulk(bulkRequest, COMMON_OPTIONS);</span><br><span class="line">                <span class="keyword">if</span> (bulk.hasFailures()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;batchUpdateDoc.exception:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">delete</span><span class="params">(EsIndexInfo esIndexInfo)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">DeleteByQueryRequest</span> <span class="variable">deleteByQueryRequest</span> <span class="operator">=</span></span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">DeleteByQueryRequest</span>(esIndexInfo.getIndexName());</span><br><span class="line">            deleteByQueryRequest.setQuery(QueryBuilders.matchAllQuery());</span><br><span class="line">            <span class="type">BulkByScrollResponse</span> <span class="variable">response</span> <span class="operator">=</span> getClient(esIndexInfo.getClusterName()).deleteByQuery(</span><br><span class="line">                    deleteByQueryRequest, COMMON_OPTIONS</span><br><span class="line">            );</span><br><span class="line">            <span class="type">long</span> <span class="variable">deleted</span> <span class="operator">=</span> response.getDeleted();</span><br><span class="line">            log.info(<span class="string">&quot;deleted.size:&#123;&#125;&quot;</span>, deleted);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;delete.exception:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">deleteDoc</span><span class="params">(EsIndexInfo esIndexInfo, String docId)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">DeleteRequest</span> <span class="variable">deleteRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeleteRequest</span>(esIndexInfo.getIndexName());</span><br><span class="line">            deleteRequest.id(docId);</span><br><span class="line">            <span class="type">DeleteResponse</span> <span class="variable">response</span> <span class="operator">=</span> getClient(esIndexInfo.getClusterName()).delete(deleteRequest, COMMON_OPTIONS);</span><br><span class="line">            log.info(<span class="string">&quot;deleteDoc.response:&#123;&#125;&quot;</span>, JSON.toJSONString(response));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;deleteDoc.exception:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isExistDocById</span><span class="params">(EsIndexInfo esIndexInfo, String docId)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">GetRequest</span> <span class="variable">getRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetRequest</span>(esIndexInfo.getIndexName());</span><br><span class="line">            getRequest.id(docId);</span><br><span class="line">            <span class="keyword">return</span> getClient(esIndexInfo.getClusterName()).exists(getRequest, COMMON_OPTIONS);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;isExistDocById.exception:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, Object&gt; <span class="title function_">getDocById</span><span class="params">(EsIndexInfo esIndexInfo, String docId)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">GetRequest</span> <span class="variable">getRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetRequest</span>(esIndexInfo.getIndexName());</span><br><span class="line">            getRequest.id(docId);</span><br><span class="line">            <span class="type">GetResponse</span> <span class="variable">response</span> <span class="operator">=</span> getClient(esIndexInfo.getClusterName()).get(getRequest, COMMON_OPTIONS);</span><br><span class="line">            Map&lt;String, Object&gt; source = response.getSource();</span><br><span class="line">            <span class="keyword">return</span> source;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;isExistDocById.exception:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, Object&gt; <span class="title function_">getDocById</span><span class="params">(EsIndexInfo esIndexInfo, String docId,</span></span><br><span class="line"><span class="params">                                                 String[] fields)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">GetRequest</span> <span class="variable">getRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetRequest</span>(esIndexInfo.getIndexName());</span><br><span class="line">            getRequest.id(docId);</span><br><span class="line">            <span class="type">FetchSourceContext</span> <span class="variable">fetchSourceContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FetchSourceContext</span>(<span class="literal">true</span>, fields, <span class="literal">null</span>);</span><br><span class="line">            getRequest.fetchSourceContext(fetchSourceContext);</span><br><span class="line">            <span class="type">GetResponse</span> <span class="variable">response</span> <span class="operator">=</span> getClient(esIndexInfo.getClusterName()).get(getRequest, COMMON_OPTIONS);</span><br><span class="line">            Map&lt;String, Object&gt; source = response.getSource();</span><br><span class="line">            <span class="keyword">return</span> source;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;isExistDocById.exception:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//执行Elasticsearch搜索，支持复杂的查询条件、字段选择、高亮显示、排序和滚动搜索。</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SearchResponse <span class="title function_">searchWithTermQuery</span><span class="params">(EsIndexInfo esIndexInfo,</span></span><br><span class="line"><span class="params">                                                     EsSearchRequest esSearchRequest)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">BoolQueryBuilder</span> <span class="variable">bq</span> <span class="operator">=</span> esSearchRequest.getBq();</span><br><span class="line">            String[] fields = esSearchRequest.getFields();</span><br><span class="line">            <span class="type">int</span> <span class="variable">from</span> <span class="operator">=</span> esSearchRequest.getFrom();</span><br><span class="line">            <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> esSearchRequest.getSize();</span><br><span class="line">            <span class="type">Long</span> <span class="variable">minutes</span> <span class="operator">=</span> esSearchRequest.getMinutes();</span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">needScroll</span> <span class="operator">=</span> esSearchRequest.getNeedScroll();</span><br><span class="line">            <span class="type">String</span> <span class="variable">sortName</span> <span class="operator">=</span> esSearchRequest.getSortName();</span><br><span class="line">            <span class="type">SortOrder</span> <span class="variable">sortOrder</span> <span class="operator">=</span> esSearchRequest.getSortOrder();</span><br><span class="line"></span><br><span class="line">            <span class="type">SearchSourceBuilder</span> <span class="variable">searchSourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">            searchSourceBuilder.query(bq);</span><br><span class="line">            searchSourceBuilder.fetchSource(fields, <span class="literal">null</span>).from(from).size(size);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (Objects.nonNull(esSearchRequest.getHighlightBuilder())) &#123;</span><br><span class="line">                searchSourceBuilder.highlighter(esSearchRequest.getHighlightBuilder());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isNotBlank(sortName)) &#123;</span><br><span class="line">                searchSourceBuilder.sort(sortName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            searchSourceBuilder.sort(<span class="keyword">new</span> <span class="title class_">ScoreSortBuilder</span>().order(SortOrder.DESC));</span><br><span class="line"></span><br><span class="line">            <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>();</span><br><span class="line">            searchRequest.searchType(SearchType.DEFAULT);</span><br><span class="line">            searchRequest.indices(esIndexInfo.getIndexName());</span><br><span class="line">            searchRequest.source(searchSourceBuilder);</span><br><span class="line">            <span class="keyword">if</span> (needScroll) &#123;</span><br><span class="line">                <span class="type">Scroll</span> <span class="variable">scroll</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scroll</span>(TimeValue.timeValueMinutes(minutes));</span><br><span class="line">                searchRequest.scroll(scroll);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">SearchResponse</span> <span class="variable">search</span> <span class="operator">=</span> getClient(esIndexInfo.getClusterName()).search(searchRequest, COMMON_OPTIONS);</span><br><span class="line">            <span class="keyword">return</span> search;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;searchWithTermQuery.exception:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">batchInsertDoc</span><span class="params">(EsIndexInfo esIndexInfo, List&lt;EsSourceData&gt; esSourceDataList)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;批量新增ES:&quot;</span> + esSourceDataList.size());</span><br><span class="line">            log.info(<span class="string">&quot;indexName:&quot;</span> + esIndexInfo.getIndexName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="type">BulkRequest</span> <span class="variable">bulkRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BulkRequest</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (EsSourceData source : esSourceDataList) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">docId</span> <span class="operator">=</span> source.getDocId();</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.isNotBlank(docId)) &#123;</span><br><span class="line">                    <span class="type">IndexRequest</span> <span class="variable">indexRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexRequest</span>(esIndexInfo.getIndexName());</span><br><span class="line">                    indexRequest.id(docId);</span><br><span class="line">                    indexRequest.source(source.getData());</span><br><span class="line">                    bulkRequest.add(indexRequest);</span><br><span class="line">                    flag = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">                <span class="type">BulkResponse</span> <span class="variable">response</span> <span class="operator">=</span> getClient(esIndexInfo.getClusterName()).bulk(bulkRequest, COMMON_OPTIONS);</span><br><span class="line">                <span class="keyword">if</span> (response.hasFailures()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;batchInsertDoc.error&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">updateByQuery</span><span class="params">(EsIndexInfo esIndexInfo, QueryBuilder queryBuilder, Script script, <span class="type">int</span> batchSize)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;updateByQuery.indexName:&quot;</span> + esIndexInfo.getIndexName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">UpdateByQueryRequest</span> <span class="variable">updateByQueryRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UpdateByQueryRequest</span>(esIndexInfo.getIndexName());</span><br><span class="line">            updateByQueryRequest.setQuery(queryBuilder);</span><br><span class="line">            updateByQueryRequest.setScript(script);</span><br><span class="line">            updateByQueryRequest.setBatchSize(batchSize);</span><br><span class="line">            updateByQueryRequest.setAbortOnVersionConflict(<span class="literal">false</span>);</span><br><span class="line">            <span class="type">BulkByScrollResponse</span> <span class="variable">response</span> <span class="operator">=</span> getClient(esIndexInfo.getClusterName()).updateByQuery(updateByQueryRequest, RequestOptions.DEFAULT);</span><br><span class="line">            List&lt;BulkItemResponse.Failure&gt; failures = response.getBulkFailures();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;updateByQuery.error&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分词方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title function_">getAnalyze</span><span class="params">(EsIndexInfo esIndexInfo, String text)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;_analyze&quot;</span>);</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">entity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        entity.put(<span class="string">&quot;analyzer&quot;</span>, <span class="string">&quot;ik_smart&quot;</span>);</span><br><span class="line">        entity.put(<span class="string">&quot;text&quot;</span>, text);</span><br><span class="line">        request.setJsonEntity(entity.toJSONString());</span><br><span class="line">        <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> getClient(esIndexInfo.getClusterName()).getLowLevelClient().performRequest(request);</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">tokens</span> <span class="operator">=</span> JSONObject.parseObject(EntityUtils.toString(response.getEntity()));</span><br><span class="line">        <span class="type">JSONArray</span> <span class="variable">arrays</span> <span class="operator">=</span> tokens.getJSONArray(<span class="string">&quot;tokens&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; arrays.size(); i++) &#123;</span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">obj</span> <span class="operator">=</span> JSON.parseObject(arrays.getString(i));</span><br><span class="line">            list.add(obj.getString(<span class="string">&quot;token&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="新增题目同步到es-带高亮的网站全文搜索"><a href="#新增题目同步到es-带高亮的网站全文搜索" class="headerlink" title="新增题目同步到es+带高亮的网站全文搜索"></a>新增题目同步到es+带高亮的网站全文搜索</h4><p><code>subject-infra</code>的<code>SubjectInfoEs.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubjectInfoEs</span> <span class="keyword">extends</span> <span class="title class_">PageInfo</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long subjectId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long docId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String subjectName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String subjectAnswer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String createUser;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long createTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer subjectType;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String keyWord;</span><br><span class="line">	<span class="comment">//相关性的分数，搜索的结果</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal score;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>subject-infra</code>的<code>EsSubjectFields.java</code></p>
<p>负责与Elasticsearch（ES）的交互，包括数据的插入和查询。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EsSubjectFields</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DOC_ID</span> <span class="operator">=</span> <span class="string">&quot;doc_id&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SUBJECT_ID</span> <span class="operator">=</span> <span class="string">&quot;subject_id&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SUBJECT_NAME</span> <span class="operator">=</span> <span class="string">&quot;subject_name&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SUBJECT_ANSWER</span> <span class="operator">=</span> <span class="string">&quot;subject_answer&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SUBJECT_TYPE</span> <span class="operator">=</span> <span class="string">&quot;subject_type&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CREATE_USER</span> <span class="operator">=</span> <span class="string">&quot;create_user&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CREATE_TIME</span> <span class="operator">=</span> <span class="string">&quot;create_time&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] FIELD_QUERY = &#123;</span><br><span class="line">            SUBJECT_ID, SUBJECT_NAME, SUBJECT_ANSWER, SUBJECT_TYPE, DOC_ID, CREATE_USER, CREATE_TIME</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>subject-infra</code>的<code>SubjectEsService.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SubjectEsService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">insert</span><span class="params">(SubjectInfoEs subjectInfoEs)</span>;</span><br><span class="line">	<span class="comment">//做一个分页的</span></span><br><span class="line">    PageResult&lt;SubjectInfoEs&gt; <span class="title function_">querySubjectList</span><span class="params">(SubjectInfoEs subjectInfoEs)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SubjectEsServiceImpl.java</code></p>
<ol>
<li><strong>插入方法</strong>：<code>insert</code>方法实现了将<code>SubjectInfoEs</code>对象转换为ES的文档并插入到ES中。它首先调用<code>convert2EsSourceData</code>方法将<code>SubjectInfoEs</code>对象转换为ES的源数据格式，然后使用<code>EsRestClient</code>的<code>insertDoc</code>方法执行插入操作。</li>
<li><strong>转换方法</strong>：<code>convert2EsSourceData</code>是一个私有方法，用于将<code>SubjectInfoEs</code>对象的属性转换为一个Map，这个Map将作为ES文档的数据部分。</li>
<li><strong>查询方法</strong>：<code>querySubjectList</code>方法实现了分页查询ES中的数据。它首先创建一个<code>EsSearchRequest</code>查询请求，然后使用<code>EsRestClient</code>的<code>searchWithTermQuery</code>方法执行查询，并将结果转换为<code>PageResult&lt;SubjectInfoEs&gt;</code>对象。</li>
<li><strong>结果转换方法</strong>：<code>convertResult</code>是一个私有方法，用于将ES查询结果的<code>SearchHit</code>转换为<code>SubjectInfoEs</code>对象。它还处理了高亮显示查询关键字的功能。</li>
<li><strong>查询构建方法</strong>：<code>createSearchListQuery</code>是一个私有方法，用于构建查询请求。它使用<code>BoolQueryBuilder</code>来构建查询条件，并设置了高亮显示的配置。</li>
<li><strong>获取ES索引信息方法</strong>：<code>getEsIndexInfo</code>是一个私有方法，用于获取ES的索引信息，包括集群名称和索引名称。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubjectEsServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">SubjectEsService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">insert</span><span class="params">(SubjectInfoEs subjectInfoEs)</span> &#123;</span><br><span class="line">        <span class="type">EsSourceData</span> <span class="variable">esSourceData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EsSourceData</span>();</span><br><span class="line">        Map&lt;String, Object&gt; data = convert2EsSourceData(subjectInfoEs);</span><br><span class="line">        esSourceData.setDocId(subjectInfoEs.getDocId().toString());</span><br><span class="line">        esSourceData.setData(data);</span><br><span class="line">        <span class="keyword">return</span> EsRestClient.insertDoc(getEsIndexInfo(), esSourceData);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; <span class="title function_">convert2EsSourceData</span><span class="params">(SubjectInfoEs subjectInfoEs)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; data = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        data.put(EsSubjectFields.SUBJECT_ID, subjectInfoEs.getSubjectId());</span><br><span class="line">        data.put(EsSubjectFields.DOC_ID, subjectInfoEs.getDocId());</span><br><span class="line">        data.put(EsSubjectFields.SUBJECT_NAME, subjectInfoEs.getSubjectName());</span><br><span class="line">        data.put(EsSubjectFields.SUBJECT_ANSWER, subjectInfoEs.getSubjectAnswer());</span><br><span class="line">        data.put(EsSubjectFields.SUBJECT_TYPE, subjectInfoEs.getSubjectType());</span><br><span class="line">        data.put(EsSubjectFields.CREATE_USER, subjectInfoEs.getCreateUser());</span><br><span class="line">        data.put(EsSubjectFields.CREATE_TIME, subjectInfoEs.getCreateTime());</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//带高亮的网站全文搜索</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PageResult&lt;SubjectInfoEs&gt; <span class="title function_">querySubjectList</span><span class="params">(SubjectInfoEs req)</span> &#123;</span><br><span class="line">        PageResult&lt;SubjectInfoEs&gt; pageResult = <span class="keyword">new</span> <span class="title class_">PageResult</span>&lt;&gt;();</span><br><span class="line">        <span class="type">EsSearchRequest</span> <span class="variable">esSearchRequest</span> <span class="operator">=</span> createSearchListQuery(req);</span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> EsRestClient.searchWithTermQuery(getEsIndexInfo(), esSearchRequest);</span><br><span class="line"></span><br><span class="line">        List&lt;SubjectInfoEs&gt; subjectInfoEsList = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">SearchHits</span> <span class="variable">searchHits</span> <span class="operator">=</span> searchResponse.getHits();</span><br><span class="line">        <span class="keyword">if</span> (searchHits == <span class="literal">null</span> || searchHits.getHits() == <span class="literal">null</span>) &#123;</span><br><span class="line">            pageResult.setPageNo(req.getPageNo());</span><br><span class="line">            pageResult.setPageSize(req.getPageSize());</span><br><span class="line">            pageResult.setRecords(subjectInfoEsList);</span><br><span class="line">            pageResult.setTotal(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span> pageResult;</span><br><span class="line">        &#125;</span><br><span class="line">        SearchHit[] hits = searchHits.getHits();</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">            <span class="type">SubjectInfoEs</span> <span class="variable">subjectInfoEs</span> <span class="operator">=</span> convertResult(hit);</span><br><span class="line">            <span class="keyword">if</span> (Objects.nonNull(subjectInfoEs)) &#123;</span><br><span class="line">                subjectInfoEsList.add(subjectInfoEs);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        pageResult.setPageNo(req.getPageNo());</span><br><span class="line">        pageResult.setPageSize(req.getPageSize());</span><br><span class="line">        pageResult.setRecords(subjectInfoEsList);</span><br><span class="line">        pageResult.setTotal(Long.valueOf(searchHits.getTotalHits().value).intValue());</span><br><span class="line">        <span class="keyword">return</span> pageResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将Elasticsearch搜索结果的SearchHit对象转换为SubjectInfoEs对象。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> hit Elasticsearch返回的搜索结果条目。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 转换后的SubjectInfoEs对象，如果结果为空则返回null。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> SubjectInfoEs <span class="title function_">convertResult</span><span class="params">(SearchHit hit)</span> &#123;</span><br><span class="line">    <span class="comment">// 获取搜索结果的源数据映射。</span></span><br><span class="line">    Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">    <span class="comment">// 如果源数据映射为空，则返回null。</span></span><br><span class="line">    <span class="keyword">if</span> (CollectionUtils.isEmpty(sourceAsMap)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建SubjectInfoEs对象用于存储转换结果。</span></span><br><span class="line">    <span class="type">SubjectInfoEs</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubjectInfoEs</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 从源数据映射中获取题目ID，并设置到result对象。</span></span><br><span class="line">    result.setSubjectId(MapUtils.getLong(sourceAsMap, EsSubjectFields.SUBJECT_ID));</span><br><span class="line">    <span class="comment">// 从源数据映射中获取题目名称，并设置到result对象。</span></span><br><span class="line">    result.setSubjectName(MapUtils.getString(sourceAsMap, EsSubjectFields.SUBJECT_NAME));</span><br><span class="line">    <span class="comment">// 从源数据映射中获取题目答案，并设置到result对象。</span></span><br><span class="line">    result.setSubjectAnswer(MapUtils.getString(sourceAsMap, EsSubjectFields.SUBJECT_ANSWER));</span><br><span class="line">    <span class="comment">// 从源数据映射中获取文档ID，并设置到result对象。</span></span><br><span class="line">    result.setDocId(MapUtils.getLong(sourceAsMap, EsSubjectFields.DOC_ID));</span><br><span class="line">    <span class="comment">// 从源数据映射中获取题目类型，并设置到result对象。</span></span><br><span class="line">    result.setSubjectType(MapUtils.getInteger(sourceAsMap, EsSubjectFields.SUBJECT_TYPE));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取搜索结果的相关性分数，并转换为百分比形式，设置到result对象。</span></span><br><span class="line">    result.setScore(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(String.valueOf(hit.getScore()))</span><br><span class="line">            .multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;100.00&quot;</span>).setScale(<span class="number">2</span>, RoundingMode.HALF_UP)));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取高亮字段，处理题目名称的高亮显示。</span></span><br><span class="line">    Map&lt;String, HighlightField&gt; highlightFields = hit.getHighlightFields();</span><br><span class="line">    <span class="type">HighlightField</span> <span class="variable">subjectNameField</span> <span class="operator">=</span> highlightFields.get(EsSubjectFields.SUBJECT_NAME);</span><br><span class="line">    <span class="keyword">if</span> (Objects.nonNull(subjectNameField)) &#123;</span><br><span class="line">        <span class="comment">// 获取题目名称的高亮片段。</span></span><br><span class="line">        Text[] fragments = subjectNameField.getFragments();</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">subjectNameBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (Text fragment : fragments) &#123;</span><br><span class="line">            <span class="comment">// 拼接高亮片段。</span></span><br><span class="line">            subjectNameBuilder.append(fragment);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置处理后的高亮题目名称。</span></span><br><span class="line">        result.setSubjectName(subjectNameBuilder.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理题目答案的高亮显示。</span></span><br><span class="line">    <span class="type">HighlightField</span> <span class="variable">subjectAnswerField</span> <span class="operator">=</span> highlightFields.get(EsSubjectFields.SUBJECT_ANSWER);</span><br><span class="line">    <span class="keyword">if</span> (Objects.nonNull(subjectAnswerField)) &#123;</span><br><span class="line">        Text[] fragments = subjectAnswerField.getFragments();</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">subjectAnswerBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (Text fragment : fragments) &#123;</span><br><span class="line">            subjectAnswerBuilder.append(fragment);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置处理后的高亮题目答案。</span></span><br><span class="line">        result.setSubjectAnswer(subjectAnswerBuilder.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回填充好的SubjectInfoEs对象。</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建一个用于查询题目列表的EsSearchRequest对象。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> req 包含查询条件的SubjectInfoEs对象。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 配置好的EsSearchRequest对象。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> EsSearchRequest <span class="title function_">createSearchListQuery</span><span class="params">(SubjectInfoEs req)</span> &#123;</span><br><span class="line">    <span class="comment">// 创建EsSearchRequest对象用于存储搜索请求的配置。</span></span><br><span class="line">    <span class="type">EsSearchRequest</span> <span class="variable">esSearchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EsSearchRequest</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建一个布尔查询构造器，用于组合多个查询条件。</span></span><br><span class="line">    <span class="type">BoolQueryBuilder</span> <span class="variable">bq</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BoolQueryBuilder</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建一个匹配查询构造器，用于匹配题目名称字段。</span></span><br><span class="line">    <span class="type">MatchQueryBuilder</span> <span class="variable">subjectNameQueryBuilder</span> <span class="operator">=</span></span><br><span class="line">            QueryBuilders.matchQuery(EsSubjectFields.SUBJECT_NAME, req.getKeyWord());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将题目名称的匹配查询添加到布尔查询中，并设置提升因子为2，以提高相关性。</span></span><br><span class="line">    bq.should(subjectNameQueryBuilder);</span><br><span class="line">    subjectNameQueryBuilder.boost(<span class="number">2</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建一个匹配查询构造器，用于匹配题目答案字段。</span></span><br><span class="line">    <span class="type">MatchQueryBuilder</span> <span class="variable">subjectAnswerQueryBuilder</span> <span class="operator">=</span></span><br><span class="line">            QueryBuilders.matchQuery(EsSubjectFields.SUBJECT_ANSWER, req.getKeyWord());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将题目答案的匹配查询添加到布尔查询中。</span></span><br><span class="line">    bq.should(subjectAnswerQueryBuilder);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建一个匹配查询构造器，用于匹配题目类型字段，必须是简答题类型。</span></span><br><span class="line">    <span class="type">MatchQueryBuilder</span> <span class="variable">subjectTypeQueryBuilder</span> <span class="operator">=</span></span><br><span class="line">            QueryBuilders.matchQuery(EsSubjectFields.SUBJECT_TYPE, SubjectInfoTypeEnum.BRIEF.getCode());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 必须匹配题目类型的查询添加到布尔查询中。</span></span><br><span class="line">    bq.must(subjectTypeQueryBuilder);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置至少应该匹配的should子句的数量为1。</span></span><br><span class="line">    bq.minimumShouldMatch(<span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建高亮显示构造器，设置高亮显示的前缀和后缀标签。</span></span><br><span class="line">    <span class="type">HighlightBuilder</span> <span class="variable">highlightBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HighlightBuilder</span>().field(<span class="string">&quot;*&quot;</span>).requireFieldMatch(<span class="literal">false</span>);</span><br><span class="line">    highlightBuilder.preTags(<span class="string">&quot;&lt;span style = \&quot;color:red\&quot;&gt;&quot;</span>);</span><br><span class="line">    highlightBuilder.postTags(<span class="string">&quot;&lt;/span&gt;&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置EsSearchRequest对象的布尔查询构造器。</span></span><br><span class="line">    esSearchRequest.setBq(bq);</span><br><span class="line">    <span class="comment">// 设置高亮显示构造器。</span></span><br><span class="line">    esSearchRequest.setHighlightBuilder(highlightBuilder);</span><br><span class="line">    <span class="comment">// 设置需要返回的字段。</span></span><br><span class="line">    esSearchRequest.setFields(EsSubjectFields.FIELD_QUERY);</span><br><span class="line">    <span class="comment">// 设置从第几个文档开始返回结果，用于分页。</span></span><br><span class="line">    esSearchRequest.setFrom((req.getPageNo() - <span class="number">1</span>) * req.getPageSize());</span><br><span class="line">    <span class="comment">// 设置每页返回的文档数量。</span></span><br><span class="line">    esSearchRequest.setSize(req.getPageSize());</span><br><span class="line">    <span class="comment">// 设置不需要滚动搜索。</span></span><br><span class="line">    esSearchRequest.setNeedScroll(<span class="literal">false</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 返回配置好的搜索请求对象。</span></span><br><span class="line">    <span class="keyword">return</span> esSearchRequest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> EsIndexInfo <span class="title function_">getEsIndexInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">EsIndexInfo</span> <span class="variable">esIndexInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EsIndexInfo</span>();</span><br><span class="line">        esIndexInfo.setClusterName(<span class="string">&quot;73438a827b55&quot;</span>);</span><br><span class="line">        esIndexInfo.setIndexName(<span class="string">&quot;subject_index&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> esIndexInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SubjectInfoDomainServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(SubjectInfoBO subjectInfoBO)</span> &#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">//同步到es</span></span><br><span class="line">    <span class="type">SubjectInfoEs</span> <span class="variable">subjectInfoEs</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubjectInfoEs</span>();</span><br><span class="line">    subjectInfoEs.setDocId(<span class="keyword">new</span> <span class="title class_">IdWorkerUtil</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>).nextId());</span><br><span class="line">    subjectInfoEs.setSubjectId(subjectInfo.getId());</span><br><span class="line">    subjectInfoEs.setSubjectAnswer(subjectInfoBO.getSubjectAnswer());</span><br><span class="line">    subjectInfoEs.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>().getTime());</span><br><span class="line">    subjectInfoEs.setCreateUser(<span class="string">&quot;lzrj&quot;</span>);</span><br><span class="line">    subjectInfoEs.setSubjectName(subjectInfo.getSubjectName());</span><br><span class="line">    subjectInfoEs.setSubjectType(subjectInfo.getSubjectType());</span><br><span class="line">    subjectEsService.insert(subjectInfoEs);</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SubjectController.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 全文检索</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/getSubjectPageBySearch&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;PageResult&lt;SubjectInfoEs&gt;&gt; <span class="title function_">getSubjectPageBySearch</span><span class="params">(<span class="meta">@RequestBody</span> SubjectInfoDTO subjectInfoDTO)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;SubjectController.getSubjectPageBySearch.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(subjectInfoDTO));</span><br><span class="line">        &#125;</span><br><span class="line">        Preconditions.checkArgument(StringUtils.isNotBlank(subjectInfoDTO.getKeyWord()), <span class="string">&quot;关键词不能为空&quot;</span>);</span><br><span class="line">        <span class="type">SubjectInfoBO</span> <span class="variable">subjectInfoBO</span> <span class="operator">=</span> SubjectInfoDTOConverter.INSTANCE.convertDTOToBO(subjectInfoDTO);</span><br><span class="line">        subjectInfoBO.setPageNo(subjectInfoDTO.getPageNo());</span><br><span class="line">        subjectInfoBO.setPageSize(subjectInfoDTO.getPageSize());</span><br><span class="line">        PageResult&lt;SubjectInfoEs&gt; boPageResult = subjectInfoDomainService.getSubjectPageBySearch(subjectInfoBO);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(boPageResult);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;SubjectCategoryController.getSubjectPageBySearch.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;全文检索失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SubjectInfoDomainServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageResult&lt;SubjectInfoEs&gt; <span class="title function_">getSubjectPageBySearch</span><span class="params">(SubjectInfoBO subjectInfoBO)</span> &#123;</span><br><span class="line">    <span class="type">SubjectInfoEs</span> <span class="variable">subjectInfoEs</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubjectInfoEs</span>();</span><br><span class="line">    subjectInfoEs.setPageNo(subjectInfoBO.getPageNo());</span><br><span class="line">    subjectInfoEs.setPageSize(subjectInfoBO.getPageSize());</span><br><span class="line">    subjectInfoEs.setKeyWord(subjectInfoBO.getKeyWord());</span><br><span class="line">    <span class="keyword">return</span> subjectEsService.querySubjectList(subjectInfoEs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="手写Mybatis拦截器自动填充数据-方法级别拦截器"><a href="#手写Mybatis拦截器自动填充数据-方法级别拦截器" class="headerlink" title="手写Mybatis拦截器自动填充数据(方法级别拦截器)"></a>手写Mybatis拦截器自动填充数据(方法级别拦截器)</h3><p><code>LoginContextHolder</code>和<code>LoginUtil</code>都放在<code>common</code>层里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 填充createBy, createTime等公共字段的拦截器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="comment">// 声明拦截器，指定要拦截的Executor类中的update方法，以及该方法的参数类型</span></span><br><span class="line"><span class="meta">@Intercepts(&#123;</span></span><br><span class="line"><span class="meta">    @Signature(type = Executor.class, method = &quot;update&quot;, args = &#123;MappedStatement.class, Object.class&#125;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisInterceptor</span> <span class="keyword">implements</span> <span class="title class_">Interceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">// 获取拦截方法的参数</span></span><br><span class="line">        <span class="type">MappedStatement</span> <span class="variable">mappedStatement</span> <span class="operator">=</span> (MappedStatement) invocation.getArgs()[<span class="number">0</span>];</span><br><span class="line">        <span class="type">SqlCommandType</span> <span class="variable">sqlCommandType</span> <span class="operator">=</span> mappedStatement.getSqlCommandType();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">parameter</span> <span class="operator">=</span> invocation.getArgs()[<span class="number">1</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果参数为空，直接执行原方法</span></span><br><span class="line">        <span class="keyword">if</span> (parameter == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> invocation.proceed();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获取当前登录用户的id</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">loginId</span> <span class="operator">=</span> LoginUtil.getLoginId();</span><br><span class="line">        <span class="comment">// 如果没有登录用户，直接执行原方法</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(loginId)) &#123;</span><br><span class="line">            <span class="keyword">return</span> invocation.proceed();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 根据SqlCommandType是INSERT或UPDATE，调用不同的处理方法</span></span><br><span class="line">        <span class="keyword">if</span> (SqlCommandType.INSERT == sqlCommandType || SqlCommandType.UPDATE == sqlCommandType) &#123;</span><br><span class="line">            replaceEntityProperty(parameter, loginId, sqlCommandType);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 执行原方法</span></span><br><span class="line">        <span class="keyword">return</span> invocation.proceed();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据不同的参数类型，调用不同的属性替换方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parameter 拦截方法的参数对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> loginId 当前登录用户的id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sqlCommandType SQL命令类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">replaceEntityProperty</span><span class="params">(Object parameter, String loginId, SqlCommandType sqlCommandType)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (parameter <span class="keyword">instanceof</span> Map) &#123;</span><br><span class="line">            replaceMap((Map) parameter, loginId, sqlCommandType);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            replace(parameter, loginId, sqlCommandType);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理Map类型的参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parameter Map参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> loginId 登录用户的id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sqlCommandType SQL命令类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">replaceMap</span><span class="params">(Map parameter, String loginId, SqlCommandType sqlCommandType)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Object val : parameter.values()) &#123;</span><br><span class="line">            replace(val, loginId, sqlCommandType);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理普通对象或集合类型的参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parameter 参数对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> loginId 登录用户的id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sqlCommandType SQL命令类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">replace</span><span class="params">(Object parameter, String loginId, SqlCommandType sqlCommandType)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (SqlCommandType.INSERT == sqlCommandType) &#123;</span><br><span class="line">        dealInsert(parameter, loginId);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dealUpdate(parameter, loginId);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 处理UPDATE操作的字段替换</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> parameter 参数对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> loginId 登录用户的id</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">dealUpdate</span><span class="params">(Object parameter, String loginId)</span> &#123;</span><br><span class="line">    <span class="comment">// 获取所有字段，包括继承的字段</span></span><br><span class="line">    Field[] fields = getAllFields(parameter);</span><br><span class="line">    <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// 如果字段已经有值，则跳过</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> field.get(parameter);</span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(o)) &#123;</span><br><span class="line">          field.setAccessible(<span class="literal">false</span>);</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 根据字段名设置不同的值</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;updateBy&quot;</span>.equals(field.getName())) &#123;</span><br><span class="line">          field.set(parameter, loginId);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;updateTime&quot;</span>.equals(field.getName())) &#123;</span><br><span class="line">          field.set(parameter, <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 其他字段不处理</span></span><br><span class="line">        &#125;</span><br><span class="line">        field.setAccessible(<span class="literal">false</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;dealUpdate.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 处理INSERT操作的字段替换</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> parameter 参数对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> loginId 登录用户的id</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">dealInsert</span><span class="params">(Object parameter, String loginId)</span> &#123;</span><br><span class="line">    <span class="comment">// 获取所有字段，包括继承的字段</span></span><br><span class="line">    Field[] fields = getAllFields(parameter);</span><br><span class="line">    <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// 如果字段已经有值，则跳过</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> field.get(parameter);</span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(o)) &#123;</span><br><span class="line">          field.setAccessible(<span class="literal">false</span>);</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 根据字段名设置不同的值</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;isDeleted&quot;</span>.equals(field.getName())) &#123;</span><br><span class="line">          field.set(parameter, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;createdBy&quot;</span>.equals(field.getName())) &#123;</span><br><span class="line">          field.set(parameter, loginId);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;createdTime&quot;</span>.equals(field.getName())) &#123;</span><br><span class="line">          field.set(parameter, <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 其他字段不处理</span></span><br><span class="line">        &#125;</span><br><span class="line">        field.setAccessible(<span class="literal">false</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;dealInsert.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 递归获取对象所有字段，包括父类的字段</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> object 对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> 字段数组</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> Field[] getAllFields(Object object) &#123;</span><br><span class="line">    Class&lt;?&gt; clazz = object.getClass();</span><br><span class="line">    List&lt;Field&gt; fieldList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">while</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 添加当前类的所有字段到列表</span></span><br><span class="line">      fieldList.addAll(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(Arrays.asList(clazz.getDeclaredFields())));</span><br><span class="line">      clazz = clazz.getSuperclass();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 转换列表为数组</span></span><br><span class="line">    Field[] fields = <span class="keyword">new</span> <span class="title class_">Field</span>[fieldList.size()];</span><br><span class="line">    fieldList.toArray(fields);</span><br><span class="line">    <span class="keyword">return</span> fields;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// MyBatis插件接口方法，实际使用时会增强目标对象</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Object <span class="title function_">plugin</span><span class="params">(Object target)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Plugin.wrap(target, <span class="built_in">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 用于接收MyBatis传入的属性，一般不使用</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setProperties</span><span class="params">(Properties properties)</span> &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="题目排行榜功能设计"><a href="#题目排行榜功能设计" class="headerlink" title="题目排行榜功能设计"></a>题目排行榜功能设计</h3><p>排行榜一般来说实时的，非实时的。</p>
<p><strong>实时的方案</strong></p>
<ol>
<li><strong>数据库统计</strong></li>
</ol>
<p>现在数据库里面的 createby 字段。用户的标识是唯一的，那我直接通过 group by 的形式统计 count。</p>
<p>select count(1),create_by from subject_info group by create_by limit 0,5;</p>
<p>数据量比较小，并发也比较小。这种方案是 ok 的。保证可以走到索引，返回速度快，不要产生慢 sql。</p>
<p>在数据库层面加一层缓存，接受一定的延时性。</p>
<ol start="2">
<li><p><strong>redis 的 sorted set</strong></p>
<p>有序集合，不允许重复的成员，然后每一个 key 都会包含一个 score 分数的概念。redis 根据分数可以帮助我们做从小到大，和从大到小的一个处理。</p>
<p>有序集合的 key 不可重复，score 重复。</p>
<p>它通过我们的一个哈希表来实现的，添加，删除，查找，复杂度 o(1) ，最大数量是 2的32 次方-1。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">zadd</span><br><span class="line"></span><br><span class="line">zrange</span><br><span class="line"></span><br><span class="line">zincrby</span><br><span class="line"></span><br><span class="line">zscore</span><br></pre></td></tr></table></figure>

<p>这种的好处在于，完全不用和数据库做任何的交互，纯纯的通过缓存来做，速度非常快，要避免一些大 key 的问题。</p>
</li>
</ol>
<p><strong>非实时</strong></p>
<p>定时任务 xxl-job</p>
<p>统计数据库的数据形式，帮助我们统计完成后，直接写入缓存。缓存的外部的交互展示。</p>
<h4 id="传统数据库实现排行榜"><a href="#传统数据库实现排行榜" class="headerlink" title="传统数据库实现排行榜"></a>传统数据库实现排行榜</h4><p><code>SubjectController.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取题目贡献榜</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/getContributeList&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;List&lt;SubjectInfoDTO&gt;&gt; <span class="title function_">getContributeList</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        List&lt;SubjectInfoBO&gt; boList = subjectInfoDomainService.getContributeList();</span><br><span class="line">        List&lt;SubjectInfoDTO&gt; dtoList = SubjectInfoDTOConverter.INSTANCE.convertBOToDTOList(boList);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(dtoList);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;SubjectCategoryController.getContributeList.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;获取贡献榜失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>SubjectDomainInfoServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;SubjectInfoBO&gt; <span class="title function_">getContributeList</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;SubjectInfo&gt; subjectInfoList = subjectInfoService.getContributeCount();</span><br><span class="line">    <span class="keyword">if</span> (CollectionUtils.isEmpty(subjectInfoList)) &#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;SubjectInfoBO&gt; boList = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">    subjectInfoList.forEach((subjectInfo -&gt; &#123;</span><br><span class="line">        <span class="type">SubjectInfoBO</span> <span class="variable">subjectInfoBO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubjectInfoBO</span>();</span><br><span class="line">        subjectInfoBO.setSubjectCount(subjectInfo.getSubjectCount());</span><br><span class="line">        <span class="comment">//这里用到了UserRpc</span></span><br><span class="line">        <span class="type">UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span> userRpc.getUserInfo(subjectInfo.getCreatedBy());</span><br><span class="line">        subjectInfoBO.setCreateUser(userInfo.getNickName());</span><br><span class="line">        subjectInfoBO.setCreateUserAvatar(userInfo.getAvatar());</span><br><span class="line">        boList.add(subjectInfoBO);</span><br><span class="line">    &#125;));</span><br><span class="line">    <span class="keyword">return</span> boList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>UserRpc.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserRpc</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserFeignService userFeignService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> UserInfo <span class="title function_">getUserInfo</span><span class="params">(String userName)</span> &#123;</span><br><span class="line">        <span class="type">AuthUserDTO</span> <span class="variable">authUserDTO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthUserDTO</span>();</span><br><span class="line">        authUserDTO.setUserName(userName);</span><br><span class="line">        Result&lt;AuthUserDTO&gt; result = userFeignService.getUserInfo(authUserDTO);</span><br><span class="line">        <span class="type">UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserInfo</span>();</span><br><span class="line">        <span class="keyword">if</span> (!result.getSuccess()) &#123;</span><br><span class="line">            <span class="keyword">return</span> userInfo;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">AuthUserDTO</span> <span class="variable">data</span> <span class="operator">=</span> result.getData();</span><br><span class="line">        userInfo.setUserName(data.getUserName());</span><br><span class="line">        userInfo.setNickName(data.getNickName());</span><br><span class="line">        <span class="comment">//新增 设置头像</span></span><br><span class="line">        userInfo.setAvatar(data.getAvatar());</span><br><span class="line">        <span class="keyword">return</span> userInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>subjectInfoServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;SubjectInfo&gt; <span class="title function_">getContributeCount</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.subjectInfoDao.getContributeCount();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SubjectInfoDao.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getContributeCount&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.jingdianjichi.subject.infra.basic.entity.SubjectInfo&quot;</span>&gt;</span></span><br><span class="line">    select count(1) as subjectCount,</span><br><span class="line">           created_by as createdBy</span><br><span class="line">    from subject_info</span><br><span class="line">    where is_deleted = 0</span><br><span class="line">    and created_by is not null</span><br><span class="line">    group by created_by</span><br><span class="line">    limit 0,5</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="基于redis的zset实现排行榜"><a href="#基于redis的zset实现排行榜" class="headerlink" title="基于redis的zset实现排行榜"></a>基于redis的zset实现排行榜</h4><p><code>subject-domain/pom.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.12.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.12.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>subject-doamin/RedisUtil.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; rankWithScore(String key, <span class="type">long</span> start, <span class="type">long</span> end) &#123;</span><br><span class="line">    Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; set = redisTemplate.opsForZSet().reverseRangeWithScores(key, start, end);</span><br><span class="line">    <span class="keyword">return</span> set;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/fuzhijieabc/article/details/123805608?ops_request_misc=%7B%22request_id%22:%22172447209416800188585058%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=172447209416800188585058&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-123805608-null-null.142%5Ev100%5Epc_search_result_base8&utm_term=reverseRangeWithScores&spm=1018.2226.3001.4187">redis——Zset有序集合之reverseRangeWithScore函数使用_reverserangewithscores-CSDN博客</a></p>
<p><code>SubjectInfoDomainServiceImpl.java</code></p>
<p>排行榜接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">RANK_KEY</span> <span class="operator">=</span> <span class="string">&quot;subject_rank&quot;</span>;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;SubjectInfoBO&gt; <span class="title function_">getContributeList</span><span class="params">()</span> &#123;</span><br><span class="line">    Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; typedTuples = redisUtil.rankWithScore(RANK_KEY, <span class="number">0</span>, <span class="number">5</span>);</span><br><span class="line">    <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">        log.info(<span class="string">&quot;getContributeList.typedTuples:&#123;&#125;&quot;</span>, JSON.toJSONString(typedTuples));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (CollectionUtils.isEmpty(typedTuples)) &#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;SubjectInfoBO&gt; boList = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">    typedTuples.forEach((rank -&gt; &#123;</span><br><span class="line">        <span class="type">SubjectInfoBO</span> <span class="variable">subjectInfoBO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubjectInfoBO</span>();</span><br><span class="line">        subjectInfoBO.setSubjectCount(rank.getScore().intValue());</span><br><span class="line">        <span class="comment">// 这个是openId</span></span><br><span class="line">        <span class="type">UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span> userRpc.getUserInfo(rank.getValue());</span><br><span class="line">        subjectInfoBO.setCreateUser(userInfo.getNickName());</span><br><span class="line">        subjectInfoBO.setCreateUserAvatar(userInfo.getAvatar());</span><br><span class="line">        boList.add(subjectInfoBO);</span><br><span class="line">    &#125;));</span><br><span class="line">    <span class="comment">// 返回一个包含题目信息的list</span></span><br><span class="line">    <span class="keyword">return</span> boList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="点赞和收藏"><a href="#点赞和收藏" class="headerlink" title="点赞和收藏"></a>点赞和收藏</h3><h4 id="点赞和收藏功能设计"><a href="#点赞和收藏功能设计" class="headerlink" title="点赞和收藏功能设计"></a>点赞和收藏功能设计</h4><p>点赞与收藏的逻辑是非常一样的，我们这里就选取点赞功能来给大家做开发。</p>
<p>按照我们的程序员 club 的设计，点赞业务其实涉及几个方面：</p>
<ul>
<li>我们肯定要知道一个题目被多少人点过赞</li>
<li>还要知道，每个人他点赞了哪些题目。</li>
</ul>
<p>点赞的业务特性：频繁。用户一多，时时刻刻都在进行点赞啊，收藏啊等等处理，如果说我们采取传统的数据库的模式啊，这个交互量是非常大的，很难去抗住这个并发问题，所以我们采取 redis 的方式来做。</p>
<p>查询的数据交互，我们可以和 redis 直接来做，持久化的数据，通过数据库查询即可，这个数据如何去同步到数据库，我们就采取的定时任务 xxl-job 定期来刷数据。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/24/IHPpxkGLXu3adjD.png" alt="image-20240824121946908.png"></p>
<p>记录的时候三个关键信息，点赞的人，被点赞的题目，点赞的状态。</p>
<p>我们最终的数据结构就是 hash，string 类型。</p>
<ul>
<li>hash，存到一个键里面，键里是一个 map，他又分为 hashkey 和 hashval。<ul>
<li>谁点赞了哪个题目+状态：hashkey，subjectId:userId，val 就存的是点赞的状态 1 是点赞 0 是不点赞。</li>
<li>点赞数量：string 类型 key subjectId，val 即使我们的题目被点赞的数量。</li>
<li>有没有点过赞，key存在说明点过（并非记录状态）：key为string 类型， subjectId:userId。</li>
</ul>
</li>
</ul>
<p><strong>表结构：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/24/IGp3lt4YMgxVOui.png" alt="image-20240824123024005.png"></p>
<p><strong>新增点赞</strong></p>
<p>直接操作 redis</p>
<p>存 hash，存数量，存点赞的人与题目的 key。</p>
<p><strong>取消点赞</strong></p>
<p>上面的反逻辑，数量会-1，hash 里面的状态会更新，点赞人与题目关联的 key 会被删除</p>
<p><strong>查询当前题目被点赞的数量</strong></p>
<p>直接与 redis 交互，读题目的被点赞数量的 key</p>
<p><strong>查询当前题目被当前用户是否点过赞</strong></p>
<p>直接查 redis 就可以了。</p>
<p><strong>我的点赞</strong></p>
<p>直接查数据库做分页逻辑的展示。</p>
<h4 id="点赞功能开发"><a href="#点赞功能开发" class="headerlink" title="点赞功能开发"></a>点赞功能开发</h4><p><code>RedisUtil.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// key可以用来区分这些不同的哈希表。hashKey 则是这些哈希表内部的键</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">putHash</span><span class="params">(String key, String hashKey, Object hashVal)</span> &#123;</span><br><span class="line">    redisTemplate.opsForHash().put(key, hashKey, hashVal);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SubjectLikedDomainServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义常量，用于作为Redis中存储主题点赞信息的哈希表的键</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SUBJECT_LIKED_KEY</span> <span class="operator">=</span> <span class="string">&quot;subject.liked&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义常量，用于作为Redis中存储主题点赞数量的键</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SUBJECT_LIKED_COUNT_KEY</span> <span class="operator">=</span> <span class="string">&quot;subject.liked.count&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义常量，用于作为Redis中存储主题点赞详细信息的键</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SUBJECT_LIKED_DETAIL_KEY</span> <span class="operator">=</span> <span class="string">&quot;subject.liked.detail&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加点赞信息到Redis。</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> subjectLikedBO 包含点赞操作的业务对象，其中包含主题ID、点赞用户ID和状态。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(SubjectLikedBO subjectLikedBO)</span> &#123;</span><br><span class="line">    <span class="comment">// 从业务对象中获取主题ID</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">subjectId</span> <span class="operator">=</span> subjectLikedBO.getSubjectId();</span><br><span class="line">    <span class="comment">// 从业务对象中获取点赞用户的ID</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">likeUserId</span> <span class="operator">=</span> subjectLikedBO.getLikeUserId();</span><br><span class="line">    <span class="comment">// 从业务对象中获取点赞状态</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">status</span> <span class="operator">=</span> subjectLikedBO.getStatus();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构建用于存储点赞状态的哈希表的字段名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">hashKey</span> <span class="operator">=</span> buildSubjectLikedKey(subjectId.toString(), likeUserId);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将点赞状态存储到Redis哈希表中</span></span><br><span class="line">    redisUtil.putHash(SUBJECT_LIKED_KEY, hashKey, status);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构建存储点赞详细信息的键，格式为 &quot;subject.liked.detail + 主题ID + . + 点赞用户ID&quot;</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">detailKey</span> <span class="operator">=</span> SUBJECT_LIKED_DETAIL_KEY + <span class="string">&quot;.&quot;</span> + subjectId + <span class="string">&quot;.&quot;</span> + likeUserId;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构建存储点赞数量的键，格式为 &quot;subject.liked.count + . + 主题ID&quot;</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">countKey</span> <span class="operator">=</span> SUBJECT_LIKED_COUNT_KEY + <span class="string">&quot;.&quot;</span> + subjectId;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 判断点赞状态是否为 &quot;点赞&quot;</span></span><br><span class="line">    <span class="keyword">if</span> (SubjectLikedStatusEnum.LIKED.getCode() == status) &#123;</span><br><span class="line">        <span class="comment">// 如果是点赞，增加点赞数量</span></span><br><span class="line">        redisUtil.increment(countKey, <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 存储点赞详细信息，这里假设点赞详细信息只存储为 &quot;1&quot;</span></span><br><span class="line">        redisUtil.set(detailKey, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果不是点赞状态，执行以下操作</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> redisUtil.getInt(countKey);</span><br><span class="line">        <span class="comment">// 如果点赞数量为null或小于等于0，则不执行任何操作</span></span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(count) || count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 减少点赞数量</span></span><br><span class="line">        redisUtil.increment(countKey, -<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 删除点赞详细信息</span></span><br><span class="line">        redisUtil.del(detailKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="题目详情增加点赞数据"><a href="#题目详情增加点赞数据" class="headerlink" title="题目详情增加点赞数据"></a>题目详情增加点赞数据</h4><p><code>SubjectLikedDomainServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">isLiked</span><span class="params">(String subjectId, String userId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">detailKey</span> <span class="operator">=</span> SUBJECT_LIKED_DETAIL_KEY + <span class="string">&quot;.&quot;</span> + subjectId + <span class="string">&quot;.&quot;</span> + userId;</span><br><span class="line">        <span class="keyword">return</span> redisUtil.exist(detailKey);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Integer <span class="title function_">getLikedCount</span><span class="params">(String subjectId)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">countKey</span> <span class="operator">=</span> SUBJECT_LIKED_COUNT_KEY + <span class="string">&quot;.&quot;</span> + subjectId;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> redisUtil.getInt(countKey);</span><br><span class="line">    <span class="keyword">if</span> (Objects.isNull(count) || count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> redisUtil.getInt(countKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SubjectInfoDomainServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SubjectInfoBO <span class="title function_">querySubjectInfo</span><span class="params">(SubjectInfoBO subjectInfoBO)</span> &#123;</span><br><span class="line">    <span class="type">SubjectInfo</span> <span class="variable">subjectInfo</span> <span class="operator">=</span> subjectInfoService.queryById(subjectInfoBO.getId());</span><br><span class="line">    <span class="type">SubjectTypeHandler</span> <span class="variable">handler</span> <span class="operator">=</span> subjectTypeHandlerFactory.getHandler(subjectInfo.getSubjectType());</span><br><span class="line">    <span class="type">SubjectOptionBO</span> <span class="variable">optionBO</span> <span class="operator">=</span> handler.query(subjectInfo.getId().intValue());</span><br><span class="line">    <span class="type">SubjectInfoBO</span> <span class="variable">bo</span> <span class="operator">=</span> SubjectInfoConverter.INSTANCE.convertOptionAndInfoToBo(optionBO, subjectInfo);</span><br><span class="line">    <span class="type">SubjectMapping</span> <span class="variable">subjectMapping</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubjectMapping</span>();</span><br><span class="line">    subjectMapping.setSubjectId(subjectInfo.getId());</span><br><span class="line">    subjectMapping.setIsDeleted(IsDeletedFlagEnum.UN_DELETED.getCode());</span><br><span class="line">    List&lt;SubjectMapping&gt; mappingList = subjectMappingService.queryLabelId(subjectMapping);</span><br><span class="line">    List&lt;Long&gt; labelIdList = mappingList.stream().map(SubjectMapping::getLabelId).collect(Collectors.toList());</span><br><span class="line">    List&lt;SubjectLabel&gt; labelList = subjectLabelService.batchQueryById(labelIdList);</span><br><span class="line">    List&lt;String&gt; labelNameList = labelList.stream().map(SubjectLabel::getLabelName).collect(Collectors.toList());</span><br><span class="line">    bo.setLabelName(labelNameList);</span><br><span class="line">    bo.setLiked(subjectLikedDomainService.isLiked(subjectInfoBO.getId().toString(), LoginUtil.getLoginId()));</span><br><span class="line">    bo.setLikedCount(subjectLikedDomainService.getLikedCount(subjectInfoBO.getId().toString()));</span><br><span class="line">    assembleSubjectCursor(subjectInfoBO, bo);</span><br><span class="line">    <span class="keyword">return</span> bo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="xxljob定时任务完成"><a href="#xxljob定时任务完成" class="headerlink" title="xxljob定时任务完成"></a>xxljob定时任务完成</h4><p>XXL-JOB 是一个轻量级分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。现已开放源代码并接入多家公司线上产品线，开箱即用。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/08/24/sb1G3l4E97DJPLQ.png" alt="image-20240824155129452.png"></p>
<p><a target="_blank" rel="noopener" href="https://www.xuxueli.com/xxl-job/">分布式任务调度平台XXL-JOB (xuxueli.com)</a></p>
<p><strong>特性</strong></p>
<ul>
<li>1、简单：支持通过 Web 页面对任务进行 CRUD 操作，操作简单，一分钟上手；</li>
<li>2、动态：支持动态修改任务状态、启动 &#x2F; 停止任务，以及终止运行中任务，即时生效；</li>
<li>3、调度中心 HA（中心式）：调度采用中心式设计，“调度中心” 自研调度组件并支持集群部署，可保证调度中心 HA；</li>
<li>4、执行器 HA（分布式）：任务分布式执行，任务 “执行器” 支持集群部署，可保证任务执行 HA；</li>
<li>5、注册中心：执行器会周期性自动注册任务，调度中心将会自动发现注册的任务并触发执行。同时，也支持手动录入执行器地址；</li>
<li>6、弹性扩容缩容：一旦有新执行器机器上线或者下线，下次调度时将会重新分配任务；</li>
<li>7、路由策略：执行器集群部署时提供丰富的路由策略，包括：第一个、最后一个、轮询、随机、一致性 HASH、最不经常使用、最近最久未使用、故障转移、忙碌转移等；</li>
<li>8、故障转移：任务路由策略选择 “故障转移” 情况下，如果执行器集群中某一台机器故障，将会自动 Failover 切换到一台正常的执行器发送调度请求。</li>
<li>9、阻塞处理策略：调度过于密集执行器来不及处理时的处理策略，策略包括：单机串行（默认）、丢弃后续调度、覆盖之前调度；</li>
<li>10、任务超时控制：支持自定义任务超时时间，任务运行超时将会主动中断任务；</li>
<li>11、任务失败重试：支持自定义任务失败重试次数，当任务失败时将会按照预设的失败重试次数主动进行重试；其中分片任务支持分片粒度的失败重试；</li>
<li>12、任务失败告警；默认提供邮件方式失败告警，同时预留扩展接口，可方便的扩展短信、钉钉等告警方式；</li>
<li>13、分片广播任务：执行器集群部署时，任务路由策略选择 “分片广播” 情况下，一次任务调度将会广播触发集群中所有执行器执行一次任务，可根据分片参数开发分片任务；</li>
<li>14、动态分片：分片广播任务以执行器为维度进行分片，支持动态扩容执行器集群从而动态增加分片数量，协同进行业务处理；在进行大数据量业务操作时可显著提升任务处理能力和速度。</li>
<li>15、事件触发：除了 “Cron 方式” 和 “任务依赖方式” 触发任务执行之外，支持基于事件的触发任务方式。调度中心提供触发任务单次执行的 API 服务，可根据业务事件灵活触发。</li>
<li>16、任务进度监控：支持实时监控任务进度；</li>
<li>17、Rolling 实时日志：支持在线查看调度结果，并且支持以 Rolling 方式实时查看执行器输出的完整的执行日志；</li>
<li>18、GLUE：提供 Web IDE，支持在线开发任务逻辑代码，动态发布，实时编译生效，省略部署上线的过程。支持 30 个版本的历史版本回溯。</li>
<li>19、脚本任务：支持以 GLUE 模式开发和运行脚本任务，包括 Shell、Python、NodeJS、PHP、PowerShell 等类型脚本；</li>
<li>20、命令行任务：原生提供通用命令行任务 Handler（Bean 任务，”CommandJobHandler”）；业务方只需要提供命令行即可；</li>
<li>21、任务依赖：支持配置子任务依赖，当父任务执行结束且执行成功后将会主动触发一次子任务的执行，多个子任务用逗号分隔；</li>
<li>22、一致性：“调度中心” 通过 DB 锁保证集群分布式调度的一致性，一次任务调度只会触发一次执行；</li>
<li>23、自定义任务参数：支持在线配置调度任务入参，即时生效；</li>
<li>24、调度线程池：调度系统多线程触发调度运行，确保调度精确执行，不被堵塞；</li>
<li>25、数据加密：调度中心和执行器之间的通讯进行数据加密，提升调度信息安全性；</li>
<li>26、邮件报警：任务失败时支持邮件报警，支持配置多邮件地址群发报警邮件；</li>
<li>27、推送 maven 中央仓库：将会把最新稳定版推送到 maven 中央仓库，方便用户接入和使用；</li>
<li>28、运行报表：支持实时查看运行数据，如任务数量、调度次数、执行器数量等；以及调度报表，如调度日期分布图，调度成功分布图等；</li>
<li>29、全异步：任务调度流程全异步化设计实现，如异步调度、异步运行、异步回调等，有效对密集调度进行流量削峰，理论上支持任意时长任务的运行；</li>
<li>30、跨语言：调度中心与执行器提供语言无关的 RESTful API 服务，第三方任意语言可据此对接调度中心或者实现执行器。除此之外，还提供了 “多任务模式” 和 “httpJobHandler” 等其他跨语言方案；</li>
<li>31、国际化：调度中心支持国际化设置，提供中文、英文两种可选语言，默认为中文；</li>
<li>32、容器化：提供官方 docker 镜像，并实时更新推送 dockerhub，进一步实现产品开箱即用；</li>
<li>33、线程池隔离：调度线程池进行隔离拆分，慢任务自动降级进入 “Slow” 线程池，避免耗尽调度线程，提高系统稳定性；</li>
<li>34、用户管理：支持在线管理系统用户，存在管理员、普通用户两种角色；</li>
<li>35、权限控制：执行器维度进行权限控制，管理员拥有全量权限，普通用户需要分配执行器权限后才允许相关操作；</li>
</ul>
<p>其实把东西配置好就行</p>
<p><code>subject-starter/application.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">xxl:</span></span><br><span class="line">  <span class="attr">job:</span></span><br><span class="line">    <span class="attr">admin:</span></span><br><span class="line">      <span class="attr">addresses:</span> <span class="string">http://127.0.0.1:8080/xxl-job-admin</span> </span><br><span class="line">    <span class="attr">accessToken:</span> <span class="string">default_token</span></span><br><span class="line">    <span class="attr">executor:</span></span><br><span class="line">      <span class="attr">appname:</span> <span class="string">jc-club-subjcet</span></span><br><span class="line">      <span class="attr">address:</span></span><br><span class="line">      <span class="attr">ip:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9999</span></span><br><span class="line">      <span class="attr">logpath:</span> <span class="string">/data/applogs/xxl-job/jobhandler</span></span><br><span class="line">      <span class="attr">logretentiondays:</span> <span class="number">30</span></span><br></pre></td></tr></table></figure>

<p><code>XxlJobConfig.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;xxl.job.admin.addresses&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String adminAddresses;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;xxl.job.accessToken&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String accessToken;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;xxl.job.executor.appname&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String appname;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;xxl.job.executor.address&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;xxl.job.executor.ip&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String ip;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;xxl.job.executor.port&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;xxl.job.executor.logpath&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String logPath;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;xxl.job.executor.logretentiondays&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> logRetentionDays;</span><br><span class="line"></span><br><span class="line"><span class="comment">//配置执行器</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> XxlJobSpringExecutor <span class="title function_">xxlJobExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">    logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init.&quot;</span>);</span><br><span class="line">    <span class="type">XxlJobSpringExecutor</span> <span class="variable">xxlJobSpringExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XxlJobSpringExecutor</span>();</span><br><span class="line">    xxlJobSpringExecutor.setAdminAddresses(adminAddresses);</span><br><span class="line">    xxlJobSpringExecutor.setAppname(appname);</span><br><span class="line">    xxlJobSpringExecutor.setAddress(address);</span><br><span class="line">    xxlJobSpringExecutor.setIp(ip);</span><br><span class="line">    xxlJobSpringExecutor.setPort(port);</span><br><span class="line">    xxlJobSpringExecutor.setAccessToken(accessToken);</span><br><span class="line">    xxlJobSpringExecutor.setLogPath(logPath);</span><br><span class="line">    xxlJobSpringExecutor.setLogRetentionDays(logRetentionDays);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> xxlJobSpringExecutor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SyncLikedJob.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SyncLikedJob</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SubjectLikedDomainService subjectLikedDomainService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步点赞数据任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@XxlJob(&quot;syncLikedJobHandler&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">syncLikedJobHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        XxlJobHelper.log(<span class="string">&quot;syncLikedJobHandler.start&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            subjectLikedDomainService.syncLiked();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            XxlJobHelper.log(<span class="string">&quot;syncLikedJobHandler.error&quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SubjectLikedDomainServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">syncLiked</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//redisUtil.getHashAndDelete(SUBJECT_LIKED_KEY)从Redis中获取键为SUBJECT_LIKED_KEY的哈希表，并在获取后删除此哈希表。</span></span><br><span class="line">    Map&lt;Object, Object&gt; subjectLikedMap = redisUtil.getHashAndDelete(SUBJECT_LIKED_KEY);</span><br><span class="line">    <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">        log.info(<span class="string">&quot;syncLiked.subjectLikedMap:&#123;&#125;&quot;</span>, JSON.toJSONString(subjectLikedMap));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (MapUtils.isEmpty(subjectLikedMap)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//批量同步到数据库</span></span><br><span class="line">    List&lt;SubjectLiked&gt; subjectLikedList = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">    subjectLikedMap.forEach((key, val) -&gt; &#123;</span><br><span class="line">        <span class="type">SubjectLiked</span> <span class="variable">subjectLiked</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubjectLiked</span>();</span><br><span class="line">        String[] keyArr = key.toString().split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">subjectId</span> <span class="operator">=</span> keyArr[<span class="number">0</span>];</span><br><span class="line">        <span class="type">String</span> <span class="variable">likedUser</span> <span class="operator">=</span> keyArr[<span class="number">1</span>];</span><br><span class="line">        subjectLiked.setSubjectId(Long.valueOf(subjectId));</span><br><span class="line">        subjectLiked.setLikeUserId(likedUser);</span><br><span class="line">        subjectLiked.setStatus(Integer.valueOf(val.toString()));</span><br><span class="line">        subjectLiked.setIsDeleted(IsDeletedFlagEnum.UN_DELETED.getCode());</span><br><span class="line">        subjectLikedList.add(subjectLiked);</span><br><span class="line">    &#125;);</span><br><span class="line">    subjectLikedService.batchInsertOrUpdate(subjectLikedList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SubjectLikedServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">batchInsertOrUpdate</span><span class="params">(List&lt;SubjectLiked&gt; subjectLikedList)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.subjectLikedDao.batchInsertOrUpdate(subjectLikedList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>RedisUtil.java</code></p>
<ol>
<li><strong>定义Map</strong>：创建一个新的<code>HashMap</code>实例，用于存储从Redis中获取的键值对。</li>
<li><strong>使用Cursor遍历哈希表</strong>：通过调用<code>redisTemplate.opsForHash().scan(key, ScanOptions.NONE)</code>获取一个<code>Cursor</code>，它可以用来遍历Redis哈希表中的所有条目。<code>ScanOptions.NONE</code>表示不使用任何扫描选项。</li>
<li><strong>遍历Cursor</strong>：使用<code>while</code>循环遍历<code>Cursor</code>，直到没有更多的条目。</li>
<li><strong>获取条目</strong>：在循环内部，使用<code>cursor.next()</code>获取当前的条目，它是一个<code>Map.Entry</code>对象。</li>
<li><strong>提取键和值</strong>：从<code>Map.Entry</code>对象中提取键（<code>hashKey</code>）和值（<code>value</code>）。</li>
<li><strong>将键值对放入Map</strong>：使用<code>map.put(hashKey, value)</code>将提取的键和值放入之前创建的Map中。</li>
<li><strong>删除哈希表中的条目</strong>：使用<code>redisTemplate.opsForHash().delete(key, hashKey)</code>从Redis的哈希表中删除当前遍历到的键值对。</li>
<li><strong>返回Map</strong>：遍历完成后，返回包含所有键值对的Map。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Map&lt;Object, Object&gt; <span class="title function_">getHashAndDelete</span><span class="params">(String key)</span> &#123;</span><br><span class="line">    Map&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    Cursor&lt;Map.Entry&lt;Object, Object&gt;&gt; cursor = redisTemplate.opsForHash().scan(key, ScanOptions.NONE);</span><br><span class="line">    <span class="keyword">while</span> (cursor.hasNext()) &#123;</span><br><span class="line">        Map.Entry&lt;Object, Object&gt; entry = cursor.next();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">hashKey</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line">        map.put(hashKey, value);</span><br><span class="line">        redisTemplate.opsForHash().delete(key, hashKey);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="我的点赞功能开发"><a href="#我的点赞功能开发" class="headerlink" title="我的点赞功能开发"></a>我的点赞功能开发</h4><p><code>SubjectLikedController.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询我的点赞列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/getSubjectLikedPage&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;PageResult&lt;SubjectLikedDTO&gt;&gt; <span class="title function_">getSubjectLikedPage</span><span class="params">(<span class="meta">@RequestBody</span> SubjectLikedDTO subjectLikedDTO)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;SubjectController.getSubjectLikedPage.dto:&#123;&#125;&quot;</span>, JSON.toJSONString(subjectLikedDTO));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">SubjectLikedBO</span> <span class="variable">subjectLikedBO</span> <span class="operator">=</span> SubjectLikedDTOConverter.INSTANCE.convertDTOToBO(subjectLikedDTO);</span><br><span class="line">        subjectLikedBO.setPageNo(subjectLikedDTO.getPageNo());</span><br><span class="line">        subjectLikedBO.setPageSize(subjectLikedDTO.getPageSize());</span><br><span class="line">        PageResult&lt;SubjectLikedBO&gt; boPageResult = subjectLikedDomainService.getSubjectLikedPage(subjectLikedBO);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(boPageResult);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;SubjectCategoryController.getSubjectLikedPage.error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;分页查询我的点赞失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SubjectLikedDomainServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageResult&lt;SubjectLikedBO&gt; <span class="title function_">getSubjectLikedPage</span><span class="params">(SubjectLikedBO subjectLikedBO)</span> &#123;</span><br><span class="line">    <span class="comment">// 创建一个分页结果对象</span></span><br><span class="line">    PageResult&lt;SubjectLikedBO&gt; pageResult = <span class="keyword">new</span> <span class="title class_">PageResult</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// 设置当前页码和每页显示的记录数</span></span><br><span class="line">    pageResult.setPageNo(subjectLikedBO.getPageNo());</span><br><span class="line">    pageResult.setPageSize(subjectLikedBO.getPageSize());</span><br><span class="line">    <span class="comment">// 计算查询的起始索引</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> (subjectLikedBO.getPageNo() - <span class="number">1</span>) * subjectLikedBO.getPageSize();</span><br><span class="line">    <span class="comment">// 将BO对象转换为Entity对象</span></span><br><span class="line">    <span class="type">SubjectLiked</span> <span class="variable">subjectLiked</span> <span class="operator">=</span> SubjectLikedBOConverter.INSTANCE.convertBOToEntity(subjectLikedBO);</span><br><span class="line">    <span class="comment">// 设置点赞用户的ID为当前登录用户的ID</span></span><br><span class="line">    subjectLiked.setLikeUserId(LoginUtil.getLoginId());</span><br><span class="line">    <span class="comment">// 执行条件查询，获取点赞记录的总数</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> subjectLikedService.countByCondition(subjectLiked);</span><br><span class="line">    <span class="comment">// 如果没有记录，则直接返回空的分页结果</span></span><br><span class="line">    <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> pageResult;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 执行分页查询，获取点赞记录的列表</span></span><br><span class="line">    List&lt;SubjectLiked&gt; subjectLikedList = subjectLikedService.queryPage(subjectLiked, start,</span><br><span class="line">            subjectLikedBO.getPageSize());</span><br><span class="line">    <span class="comment">// 将Entity列表转换为BO列表</span></span><br><span class="line">    List&lt;SubjectLikedBO&gt; subjectInfoBOS = SubjectLikedBOConverter.INSTANCE.convertListInfoToBO(subjectLikedList);</span><br><span class="line">    <span class="comment">// 遍历BO列表，为每个点赞记录添加主题名称</span></span><br><span class="line">    subjectInfoBOS.forEach(info -&gt; &#123;</span><br><span class="line">        <span class="type">SubjectInfo</span> <span class="variable">subjectInfo</span> <span class="operator">=</span> subjectInfoService.queryById(info.getSubjectId());</span><br><span class="line">        info.setSubjectName(subjectInfo.getSubjectName());</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 设置分页结果中的记录列表和总数</span></span><br><span class="line">    pageResult.setRecords(subjectInfoBOS);</span><br><span class="line">    pageResult.setTotal(count);</span><br><span class="line">    <span class="comment">// 返回分页结果对象</span></span><br><span class="line">    <span class="keyword">return</span> pageResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SubjectLikedServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">countByCondition</span><span class="params">(SubjectLiked subjectLiked)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.subjectLikedDao.countByCondition(subjectLiked);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//分页查询</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;SubjectLiked&gt; <span class="title function_">queryPage</span><span class="params">(SubjectLiked subjectLiked, <span class="type">int</span> start, Integer pageSize)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.subjectLikedDao.queryPage(subjectLiked, start, pageSize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="快速刷题功能开发"><a href="#快速刷题功能开发" class="headerlink" title="快速刷题功能开发"></a>快速刷题功能开发</h4><p><code>SubjectInfoDTO.java</code></p>
<p>新增字段</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 下一题</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Long nextSubjectId;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上一题</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Long lastSubjectId;</span><br></pre></td></tr></table></figure>

<p><code>SubjectInfoDomainService.java</code></p>
<p><strong>这段代码的主要逻辑是：</strong></p>
<ol>
<li>根据题目ID查询题目实体。</li>
<li>根据题目类型获取相应的处理器，并使用它查询题目选项信息。</li>
<li>将题目选项和题目信息转换为业务对象BO。</li>
<li>查询题目的标签ID列表，并批量查询标签列表。</li>
<li>提取标签名称并设置到业务对象BO中。</li>
<li>设置是否已点赞的状态和点赞数量。</li>
<li>组装题目的上下文信息，包括上一个和下一个题目的ID。</li>
<li>返回封装好的业务对象BO。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SubjectInfoBO <span class="title function_">querySubjectInfo</span><span class="params">(SubjectInfoBO subjectInfoBO)</span> &#123;</span><br><span class="line">    <span class="comment">// 根据题目信息BO中的ID查询题目实体</span></span><br><span class="line">    <span class="type">SubjectInfo</span> <span class="variable">subjectInfo</span> <span class="operator">=</span> subjectInfoService.queryById(subjectInfoBO.getId());</span><br><span class="line">    <span class="comment">// 根据题目类型获取相应的处理器</span></span><br><span class="line">    <span class="type">SubjectTypeHandler</span> <span class="variable">handler</span> <span class="operator">=</span> subjectTypeHandlerFactory.getHandler(subjectInfo.getSubjectType());</span><br><span class="line">    <span class="comment">// 使用处理器查询题目选项信息</span></span><br><span class="line">    <span class="type">SubjectOptionBO</span> <span class="variable">optionBO</span> <span class="operator">=</span> handler.query(subjectInfo.getId().intValue());</span><br><span class="line">    <span class="comment">// 将题目选项和题目信息转换为业务对象BO</span></span><br><span class="line">    <span class="type">SubjectInfoBO</span> <span class="variable">bo</span> <span class="operator">=</span> SubjectInfoConverter.INSTANCE.convertOptionAndInfoToBo(optionBO, subjectInfo);</span><br><span class="line">    <span class="comment">// 创建题目映射对象，设置题目ID和未删除标志</span></span><br><span class="line">    <span class="type">SubjectMapping</span> <span class="variable">subjectMapping</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubjectMapping</span>();</span><br><span class="line">    subjectMapping.setSubjectId(subjectInfo.getId());</span><br><span class="line">    subjectMapping.setIsDeleted(IsDeletedFlagEnum.UN_DELETED.getCode());</span><br><span class="line">    <span class="comment">// 查询题目标签ID列表</span></span><br><span class="line">    List&lt;SubjectMapping&gt; mappingList = subjectMappingService.queryLabelId(subjectMapping);</span><br><span class="line">    <span class="comment">// 从映射列表中提取标签ID</span></span><br><span class="line">    List&lt;Long&gt; labelIdList = mappingList.stream().map(SubjectMapping::getLabelId).collect(Collectors.toList());</span><br><span class="line">    <span class="comment">// 批量查询标签列表</span></span><br><span class="line">    List&lt;SubjectLabel&gt; labelList = subjectLabelService.batchQueryById(labelIdList);</span><br><span class="line">    <span class="comment">// 从标签列表中提取标签名称</span></span><br><span class="line">    List&lt;String&gt; labelNameList = labelList.stream().map(SubjectLabel::getLabelName).collect(Collectors.toList());</span><br><span class="line">    <span class="comment">// 设置标签名称到业务对象BO中</span></span><br><span class="line">    bo.setLabelName(labelNameList);</span><br><span class="line">    <span class="comment">// 设置是否已点赞的状态</span></span><br><span class="line">    bo.setLiked(subjectLikedDomainService.isLiked(subjectInfoBO.getId().toString(), LoginUtil.getLoginId()));</span><br><span class="line">    <span class="comment">// 设置点赞数量</span></span><br><span class="line">    bo.setLikedCount(subjectLikedDomainService.getLikedCount(subjectInfoBO.getId().toString()));</span><br><span class="line">    <span class="comment">// 组装题目的上下文信息，如上一个和下一个题目的ID</span></span><br><span class="line">    assembleSubjectCursor(subjectInfoBO, bo);</span><br><span class="line">    <span class="comment">// 返回封装好的业务对象BO</span></span><br><span class="line">    <span class="keyword">return</span> bo;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 私有方法，用于组装题目的上下文信息</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">assembleSubjectCursor</span><span class="params">(SubjectInfoBO subjectInfoBO, SubjectInfoBO bo)</span> &#123;</span><br><span class="line">    <span class="comment">// 获取分类ID、标签ID和题目ID</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">categoryId</span> <span class="operator">=</span> subjectInfoBO.getCategoryId();</span><br><span class="line">    <span class="type">Long</span> <span class="variable">labelId</span> <span class="operator">=</span> subjectInfoBO.getLabelId();</span><br><span class="line">    <span class="type">Long</span> <span class="variable">subjectId</span> <span class="operator">=</span> subjectInfoBO.getId();</span><br><span class="line">    <span class="comment">// 如果分类ID或标签ID为空，则不进行上下文信息的组装</span></span><br><span class="line">    <span class="keyword">if</span> (Objects.isNull(categoryId) || Objects.isNull(labelId)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 查询下一个题目的ID</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">nextSubjectId</span> <span class="operator">=</span> subjectInfoService.querySubjectIdCursor(subjectId, categoryId, labelId, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 设置下一个题目的ID到业务对象BO中</span></span><br><span class="line">    bo.setNextSubjectId(nextSubjectId);</span><br><span class="line">    <span class="comment">// 查询上一个题目的ID</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">lastSubjectId</span> <span class="operator">=</span> subjectInfoService.querySubjectIdCursor(subjectId, categoryId, labelId, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 设置上一个题目的ID到业务对象BO中</span></span><br><span class="line">    bo.setLastSubjectId(lastSubjectId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SubjectInfoDao.xml</code></p>
<p><code>querySubjectIdCursor</code>对应的sql语句</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;querySubjectIdCursor&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;java.lang.Long&quot;</span>&gt;</span></span><br><span class="line">    select a.id</span><br><span class="line">    from subject_info a,</span><br><span class="line">    subject_mapping b</span><br><span class="line">    where a.id = b.subject_id</span><br><span class="line">    and b.category_id = #&#123;categoryId&#125;</span><br><span class="line">    and b.label_id = #&#123;labelId&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;cursor !=null and cursor == 1&quot;</span>&gt;</span></span><br><span class="line">        and a.id &gt; #&#123;subjectId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;cursor !=null and cursor == 0&quot;</span>&gt;</span></span><br><span class="line">        and a.id <span class="symbol">&amp;lt;</span> #&#123;subjectId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    limit 0,1</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">Roger-Lv</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2024/07/10/2024-07-10-%E7%A8%8B%E5%BA%8F%E5%91%98%E7%A4%BE%E5%8C%BA%E9%A1%B9%E7%9B%AE%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/">http://example.com/2024/07/10/2024-07-10-%E7%A8%8B%E5%BA%8F%E5%91%98%E7%A4%BE%E5%8C%BA%E9%A1%B9%E7%9B%AE%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="http://example.com" target="_blank">Roger-Lv's space</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java/">Java</a><a class="post-meta__tags" href="/tags/%E5%90%8E%E7%AB%AF/">后端</a><a class="post-meta__tags" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a></div><div class="post-share"><div class="social-share" data-image="/img/cover/java.gif" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2024/07/17/2024-07-17-Rust%E6%9E%84%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA%E9%A1%B9%E7%9B%AE/" title="Rust构建自己的第一个项目"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/rust.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Rust构建自己的第一个项目</div></div><div class="info-2"><div class="info-item-1">Rust构建自己的第一个项目几个核心命令： cargo new xxx：用于新建项目 cargo build：用于在Cargo.toml中添加dependencies进行依赖的下载和编译 cargo run：用于运行 新建项目在目录下输入下列指令，例如要构建一个叫做hello-rust的项目 1cargo new hello-rust   Cargo 已经帮我们创建好默认项目了，还创建了个git的本地仓库，还有一些配置文件， src/main.rs 为编写应用代码的地方。 运行项目使用cargo run命令运行 1cargo run   可以看到会经历一个编译的过程后，打印出Hello,world！信息 编写Hello-RustCargo.toml文件是一个管理项目配置的文件，包括项目依赖等相关配置 添加配置在dependencies中：  在命令行中运行： 1cargo build   可以看到除了我们自定义添加的ferris-say版本的依赖，还会自动添加好依赖的依赖 接下来就在 src/main.rs 中写入以下内容: 123456789101112use ferris_s...</div></div></div></a><a class="pagination-related" href="/2024/07/10/2024-06-24-Java%E5%85%AB%E8%82%A1/" title="Java八股"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/java.gif" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Java八股</div></div><div class="info-2"><div class="info-item-1">Java八股2024年 Java 面试八股文（20w字）_java八股文2023-CSDN博客 Spring面试被问了几百遍的 IOC 和 AOP ，一篇文章带你搞清楚！！！_ioc和aop的原理面试-CSDN博客 Sentinelsentinel （史上最全）-CSDN博客 Gradle&amp;Mavengradle中的build script详解_gradle buildscript-CSDN博客 [Gradle和Maven的区别-CSDN博客](https://blog.csdn.net/weixin_45626288/article/details/131973787?ops_request_misc=%7B%22request%5Fid%22%3A%22172024305816800185819613%22%2C%22scm%22%3A%2220140713.130102334..%22%7D&amp;request_id=172024305816800185819613&amp;biz_id=0&amp;utm_medium=distribute.pc_search...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2024/07/21/2024-07-21-%E5%90%8E%E7%AB%AF%E5%BE%AE%E6%9C%8D%E5%8A%A1-programmer-club%E9%A1%B9%E7%9B%AE%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E5%BF%83%E5%BE%97/" title="后端微服务-programmer-club项目的设计与实现心得"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/java.gif" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-21</div><div class="info-item-2">后端微服务-programmer-club项目的设计与实现心得</div></div><div class="info-2"><div class="info-item-1">后端微服务-programmer-club项目的设计与实现心得开发工具后端：IDEA 前端：VSCode 项目管理：git 包依赖管理：Maven3.6.0 数据库：Mysql5.7 数据库连接池和监控库：Druid 框架：Springboot 2.4.2 数据库图形化：Navicat 接口管理工具：APIPost7 Redis桌面工具：RedisDesktop 表建模：PDManager 原型设计：axure8 原型组件库: antdesign 代码生成器：easycode（idea的plugin市场） 一些插件：mybatis（类-&gt;dao-&gt;数据库），easycode（由数据库表生成相应代码）, preconditions（参数校验） node.js 阿里云脚手架用于组件&#x2F;版本的选择兼容，非常方便: start.aliyun.com 架构设计传统项目[SpringMVC框架（详解）-CSDN博客](https://blog.csdn.net/H20031011/article/details/131511482?ops_request_misc=%7B...</div></div></div></a><a class="pagination-related" href="/2024/08/25/2024-08-25-xxl-job%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="xxl-job学习笔记"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/java.gif" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-25</div><div class="info-item-2">xxl-job学习笔记</div></div><div class="info-2"><div class="info-item-1">xxl-job学习笔记基础概念xxl-job是一个轻量级分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。现已开放源代码并接入多家公司线上产品线，开箱即用。 任务执行流程 执行流程  任务执行器根据配置的调度中心的地址，自动注册到调度中心  达到任务出发条件，调度中心下发任务  执行器基于线程池执行任务，并把执行结果放入内存队列、把执行日志写入日志文件中  执行器消费内存队列中的执行结果，主动上报给调度中心  当用户在调度中心查看任务日志，调度中心请求任务执行器，任务执行器读取任务日志文件并返回日志详情   搭建xxl-jobxxl-job: 一个分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。现已开放源代码并接入多家公司线上产品线，开箱即用。 (gitee.com) 使用docker搭建xxl-job12345678910111213docker search xxl-jobdocker pull xuxueli/xxl-job-admin:2.4.0docker run  -d \        -p 8088:8088\    ...</div></div></div></a><a class="pagination-related" href="/2024/08/06/2024-08-06-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%95%B0%E9%87%8F%E5%88%B0%E5%BA%95%E5%A6%82%E4%BD%95%E9%85%8D%E7%BD%AE%EF%BC%9F/" title="线程池数量到底如何配置？"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/java.gif" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-06</div><div class="info-item-2">线程池数量到底如何配置？</div></div><div class="info-2"><div class="info-item-1">线程池数量到底如何配置？可能很多人都看到过一个线程数设置的理论:  CPU 密集型的程序-核心数 +1 1&#x2F;0 密集型的程序-核心数*2  不会吧，不会吧，真的有人按照这个理论规划线程数? 线程数和CPU利用率的小测试抛开一些操作系统，计算机原理不谈，说一个基本的理论(不用纠结是否严谨，只为好理解)： 一个CPU核心，单位时间内只能执行一个线程的指令那么理论上，我一个线程只需要不停的执行指令，就可以跑满一个核心的利用率。 来写个死循环空跑的例子验证一下： 1234567public class CPUUtilizationTest&#123;	public static void main(String[] args)&#123;//死循环，什么都不做		while(true)&#123;			&#125;	&#125;&#125;    测试CPU：6核心12线程 现在的CPU利用率：  从图上可以看到，3号核心利用率已经被跑满了 基于上面的理论，多开几个线程试试呢? 123456789101112public class CPUUtilizationTest&#12...</div></div></div></a><a class="pagination-related" href="/2024/08/06/2024-08-06-Java%E9%9D%A2%E8%AF%95%E6%B1%87%E6%80%BB/" title="Java面试汇总"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/java.gif" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-06</div><div class="info-item-2">Java面试汇总</div></div><div class="info-2"><div class="info-item-1">Java面试汇总项目问题数联网交换机Netty核心面试题20连问，由浅入深 助你轻松吊打面试官_netty面试题-CSDN博客 Tomcat与Netty比较_netty和tomcat-CSDN博客 programmer club后端微服务-programmer-club项目的设计与实现心得 | Roger-Lv’s space 项目介绍​	大家在求职的过程中，免不了要进行面试题的学习，网上的pdf 很多，大家一般都是基于此来进行背诵或者收集，重复的题目及答案的质量参差不齐，这个个人项目，做一个线上化的面试题网站，来进行资源整合。学习面试的同时，将所学习的技术结合到一起。我们采用的是主流的微服务架构 alibaba，配合主流的中间件，前端主要是以 react 配合 antdesiqn 来进行，以C端为主的一个网站形式。叫他programmer_club，整体为一个社区的形式，主要实现的功能有刷题，练题，交流群，模拟面试。我在这里面设计技术选型，架构设计，功能的设计及落地。其中刷题模块、登录注册鉴权等模块以及优化等是我来进行主要落地实现的。 使用DDD（领域驱动设计)的原因主要有以下...</div></div></div></a><a class="pagination-related" href="/2024/08/07/2024-08-07-Java%E7%BA%BF%E7%A8%8B%E3%80%81%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%80%BB%E7%BB%93/" title="Java线程、多线程与线程池总结"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/java.gif" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-07</div><div class="info-item-2">Java线程、多线程与线程池总结</div></div><div class="info-2"><div class="info-item-1">Java线程、多线程与线程池总结Java创建线程的三种方法 继承Thread类创建线程类 （extends）  定义Thread类的子类，并重写该类的run方法，该run方法的方法体就代表了线程要完成的任务。因此把run()方法称为执行体(线程体)。  创建Thread子类的实例，即创建了线程对象。  调用线程对象的start()方法来启动该线程。  123456789101112131415public class CreateThreadByExtendThread extends Thread&#123;    int i = 0;    @Override    public void run()&#123;        for (;i&lt;100;i++)&#123;            System.out.println(Thread.currentThread().getName()+&quot;:&quot;+i); //获取本线程的名称        &#125;    &#125;    public static void main(String[]...</div></div></div></a><a class="pagination-related" href="/2024/08/08/2024-08-08-Java%E7%9A%84Stream%E6%B5%81/" title="Java的Stream流"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/java.gif" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-08</div><div class="info-item-2">Java的Stream流</div></div><div class="info-2"><div class="info-item-1">Java的Stream流[讲透JAVA Stream的collect用法与原理，远比你想象的更强大_stream.collection-CSDN博客](https://blog.csdn.net/veezean/article/details/125857074?ops_request_misc=%7B%22request%5Fid%22%3A%22172258578116800227423214%22%2C%22scm%22%3A%2220140713.130102334..%22%7D&amp;request_id=172258578116800227423214&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-125857074-null-null.142^v100^pc_search_result_base8&amp;utm_term=Java stream collect&amp;spm&#x3D;1018.2226.3...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Roger-Lv</div><div class="author-info-description">Send a flare and light the way.</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">85</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">108</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">25</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Roger-Lv"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/Roger-Lv" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:1150568956@qq.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://www.linkedin.com/in/zhongrenjie-lv-5588a928a/" target="_blank" title="LinkedIn"><i class="iconfont icon-linkedin-fill"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">Welcome!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E5%91%98%E7%A4%BE%E5%8C%BA%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.</span> <span class="toc-text">程序员社区项目</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.1.</span> <span class="toc-text">开发模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7"><span class="toc-number">1.2.</span> <span class="toc-text">开发工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.3.</span> <span class="toc-text">架构设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.3.1.</span> <span class="toc-text">传统项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%B0%E6%9C%89%E7%9A%84%E6%9E%B6%E6%9E%84"><span class="toc-number">1.3.2.</span> <span class="toc-text">现有的架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.3.</span> <span class="toc-text">项目结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E9%A1%B9%E7%9B%AE%E7%9B%AE%E5%BD%95%EF%BC%88backend%EF%BC%89"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">后端项目目录（backend）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B"><span class="toc-number">1.4.</span> <span class="toc-text">技术选型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">1.5.</span> <span class="toc-text">服务器中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker%E5%AE%89%E8%A3%85"><span class="toc-number">1.5.1.</span> <span class="toc-text">Docker安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker%E5%AE%89%E8%A3%85mysql"><span class="toc-number">1.5.2.</span> <span class="toc-text">Docker安装mysql</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Maven%E9%85%8D%E7%BD%AE%E5%9B%BD%E5%86%85%E6%BA%90"><span class="toc-number">1.5.3.</span> <span class="toc-text">Maven配置国内源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker%E5%AE%89%E8%A3%85Jenkins"><span class="toc-number">1.5.4.</span> <span class="toc-text">Docker安装Jenkins</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#yum%E5%AE%89%E8%A3%85JDK"><span class="toc-number">1.5.5.</span> <span class="toc-text">yum安装JDK</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker%E5%AE%89%E8%A3%85minio%EF%BC%8C%E6%90%AD%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84oss%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">1.5.6.</span> <span class="toc-text">Docker安装minio，搭建自己的oss服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Docker%E5%AE%89%E8%A3%85miniomc%E7%AA%81%E7%A0%B47%E5%A4%A9%E9%99%90%E5%88%B6"><span class="toc-number">1.5.6.1.</span> <span class="toc-text">Docker安装miniomc突破7天限制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker%E6%9F%A5%E7%9C%8B%E8%BF%90%E8%A1%8C%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">1.5.7.</span> <span class="toc-text">Docker查看运行容器启动命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker%E5%AE%89%E8%A3%85nacos"><span class="toc-number">1.5.8.</span> <span class="toc-text">Docker安装nacos</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker%E5%AE%89%E8%A3%85Redis"><span class="toc-number">1.5.9.</span> <span class="toc-text">Docker安装Redis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker%E5%AE%89%E8%A3%85es"><span class="toc-number">1.5.10.</span> <span class="toc-text">Docker安装es</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#docker%E5%AE%89%E8%A3%85xxl-job"><span class="toc-number">1.5.11.</span> <span class="toc-text">docker安装xxl-job</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rocketmq%E5%AE%89%E8%A3%85"><span class="toc-number">1.5.12.</span> <span class="toc-text">rocketmq安装</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86"><span class="toc-number">1.6.</span> <span class="toc-text">第一部分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8"><span class="toc-number">1.6.1.</span> <span class="toc-text">数据库表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E5%BB%BA%E6%A8%A1JSON"><span class="toc-number">1.6.1.1.</span> <span class="toc-text">数据库表建模JSON</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%B7%E9%A2%98%E6%A8%A1%E5%9D%97%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.6.1.2.</span> <span class="toc-text">刷题模块数据模型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%88%B7%E9%A2%98%E6%A8%A1%E5%9D%97%EF%BC%88%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%9D%97%EF%BC%89"><span class="toc-number">1.6.2.</span> <span class="toc-text">1.刷题模块（微服务模块）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%A7%E5%93%81%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97"><span class="toc-number">1.6.2.1.</span> <span class="toc-text">产品功能模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A0%94%E5%8F%91%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97%E6%8B%86%E5%88%86"><span class="toc-number">1.6.2.2.</span> <span class="toc-text">研发功能模块拆分</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E5%9E%8B%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.6.2.3.</span> <span class="toc-text">原型设计</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%B7%E9%A2%98%E9%A6%96%E9%A1%B5"><span class="toc-number">1.6.2.3.1.</span> <span class="toc-text">刷题首页</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E8%AF%A6%E6%83%85"><span class="toc-number">1.6.2.3.2.</span> <span class="toc-text">题目详情</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E7%B1%BB%E6%A8%A1%E5%9D%97"><span class="toc-number">1.6.2.4.</span> <span class="toc-text">分类模块</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E%E5%88%86%E7%B1%BB"><span class="toc-number">1.6.2.4.1.</span> <span class="toc-text">新增分类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%88%86%E7%B1%BB"><span class="toc-number">1.6.2.4.2.</span> <span class="toc-text">修改分类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E5%88%86%E7%B1%BB"><span class="toc-number">1.6.2.4.3.</span> <span class="toc-text">删除分类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%A6%96%E9%A1%B5%E7%9A%84%E5%88%86%E7%B1%BB"><span class="toc-number">1.6.2.4.4.</span> <span class="toc-text">首页的分类</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%87%E7%AD%BE%E8%AF%A6%E7%BB%86%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.6.2.5.</span> <span class="toc-text">标签详细设计</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E%E6%A0%87%E7%AD%BE"><span class="toc-number">1.6.2.5.1.</span> <span class="toc-text">新增标签</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%A0%87%E7%AD%BE"><span class="toc-number">1.6.2.5.2.</span> <span class="toc-text">修改标签</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%A0%87%E7%AD%BE"><span class="toc-number">1.6.2.5.3.</span> <span class="toc-text">删除标签</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A0%87%E7%AD%BE%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.6.2.5.4.</span> <span class="toc-text">标签查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E6%A8%A1%E5%9D%97"><span class="toc-number">1.6.2.6.</span> <span class="toc-text">题目模块</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E%E9%A2%98%E7%9B%AE"><span class="toc-number">1.6.2.6.1.</span> <span class="toc-text">新增题目</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%A2%98%E7%9B%AE"><span class="toc-number">1.6.2.6.2.</span> <span class="toc-text">修改题目</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E9%A2%98%E7%9B%AE"><span class="toc-number">1.6.2.6.3.</span> <span class="toc-text">删除题目</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E5%88%97%E8%A1%A8"><span class="toc-number">1.6.2.6.4.</span> <span class="toc-text">题目列表</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E7%9A%84%E8%AF%A6%E6%83%85"><span class="toc-number">1.6.2.6.5.</span> <span class="toc-text">题目的详情</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%B7%E9%A2%98%E6%A8%A1%E5%9D%97%E4%BB%A3%E7%A0%81%E7%9A%84%E5%AE%9E%E7%8E%B0%EF%BC%88jc-club-subject%EF%BC%89"><span class="toc-number">1.6.2.7.</span> <span class="toc-text">刷题模块代码的实现（jc-club-subject）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#application%E5%B1%82%E7%9A%84SubjectController%EF%BC%88%E5%BA%94%E7%94%A8%E5%B1%82%E5%88%9D%E6%8E%A2-SpringMVC%E9%9B%86%E6%88%90%EF%BC%89"><span class="toc-number">1.6.2.7.1.</span> <span class="toc-text">application层的SubjectController（应用层初探&amp;SpringMVC集成）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#mysql-druid-mybatis%E9%9B%86%E6%88%90-infrastructure%E5%B1%82"><span class="toc-number">1.6.2.7.2.</span> <span class="toc-text">mysql,druid,mybatis集成(infrastructure层)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Edruid%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%8A%A0%E5%AF%86%EF%BC%88infra%E4%B8%AD%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB%EF%BC%89"><span class="toc-number">1.6.2.7.3.</span> <span class="toc-text">基于druid配置文件加密（infra中的工具类）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84%E4%B8%9A%E5%8A%A1%E5%BC%80%E5%8F%91"><span class="toc-number">1.6.2.7.4.</span> <span class="toc-text">分层架构业务开发</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E5%88%86%E7%B1%BB-SubjectCategoryController-java"><span class="toc-number">1.6.2.7.4.1.</span> <span class="toc-text">题目分类(SubjectCategoryController.java)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%B7%E9%A2%98%E6%A8%A1%E5%9D%97%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-number">1.6.2.7.4.2.</span> <span class="toc-text">刷题模块接口定义</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E5%88%97%E8%A1%A8%E5%8F%8A%E8%AF%A6%E6%83%85%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-number">1.6.2.7.4.3.</span> <span class="toc-text">题目列表及详情接口定义</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%86%E7%B1%BB%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="toc-number">1.6.2.7.4.4.</span> <span class="toc-text">分类接口开发</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E6%A0%87%E7%AD%BE%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-number">1.6.2.7.4.5.</span> <span class="toc-text">题目标签接口定义</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%A0%87%E7%AD%BE%E5%9F%BA%E7%A1%80%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91"><span class="toc-number">1.6.2.7.4.6.</span> <span class="toc-text">标签基础模块开发</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%A0%87%E7%AD%BE%E4%B8%9A%E5%8A%A1%E6%94%B9%E5%8A%A8"><span class="toc-number">1.6.2.7.4.7.</span> <span class="toc-text">标签业务改动</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E6%A8%A1%E5%9D%97%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-number">1.6.2.7.4.8.</span> <span class="toc-text">题目模块接口定义</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E6%A8%A1%E5%9D%97%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="toc-number">1.6.2.7.4.9.</span> <span class="toc-text">题目模块接口开发</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2"><span class="toc-number">1.6.3.</span> <span class="toc-text">部署</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E9%83%A8%E7%BD%B2%E5%BD%A2%E5%BC%8F"><span class="toc-number">1.6.3.1.</span> <span class="toc-text">传统部署形式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CI-CD-jenkins%E8%87%AA%E5%8A%A8%E6%89%93%E5%8C%85%E9%9B%86%E6%88%90%E5%92%8C%E9%83%A8%E7%BD%B2"><span class="toc-number">1.6.3.2.</span> <span class="toc-text">CI&#x2F;CD jenkins自动打包集成和部署</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-OSS%E6%A8%A1%E5%9D%97-jc-club-oss"><span class="toc-number">1.6.4.</span> <span class="toc-text">2. OSS模块(jc-club-oss)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#OSS%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.6.4.1.</span> <span class="toc-text">OSS模块设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#minio%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91"><span class="toc-number">1.6.4.2.</span> <span class="toc-text">minio模块开发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OSS%E6%A8%A1%E5%9D%97%E9%85%8D%E5%90%88nacos%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81%E5%88%87%E6%8D%A2"><span class="toc-number">1.6.4.3.</span> <span class="toc-text">OSS模块配合nacos实现动态切换</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9B%86%E6%88%90naocs%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE"><span class="toc-number">1.6.4.3.1.</span> <span class="toc-text">集成naocs动态配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%99%BB%E5%BD%95%E9%89%B4%E6%9D%83%E6%A8%A1%E5%9D%97"><span class="toc-number">1.6.5.</span> <span class="toc-text">3. 登录鉴权模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B-1"><span class="toc-number">1.6.5.1.</span> <span class="toc-text">技术选型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%89%B4%E6%9D%83%E8%AE%BE%E8%AE%A1-RBAC%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.6.5.2.</span> <span class="toc-text">鉴权设计-RBAC模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%89%B4%E6%9D%83%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.6.5.3.</span> <span class="toc-text">鉴权数据模型设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%89%B4%E6%9D%83%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.6.5.4.</span> <span class="toc-text">鉴权架构设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%89%B4%E6%9D%83%E5%8A%9F%E8%83%BD%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.6.5.5.</span> <span class="toc-text">鉴权功能设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#auth%E6%A8%A1%E5%9D%97%E9%85%8D%E7%BD%AE"><span class="toc-number">1.6.5.6.</span> <span class="toc-text">auth模块配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%99%BB%E5%BD%95-%E8%AF%A6%E6%83%85%E5%9C%A8%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97"><span class="toc-number">1.6.5.7.</span> <span class="toc-text">登录(详情在用户模块)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%88%B0nacos"><span class="toc-number">1.6.5.8.</span> <span class="toc-text">微服务注册到nacos</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#oss%E6%9C%8D%E5%8A%A1-nacos"><span class="toc-number">1.6.5.8.1.</span> <span class="toc-text">oss服务-&gt;nacos</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%88gateway-nacos%EF%BC%89Spring-Cloud-Gateway%E6%90%AD%E5%BB%BA%E5%8F%8A%E8%B7%AF%E7%94%B1%E9%85%8D%E7%BD%AE"><span class="toc-number">1.6.5.8.2.</span> <span class="toc-text">（gateway-&gt;nacos）Spring Cloud Gateway搭建及路由配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%89%B4%E6%9D%83-%E5%88%B7%E9%A2%98-nacos"><span class="toc-number">1.6.5.8.3.</span> <span class="toc-text">鉴权+刷题-&gt;nacos</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Sa-Token%E9%9B%86%E6%88%90Redis"><span class="toc-number">1.6.5.9.</span> <span class="toc-text">Sa-Token集成Redis</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gateway%E7%BD%91%E5%85%B3%EF%BC%88sa-token%EF%BC%89%E5%9F%BA%E4%BA%8Eredis%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E4%BC%9A%E8%AF%9D%E9%89%B4%E6%9D%83"><span class="toc-number">1.6.5.10.</span> <span class="toc-text">gateway网关（sa-token）基于redis实现分布式会话鉴权</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E5%85%B3%E5%85%A8%E5%B1%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%EF%BC%88sa-token-mono%EF%BC%89"><span class="toc-number">1.6.5.11.</span> <span class="toc-text">网关全局异常处理（sa-token mono）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gateway%E5%AE%9E%E7%8E%B0redis%E6%9D%83%E9%99%90%E6%95%B0%E6%8D%AE%E6%8B%89%E5%8F%96-gateway"><span class="toc-number">1.6.5.12.</span> <span class="toc-text">gateway实现redis权限数据拉取(gateway)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91-auth-user"><span class="toc-number">1.6.5.13.</span> <span class="toc-text">用户模块开发(auth_user)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#controller%E5%8C%85"><span class="toc-number">1.6.5.13.1.</span> <span class="toc-text">controller包</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#domain%E5%8C%85"><span class="toc-number">1.6.5.13.2.</span> <span class="toc-text">domain包</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#infra%E5%B1%82"><span class="toc-number">1.6.5.13.3.</span> <span class="toc-text">infra层</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E5%8A%A0%E5%AF%86-%E5%AF%86%E7%A0%81%E5%8A%A0%E5%AF%86"><span class="toc-number">1.6.5.13.4.</span> <span class="toc-text">常见加密&amp;密码加密</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%92%E8%89%B2%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91-auth-role"><span class="toc-number">1.6.5.14.</span> <span class="toc-text">角色模块开发(auth_role)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#controller"><span class="toc-number">1.6.5.14.1.</span> <span class="toc-text">controller</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#domain"><span class="toc-number">1.6.5.14.2.</span> <span class="toc-text">domain</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#infra%E5%B1%82-1"><span class="toc-number">1.6.5.14.3.</span> <span class="toc-text">infra层</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E8%A7%92%E8%89%B2%E5%85%B3%E8%81%94-user-role-%E8%BF%99%E9%87%8C%E4%B8%BB%E8%A6%81%E6%98%AFinfra%E5%B1%82%E7%9A%84%E4%B8%9C%E8%A5%BF"><span class="toc-number">1.6.5.15.</span> <span class="toc-text">用户角色关联(user_role,这里主要是infra层的东西)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#controller%EF%BC%88UserController%E7%9A%84%E6%B3%A8%E5%86%8C%E6%A8%A1%E5%9D%97%EF%BC%89"><span class="toc-number">1.6.5.15.1.</span> <span class="toc-text">controller（UserController的注册模块）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#domain-1"><span class="toc-number">1.6.5.15.2.</span> <span class="toc-text">domain</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#infra%E5%B1%82-2"><span class="toc-number">1.6.5.15.3.</span> <span class="toc-text">infra层</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91-auth-permission"><span class="toc-number">1.6.5.16.</span> <span class="toc-text">权限模块开发(auth_permission)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#controller%E5%B1%82"><span class="toc-number">1.6.5.16.1.</span> <span class="toc-text">controller层</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#domain%E5%B1%82"><span class="toc-number">1.6.5.16.2.</span> <span class="toc-text">domain层</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#infra%E5%B1%82-3"><span class="toc-number">1.6.5.16.3.</span> <span class="toc-text">infra层</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%92%E8%89%B2%E6%9D%83%E9%99%90%E5%85%B3%E8%81%94%E5%BC%80%E5%8F%91%EF%BC%88auth-role-permission%EF%BC%89"><span class="toc-number">1.6.5.17.</span> <span class="toc-text">角色权限关联开发（auth_role_permission）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#controller-1"><span class="toc-number">1.6.5.17.1.</span> <span class="toc-text">controller</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#domain%E5%B1%82-1"><span class="toc-number">1.6.5.17.2.</span> <span class="toc-text">domain层</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#infra%E5%B1%82-4"><span class="toc-number">1.6.5.17.3.</span> <span class="toc-text">infra层</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E4%B8%8E%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98%EF%BC%88%E5%BB%B6%E8%BF%9F%E5%8F%8C%E5%88%A0%EF%BC%89"><span class="toc-number">1.6.5.18.</span> <span class="toc-text">缓存与数据一致性问题（延迟双删）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E5%85%B3%E4%B8%8Eauth%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BC%93%E5%AD%98%E6%89%93%E9%80%9A"><span class="toc-number">1.6.5.19.</span> <span class="toc-text">网关与auth微服务缓存打通</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E5%BC%80%E5%8F%91%EF%BC%88%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7%EF%BC%8C%E6%B5%8B%E8%AF%95%E5%8F%B7%EF%BC%89"><span class="toc-number">1.6.5.20.</span> <span class="toc-text">登录开发（微信公众号，测试号）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B"><span class="toc-number">1.6.5.20.1.</span> <span class="toc-text">登录流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.6.5.20.2.</span> <span class="toc-text">服务设计</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%AC%E4%BC%97%E5%8F%B7%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3"><span class="toc-number">1.6.5.20.3.</span> <span class="toc-text">公众号开发文档</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%AC%E4%BC%97%E5%8F%B7%E9%AA%8C%E7%AD%BE%E5%BC%80%E5%8F%91"><span class="toc-number">1.6.5.20.4.</span> <span class="toc-text">公众号验签开发</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%EF%BC%88natapp%EF%BC%89"><span class="toc-number">1.6.5.20.5.</span> <span class="toc-text">内网穿透（natapp）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%91%E5%90%AC%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA-%E8%87%AA%E5%8A%A8%E5%9B%9E%E5%A4%8D%E6%B6%88%E6%81%AF-%E6%B6%88%E6%81%AF%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC-%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F%E5%AE%9E%E7%8E%B0%E8%A7%A3%E8%80%A6"><span class="toc-number">1.6.5.20.6.</span> <span class="toc-text">监听用户行为&amp;自动回复消息(消息事件监听+策略模式实现解耦)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#controller-2"><span class="toc-number">1.6.5.20.6.1.</span> <span class="toc-text">controller</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Utils"><span class="toc-number">1.6.5.20.6.2.</span> <span class="toc-text">Utils</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#handler"><span class="toc-number">1.6.5.20.6.3.</span> <span class="toc-text">handler</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#redis"><span class="toc-number">1.6.5.20.6.4.</span> <span class="toc-text">redis</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%AC%E4%BC%97%E5%8F%B7%E7%99%BB%E5%BD%95%E9%AA%8C%E8%AF%81%E7%A0%81%E9%80%BB%E8%BE%91"><span class="toc-number">1.6.5.20.7.</span> <span class="toc-text">公众号登录验证码逻辑</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86"><span class="toc-number">1.7.</span> <span class="toc-text">第二部分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E5%90%8E%E7%AB%AF%E9%83%A8%E7%BD%B2"><span class="toc-number">1.7.1.</span> <span class="toc-text">前后端部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%86%E8%8A%82%E4%BC%98%E5%8C%96"><span class="toc-number">1.7.2.</span> <span class="toc-text">细节优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E9%81%BF%E5%85%8D%E9%87%8D%E5%A4%8D%E6%B3%A8%E5%86%8C"><span class="toc-number">1.7.2.1.</span> <span class="toc-text">1. 避免重复注册</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E4%B8%AA%E4%BA%BA%E4%BF%A1%E6%81%AF%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.7.2.2.</span> <span class="toc-text">2.个人信息查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E7%94%A8%E6%88%B7%E9%80%80%E5%87%BA"><span class="toc-number">1.7.2.3.</span> <span class="toc-text">3.用户退出</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E7%94%A8%E6%88%B7%E4%B8%8A%E4%BC%A0%E5%A4%B4%E5%83%8F"><span class="toc-number">1.7.2.4.</span> <span class="toc-text">4. 用户上传头像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E5%88%86%E7%B1%BB%E9%A2%98%E7%9B%AE%E6%95%B0%E9%87%8F%E6%9B%B4%E6%96%B0"><span class="toc-number">1.7.2.5.</span> <span class="toc-text">5.分类题目数量更新</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E5%88%86%E7%B1%BB%E6%A0%87%E7%AD%BE%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-star"><span class="toc-number">1.7.2.6.</span> <span class="toc-text">6. 分类标签性能优化:star:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E8%8E%B7%E5%8F%96"><span class="toc-number">1.7.2.7.</span> <span class="toc-text">7. 用户权限获取</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-%E5%88%A9%E7%94%A8minio-mc%E7%AA%81%E7%A0%B4%E5%9B%BE%E7%89%877%E5%A4%A9%E6%9D%83%E9%99%90"><span class="toc-number">1.7.2.8.</span> <span class="toc-text">8. 利用minio&#x2F;mc突破图片7天权限</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E8%A7%84%E5%88%92"><span class="toc-number">1.7.3.</span> <span class="toc-text">功能规划</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E5%8A%9F%E8%83%BD%EF%BC%88%E5%AE%8C%E6%88%90%EF%BC%89"><span class="toc-number">1.7.3.1.</span> <span class="toc-text">搜索功能（完成）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%82%B9%E8%B5%9E%EF%BC%88%E5%AE%8C%E6%88%90%EF%BC%89"><span class="toc-number">1.7.3.2.</span> <span class="toc-text">点赞（完成）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%88%91%E7%9A%84%E7%82%B9%E8%B5%9E%EF%BC%88%E5%AE%8C%E6%88%90%EF%BC%89"><span class="toc-number">1.7.3.3.</span> <span class="toc-text">我的点赞（完成）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%B6%E8%97%8F%EF%BC%88%E5%AE%8C%E6%88%90%EF%BC%89"><span class="toc-number">1.7.3.4.</span> <span class="toc-text">收藏（完成）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%88%91%E7%9A%84%E6%94%B6%E8%97%8F%EF%BC%88%E5%AE%8C%E6%88%90%EF%BC%89"><span class="toc-number">1.7.3.5.</span> <span class="toc-text">我的收藏（完成）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%A0%E9%94%99%EF%BC%88%E5%AE%8C%E6%88%90%EF%BC%89"><span class="toc-number">1.7.3.6.</span> <span class="toc-text">纠错（完成）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E5%88%B7%E9%A2%98%EF%BC%88%E5%AE%8C%E6%88%90%EF%BC%89"><span class="toc-number">1.7.3.7.</span> <span class="toc-text">快速刷题（完成）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B4%A1%E7%8C%AE%E6%A6%9C%EF%BC%88%E5%AE%8C%E6%88%90%EF%BC%89"><span class="toc-number">1.7.3.8.</span> <span class="toc-text">贡献榜（完成）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#feign-%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%97%B4%E8%B0%83%E7%94%A8%EF%BC%88%E5%AE%8C%E6%88%90%EF%BC%89"><span class="toc-number">1.7.3.9.</span> <span class="toc-text">feign 的微服务间调用（完成）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%93%E9%80%9A%E7%94%A8%E6%88%B7%E4%B8%8A%E4%B8%8B%E6%96%87%EF%BC%88%E5%AE%8C%E6%88%90%EF%BC%89"><span class="toc-number">1.7.3.10.</span> <span class="toc-text">打通用户上下文（完成）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%E7%BA%A7%E7%BC%93%E5%AD%98%E7%9A%84%E4%BD%BF%E7%94%A8%EF%BC%88%E5%AE%8C%E6%88%90%EF%BC%89"><span class="toc-number">1.7.3.11.</span> <span class="toc-text">二级缓存的使用（完成）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E4%B8%8A%E4%B8%8B%E6%96%87%E6%89%93%E9%80%9A"><span class="toc-number">1.7.4.</span> <span class="toc-text">用户上下文打通</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#gateway%E7%BD%91%E5%85%B3%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8B%A6%E6%88%AAheader"><span class="toc-number">1.7.4.1.</span> <span class="toc-text">gateway网关自定义拦截header</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8EthreadLocal%E5%AE%9E%E7%8E%B0%E4%B8%8A%E4%B8%8B%E6%96%87%E4%BC%A0%E9%80%92"><span class="toc-number">1.7.4.2.</span> <span class="toc-text">基于threadLocal实现上下文传递</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8B%E9%97%B4%E7%9A%84Feign%E8%B0%83%E7%94%A8"><span class="toc-number">1.7.4.3.</span> <span class="toc-text">微服务之间的Feign调用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#guava%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98-%E5%B7%B2%E7%BB%8F%E5%8D%87%E7%BA%A7%E6%88%90Caffiene"><span class="toc-number">1.7.5.</span> <span class="toc-text">guava本地缓存(已经升级成Caffiene)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2%E5%8A%9F%E8%83%BD"><span class="toc-number">1.7.6.</span> <span class="toc-text">全文检索功能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.7.6.1.</span> <span class="toc-text">功能设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E6%93%8D%E4%BD%9C"><span class="toc-number">1.7.6.2.</span> <span class="toc-text">实际操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#es%E5%88%86%E8%AF%8D%E9%97%AE%E9%A2%98"><span class="toc-number">1.7.6.3.</span> <span class="toc-text">es分词问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81-%E8%AF%95%E6%89%8B"><span class="toc-number">1.7.6.4.</span> <span class="toc-text">编码: 试手</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E5%B0%81%E8%A3%85es%E9%9B%86%E7%BE%A4%E8%BF%9E%E6%8E%A5%E7%BB%9F%E4%B8%80%E7%AE%A1%E7%90%86"><span class="toc-number">1.7.6.5.</span> <span class="toc-text">编码：自定义封装es集群连接统一管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E%E9%A2%98%E7%9B%AE%E5%90%8C%E6%AD%A5%E5%88%B0es-%E5%B8%A6%E9%AB%98%E4%BA%AE%E7%9A%84%E7%BD%91%E7%AB%99%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2"><span class="toc-number">1.7.6.6.</span> <span class="toc-text">新增题目同步到es+带高亮的网站全文搜索</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%8B%E5%86%99Mybatis%E6%8B%A6%E6%88%AA%E5%99%A8%E8%87%AA%E5%8A%A8%E5%A1%AB%E5%85%85%E6%95%B0%E6%8D%AE-%E6%96%B9%E6%B3%95%E7%BA%A7%E5%88%AB%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">1.7.7.</span> <span class="toc-text">手写Mybatis拦截器自动填充数据(方法级别拦截器)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E6%8E%92%E8%A1%8C%E6%A6%9C%E5%8A%9F%E8%83%BD%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.7.8.</span> <span class="toc-text">题目排行榜功能设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E7%8E%B0%E6%8E%92%E8%A1%8C%E6%A6%9C"><span class="toc-number">1.7.8.1.</span> <span class="toc-text">传统数据库实现排行榜</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Eredis%E7%9A%84zset%E5%AE%9E%E7%8E%B0%E6%8E%92%E8%A1%8C%E6%A6%9C"><span class="toc-number">1.7.8.2.</span> <span class="toc-text">基于redis的zset实现排行榜</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%82%B9%E8%B5%9E%E5%92%8C%E6%94%B6%E8%97%8F"><span class="toc-number">1.7.9.</span> <span class="toc-text">点赞和收藏</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%82%B9%E8%B5%9E%E5%92%8C%E6%94%B6%E8%97%8F%E5%8A%9F%E8%83%BD%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.7.9.1.</span> <span class="toc-text">点赞和收藏功能设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%82%B9%E8%B5%9E%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91"><span class="toc-number">1.7.9.2.</span> <span class="toc-text">点赞功能开发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E8%AF%A6%E6%83%85%E5%A2%9E%E5%8A%A0%E7%82%B9%E8%B5%9E%E6%95%B0%E6%8D%AE"><span class="toc-number">1.7.9.3.</span> <span class="toc-text">题目详情增加点赞数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#xxljob%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%AE%8C%E6%88%90"><span class="toc-number">1.7.9.4.</span> <span class="toc-text">xxljob定时任务完成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%88%91%E7%9A%84%E7%82%B9%E8%B5%9E%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91"><span class="toc-number">1.7.9.5.</span> <span class="toc-text">我的点赞功能开发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E5%88%B7%E9%A2%98%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91"><span class="toc-number">1.7.9.6.</span> <span class="toc-text">快速刷题功能开发</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/08/13/2025-08-13-Shall-We-Pretrain-Autoregressive-Language-Models-with-Retrieval/" title="Shall We Pretrain Autoregressive Language Models with Retrieval"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/LLM.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Shall We Pretrain Autoregressive Language Models with Retrieval"/></a><div class="content"><a class="title" href="/2025/08/13/2025-08-13-Shall-We-Pretrain-Autoregressive-Language-Models-with-Retrieval/" title="Shall We Pretrain Autoregressive Language Models with Retrieval">Shall We Pretrain Autoregressive Language Models with Retrieval</a><time datetime="2025-08-12T16:00:00.000Z" title="发表于 2025-08-13 00:00:00">2025-08-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/08/13/2025-08-13-%E6%BC%AB%E8%B0%88%20LLM%20%E8%A7%A3%E7%A0%81%E7%AD%96%E7%95%A5%EF%BC%9A%E9%87%87%E6%A0%B7%E7%AD%96%E7%95%A5%EF%BC%88%E8%B4%AA%E5%BF%83%E8%A7%A3%E7%A0%81%E3%80%81%E9%9A%8F%E6%9C%BA%E9%87%87%E6%A0%B7%E3%80%81Top-K%20%E9%87%87%E6%A0%B7%E3%80%81Top-P%20%E9%87%87%E6%A0%B7%E3%80%81%E6%A0%B8%E9%87%87%E6%A0%B7%EF%BC%89%E5%92%8C%E6%90%9C%E7%B4%A2%E7%AD%96%E7%95%A5%EF%BC%88%20Beam%20Search%EF%BC%89/" title="漫谈 LLM 解码策略-采样策略（贪心解码、随机采样、Top-K 采样、Top-P 采样、核采样）和搜索策略（ Beam Search）"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/LLM.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="漫谈 LLM 解码策略-采样策略（贪心解码、随机采样、Top-K 采样、Top-P 采样、核采样）和搜索策略（ Beam Search）"/></a><div class="content"><a class="title" href="/2025/08/13/2025-08-13-%E6%BC%AB%E8%B0%88%20LLM%20%E8%A7%A3%E7%A0%81%E7%AD%96%E7%95%A5%EF%BC%9A%E9%87%87%E6%A0%B7%E7%AD%96%E7%95%A5%EF%BC%88%E8%B4%AA%E5%BF%83%E8%A7%A3%E7%A0%81%E3%80%81%E9%9A%8F%E6%9C%BA%E9%87%87%E6%A0%B7%E3%80%81Top-K%20%E9%87%87%E6%A0%B7%E3%80%81Top-P%20%E9%87%87%E6%A0%B7%E3%80%81%E6%A0%B8%E9%87%87%E6%A0%B7%EF%BC%89%E5%92%8C%E6%90%9C%E7%B4%A2%E7%AD%96%E7%95%A5%EF%BC%88%20Beam%20Search%EF%BC%89/" title="漫谈 LLM 解码策略-采样策略（贪心解码、随机采样、Top-K 采样、Top-P 采样、核采样）和搜索策略（ Beam Search）">漫谈 LLM 解码策略-采样策略（贪心解码、随机采样、Top-K 采样、Top-P 采样、核采样）和搜索策略（ Beam Search）</a><time datetime="2025-08-12T16:00:00.000Z" title="发表于 2025-08-13 00:00:00">2025-08-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/08/13/FAISS/" title="Faiss入门及应用经验记录"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/LLM.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Faiss入门及应用经验记录"/></a><div class="content"><a class="title" href="/2025/08/13/FAISS/" title="Faiss入门及应用经验记录">Faiss入门及应用经验记录</a><time datetime="2025-08-12T16:00:00.000Z" title="发表于 2025-08-13 00:00:00">2025-08-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/08/13/Linux%E4%B8%AD%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6%EF%BC%8C%E8%BD%AF%E7%A1%AC%E4%BB%B6%E5%88%86%E5%88%AB%E5%8F%91%E7%94%9F%E4%BB%80%E4%B9%88%EF%BC%9F/" title="Linux中读取文件,软硬件分别发生什么"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/%E5%B9%B6%E8%A1%8C%E8%AE%A1%E7%AE%97.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux中读取文件,软硬件分别发生什么"/></a><div class="content"><a class="title" href="/2025/08/13/Linux%E4%B8%AD%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6%EF%BC%8C%E8%BD%AF%E7%A1%AC%E4%BB%B6%E5%88%86%E5%88%AB%E5%8F%91%E7%94%9F%E4%BB%80%E4%B9%88%EF%BC%9F/" title="Linux中读取文件,软硬件分别发生什么">Linux中读取文件,软硬件分别发生什么</a><time datetime="2025-08-12T16:00:00.000Z" title="发表于 2025-08-13 00:00:00">2025-08-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/08/12/Mem0%20Building%20Production-Ready%20AI%20Agents%20with%20Scalable%20Long-Term%20Memory/" title="Mem0 Building Production-Ready AI Agents with Scalable Long-Term Memory"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover/LLM.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Mem0 Building Production-Ready AI Agents with Scalable Long-Term Memory"/></a><div class="content"><a class="title" href="/2025/08/12/Mem0%20Building%20Production-Ready%20AI%20Agents%20with%20Scalable%20Long-Term%20Memory/" title="Mem0 Building Production-Ready AI Agents with Scalable Long-Term Memory">Mem0 Building Production-Ready AI Agents with Scalable Long-Term Memory</a><time datetime="2025-08-11T16:00:00.000Z" title="发表于 2025-08-12 00:00:00">2025-08-12</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;2020 - 2025 By Roger-Lv</span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.4.2"></script><script src="/js/main.js?v=5.4.2"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@19.1.3/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const initValine = (el, path) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyValine = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    const valineConfig = {
      el: '#vcomment',
      appId: 'smA3tZdRGodG2VgnMubBQjLm-gzGzoHsz',
      appKey: 'biCDxj0lSBtZTMie2kNIKErd',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      visitor: true,
      ...option,
      path: isShuoshuo ? path : (option && option.path) || window.location.pathname
    }

    new Valine(valineConfig)
  }

  const loadValine = async (el, path) => {
    if (typeof Valine === 'function') {
      initValine(el, path)
    } else {
      await btf.getScript('https://cdn.jsdelivr.net/npm/valine@1.5.3/dist/Valine.min.js')
      initValine(el, path)
    }
  }

  if (isShuoshuo) {
    'Valine' === 'Valine'
      ? window.shuoshuoComment = { loadComment: loadValine }
      : window.loadOtherComment = loadValine
    return
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script></div><div class="aplayer no-destroy" data-id="8674547170" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="true" data-lrcType="-1"> </div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/dist/fireworks.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>