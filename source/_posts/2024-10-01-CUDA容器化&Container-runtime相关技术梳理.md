---
title: CUDAå®¹å™¨åŒ–&Container runtimeç›¸å…³æŠ€æœ¯æ¢³ç†
date: 2024-10-01
updated:
tags: [äººå·¥æ™ºèƒ½,å®¹å™¨åŒ–,è™šæ‹ŸåŒ–,CUDA,AI Infra]
categories: CUDA
keywords:
description:
top_img: /img/default_top_img.jpg
comments:
cover: /img/cover/CUDA.png
toc:
toc_number:
toc_style_simple:
copyright:
copyright_author:
copyright_author_href:
copyright_url:
copyright_info:
mathjax:
katex:
aplayer:
highlight_shrink:
aside:
abcjs:




---

# CUDAå®¹å™¨åŒ–&Container runtimeç›¸å…³æŠ€æœ¯æ¢³ç†

## æ•´ä½“ç»“æž„

### CUDA APIä½“ç³»

![image-20240927223023317.png](https://s2.loli.net/2024/09/27/Qk5REXwfKgbDFS6.png)

CUDA Driver APIï¼šGPU è®¾å¤‡çš„æŠ½è±¡å±‚ï¼Œé€šè¿‡ä¸€ç³»åˆ— API ç›´æŽ¥æ“ä½œ GPU è®¾å¤‡ï¼Œæ€§èƒ½å¥½ï¼Œä½†ç¼–ç¨‹éš¾åº¦é«˜ï¼ˆéœ€è¦æ˜¾å¼è¿›è¡Œdeviceåˆå§‹åŒ–ä»¥åŠcontextç®¡ç†ç­‰ï¼‰ï¼›

CUDA Runtime API: å¯¹ CUDA Driver API è¿›è¡Œä¸€å®šå°è£…ï¼Œç®€åŒ–ç¼–ç¨‹è¿‡ç¨‹ï¼Œé™ä½Žå¼€å‘éš¾åº¦ï¼›

CUDA Libraries: æ›´é«˜å±‚çš„å°è£…ï¼ŒåŒ…å«ä¸€äº›æˆç†Ÿçš„é«˜æ•ˆå‡½æ•°åº“ã€‚

å› æ­¤è¦å®žçŽ° NVIDIA å®¹å™¨åŒ–ï¼Œä¹Ÿå°±æ˜¯è¦è®©åº”ç”¨ç¨‹åºå¯ä»¥åœ¨å®¹å™¨å†…è°ƒç”¨ CUDA API æ¥æ“ä½œ GPUï¼Œä¸€èˆ¬æ¥è®²ï¼Œå°±è¦ä½¿å®¹å™¨å†…**åº”ç”¨ç¨‹åºå†…**å¯è°ƒç”¨ CUDA Runtime API å’Œ CUDA Librariesï¼Œ**å®¹å™¨å†…**å¯ä½¿ç”¨ CUDA Driver ç›¸å…³åº“ã€‚

### NVIDIA CONTAINER TOOLKIT å…·ä½“ç»“æž„

![image-20240927223237338.png](https://s2.loli.net/2024/09/27/ZEfkCY5nV1hXo7z.png)

[GPU å®¹å™¨åº•å±‚å®žçŽ°](https://infinigence.feishu.cn/docx/CjgqdgeFkoFT8vxh8OxcwnUCnKd)

[GPU å®¹å™¨ç›¸å…³æ¦‚å¿µ](https://infinigence.feishu.cn/docx/Sha4dDAThon7EyxCSBIcKVofnYe)

#### ä¸€äº›èƒŒæ™¯çŸ¥è¯†

1. ä»€ä¹ˆæ˜¯è¿è¡Œæ—¶ï¼Ÿä»€ä¹ˆæ˜¯é«˜çº§è¿è¡Œæ—¶ï¼ˆhigh-level runtimeï¼‰å’Œä½Žçº§è¿è¡Œæ—¶(low-level runtime):
   1. å‚è€ƒï¼šhttps://blog.csdn.net/easylife206/article/details/135447413?fromshare=blogdetail&sharetype=blogdetail&sharerId=135447413&sharerefer=PC&sharesource=a1150568956&sharefrom=from_link
2. dockerå’Œcontainerdçš„åŒºåˆ«å’Œè”ç³»ï¼š
   1. å‚è€ƒï¼šhttps://blog.csdn.net/weixin_58519482/article/details/139123290?fromshare=blogdetail&sharetype=blogdetail&sharerId=139123290&sharerefer=PC&sharesource=a1150568956&sharefrom=from_link
3. å®˜æ–¹å‚è€ƒï¼šhttps://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/arch-overview.html
4. ä»€ä¹ˆæ˜¯OCI?CRI?
   1. å‚è€ƒï¼šhttps://blog.csdn.net/weixin_43539320/article/details/137865618?fromshare=blogdetail&sharetype=blogdetail&sharerId=137865618&sharerefer=PC&sharesource=a1150568956&sharefrom=from_link

#### ç»„ä»¶ä»‹ç»

åœ¨æ•´ä¸ªcontainer-runtimeçš„ç»„ç»‡ç»“æž„å›¾ä¸­ï¼Œåˆ†åˆ«å¯¹ä¸Šå›¾è¿›è¡Œå„ä¸ªç»„ä»¶çš„è§£é‡Šï¼š

1. containerd: 

   1. **CRI æ’ä»¶** æ˜¯ä¸€ä¸ªä¸­é—´å±‚ï¼Œä½äºŽ Kubelet å’Œå…·ä½“å®¹å™¨è¿è¡Œæ—¶ä¹‹é—´ã€‚æ’ä»¶å®žçŽ°äº† CRI å®šä¹‰çš„æŽ¥å£ï¼ˆä¾‹å¦‚ PodSandboxService å’Œ RuntimeServiceï¼‰ï¼Œå¹¶å°† Kubelet å‘é€çš„è¯·æ±‚ç¿»è¯‘æˆå¯¹åº”å®¹å™¨è¿è¡Œæ—¶çš„ API è°ƒç”¨ã€‚**è€Œcontainerdæ˜¯è¢«è°ƒç”¨çš„å…¶ä¸­çš„ä¸€ç§ã€‚**

      ![image-20241001004137064.png](https://s2.loli.net/2024/10/01/NIzdrMApTVQqkt6.png)

   2. â€‹       è€Œdockerçš„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆå…¶ä¸­ä¹ŸåŒ…å«äº†containerdï¼‰ï¼š

      ![image-20241001004226933.png](https://s2.loli.net/2024/10/01/3LRvMxPuJCW9qHj.png)

   3. containerd æ˜¯ä¸€ä¸ª**é«˜çº§å®¹å™¨è¿è¡Œæ—¶ï¼ˆhigh-level container runtimeï¼‰**ï¼Œå®ƒåœ¨ä½Žçº§è¿è¡Œæ—¶ï¼ˆå¦‚ runcï¼‰ä¹‹ä¸Šæž„å»ºï¼Œæä¾›æ›´ä¸°å¯Œçš„åŠŸèƒ½å’Œæ›´é«˜å±‚æ¬¡çš„æŠ½è±¡ã€‚ä½œä¸ºé«˜çº§è¿è¡Œæ—¶ï¼Œcontainerd è´Ÿè´£**å®¹å™¨é•œåƒçš„ä¼ è¾“å’Œç®¡ç†**ï¼Œä»¥åŠä»Žé•œåƒè¿è¡Œå®¹å™¨ã€‚å®ƒé€šè¿‡æ’ä»¶æœºåˆ¶å®žçŽ°æ‰©å±•ï¼ŒåŒ…æ‹¬ä¸Ž Kubernetes çš„ CRI æ’ä»¶é›†æˆã€ä½¿ç”¨ CNI æ’ä»¶è¿›è¡Œç½‘ç»œç®¡ç†ä»¥åŠä½¿ç”¨ CSI æ’ä»¶è¿›è¡Œå­˜å‚¨ç®¡ç†ã€‚

   4. å…¶è®¾è®¡ç›®æ ‡æ˜¯ç®€å•ã€é«˜æ•ˆï¼Œå¹¶ä¸”ä¸Ž Kubernetes æ·±åº¦é›†æˆï¼Œä½¿å…¶æˆä¸º Kubernetes çš„é¦–é€‰å®¹å™¨è¿è¡Œæ—¶ã€‚å®ƒæä¾›äº†æ ¸å¿ƒçš„å®¹å™¨ç®¡ç†åŠŸèƒ½ï¼Œå¦‚é•œåƒç®¡ç†ã€å®¹å™¨æ‰§è¡Œå’Œå­˜å‚¨ç®¡ç†ï¼Œå¹¶ä¸”é€šè¿‡ gRPC API ä¸Žå¤–éƒ¨å®¢æˆ·ç«¯é€šä¿¡ï¼Œæä¾›æ ‡å‡†åŒ–çš„æŽ¥å£ä»¥æ‰§è¡Œå®¹å™¨æ“ä½œã€‚

   5.  containerd æ˜¯ Kubernetes é»˜è®¤çš„å®¹å™¨è¿è¡Œæ—¶ã€‚

2. runc:

   1. runcæ˜¯ä¸€ä¸ªè½»é‡çº§çš„ã€ç¬¦åˆ Open Container Initiative (OCI) è§„èŒƒçš„ä½Žçº§å®¹å™¨è¿è¡Œæ—¶ï¼ˆ**low-level container runtimeï¼‰**å·¥å…·ï¼Œå®ƒçš„ä¸»è¦ä»»åŠ¡æ˜¯åˆ›å»ºå’Œè¿è¡Œå®¹å™¨ ã€‚ä½œä¸ºä¸€ä¸ªä½Žçº§è¿è¡Œæ—¶ï¼Œrunc ä¸“æ³¨äºŽåœ¨ Linux ç³»ç»Ÿä¸Šåˆ©ç”¨å‘½åç©ºé—´ï¼ˆnamespacesï¼‰å’ŒæŽ§åˆ¶ç»„ï¼ˆcgroupsï¼‰ç­‰å†…æ ¸ç‰¹æ€§æ¥æä¾›å®¹å™¨çš„éš”ç¦»æ€§ã€‚å®ƒä¸æ¶‰åŠé•œåƒç®¡ç†ã€ç½‘ç»œé…ç½®æˆ–å·ç®¡ç†ç­‰é«˜çº§åŠŸèƒ½ï¼Œè¿™äº›é€šå¸¸ç”± Dockerã€containerd æˆ– Kubernetes ç­‰æ›´é«˜çº§çš„å®¹å™¨ç®¡ç†ç³»ç»Ÿæ¥å¤„ç†ã€‚
   2. runc ç›´æŽ¥ä¸Ž Linux å†…æ ¸äº¤äº’ï¼Œåˆ›å»ºå®¹å™¨æ‰€éœ€çš„éš”ç¦»çŽ¯å¢ƒï¼Œå¹¶æ‰§è¡ŒæŒ‡å®šçš„å®¹å™¨è¿›ç¨‹ã€‚å®ƒä¸å…³å¿ƒé•œåƒçš„åˆ†å‘å’Œå­˜å‚¨ï¼Œè€Œæ˜¯å‡å®šå·²ç»æœ‰ä¸€ä¸ªå‡†å¤‡å¥½çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆrootfsï¼‰å’Œä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼ˆconfig.jsonï¼‰æ¥æè¿°å®¹å™¨çš„è¿è¡Œé…ç½®ã€‚runc çš„è®¾è®¡å“²å­¦æ˜¯ä¿æŒç®€å•å’Œä¸“æ³¨äºŽå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œå¦‚åˆ›å»ºã€å¯åŠ¨ã€åœæ­¢å’Œåˆ é™¤å®¹å™¨ã€‚
   3. åœ¨å®¹å™¨æŠ€æœ¯æ ˆä¸­ï¼Œrunc ä½œä¸ºå®¹å™¨è¿è¡Œçš„åŸºç¡€ï¼Œè¢«è®¾è®¡ä¸ºå¯ä»¥è¢«æ›´é«˜çº§åˆ«çš„å®¹å™¨ç®¡ç†ç³»ç»Ÿæ‰€è°ƒç”¨ï¼Œä¾‹å¦‚ containerd æˆ– CRI-Oã€‚è¿™äº›ç³»ç»Ÿåœ¨ runc ä¹‹ä¸Šæä¾›äº†é¢å¤–çš„åŠŸèƒ½ï¼Œå¦‚é•œåƒç®¡ç†ã€ç½‘ç»œå’Œå­˜å‚¨çš„é›†æˆã€API æŽ¥å£ç­‰ï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥æ›´æ–¹ä¾¿åœ°ä½¿ç”¨å®¹å™¨æŠ€æœ¯ã€‚
   4. **runc ä½œä¸ºä½Žçº§è¿è¡Œæ—¶ï¼Œæä¾›äº†å®¹å™¨è¿è¡Œæ‰€éœ€çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œè€Œé«˜çº§è¿è¡Œæ—¶ï¼ˆæ¯”å¦‚containerdï¼‰åˆ™æž„å»ºåœ¨ runc è¿™æ ·çš„ä½Žçº§è¿è¡Œæ—¶ä¹‹ä¸Š**ï¼Œæä¾›æ›´å…¨é¢å’Œæ˜“ç”¨çš„å®¹å™¨ç®¡ç†æœåŠ¡ã€‚

3. NVIDIA Container Runtimeå’Œruncçš„å…³ç³»

   1. NVIDIA Container Runtime æ˜¯ä¸€ä¸ªä¸Ž Open Containers Initiative (OCI) è§„èŒƒå…¼å®¹çš„ GPU æ„ŸçŸ¥å®¹å™¨è¿è¡Œæ—¶ï¼Œå®ƒåœ¨ runc çš„åŸºç¡€ä¸Šå¢žåŠ äº†å¯¹ NVIDIA GPU çš„æ”¯æŒã€‚runc æœ¬èº«æ˜¯ä¸€ä¸ªéµå¾ª OCI è§„èŒƒçš„ä½Žçº§å®¹å™¨è¿è¡Œæ—¶ï¼Œä¸“æ³¨äºŽåˆ›å»ºå’Œè¿è¡Œå®¹å™¨ã€‚
   2. NVIDIA Container Runtime é€šè¿‡åœ¨ runc çš„åŸºç¡€ä¸Šå¢žåŠ ä¸€ä¸ª prestart hookï¼ˆç§°ä¸º nvidia-container-runtime-hookï¼‰ï¼Œåœ¨å®¹å™¨å¯åŠ¨åŽï¼ˆNamespace å·²åˆ›å»ºå®Œæˆï¼‰ï¼Œå®¹å™¨è‡ªå®šä¹‰å‘½ä»¤ï¼ˆEntrypointï¼‰å¯åŠ¨å‰æ‰§è¡Œã€‚è¿™ä¸ª hook ä¼šæ£€æŸ¥å®¹å™¨æ˜¯å¦éœ€è¦ä½¿ç”¨ GPUï¼ˆé€šè¿‡çŽ¯å¢ƒå˜é‡ NVIDIA_VISIBLE_DEVICES åˆ¤æ–­ï¼‰ï¼Œå¦‚æžœéœ€è¦åˆ™è°ƒç”¨ libnvidia-container æ¥æŒ‚è½½ GPU è®¾å¤‡å’Œ CUDA é©±åŠ¨åˆ°å®¹å™¨ä¸­ã€‚å¦‚æžœæ£€æµ‹ä¸åˆ°éœ€è¦ GPU çš„çŽ¯å¢ƒå˜é‡ï¼Œåˆ™ä¼šæ‰§è¡Œé»˜è®¤çš„ runc è¿è¡Œæ—¶é€»è¾‘ã€‚
   3. runc æ˜¯ä¸€ä¸ªä½Žçº§å®¹å™¨è¿è¡Œæ—¶ï¼Œä¸»è¦è´Ÿè´£å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œå¦‚åˆ›å»ºã€å¯åŠ¨å’Œåœæ­¢å®¹å™¨ã€‚è€Œ NVIDIA Container Runtime åˆ™æ˜¯åœ¨ runc çš„åŸºç¡€ä¸Šå¢žåŠ äº† GPU æ”¯æŒçš„èƒ½åŠ›ï¼Œä½¿å¾—å®¹å™¨å¯ä»¥è®¿é—®å’Œåˆ©ç”¨å®¿ä¸»æœºä¸Šçš„ NVIDIA GPU èµ„æºã€‚è¿™ç§è®¾è®¡ä½¿å¾— NVIDIA Container Runtime å¯ä»¥çµæ´»åœ°æ”¯æŒä¸åŒçš„å®¹å™¨è¿è¡Œæ—¶ï¼Œå¦‚ Dockerã€LXC å’Œ CRI-Oï¼Œä»Žè€Œåœ¨å®¹å™¨ä¸­è¿è¡Œ GPU åŠ é€Ÿçš„åº”ç”¨ã€‚

4. nvidia-container-runtime-hook

   1. `Nvidia-container-runtime-hook` çš„ä½œç”¨ä¸ºæ ¹æ® config è®¾ç½® nvidia-container-cli çš„å‚æ•°ï¼Œå¹¶è°ƒç”¨ nvidia-container-cliã€‚
   2. `nvidia-container-cli `å·¥å…·åŒ…å«äºŽ `libnvidia-container` ä¸­ï¼Œç”¨äºŽè‡ªåŠ¨é…ç½®åˆ©ç”¨NVIDIAç¡¬ä»¶çš„ç›¸å…³å®¹å™¨ã€‚è¯¥å®žçŽ°ä¾èµ–äºŽå†…æ ¸åŽŸè¯­ï¼Œå…¶è®¾è®¡ä¸Žå®¹å™¨è¿è¡Œæ—¶æ— å…³ã€‚nvidia-container-cli é€šè¿‡å‘å®¹å™¨æš´éœ²è®¾å¤‡é©±åŠ¨ç¨‹åºï¼Œä»Žè€Œé…ç½®å®¹å™¨çš„ GPU æ”¯æŒï¼Œå…¶å°†è¿›å…¥æŒ‡å®šå®¹å™¨çš„ namespace ä¸­æ‰§è¡Œéƒ¨åˆ†æ“ä½œä»¥ç¡®ä¿é©±åŠ¨ç¨‹åºçš„ç›¸å…³åŠŸèƒ½åœ¨å®¹å™¨é‡Œå¯ç”¨ï¼Œæ³¨æ„ï¼Œæ­¤æ—¶å‡å®šå®¹å™¨å·²åˆ›å»ºä½†å°šæœªå¯åŠ¨ï¼Œå¹¶ä¸”ä¸»æœºæ–‡ä»¶ç³»ç»Ÿæ˜¯å¯è®¿é—®çš„ï¼ˆå³å°šæœªè°ƒç”¨ chroot/pivot_rootï¼‰ã€‚

5. Libnvidia-container:

   1. `libnvidia-container`ç”¨äºŽæŒ‚è½½ GPU Device å’Œ CUDA Driver
      1.   `libnvidia-container` æ˜¯ NVIDIA Container Toolkit çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªåº“å’Œå‘½ä»¤è¡Œå·¥å…·æ¥å¸®åŠ©å®¹å™¨å‘çŽ°å’Œä½¿ç”¨å®¿ä¸»æœºä¸Šçš„ NVIDIA GPU èµ„æºã€‚è¿™ä¸ªåº“å®žçŽ°äº†æ ¸å¿ƒçš„ GPU å‘çŽ°å’ŒæŒ‚è½½é€»è¾‘ï¼Œä½¿å¾—å®¹å™¨å¯ä»¥åˆ©ç”¨ NVIDIA GPU è¿›è¡ŒåŠ é€Ÿè®¡ç®—ã€‚
      2.   libnvidia-container çš„ä¸»è¦ç»„ä»¶åŒ…æ‹¬ï¼š
      3. **åº“æ–‡ä»¶** (`libnvidia-container1`): æä¾›æ ¸å¿ƒåŠŸèƒ½ï¼Œä¾›å…¶ä»–ç¨‹åºè°ƒç”¨ã€‚
      4. **å‘½ä»¤è¡Œå·¥å…·** (`nvidia-container-cli`): ç”¨äºŽé…ç½® Linux å®¹å™¨å¯¹ GPU ç¡¬ä»¶çš„ä½¿ç”¨ã€‚
      5.   [NVIDIA device plugin for Kubernetes åŽŸç†åˆ†æž](https://infinigence.feishu.cn/docx/Cb4tdK3N4o1ziUxloTWcqOVvnHc)

## å®¹å™¨å¯åŠ¨æµç¨‹ï¼ˆkubeletã€containerdã€container-runtimeã€device-pluginã€runcï¼‰

### ä¸€äº›åŸºç¡€èƒŒæ™¯ï¼š

1. Kubelet

   1. å‚è€ƒï¼šhttps://blog.csdn.net/ok875161027/article/details/78891733?fromshare=blogdetail&sharetype=blogdetail&sharerId=78891733&sharerefer=PC&sharesource=a1150568956&sharefrom=from_link

      ![image-20241001004301154.png](https://s2.loli.net/2024/10/01/cB24m31gWblnpAY.png)

### **containerdé“¾è·¯:**

containerd ä½œä¸ºä¸€ä¸ª api æœåŠ¡ï¼Œæä¾›äº†ä¸€ç³»åˆ—çš„æŽ¥å£ä¾›å¤–éƒ¨è°ƒç”¨ï¼Œæ¯”å¦‚åˆ›å»ºå®¹å™¨ã€åˆ é™¤å®¹å™¨ã€åˆ›å»ºé•œåƒã€åˆ é™¤é•œåƒç­‰ç­‰ã€‚ä½¿ç”¨ docker å’Œ ctr ç­‰å·¥å…·ï¼Œéƒ½æ˜¯é€šè¿‡è°ƒç”¨ containerd çš„ api æ¥å®žçŽ°çš„ã€‚

![image-20241001004137064.png](https://s2.loli.net/2024/10/01/NIzdrMApTVQqkt6.png)

### **Device plugin & å…·ä½“åˆ†é…example:**

[NVIDIA device plugin for Kubernetes åŽŸç†åˆ†æž](https://infinigence.feishu.cn/docx/Cb4tdK3N4o1ziUxloTWcqOVvnHc)

![image-20241001004338132.png](https://s2.loli.net/2024/10/01/e5RqIZdCiHEftM7.png)

deviceç‰©ç†è®¾å¤‡è¦ä½œä¸ºèµ„æºï¼Œé€šè¿‡device pluginçš„grpcå‘kubeletæ³¨å†Œã€‚åœ¨ä¹‹åŽçš„pod/å®¹å™¨çš„åˆ›å»ºä¾¿ä¼šé¦–å…ˆé€šè¿‡kubeletåŽ»è¿›è¡Œrpcè°ƒç”¨listWatchå¯¹æ‰€æ‹¥æœ‰çš„ç‰©ç†è®¾å¤‡èµ„æºè¿›è¡ŒæŸ¥è¯¢ï¼Œå¹¶é€šè¿‡allocateè¿›è¡Œå…·ä½“çš„æ“ä½œ

![image-20241001004405475.png](https://s2.loli.net/2024/10/01/D6IfwTHiU2zeoCt.png)

å¯¹äºŽä¸Šå›¾ï¼š

- é¦–å…ˆï¼Œå¯¹äºŽæ¯ä¸€ç§ç¡¬ä»¶è®¾å¤‡ï¼Œéƒ½éœ€è¦æœ‰å®ƒæ‰€å¯¹åº”çš„ Device Plugin è¿›è¡Œç®¡ç†ï¼Œè¿™äº› Device Pluginï¼Œéƒ½é€šè¿‡ gRPC çš„æ–¹å¼ï¼ŒåŒ kubelet è¿žæŽ¥èµ·æ¥ã€‚ä»¥ NVIDIA GPU ä¸ºä¾‹ï¼Œå®ƒå¯¹åº”çš„æ’ä»¶å«ä½œNVIDIA GPU device pluginã€‚
- è¿™ä¸ª Device Plugin ä¼šé€šè¿‡ä¸€ä¸ªå«ä½œ ListAndWatch çš„ APIï¼Œå®šæœŸå‘ kubelet æ±‡æŠ¥è¯¥ Node ä¸Š GPU çš„åˆ—è¡¨ã€‚æ¯”å¦‚ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­é‡Œï¼Œä¸€å…±æœ‰ä¸‰ä¸ª GPUï¼ˆGPU0ã€GPU1 å’Œ GPU2ï¼‰ã€‚è¿™æ ·ï¼Œkubelet åœ¨æ‹¿åˆ°è¿™ä¸ªåˆ—è¡¨ä¹‹åŽï¼Œå°±å¯ä»¥ç›´æŽ¥åœ¨å®ƒå‘ APIServer å‘é€çš„å¿ƒè·³é‡Œï¼Œä»¥ Extended Resource çš„æ–¹å¼ï¼ŒåŠ ä¸Šè¿™äº› GPU çš„æ•°é‡ï¼Œæ¯”å¦‚nvidia.com/gpu=3ã€‚æ‰€ä»¥è¯´ï¼Œç”¨æˆ·åœ¨è¿™é‡Œæ˜¯ä¸éœ€è¦å…³å¿ƒ GPU ä¿¡æ¯å‘ä¸Šçš„æ±‡æŠ¥æµç¨‹çš„ã€‚
- éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒListAndWatch å‘ä¸Šæ±‡æŠ¥çš„ä¿¡æ¯ï¼Œåªæœ‰æœ¬æœºä¸Š GPU çš„ ID åˆ—è¡¨ï¼Œè€Œä¸ä¼šæœ‰ä»»ä½•å…³äºŽ GPU è®¾å¤‡æœ¬èº«çš„ä¿¡æ¯ã€‚è€Œä¸” kubelet åœ¨å‘ API Server æ±‡æŠ¥çš„æ—¶å€™ï¼Œåªä¼šæ±‡æŠ¥è¯¥ GPU å¯¹åº”çš„ Extended Resource çš„æ•°é‡ã€‚å½“ç„¶ï¼Œkubelet æœ¬èº«ï¼Œä¼šå°†è¿™ä¸ª GPU çš„ ID åˆ—è¡¨ä¿å­˜åœ¨è‡ªå·±çš„å†…å­˜é‡Œï¼Œå¹¶é€šè¿‡ ListAndWatch API å®šæ—¶æ›´æ–°ã€‚
- è€Œå½“ä¸€ä¸ª Pod æƒ³è¦ä½¿ç”¨ä¸€ä¸ª GPU çš„æ—¶å€™ï¼Œå®ƒåªéœ€è¦åœ¨ Pod çš„ limits å­—æ®µå£°æ˜Žnvidia.com/gpu: 1ã€‚é‚£ä¹ˆæŽ¥ä¸‹æ¥ï¼ŒKubernetes çš„è°ƒåº¦å™¨å°±ä¼šä»Žå®ƒçš„ç¼“å­˜é‡Œï¼Œå¯»æ‰¾ GPU æ•°é‡æ»¡è¶³æ¡ä»¶çš„ Nodeï¼Œç„¶åŽå°†ç¼“å­˜é‡Œçš„ GPU æ•°é‡å‡ 1ï¼Œå®Œæˆ Pod ä¸Ž Node çš„ç»‘å®šã€‚
- è¿™ä¸ªè°ƒåº¦æˆåŠŸåŽçš„ Pod ä¿¡æ¯ï¼Œè‡ªç„¶å°±ä¼šè¢«å¯¹åº”çš„ kubelet æ‹¿æ¥è¿›è¡Œå®¹å™¨æ“ä½œã€‚è€Œå½“ kubelet å‘çŽ°è¿™ä¸ª Pod çš„å®¹å™¨è¯·æ±‚ä¸€ä¸ª GPU çš„æ—¶å€™ï¼Œkubelet å°±ä¼šä»Žè‡ªå·±æŒæœ‰çš„ GPU åˆ—è¡¨é‡Œï¼Œä¸ºè¿™ä¸ªå®¹å™¨åˆ†é…ä¸€ä¸ª GPUã€‚æ­¤æ—¶ï¼Œkubelet å°±ä¼šå‘æœ¬æœºçš„ Device Plugin å‘èµ·ä¸€ä¸ª Allocate() è¯·æ±‚ã€‚è¿™ä¸ªè¯·æ±‚æºå¸¦çš„å‚æ•°ï¼Œæ­£æ˜¯å³å°†åˆ†é…ç»™è¯¥å®¹å™¨çš„è®¾å¤‡ ID åˆ—è¡¨ã€‚
- å½“ Device Plugin æ”¶åˆ° Allocate è¯·æ±‚ä¹‹åŽï¼Œå®ƒå°±ä¼šæ ¹æ® kubelet ä¼ é€’è¿‡æ¥çš„è®¾å¤‡ IDï¼Œä»Ž Device Plugin é‡Œæ‰¾åˆ°è¿™äº›è®¾å¤‡å¯¹åº”çš„è®¾å¤‡è·¯å¾„å’Œé©±åŠ¨ç›®å½•ã€‚å½“ç„¶ï¼Œè¿™äº›ä¿¡æ¯ï¼Œæ­£æ˜¯ Device Plugin å‘¨æœŸæ€§çš„ä»Žæœ¬æœºæŸ¥è¯¢åˆ°çš„ã€‚æ¯”å¦‚ï¼Œåœ¨ NVIDIA Device Plugin çš„å®žçŽ°é‡Œï¼Œå®ƒä¼šå®šæœŸè®¿é—® nvidia-docker æ’ä»¶ï¼Œä»Žè€ŒèŽ·å–åˆ°æœ¬æœºçš„ GPU ä¿¡æ¯ã€‚
- è€Œè¢«åˆ†é… GPU å¯¹åº”çš„è®¾å¤‡è·¯å¾„å’Œé©±åŠ¨ç›®å½•ä¿¡æ¯è¢«è¿”å›žç»™ kubelet ä¹‹åŽï¼Œkubelet å°±å®Œæˆäº†ä¸ºä¸€ä¸ªå®¹å™¨åˆ†é… GPU çš„æ“ä½œã€‚æŽ¥ä¸‹æ¥ï¼Œkubelet ä¼šæŠŠè¿™äº›ä¿¡æ¯è¿½åŠ åœ¨åˆ›å»ºè¯¥å®¹å™¨æ‰€å¯¹åº”çš„ CRI è¯·æ±‚å½“ä¸­ã€‚è¿™æ ·ï¼Œå½“è¿™ä¸ª CRI è¯·æ±‚å‘ç»™ Docker ä¹‹åŽï¼ŒDocker ä¸ºä½ åˆ›å»ºå‡ºæ¥çš„å®¹å™¨é‡Œï¼Œå°±ä¼šå‡ºçŽ°è¿™ä¸ª GPU è®¾å¤‡ï¼Œå¹¶æŠŠå®ƒæ‰€éœ€è¦çš„é©±åŠ¨ç›®å½•æŒ‚è½½è¿›åŽ»ã€‚

è‡³æ­¤ï¼ŒKubernetes ä¸ºä¸€ä¸ª Pod åˆ†é…ä¸€ä¸ª GPU çš„æµç¨‹å°±å®Œæˆäº†ã€‚                   

å‚è€ƒåŽŸæ–‡é“¾æŽ¥ï¼šhttps://blog.csdn.net/qq_37756660/article/details/134523326

### containerd åˆ›å»ºå®¹å™¨æµç¨‹ï¼š

1. æŽ¥æ”¶åˆ° api è¯·æ±‚ï¼Œé€šè¿‡è°ƒç”¨ containerd-shim-runc-v2 è°ƒç”¨ runc åˆ›å»ºå®¹å™¨ï¼Œä¸»è¦æ˜¯åšè§£åŽ‹æ–‡ä»¶å’Œå‡†å¤‡çŽ¯å¢ƒçš„å·¥ä½œã€‚
2. æŽ¥æ”¶åˆ° api è¯·æ±‚ï¼Œåˆ›å»ºä¸€ä¸ª taskï¼Œtask æ˜¯ä¸€ä¸ªå®¹å™¨çš„æŠ½è±¡ï¼ŒåŒ…å«äº†å®¹å™¨çš„æ‰€æœ‰ä¿¡æ¯ï¼Œæ¯”å¦‚å®¹å™¨çš„ idã€å®¹å™¨çš„çŠ¶æ€ã€å®¹å™¨çš„é…ç½®ç­‰ç­‰ã€‚
3. containerd å¯åŠ¨ä¸€ä¸ª containerd-shim-runc-v2 è¿›ç¨‹ã€‚
4. containerd-shim-runc-v2 è¿›ç¨‹å†å¯åŠ¨ä¸€ä¸ª containerd-shim-runc-v2 è¿›ç¨‹ï¼ˆç›¸å½“äºŽè¿™é‡Œå·²ç»æœ‰ä¸¤ä¸ªï¼‰ï¼Œç„¶åŽç¬¬ä¸€ä¸ª containerd-shim-runc-v2 è¿›ç¨‹é€€å‡ºã€‚
5. containerd é€šè¿‡ IPC é€šä¿¡ï¼Œè®©ç¬¬äºŒä¸ª containerd-shim-runc-v2 å¯åŠ¨å®¹å™¨ã€‚
6. containerd-shim-runc-v2 è¿›ç¨‹é€šè¿‡è°ƒç”¨ runc start å¯åŠ¨å®¹å™¨ã€‚
7. runc ä¼šè°ƒç”¨ runc init å¯åŠ¨å®¹å™¨çš„ init è¿›ç¨‹ã€‚
8. runc init è¿›ç¨‹ä¼šè°ƒç”¨ unix.Exec çš„æ–¹å¼ï¼Œæ›¿æ¢è‡ªå·±çš„è¿›ç¨‹ï¼Œå¯åŠ¨å®¹å™¨çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ã€‚è¿™ä¸ªè¿›ç¨‹æ—¢æ˜¯å®¹å™¨çš„å¯åŠ¨å‘½ä»¤ï¼Œä¹Ÿæ˜¯å®¹å™¨çš„ pid 1 è¿›ç¨‹ã€‚å®Œæˆä¹‹åŽï¼Œrunc create è¿›ç¨‹é€€å‡ºã€‚

è¿™æ · containerd-shim-runc-v2 çš„çˆ¶è¿›ç¨‹å°±æ˜¯ init è¿›ç¨‹ï¼ˆ1ï¼‰ï¼Œè€Œ å®¹å™¨çš„init è¿›ç¨‹ï¼ˆç”¨æˆ·è¿›ç¨‹ï¼‰çš„çˆ¶è¿›ç¨‹æ˜¯ containerd-shim-runc-v2 è¿›ç¨‹ï¼Œè¿™æ ·å°±å½¢æˆäº†ä¸€ä¸ªè¿›ç¨‹æ ‘ã€‚



ä¸€äº›é—®é¢˜ðŸ™‹

1. ä¸ºä»€ä¹ˆè¦åˆ›å»ºä¸¤ä¸ª containerd-shim ä¸å«Œéº»çƒ¦å—ï¼Ÿ
   1. å› ä¸ºç¬¬ä¸€ä¸ª containerd-shim ä¼šåœ¨åˆ›å»ºå®Œç¬¬äºŒä¸ª containerd-shim åŽé€€å‡ºï¼Œè€Œä½œä¸ºç¬¬ä¸€ä¸ªè¿›ç¨‹å­è¿›ç¨‹çš„ç¬¬äºŒä¸ª containerd-shim ä¼šæˆä¸ºå­¤å„¿è¿›ç¨‹ï¼Œè¿™æ ·å°±ä¼šè¢« init è¿›ç¨‹æŽ¥ç®¡ï¼Œè€Œå’Œ containerd æœ¬èº«è„±ç¦»äº†å…³ç³»ã€‚
2. ä¸ºä»€ä¹ˆè¦æƒ³æ–¹è®¾æ³•æŠŠ containerd-shim æŒ‚åœ¨ init è¿›ç¨‹ä¸‹é¢ï¼Œè€Œä¸æ˜¯ containerdï¼Ÿ
   1. ä¸ºäº†ä¿è¯ç¨³å®šæ€§å’Œç‹¬ç«‹æ€§ã€‚è¿™æ ·åšå¯ä»¥ç¡®ä¿å³ä½¿ containerd å´©æºƒæˆ–é‡å¯ï¼Œç”± containerd-shim ç®¡ç†çš„å®¹å™¨è¿›ç¨‹ä»ç„¶å¯ä»¥ç»§ç»­è¿è¡Œï¼Œä¸å—å½±å“ã€‚æ­¤å¤–ï¼Œè¿™ç§è®¾è®¡è¿˜æœ‰åŠ©äºŽæ›´å¥½åœ°ç®¡ç†èµ„æºå’Œé˜²æ­¢èµ„æºæ³„éœ²ã€‚
3. ä¸ºä»€ä¹ˆ runc start è¿›ç¨‹é€€å‡ºäº† runc init è¿›ç¨‹ï¼ˆç”¨æˆ·è¿›ç¨‹ï¼‰æ²¡æœ‰å˜æˆ ç³»ç»Ÿinit çš„å­è¿›ç¨‹ è€Œæ˜¯containerd-shimçš„å­è¿›ç¨‹ï¼Ÿ
   1. å› ä¸º containerd-shim åšäº† unix çš„ PR_SET_CHILD_SUBREAPER è°ƒç”¨, è¿™ä¸ªç³»ç»Ÿè°ƒç”¨å¤§æ¦‚ä½œç”¨ä¸ºå½“è¿™ä¸ªè¿›ç¨‹çš„å­å­å­™å­™è¿›ç¨‹å˜æˆå­¤å„¿è¿›ç¨‹çš„æ—¶å€™ï¼Œè¿™ä¸ªè¿›ç¨‹ä¼šæŽ¥ç®¡è¿™ä¸ªå­¤å„¿è¿›ç¨‹ï¼Œè€Œä¸æ˜¯ init è¿›ç¨‹æŽ¥ç®¡ã€‚

![image-20241001004438667.png](https://s2.loli.net/2024/10/01/sNMugtrzBRy6kTX.png)

### å®Œæ•´é“¾è·¯æµç¨‹ï¼š

ä¸‹é¢æ˜¯ä¸€ä¸ªè¯¦ç»†çš„ç¤ºæ„å›¾ï¼Œå±•ç¤ºäº†åŒ…å« GPU éœ€æ±‚çš„ Pod åœ¨ Kubernetes é›†ç¾¤ä¸Šçš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬ Kubeletã€containerdã€å®¹å™¨è¿è¡Œæ—¶ï¼ˆå¦‚ runcï¼‰ã€è®¾å¤‡æ’ä»¶ï¼ˆå¦‚ NVIDIA Device Pluginï¼‰ä¹‹é—´çš„äº¤äº’ï¼š

1. **è®¾å¤‡æ³¨å†Œä¸Žèµ„æºä¿¡æ¯åŒæ­¥**ï¼š
   1. æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„ Kubelet ä¸Žè®¾å¤‡æ’ä»¶ï¼ˆå¦‚ NVIDIA GPU Device Pluginï¼‰äº¤äº’ï¼Œå®Œæˆè®¾å¤‡çš„æ³¨å†Œã€‚
   2. è®¾å¤‡æ’ä»¶é€šè¿‡ ListAndWatch æ–¹æ³•å®šæœŸå‘ Kubelet æ±‡æŠ¥èŠ‚ç‚¹ä¸Šå¯ç”¨çš„ GPU è®¾å¤‡åˆ—è¡¨ã€‚
   3. Kubelet å°†è¿™äº›è®¾å¤‡èµ„æºä¿¡æ¯åŒæ­¥è‡³ Kubernetes é›†ç¾¤çš„ API Serverã€‚
2. **Pod** **è°ƒåº¦**ï¼š
   1. åŒ…å« GPU éœ€æ±‚çš„ Pod è¢«åˆ›å»ºåŽï¼ŒKubernetes è°ƒåº¦å™¨æ ¹æ® API Server ä¸­çš„èŠ‚ç‚¹èµ„æºä¿¡æ¯é€‰æ‹©åˆé€‚çš„èŠ‚ç‚¹è¿›è¡Œè°ƒåº¦ã€‚
3. **è®¾å¤‡åˆ†é…**ï¼š
   1. èŠ‚ç‚¹ä¸Šçš„ Kubelet èŽ·å–åˆ° Pod ä¿¡æ¯åŽï¼Œæ ¹æ® Pod çš„èµ„æºéœ€æ±‚ä»Žæœ¬åœ°ç¼“å­˜ä¸­é€‰æ‹©åˆé€‚çš„è®¾å¤‡ã€‚
   2. Kubelet å‘è®¾å¤‡æ’ä»¶å‘é€ Allocate è°ƒç”¨ï¼Œè¯·æ±‚åˆ†é… GPU è®¾å¤‡ã€‚
   3. è®¾å¤‡æ’ä»¶æ ¹æ®è¯·æ±‚çš„è®¾å¤‡ IDï¼Œè¿”å›žè®¾å¤‡è·¯å¾„å’Œé©±åŠ¨ç›®å½•ç­‰ä¿¡æ¯ç»™ Kubeletã€‚
4. **Kubelet å­˜å‚¨è®¾å¤‡åˆ†é…ä¿¡æ¯**ï¼š
   1. Kubelet å°†è®¾å¤‡åˆ†é…ä¿¡æ¯å­˜å‚¨åœ¨ä¸€ä¸ªåä¸º podDevices çš„æ˜ å°„ï¼ˆmapï¼‰ä¸­ï¼Œè¿™ä¸ªæ˜ å°„ä½äºŽ ManagerImpl ä¸­ã€‚
5. **å®¹å™¨åˆ›å»º**ï¼š
   1. Kubelet åœ¨åˆ›å»º Pod çš„å®¹å™¨æ—¶ï¼Œä¼šæ ¹æ® podDevices æ˜ å°„ä¸­çš„ä¿¡æ¯ï¼Œé€šè¿‡ CRI (Container Runtime Interface) è¯·æ±‚ containerd åˆ›å»ºå®¹å™¨ã€‚
   2. Kubelet ä¼šå°† GPU è®¾å¤‡è·¯å¾„å’Œé©±åŠ¨ç›®å½•ä½œä¸ºæŒ‚è½½å·å’ŒçŽ¯å¢ƒå˜é‡ä¼ é€’ç»™å®¹å™¨è¿è¡Œæ—¶ã€‚
6. **å®¹å™¨è¿è¡Œæ—¶ä¸Žè®¾å¤‡æ’ä»¶äº¤äº’**ï¼š
   1. containerd æŽ¥æ”¶åˆ° Kubelet çš„è¯·æ±‚åŽï¼Œåˆ›å»ºä¸€ä¸ª taskï¼Œå¹¶å¯åŠ¨ containerd-shim è¿›ç¨‹æ¥ç®¡ç†å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸã€‚
   2. containerd-shim è°ƒç”¨ NVIDIA Container Runtimeï¼Œå®ƒè´Ÿè´£åœ¨å®¹å™¨å†…è®¾ç½® GPU çŽ¯å¢ƒã€‚
7. **å®¹å™¨å¯åŠ¨**ï¼š
   1. NVIDIA Container Runtime è°ƒç”¨ runc æ¥å®žé™…åˆ›å»ºå®¹å™¨ï¼Œè¿›è¡Œè§£åŽ‹é•œåƒå’Œå‡†å¤‡çŽ¯å¢ƒçš„å·¥ä½œã€‚
   2. runc å¯åŠ¨å®¹å™¨çš„ init è¿›ç¨‹ï¼ˆPID 1ï¼‰ï¼Œå®¹å™¨å¯åŠ¨å¹¶è¿è¡Œã€‚
8. **å®¹å™¨å¯åŠ¨å®Œæˆ**ï¼š
   1. å®¹å™¨å¯åŠ¨å¹¶è¿è¡Œï¼ŒKubelet å°†å®¹å™¨çŠ¶æ€æ›´æ–°åˆ° Kubernetes é›†ç¾¤ã€‚

ä»¥ä¸‹æ˜¯è¿™ä¸ªè¿‡ç¨‹çš„ç¤ºæ„å›¾ï¼š

```Plain
Kubernetes Cluster
    |----> Kubernetes Scheduler ----> Kubelet (Node 1)
    |                                     |
    |                                     |----> Device Plugin (e.g., NVIDIA)
    |                                     |               |
    |                                     |               |----> GPU Hardware
    |                                     |               |
    |                                     |<---- ListAndWatch API ----< 
    |                                     |               |
    |               +-------------------+               |----> containerd
    |               |                   |               |
    |               |                   |               |----> NVIDIA Container Runtime(shim)
    |               |                   |               |               |
    |               |                   |               |               |----> runc
    |               |                   |               |               |
    |               |                   |               |               |----> Container (PID 1)
    |               |                   |               |               |
    |               |                   |               |<------------+
    |               |                   |               |
    |               |                   |               |---- Allocate()
    |               |                   |               |
    |               |                   +------------->+
    |               |                              |
    |               |<----------------------------+
    +---------------+---------------------------+
```

åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒKubelet ä½œä¸º Kubernetes ä¸Žå®¹å™¨è¿è¡Œæ—¶ä¹‹é—´çš„æ¡¥æ¢ï¼Œè´Ÿè´£åè°ƒå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚containerd ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶çš„å®ˆæŠ¤è¿›ç¨‹ï¼Œå¤„ç†å®¹å™¨çš„åˆ›å»ºã€å¯åŠ¨å’Œç›‘æŽ§ã€‚è®¾å¤‡æ’ä»¶ä¸ºå®¹å™¨æä¾›å¿…è¦çš„ç¡¬ä»¶èµ„æºï¼Œå¦‚ GPUã€‚è¿™äº›ç»„ä»¶ä¹‹é—´çš„äº¤äº’ç¡®ä¿äº† Pod èƒ½å¤Ÿåœ¨èŠ‚ç‚¹ä¸Šé¡ºåˆ©åˆ›å»ºå’Œè¿è¡Œã€‚